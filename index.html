<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FIX$ - GeoEquity Impact Engine</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Google Places API will be loaded dynamically when API key is provided -->
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            overflow: hidden;
            margin: 0;
            padding: 0;
        }

        /* Landing Page */
        .landing-page {
            display: flex;
            flex-direction: column;
            height: 100vh;
            width: 100vw;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            position: fixed;
            top: 0;
            left: 0;
            z-index: 999;
        }

        .landing-header {
            background: rgba(255, 255, 255, 0.95);
            padding: 15px 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
        }

        .landing-header h1 {
            font-size: 28px;
            color: #667eea;
            font-weight: 700;
            margin: 0;
        }

        .landing-header .subtitle {
            font-size: 14px;
            color: #666;
            margin: 0;
            display: none;
        }

        .landing-content {
            display: flex;
            flex: 1;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .module-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 25px;
            max-width: 1000px;
            width: 100%;
        }

        .module-btn {
            background: white;
            border: none;
            border-radius: 15px;
            padding: 40px 30px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            text-align: center;
        }

        .module-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }

        .module-btn .icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .module-btn .title {
            font-size: 24px;
            font-weight: 700;
            color: #333;
            margin-bottom: 8px;
        }

        .module-btn .description {
            font-size: 14px;
            color: #666;
        }

        .module-btn.user-dashboard {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .module-btn.user-dashboard .title,
        .module-btn.user-dashboard .description {
            color: white;
        }

        .module-btn.locator {
            background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
            color: white;
        }

        .module-btn.locator .title,
        .module-btn.locator .description {
            color: white;
        }

        .module-btn.compare {
            background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
            color: white;
        }

        .module-btn.compare .title,
        .module-btn.compare .description {
            color: white;
        }

        .module-btn.optimize {
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
            color: white;
        }

        .module-btn.optimize .title,
        .module-btn.optimize .description {
            color: white;
        }

        .module-btn.engage {
            background: linear-gradient(135deg, #e91e63 0%, #c2185b 100%);
            color: white;
        }

        .module-btn.engage .title,
        .module-btn.engage .description {
            color: white;
        }

        .module-btn.compete {
            background: linear-gradient(135deg, #00bcd4 0%, #0097a7 100%);
            color: white;
        }

        .module-btn.compete .title,
        .module-btn.compete .description {
            color: white;
        }

        /* Module Pages */
        .module-page {
            display: none;
            height: 100vh;
            width: 100vw;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 1000;
            background: white;
            overflow: hidden;
        }

        .module-page.active {
            display: flex;
            flex-direction: column;
        }

        /* Ensure main-content in modules is visible */
        .module-page .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* Force sidebar visibility */
        .module-page .sidebar {
            display: flex;
            flex-direction: column;
        }

        /* Force map container visibility */
        .module-page .map-container {
            display: block;
            flex: 1;
        }

        .module-header {
            background: rgba(255, 255, 255, 0.95);
            padding: 15px 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .module-header .back-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .module-header .back-btn:hover {
            background: #5568d3;
        }

        .module-header h2 {
            font-size: 24px;
            color: #667eea;
            font-weight: 700;
        }

        .empty-module {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            margin: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .empty-module-content {
            text-align: center;
            padding: 40px;
        }

        .empty-module-content .icon {
            font-size: 80px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-module-content h3 {
            font-size: 28px;
            color: #333;
            margin-bottom: 10px;
        }

        .empty-module-content p {
            font-size: 16px;
            color: #666;
        }

        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            width: 100vw;
        }

        /* Header */
        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 28px;
            color: #667eea;
            font-weight: 700;
        }

        .header .subtitle {
            font-size: 14px;
            color: #666;
            margin-top: 2px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-info span {
            color: #333;
            font-size: 14px;
        }

        .logout-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        .logout-btn:hover {
            background: #5568d3;
        }

        /* Main Content */
        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: 380px;
            background: white;
            padding: 20px;
            overflow-y: auto;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            gap: 15px;
            z-index: 100;
        }

        .search-section {
            margin-bottom: 25px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .search-section h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 16px;
            font-weight: 600;
        }

        .input-group {
            margin-bottom: 12px;
        }

        .input-group label {
            display: block;
            color: #555;
            font-size: 13px;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .input-group input,
        .input-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .input-group input:focus,
        .input-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .search-btn {
            width: 100%;
            padding: 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            margin-top: 10px;
            transition: background 0.3s;
        }

        .search-btn:hover {
            background: #5568d3;
        }

        .search-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .results {
            margin-top: 20px;
            padding: 15px;
            background: white;
            border-radius: 10px;
            border: 1px solid #e0e0e0;
        }

        .results h4 {
            color: #333;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .result-text {
            color: #666;
            font-size: 13px;
            line-height: 1.5;
        }

        .store-list {
            margin-top: 15px;
            max-height: 300px;
            overflow-y: auto;
        }

        .store-item {
            padding: 12px;
            background: #f8f9fa;
            margin-bottom: 8px;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.2s;
            border-left: 4px solid #667eea;
        }

        .store-item:hover {
            background: #e9ecef;
        }

        .store-item.supermarket {
            border-left-color: #28a745;
        }

        .store-item.pharmacy {
            border-left-color: #dc3545;
        }

        .store-item.restaurant {
            border-left-color: #ffc107;
        }

        .store-item.convenience {
            border-left-color: #17a2b8;
        }

        .store-item.warehouse {
            border-left-color: #9c27b0;
        }

        .store-name {
            font-weight: 600;
            color: #333;
            font-size: 13px;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .store-icon {
            font-size: 16px;
        }

        .store-address {
            font-size: 12px;
            color: #666;
        }

        .ejv-score {
            display: inline-block;
            padding: 4px 10px;
            background: #667eea;
            color: white;
            border-radius: 3px;
            font-size: 11px;
            font-weight: 600;
            margin-top: 5px;
        }

        /* Dashboard Panel */
        .dashboard-panel {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #667eea;
        }

        .dashboard-header {
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid #667eea;
        }

        .dashboard-header h3 {
            color: #667eea;
            font-size: 16px;
            font-weight: 700;
            margin: 0;
        }

        .dashboard-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 12px;
        }

        .stat-card {
            background: white;
            padding: 10px;
            border-radius: 6px;
            text-align: center;
            border: 1px solid #e0e0e0;
        }

        .stat-value {
            font-size: 20px;
            font-weight: 700;
            color: #667eea;
        }

        .stat-label {
            font-size: 10px;
            color: #666;
            margin-top: 3px;
            text-transform: uppercase;
        }

        .wealth-metrics {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 12px;
        }

        .wealth-card {
            background: white;
            padding: 10px;
            border-radius: 6px;
            text-align: center;
            border: 1px solid #e0e0e0;
        }

        .wealth-card.retained {
            border-left: 3px solid #28a745;
        }

        .wealth-card.leakage {
            border-left: 3px solid #dc3545;
        }

        .wealth-value {
            font-size: 16px;
            font-weight: 700;
        }

        .wealth-card.retained .wealth-value {
            color: #28a745;
        }

        .wealth-card.leakage .wealth-value {
            color: #dc3545;
        }

        .wealth-label {
            font-size: 10px;
            color: #666;
            margin-top: 3px;
        }

        .dimensions-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 6px;
            margin-top: 10px;
        }

        .dimension-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 11px;
            border-left: 3px solid #667eea;
        }

        .dimension-name {
            color: #333;
            font-weight: 600;
            flex: 1;
        }

        .dimension-value {
            color: #667eea;
            font-weight: 700;
            font-size: 12px;
        }

        .dimensions-header {
            font-size: 12px;
            font-weight: 600;
            color: #333;
            margin: 10px 0 5px 0;
        }

        .score-breakdown {
            background: white;
            padding: 10px;
            border-radius: 6px;
            margin-top: 10px;
        }

        .score-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            font-size: 11px;
            border-bottom: 1px solid #f0f0f0;
        }

        .score-item:last-child {
            border-bottom: none;
        }

        .score-item-label {
            color: #666;
        }

        .score-item-value {
            font-weight: 700;
            color: #667eea;
        }

        .decision-step:hover {
            background: #f0f8ff !important;
            transform: scale(1.02);
            transition: all 0.2s;
        }

        .decision-step.active {
            background: #e3f2fd !important;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
        }

        .legend {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
        }

        /* Impact Circle Visualization */
        .impact-circle {
            position: absolute;
            border-radius: 50%;
            pointer-events: none;
            z-index: 500;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
                opacity: 0.7;
            }
            50% {
                transform: scale(1.1);
                opacity: 0.9;
            }
            100% {
                transform: scale(1);
                opacity: 0.7;
            }
        }

        .impact-high {
            background: radial-gradient(circle, rgba(40, 167, 69, 0.3) 0%, rgba(40, 167, 69, 0) 70%);
            box-shadow: 0 0 40px rgba(40, 167, 69, 0.6);
        }

        .impact-medium {
            background: radial-gradient(circle, rgba(255, 193, 7, 0.3) 0%, rgba(255, 193, 7, 0) 70%);
            box-shadow: 0 0 40px rgba(255, 193, 7, 0.6);
        }

        .impact-low {
            background: radial-gradient(circle, rgba(220, 53, 69, 0.3) 0%, rgba(220, 53, 69, 0) 70%);
            box-shadow: 0 0 40px rgba(220, 53, 69, 0.6);
        }

        .legend h4 {
            font-size: 12px;
            color: #333;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
            font-size: 11px;
            color: #666;
        }

        .legend-icon {
            font-size: 16px;
        }

        /* Map Container */
        .map-container {
            flex: 1;
            position: relative;
            background: #e0e0e0;
            min-width: 0;
        }

        /* Map Search Bar */
        #mapSearchClear.visible {
            opacity: 1 !important;
            visibility: visible !important;
        }

        #mapSearchAutocomplete.visible {
            display: block !important;
        }

        .map-search-result {
            padding: 12px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: background 0.2s;
        }

        .map-search-result:hover {
            background: #f8f9fa;
        }

        .map-search-result:last-child {
            border-bottom: none;
        }

        #map {
            width: 100%;
            height: 100%;
            background: #a8d5e2;
        }

        /* Map Search Bar Styles */
        .map-search-container {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            width: 90%;
            max-width: 500px;
        }

        .map-search-bar {
            position: relative;
            width: 100%;
        }

        #mapSearchInput {
            width: 100%;
            padding: 14px 50px 14px 20px;
            border: none;
            border-radius: 25px;
            font-size: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            outline: none;
            transition: box-shadow 0.3s;
        }

        #mapSearchInput:focus {
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
        }

        .map-search-clear {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: #667eea;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            line-height: 1;
            transition: background 0.2s;
        }

        .map-search-clear.visible {
            display: flex;
        }

        .map-search-clear:hover {
            background: #764ba2;
        }

        #mapSearchAutocomplete {
            position: absolute;
            top: calc(100% + 5px);
            left: 0;
            right: 0;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            max-height: 300px;
            overflow-y: auto;
            display: none;
        }

        #mapSearchAutocomplete.visible {
            display: block;
        }

        .map-search-result {
            padding: 12px 20px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: background 0.2s;
        }

        .map-search-result:last-child {
            border-bottom: none;
        }

        .map-search-result:hover {
            background: #f8f9fa;
        }

        .map-search-result-name {
            font-weight: 600;
            color: #333;
            font-size: 14px;
            margin-bottom: 3px;
        }

        .map-search-result-address {
            font-size: 12px;
            color: #666;
        }

        /* Custom Marker Styles */
        .custom-marker {
            background: transparent !important;
            border: none !important;
            cursor: pointer;
            z-index: 1000 !important;
        }

        .leaflet-marker-icon.custom-marker {
            display: flex !important;
            align-items: center;
            justify-content: center;
            pointer-events: auto !important;
        }
        
        .leaflet-marker-icon {
            z-index: 1000 !important;
        }

        /* Loading Overlay */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .loading-overlay.active {
            display: flex;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Login Screen */
        .login-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            position: relative;
            overflow: hidden;
        }

        .login-screen::before {
            content: '';
            position: absolute;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 1px, transparent 1px);
            background-size: 50px 50px;
            animation: moveBackground 20s linear infinite;
        }

        @keyframes moveBackground {
            0% { transform: translate(0, 0); }
            100% { transform: translate(50px, 50px); }
        }

        .login-box {
            background: rgba(255, 255, 255, 0.98);
            padding: 50px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 450px;
            position: relative;
            z-index: 1;
            animation: slideUp 0.5s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .login-box h2 {
            color: #667eea;
            margin-bottom: 8px;
            font-size: 32px;
            font-weight: 700;
            text-align: center;
        }

        .login-box p {
            color: #666;
            margin-bottom: 35px;
            font-size: 15px;
            text-align: center;
            font-weight: 500;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            color: #333;
            margin-bottom: 10px;
            font-weight: 600;
            font-size: 14px;
        }

        .form-group input {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 15px;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
        }

        .form-group input::placeholder {
            color: #aaa;
        }

        .login-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 700;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 10px;
            position: relative;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }

        .login-btn:active {
            transform: translateY(0);
        }

        .login-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }

        .login-btn.loading::after {
            content: '';
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            width: 16px;
            height: 16px;
            border: 2px solid white;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }

        @keyframes spin {
            to { transform: translateY(-50%) rotate(360deg); }
        }

        .error-message {
            color: #dc3545;
            font-size: 14px;
            margin-top: 15px;
            padding: 12px;
            background: #ffe6e6;
            border-radius: 6px;
            border-left: 4px solid #dc3545;
            display: none;
            animation: shake 0.4s ease;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        .error-message.active {
            display: block;
        }

        .login-info {
            text-align: center;
            margin-top: 25px;
            padding-top: 25px;
            border-top: 1px solid #e0e0e0;
        }

        .login-info p {
            color: #999;
            font-size: 12px;
            margin: 5px 0;
        }

        .login-info strong {
            color: #667eea;
            font-weight: 600;
        }

        /* Custom Tooltip Styles */
        [data-tooltip] {
            position: relative;
            cursor: help;
        }

        [data-tooltip]::before {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%) translateY(-8px);
            padding: 8px 12px;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            font-size: 12px;
            line-height: 1.4;
            border-radius: 6px;
            white-space: nowrap;
            max-width: 300px;
            white-space: normal;
            text-align: center;
            pointer-events: none;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s ease, visibility 0.2s ease, transform 0.2s ease;
            z-index: 10000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        [data-tooltip]::after {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%) translateY(-2px);
            border: 6px solid transparent;
            border-top-color: rgba(0, 0, 0, 0.9);
            pointer-events: none;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s ease, visibility 0.2s ease;
            z-index: 10000;
        }

        [data-tooltip]:hover::before,
        [data-tooltip]:hover::after {
            opacity: 1;
            visibility: visible;
        }

        [data-tooltip]:hover::before {
            transform: translateX(-50%) translateY(-4px);
        }

        /* Help button tooltips - positioned to the left to avoid overflow */
        .help-btn[data-tooltip]::before {
            left: auto;
            right: 0;
            transform: translateY(-8px);
            white-space: normal;
            min-width: 250px;
            max-width: 300px;
        }

        .help-btn[data-tooltip]::after {
            left: auto;
            right: 15px;
            transform: translateY(-2px);
        }

        .help-btn[data-tooltip]:hover::before {
            transform: translateY(-4px);
        }

        /* Help Modal Styles */
        .help-modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.6);
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .help-modal-content {
            background-color: white;
            margin: 3% auto;
            padding: 0;
            border-radius: 12px;
            width: 90%;
            max-width: 800px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .help-modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px 30px;
            border-radius: 12px 12px 0 0;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .help-modal-header h2 {
            margin: 0;
            font-size: 26px;
            font-weight: 700;
        }

        .help-modal-header p {
            margin: 8px 0 0 0;
            font-size: 14px;
            opacity: 0.9;
        }

        .help-close {
            position: absolute;
            top: 20px;
            right: 25px;
            color: white;
            font-size: 32px;
            font-weight: 300;
            cursor: pointer;
            transition: all 0.3s;
            line-height: 1;
        }

        .help-close:hover {
            transform: rotate(90deg);
            opacity: 0.8;
        }

        .help-modal-body {
            padding: 30px;
        }

        .help-section {
            margin-bottom: 30px;
        }

        .help-section h3 {
            color: #667eea;
            font-size: 18px;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid #e0e0e0;
        }

        .help-formula {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            margin: 15px 0;
        }

        .help-formula code {
            font-family: 'Courier New', monospace;
            font-size: 14px;
            color: #333;
            font-weight: 600;
        }

        .help-formula p {
            margin: 8px 0 0 0;
            color: #666;
            font-size: 13px;
        }

        .help-component {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .help-component h4 {
            color: #333;
            font-size: 15px;
            margin: 0 0 10px 0;
        }

        .help-component p {
            color: #666;
            font-size: 13px;
            line-height: 1.6;
            margin: 8px 0;
        }

        .help-component ul {
            margin: 10px 0;
            padding-left: 20px;
        }

        .help-component li {
            color: #666;
            font-size: 13px;
            line-height: 1.6;
            margin-bottom: 5px;
        }

        .help-data-source {
            background: #f8f9fa;
            padding: 12px 15px;
            border-radius: 6px;
            margin-bottom: 10px;
            border-left: 3px solid #28a745;
        }

        .help-data-source strong {
            color: #333;
            font-size: 14px;
        }

        .help-data-source p {
            margin: 5px 0 0 0;
            color: #666;
            font-size: 12px;
        }

        .help-data-source a {
            color: #667eea;
            text-decoration: none;
            font-size: 11px;
        }

        .help-data-source a:hover {
            text-decoration: underline;
        }

        .help-btn {
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid currentColor;
            color: #667eea;
            cursor: pointer;
            font-size: 18px;
            padding: 6px 10px;
            border-radius: 50%;
            transition: all 0.3s;
            vertical-align: middle;
            margin-left: 8px;
            display: inline-block;
            line-height: 1;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .help-btn:hover {
            background: #667eea;
            color: white;
            transform: scale(1.2) rotate(15deg);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
        }

        .help-btn:active {
            transform: scale(1.1) rotate(15deg);
        }

        .help-insight {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            margin: 20px 0;
            font-size: 14px;
            font-weight: 500;
            text-align: center;
        }

        .help-interpretation {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }

        .help-interpretation-item {
            padding: 10px;
            border-radius: 6px;
            font-size: 12px;
            text-align: center;
        }

        .help-interpretation-item.excellent {
            background: #d4edda;
            border: 1px solid #28a745;
        }

        .help-interpretation-item.good {
            background: #d1ecf1;
            border: 1px solid #17a2b8;
        }

        .help-interpretation-item.fair {
            background: #fff3cd;
            border: 1px solid #ffc107;
        }

        .help-interpretation-item.poor {
            background: #f8d7da;
            border: 1px solid #dc3545;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }
    </style>
</head>
<body>
    <script>
        // Global variables that need to be declared early
        var map = null;
        var markers = [];
        var storeData = [];
        var rawStores = [];
        var ejvData = {};
        var ejvCache = {};
        var hoverDebounceTimer = null;
        var currentZip = '10001';
        
        // Early function declarations - will be replaced by actual implementations later
        window.searchByZip = function() { console.log('searchByZip early declaration'); };
        window.toggleCustomSearch = function(type) { console.log('toggleCustomSearch early declaration'); };
        
        // Show landing page function
        window.showLanding = function() {
            console.log('showLanding called');
            // Show landing page
            document.getElementById('landingPage').style.display = 'flex';
            // Hide all modules
            document.getElementById('userDashboardModule').style.display = 'none';
            document.getElementById('locatorModule').style.display = 'none';
            document.getElementById('compareModule').style.display = 'none';
            document.getElementById('optimizeModule').style.display = 'none';
            document.getElementById('engageModule').style.display = 'none';
            document.getElementById('competeModule').style.display = 'none';
        };
        
        // Define showModule immediately in body
        window.showModule = function(moduleName) {
            console.log('showModule called:', moduleName);
            
            try {
                // Hide landing page
                const landing = document.getElementById('landingPage');
                if (!landing) return;
                landing.style.display = 'none';
                
                // Get all module elements
                const modules = {
                    userDashboard: document.getElementById('userDashboardModule'),
                    locator: document.getElementById('locatorModule'),
                    compare: document.getElementById('compareModule'),
                    optimize: document.getElementById('optimizeModule'),
                    engage: document.getElementById('engageModule'),
                    compete: document.getElementById('competeModule')
                };
                
                // Hide all modules
                Object.values(modules).forEach(m => {
                    if (m) m.style.display = 'none';
                });
                
                // Show selected module
                const targetModule = modules[moduleName];
                if (!targetModule) return;
                
                targetModule.style.display = 'flex';
                if (moduleName === 'locator') {
                    targetModule.style.flexDirection = 'column';
                }
                
                // For locator, initialize map immediately
                if (moduleName === 'locator') {
                    setTimeout(function() {
                        try {
                            const mapContainer = document.getElementById('map');
                            if (!mapContainer || typeof L === 'undefined') return;
                            
                            if (map) map.remove();
                            
                            map = L.map('map').setView([39.8283, -98.5795], 4);
                            
                            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                                attribution: '¬© OpenStreetMap contributors',
                                maxZoom: 19
                            }).addTo(map);
                            
                            setTimeout(function() {
                                map.invalidateSize();
                                console.log('Map initialized');
                            }, 200);
                            
                        } catch (error) {
                            console.error('Map init error:', error);
                        }
                    }, 300);
                } else {
                    // For other modules, try to call their init functions
                    setTimeout(function() {
                        try {
                            if (moduleName === 'userDashboard' && typeof initUserDashboard === 'function') {
                                initUserDashboard();
                            } else if (moduleName === 'compare' && typeof initCompareModule === 'function') {
                                initCompareModule();
                            } else if (moduleName === 'optimize' && typeof initOptimizeModule === 'function') {
                                initOptimizeModule();
                            } else if (moduleName === 'engage' && typeof initEngageModule === 'function') {
                                initEngageModule();
                            }
                        } catch (error) {
                            console.error('Init error:', error);
                        }
                    }, 100);
                }
                
            } catch (error) {
                console.error('showModule error:', error);
            }
        };
    </script>
    
    <!-- Landing Page -->
    <div id="landingPage" class="landing-page">
        <div class="landing-header">
            <img src="/FIX%24%20logo.png" alt="FIX$ Logo" style="width: 140px; height: 140px; object-fit: contain; object-position: center; background: transparent; image-rendering: auto; -webkit-font-smoothing: antialiased; backface-visibility: hidden; transform: translateZ(0);" />
            <div>
                <h1>GeoEquity Impact Engine</h1>
                <div class="subtitle" style="display: block; margin-top: 5px;">Geo-Contextual Decision Intelligence System</div>
            </div>
        </div>
        <div class="landing-content">
            <div class="module-buttons">
                <button class="module-btn user-dashboard" onclick="showModule('userDashboard')">
                    <div class="icon">üë§</div>
                    <div class="title">User Dashboard</div>
                    <div class="description">View your profile and settings</div>
                </button>
                <button class="module-btn locator" onclick="showModule('locator')">
                    <div class="icon">üìç</div>
                    <div class="title">Locator</div>
                    <div class="description">Find and analyze stores</div>
                </button>
                <button class="module-btn compare" onclick="showModule('compare')">
                    <div class="icon">‚öñÔ∏è</div>
                    <div class="title">Compare</div>
                    <div class="description">Compare EJV across stores</div>
                </button>
                <button class="module-btn optimize" onclick="showModule('optimize')">
                    <div class="icon">‚ú®</div>
                    <div class="title">Optimize</div>
                    <div class="description">Get recommendations</div>
                </button>
                <button class="module-btn engage" onclick="showModule('engage')">
                    <div class="icon">ü§ù</div>
                    <div class="title">Engage</div>
                    <div class="description">Community participation</div>
                </button>
                <button class="module-btn compete" onclick="showModule('compete')">
                    <div class="icon">üèÜ</div>
                    <div class="title">Compete</div>
                    <div class="description">Coming soon</div>
                </button>
            </div>
        </div>
    </div>

    <!-- User Dashboard Module -->
    <div id="userDashboardModule" class="module-page">
        <div class="module-header">
            <button class="back-btn" onclick="showLanding()">
                <span>‚Üê</span> Back to Home
            </button>
            <h2>üë§ User Dashboard</h2>
            <button onclick="editUserProfile()" style="background: #667eea; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 12px;">
                Edit Profile
            </button>
        </div>
        <div id="dashboardContent" style="padding: 30px; overflow-y: auto; height: calc(100vh - 80px); background: #f5f7fa;">
            
            <!-- Welcome / Setup Section -->
            <div id="welcomeSection" style="display: none; max-width: 600px; margin: 100px auto; background: white; padding: 40px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); text-align: center;">
                <h2 style="color: #667eea; margin-bottom: 20px;">üëã Welcome to Your GeoEquity Dashboard!</h2>
                <p style="color: #666; margin-bottom: 30px; line-height: 1.6;">Let's personalize your experience. Tell us about yourself to start tracking your economic impact.</p>
                
                <div style="text-align: left; margin-bottom: 20px;">
                    <label style="display: block; color: #333; font-weight: 600; margin-bottom: 8px;">Your Name</label>
                    <input type="text" id="setupName" placeholder="e.g., John Doe" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                </div>
                
                <div style="text-align: left; margin-bottom: 20px;">
                    <label style="display: block; color: #333; font-weight: 600; margin-bottom: 8px;">Home ZIP Code</label>
                    <input type="text" id="setupZip" placeholder="e.g., 10001" maxlength="5" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                </div>
                
                <div style="text-align: left; margin-bottom: 30px;">
                    <label style="display: block; color: #333; font-weight: 600; margin-bottom: 8px;">Monthly Spending Goal (Optional)</label>
                    <input type="number" id="setupGoal" placeholder="e.g., 5000" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                    <small style="color: #999;">This helps track your progress</small>
                </div>
                
                <button onclick="saveUserProfile()" style="width: 100%; padding: 16px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 700;">
                    Get Started ‚Üí
                </button>
            </div>

            <!-- Main Dashboard Content -->
            <div id="mainDashboard" style="display: none;">
                
                <!-- User Greeting -->
                <div style="margin-bottom: 30px;">
                    <h1 style="color: #333; font-size: 32px; margin-bottom: 5px;">Hello, <span id="userName">User</span>! üëã</h1>
                    <p style="color: #666; font-size: 16px;">Here's your GeoEquity impact summary</p>
                </div>

                <!-- Top Score Card -->
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 40px; border-radius: 15px; box-shadow: 0 8px 30px rgba(102, 126, 234, 0.3); margin-bottom: 30px; color: white;">
                    <div style="text-align: center; margin-bottom: 20px;">
                        <div style="font-size: 14px; opacity: 0.9; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px;">Whole-Person GeoEquity Score</div>
                        <div style="display: flex; align-items: center; justify-content: center; gap: 15px;">
                            <div style="font-size: 72px; font-weight: 700;" id="geoEquityScore">-</div>
                            <div style="font-size: 24px; opacity: 0.8;">/ 100</div>
                            <div style="background: rgba(255,255,255,0.2); padding: 8px 16px; border-radius: 20px; font-size: 16px;" id="scoreTrend">--</div>
                        </div>
                        <div style="font-size: 18px; opacity: 0.85; margin-top: 10px;" id="scoreInDollars">‚âà $0 local impact</div>
                    </div>
                    <div style="text-align: center; font-size: 16px; font-style: italic; opacity: 0.95; margin-bottom: 20px;" id="scoreMessage">
                        Start logging purchases to see your impact!
                    </div>
                    <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                        <button onclick="showMethodologyModal()" style="background: rgba(255,255,255,0.2); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600;">
                            üìê View Methodology
                        </button>
                        <button onclick="logPurchaseModal()" style="background: rgba(255,255,255,0.3); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600;">
                            ‚ûï Log Purchase
                        </button>
                    </div>
                </div>

                <!-- Core Dimensions Grid -->
                <div style="margin-bottom: 30px;">
                    <h3 style="color: #333; font-size: 20px; margin-bottom: 20px;">Core Dimensions</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;">
                        
                        <!-- LOCATOR -->
                        <div style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); border-left: 4px solid #4caf50;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
                                <div>
                                    <div style="color: #666; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px;">LOCATOR</div>
                                    <div style="color: #333; font-size: 16px; font-weight: 600;">Awareness</div>
                                </div>
                                <div style="font-size: 32px;">üìç</div>
                            </div>
                            <div style="display: flex; align-items: baseline; gap: 10px; margin-bottom: 10px;">
                                <div style="font-size: 36px; font-weight: 700; color: #4caf50;" id="locatorScore">0</div>
                                <div style="font-size: 18px; color: #999;">/ 100</div>
                                <div style="background: #e8f5e9; color: #2e7d32; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600;" id="locatorTrend">--</div>
                            </div>
                            <div style="color: #666; font-size: 13px; font-style: italic;" id="locatorMessage">Search for stores to increase awareness</div>
                        </div>

                        <!-- COMPARE -->
                        <div style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); border-left: 4px solid #2196f3;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
                                <div>
                                    <div style="color: #666; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px;">COMPARE</div>
                                    <div style="color: #333; font-size: 16px; font-weight: 600;">Equity Alignment</div>
                                </div>
                                <div style="font-size: 32px;">‚öñÔ∏è</div>
                            </div>
                            <div style="display: flex; align-items: baseline; gap: 10px; margin-bottom: 10px;">
                                <div style="font-size: 36px; font-weight: 700; color: #2196f3;" id="compareScore">0</div>
                                <div style="font-size: 18px; color: #999;">/ 100</div>
                                <div style="background: #e3f2fd; color: #1565c0; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600;" id="compareTrend">--</div>
                            </div>
                            <div style="color: #666; font-size: 13px; font-style: italic;" id="compareMessage">Your avg EJV from purchases</div>
                        </div>

                        <!-- OPTIMIZE -->
                        <div style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); border-left: 4px solid #ff9800;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
                                <div>
                                    <div style="color: #666; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px;">OPTIMIZE</div>
                                    <div style="color: #333; font-size: 16px; font-weight: 600;">Action Rate</div>
                                </div>
                                <div style="font-size: 32px;">‚ú®</div>
                            </div>
                            <div style="display: flex; align-items: baseline; gap: 10px; margin-bottom: 10px;">
                                <div style="font-size: 36px; font-weight: 700; color: #ff9800;" id="optimizeScore">0</div>
                                <div style="font-size: 18px; color: #999;">/ 100</div>
                                <div style="background: #fff3e0; color: #e65100; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600;" id="optimizeTrend">--</div>
                            </div>
                            <div style="color: #666; font-size: 13px; font-style: italic;" id="optimizeMessage">Adopt suggestions to improve</div>
                        </div>

                        <!-- ENGAGE -->
                        <div style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); border-left: 4px solid #e91e63;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
                                <div>
                                    <div style="color: #666; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px;">ENGAGE</div>
                                    <div style="color: #333; font-size: 16px; font-weight: 600;">Collective Impact</div>
                                </div>
                                <div style="font-size: 32px;">ü§ù</div>
                            </div>
                            <div style="display: flex; align-items: baseline; gap: 10px; margin-bottom: 10px;">
                                <div style="font-size: 36px; font-weight: 700; color: #e91e63;" id="engageScore">0</div>
                                <div style="font-size: 18px; color: #999;">/ 100</div>
                                <div style="background: #fce4ec; color: #c2185b; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600;" id="engageTrend">--</div>
                            </div>
                            <div style="color: #666; font-size: 13px; font-style: italic;" id="engageMessage">Participate in community activities</div>
                        </div>

                    </div>
                </div>

                <!-- Two Column Layout for Spending Flow and Timeline -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 30px; margin-bottom: 30px;">
                    
                    <!-- Spending Flow -->
                    <div style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.08);">
                        <h3 style="color: #333; font-size: 18px; margin-bottom: 20px;">üí∞ Spending Flow / Retention Visual</h3>
                        <div style="margin-bottom: 15px;">
                            <div style="font-size: 13px; color: #666; margin-bottom: 5px;">Where Your Money Goes</div>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                                <span style="font-size: 13px; color: #666;">Local Retained:</span>
                                <span style="font-size: 14px; font-weight: 600; color: #4caf50;" id="localRetainedPercent">0%</span>
                            </div>
                            <div style="background: #e0e0e0; border-radius: 10px; height: 20px; overflow: hidden;">
                                <div id="localRetainedBar" style="background: linear-gradient(90deg, #4caf50, #66bb6a); height: 100%; width: 0%; transition: width 0.5s ease;"></div>
                            </div>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                                <span style="font-size: 13px; color: #666;">Regional Leak:</span>
                                <span style="font-size: 14px; font-weight: 600; color: #ff9800;" id="regionalLeakPercent">0%</span>
                            </div>
                            <div style="background: #e0e0e0; border-radius: 10px; height: 20px; overflow: hidden;">
                                <div id="regionalLeakBar" style="background: linear-gradient(90deg, #ff9800, #ffa726); height: 100%; width: 0%; transition: width 0.5s ease;"></div>
                            </div>
                        </div>
                        <div style="margin-bottom: 20px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                                <span style="font-size: 13px; color: #666;">National Leak:</span>
                                <span style="font-size: 14px; font-weight: 600; color: #f44336;" id="nationalLeakPercent">0%</span>
                            </div>
                            <div style="background: #e0e0e0; border-radius: 10px; height: 20px; overflow: hidden;">
                                <div id="nationalLeakBar" style="background: linear-gradient(90deg, #f44336, #ef5350); height: 100%; width: 0%; transition: width 0.5s ease;"></div>
                            </div>
                        </div>
                        <div style="background: #f5f7fa; padding: 12px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 12px; color: #666; margin-bottom: 3px;">Avg Distance Traveled</div>
                            <div style="font-size: 20px; font-weight: 700; color: #667eea;" id="avgDistance">0 miles</div>
                        </div>
                    </div>

                    <!-- Progress Timeline -->
                    <div style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.08);">
                        <h3 style="color: #333; font-size: 18px; margin-bottom: 20px;">üìà Your Progress Over Time</h3>
                        <div id="progressChart" style="height: 200px; display: flex; align-items: flex-end; gap: 8px; padding: 20px 10px; background: #f9fafb; border-radius: 8px; position: relative;">
                            <!-- Chart will be dynamically generated -->
                            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; color: #999;">
                                <div style="font-size: 48px; margin-bottom: 10px;">üìä</div>
                                <div style="font-size: 14px;">Log purchases to see your progress</div>
                            </div>
                        </div>
                        <div style="display: flex; justify-content: space-around; margin-top: 15px; font-size: 11px; color: #999;">
                            <span id="chartMonth1">Jan</span>
                            <span id="chartMonth2">Feb</span>
                            <span id="chartMonth3">Mar</span>
                            <span id="chartMonth4">Apr</span>
                            <span id="chartMonth5">May</span>
                            <span id="chartMonth6">Jun</span>
                        </div>
                    </div>

                </div>

                <!-- Purchase History -->
                <div style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.08);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="color: #333; font-size: 18px; margin: 0;">üõí Recent Purchases</h3>
                        <button onclick="logPurchaseModal()" style="background: #667eea; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600;">
                            ‚ûï Log Purchase
                        </button>
                    </div>
                    <div id="purchaseHistory" style="min-height: 100px;">
                        <div style="text-align: center; padding: 40px; color: #999;">
                            <div style="font-size: 48px; margin-bottom: 10px;">üßæ</div>
                            <div style="font-size: 14px;">No purchases logged yet. Start tracking your impact!</div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- Purchase Logging Modal -->
    <div id="purchaseModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 15px; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto; padding: 30px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="color: #333; font-size: 24px; margin: 0;">Log a Purchase</h2>
                <button onclick="closePurchaseModal()" style="background: none; border: none; font-size: 28px; cursor: pointer; color: #999;">&times;</button>
            </div>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; color: #333; font-weight: 600; margin-bottom: 8px;">Store Name</label>
                <input type="text" id="purchaseStoreName" placeholder="e.g., Local Grocery Co" list="storesList" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                <datalist id="storesList"></datalist>
                <small style="color: #999;">Select from recently searched stores or enter manually</small>
            </div>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; color: #333; font-weight: 600; margin-bottom: 8px;">Purchase Amount ($)</label>
                <input type="number" id="purchaseAmount" placeholder="e.g., 156.50" step="0.01" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
            </div>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; color: #333; font-weight: 600; margin-bottom: 8px;">Purchase Date</label>
                <input type="date" id="purchaseDate" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
            </div>
            
            <div style="margin-bottom: 30px;">
                <label style="display: block; color: #333; font-weight: 600; margin-bottom: 8px;">Category (Optional)</label>
                <select id="purchaseCategory" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                    <option value="">Select category...</option>
                    <option value="grocery">Grocery</option>
                    <option value="restaurant">Restaurant</option>
                    <option value="pharmacy">Pharmacy</option>
                    <option value="retail">Retail</option>
                    <option value="services">Services</option>
                    <option value="other">Other</option>
                </select>
            </div>
            
            <button onclick="savePurchase()" style="width: 100%; padding: 16px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 700;">
                Save Purchase
            </button>
        </div>
    </div>

    <!-- Locator Module -->
    <div id="locatorModule" class="module-page">
        <div class="module-header">
            <button class="back-btn" onclick="showLanding()">
                <span>‚Üê</span> Back to Home
            </button>
            <h2>üìç Locator</h2>
            <div style="width: 120px;"></div>
        </div>
        <div class="main-content">
            <!-- Sidebar -->
            <div class="sidebar">
                <!-- Instructions -->
                <div style="margin-bottom: 15px; padding: 12px; background: #e8f5e9; border-left: 4px solid #4caf50; border-radius: 5px;">
                    <p style="margin: 0; font-size: 13px; color: #2e7d32; line-height: 1.5;">
                        <strong>‚úì Smart Address Search!</strong><br>
                        <span style="font-size: 12px;">Search for a <strong>specific store address</strong> to see only that store with its EJV, or search a <strong>general location</strong> to find nearby stores.</span>
                    </p>
                </div>

                <!-- ZIP Code Search -->
                <div class="search-section">
                    <h3>üîç Search by ZIP Code</h3>
                    <div class="input-group">
                        <label>ZIP Code</label>
                        <input type="text" id="zipInput" placeholder="e.g., 10001">
                    </div>
                    <div class="input-group">
                        <label>Search Radius</label>
                        <select id="zipRadius">
                            <option value="1">1 mile</option>
                            <option value="2" selected>2 miles</option>
                            <option value="3">3 miles</option>
                            <option value="5">5 miles</option>
                            <option value="10">10 miles</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Store Category</label>
                        <select id="zipCategory" onchange="toggleCustomSearch('zip')">
                            <option value="all">üè™ All Stores & Businesses</option>
                            <option value="supermarket">üõí Supermarkets & Grocery Stores</option>
                            <option value="pharmacy">üíä Pharmacies & Drugstores</option>
                            <option value="restaurant">üçΩÔ∏è Restaurants & Fast Food</option>
                            <option value="convenience">üè™ Convenience Stores</option>
                            <option value="coffee">‚òï Coffee Shops & Cafes</option>
                            <option value="electronics">üì± Electronics Stores</option>
                            <option value="custom">‚úèÔ∏è Custom Search...</option>
                        </select>
                    </div>
                    <div class="input-group" id="zipRestaurantType" style="display: none;">
                        <label>Restaurant Type</label>
                        <select id="zipRestaurantTypeSelect">
                            <option value="all">All Restaurant Types</option>
                            <option value="italian">üáÆüáπ Italian</option>
                            <option value="chinese">ü•° Chinese</option>
                            <option value="mexican">üåÆ Mexican</option>
                            <option value="japanese">üç£ Japanese / Sushi</option>
                            <option value="indian">üçõ Indian</option>
                            <option value="thai">üçú Thai</option>
                            <option value="american">üçî American</option>
                            <option value="pizza">üçï Pizza</option>
                            <option value="fast_food">‚ö° Fast Food</option>
                            <option value="cafe">‚òï Cafe</option>
                            <option value="seafood">ü¶û Seafood</option>
                            <option value="steakhouse">ü•© Steakhouse</option>
                            <option value="vegetarian">ü•ó Vegetarian / Vegan</option>
                        </select>
                        <small style="color: #666; font-size: 11px;">Filter by cuisine or restaurant type</small>
                    </div>
                    <div class="input-group" id="zipCustomSearch" style="display: none;">
                        <label>Custom Business Type</label>
                        <input type="text" id="zipCustomInput" placeholder="e.g., bookstore, gym, salon">
                        <small style="color: #666; font-size: 11px;">Enter any business type to search</small>
                    </div>
                    <button class="search-btn" onclick="searchByZip()">Search ZIP</button>
                    
                    <!-- Near Me Button -->
                    <div style="margin-top: 12px; padding: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 8px; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);">
                        <div class="input-group" style="margin-bottom: 10px;">
                            <label style="color: white; font-weight: 600;">Store Type</label>
                            <select id="nearMeCategory" onchange="handleNearMeCategoryChange()" style="background: white; color: #333; border: 1px solid #ddd; padding: 8px; border-radius: 6px; width: 100%;">
                                <option value="all">üè™ All Stores</option>
                                <option value="supermarket" selected>üõí Grocery / Supermarket</option>
                                <option value="convenience">üè™ Convenience Store</option>
                                <option value="restaurant">üçΩÔ∏è Restaurant</option>
                                <option value="coffee">‚òï Coffee Shop</option>
                                <option value="pharmacy">üíä Pharmacy</option>
                                <option value="electronics">üì± Electronics</option>
                            </select>
                        </div>
                        <div class="input-group" id="nearMeRestaurantType" style="display: none; margin-bottom: 10px;">
                            <label style="color: white; font-weight: 600;">Restaurant Type</label>
                            <select id="nearMeRestaurantTypeSelect" style="background: white; color: #333; border: 1px solid #ddd; padding: 8px; border-radius: 6px; width: 100%;">
                                <option value="all">All Restaurants</option>
                                <option value="american">üçî American</option>
                                <option value="mexican">üåÆ Mexican</option>
                                <option value="italian">üçù Italian</option>
                                <option value="chinese">ü•° Chinese</option>
                                <option value="japanese">üç± Japanese</option>
                                <option value="indian">üçõ Indian</option>
                                <option value="thai">üçú Thai</option>
                                <option value="vietnamese">ü•¢ Vietnamese</option>
                                <option value="pizza">üçï Pizza</option>
                                <option value="seafood">ü¶û Seafood</option>
                                <option value="steakhouse">ü•© Steakhouse</option>
                                <option value="vegetarian">ü•ó Vegetarian / Vegan</option>
                            </select>
                        </div>
                        <div class="input-group" style="margin-bottom: 10px;">
                            <label style="color: white; font-weight: 600;">Search Radius</label>
                            <select id="nearMeRadius" style="background: white; color: #333; border: 1px solid #ddd; padding: 8px; border-radius: 6px; width: 100%;">
                                <option value="0.5">0.5 mile</option>
                                <option value="1">1 mile</option>
                                <option value="2" selected>2 miles</option>
                                <option value="3">3 miles</option>
                                <option value="5">5 miles</option>
                            </select>
                        </div>
                        <button 
                            class="search-btn" 
                            onclick="searchNearMe()" 
                            style="background: white; color: #667eea; font-weight: 700; width: 100%; display: flex; align-items: center; justify-content: center; gap: 8px;"
                            onmouseover="this.style.background='#f0f0f0'"
                            onmouseout="this.style.background='white'"
                        >
                            <span style="font-size: 18px;">üìç</span>
                            <span>Find Stores Near Me</span>
                        </button>
                        <div style="margin-top: 8px; font-size: 11px; color: white; text-align: center; line-height: 1.5;">
                            ‚ú® Uses your location to find nearby stores & calculate EJV 4.1
                        </div>
                    </div>
                </div>

                <!-- Store Name Search with Google Maps -->
                <div class="search-section">
                    <h3>üè™ Search by Store Name</h3>
                    <div class="input-group">
                        <label>Store Name</label>
                        <input type="text" id="storeNameInput" placeholder="e.g., Walmart, Kroger, Target">
                    </div>
                    <div class="input-group">
                        <label>Location (City, State, or Address)</label>
                        <input type="text" id="storeLocationInput" placeholder="e.g., Huntsville, AL">
                    </div>
                    <div class="input-group">
                        <label>Search Radius</label>
                        <select id="storeNameRadius">
                            <option value="1">1 mile</option>
                            <option value="2">2 miles</option>
                            <option value="3">3 miles</option>
                            <option value="5" selected>5 miles</option>
                            <option value="10">10 miles</option>
                        </select>
                    </div>
                    <div class="input-group" style="margin-bottom: 10px;">
                        <label>Google API Key (Optional)</label>
                        <input type="text" id="googleApiKey" placeholder="Optional - for Google Places API">
                        <small style="color: #666; font-size: 11px; display: block; margin-top: 3px;">Leave blank to use free OpenStreetMap search, or enter key for Google Places</small>
                    </div>
                    <button class="search-btn" onclick="searchByStoreName()" style="margin-bottom: 8px;">üîç Search Stores</button>
                    <button class="search-btn" onclick="searchOnGoogleMaps()" style="background: #4285f4;">üó∫Ô∏è Open in Google Maps</button>
                </div>

                <!-- Locator Loop -->
                <div class="dashboard-panel" id="decisionLoop" style="margin: 0 auto; max-width: 340px;">
                    <div class="dashboard-header">
                        <h3 style="text-align: center;">üîÑ Locator Loop</h3>
                    </div>
                    <div style="font-size: 11px; color: #666; line-height: 1.6;">
                        <div class="decision-step" data-mode="compare" onclick="setDecisionMode('compare')" style="background: white; padding: 10px; border-radius: 6px; margin-bottom: 8px; border-left: 3px solid #28a745; cursor: pointer;" data-tooltip="Compare economic justice values across multiple stores side-by-side">
                            <strong style="color: #28a745;">‚öñÔ∏è BENCHMARK</strong><br>
                            Compare EJV scores across different stores
                        </div>
                        <div class="decision-step" data-mode="optimize" onclick="setDecisionMode('optimize')" style="background: white; padding: 10px; border-radius: 6px; margin-bottom: 8px; border-left: 3px solid #ffc107; cursor: pointer;" data-tooltip="Get AI-powered recommendations for stores with highest local impact">
                            <strong style="color: #ffc107;">‚ú® SURFACE OPPORTUNITIES</strong><br>
                            Get recommendations for best and least impact stores
                        </div>
                        <button onclick="openQuickLogFromLocator()" style="width: 100%; padding: 12px; background: linear-gradient(135deg, #4caf50 0%, #66bb6a 100%); color: white; border: none; border-radius: 8px; font-size: 13px; font-weight: 700; cursor: pointer; margin-top: 8px; box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);">
                            üí∞ Log Purchase
                        </button>
                    </div>
                    <div id="modeDisplay" style="margin-top: 10px; padding: 10px; background: #e3f2fd; border-radius: 6px; font-size: 11px; display: none;">
                        <strong id="currentMode" style="color: #667eea;">Current Mode: Benchmark</strong>
                    </div>
                </div>

                <!-- AI Assistant Panel -->
                <div class="dashboard-panel" id="aiAssistantPanel" style="margin: 15px auto 0 auto; max-width: 340px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 10px; padding: 15px; box-shadow: 0 4px 20px rgba(102, 126, 234, 0.3);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <h3 style="color: white; font-size: 14px; margin: 0; display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 20px;">ü§ñ</span>
                            AI Assistant
                        </h3>
                        <button id="toggleAssistant" onclick="toggleAIAssistant()" style="background: rgba(255,255,255,0.2); color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 12px; font-weight: 600;">
                            Minimize
                        </button>
                    </div>
                    
                    <div id="aiAssistantContent">
                        <!-- Provider Selection -->
                        <div style="margin-bottom: 10px;">
                            <select id="aiProvider" style="width: 100%; padding: 8px; border: none; border-radius: 6px; font-size: 12px; font-weight: 600; color: #667eea; cursor: pointer;">
                                <option value="openai">üåü ChatGPT (OpenAI)</option>
                                <option value="claude">üß† Claude (Anthropic)</option>
                            </select>
                        </div>
                        
                        <!-- Chat Messages -->
                        <div id="aiChatMessages" style="background: white; border-radius: 8px; padding: 10px; min-height: 120px; max-height: 200px; overflow-y: auto; margin-bottom: 10px; font-size: 12px;">
                            <div style="color: #999; font-style: italic; text-align: center; padding: 20px 10px; line-height: 1.5;">
                                üëã Hi! I'm your AI assistant.<br>
                                Ask me about EJV scores, store comparisons, or economic impact!
                            </div>
                        </div>
                        
                        <!-- Input Area -->
                        <div style="display: flex; gap: 8px;">
                            <input 
                                type="text" 
                                id="aiUserInput" 
                                placeholder="Ask about stores, EJV scores..."
                                style="flex: 1; padding: 10px; border: none; border-radius: 6px; font-size: 12px;"
                                onkeypress="if(event.key==='Enter') sendAIMessage()"
                            >
                            <button 
                                onclick="sendAIMessage()" 
                                style="background: white; color: #667eea; border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer; font-weight: 700; font-size: 14px;"
                            >
                                Send
                            </button>
                        </div>
                        
                        <!-- Quick Actions -->
                        <div style="margin-top: 10px; display: flex; flex-wrap: wrap; gap: 5px;">
                            <button onclick="askAI('What is EJV and how is it calculated?')" style="background: rgba(255,255,255,0.2); color: white; border: none; padding: 6px 10px; border-radius: 15px; cursor: pointer; font-size: 10px; font-weight: 600;">
                                ‚ÑπÔ∏è Explain EJV
                            </button>
                            <button onclick="askAI('Compare the stores currently visible on the map')" style="background: rgba(255,255,255,0.2); color: white; border: none; padding: 6px 10px; border-radius: 15px; cursor: pointer; font-size: 10px; font-weight: 600;">
                                ‚öñÔ∏è Compare Stores
                            </button>
                            <button onclick="askAI('Which store has the best local impact?')" style="background: rgba(255,255,255,0.2); color: white; border: none; padding: 6px 10px; border-radius: 15px; cursor: pointer; font-size: 10px; font-weight: 600;">
                                üåü Best Store
                            </button>
                        </div>
                        
                        <!-- Status Indicator -->
                        <div id="aiStatus" style="margin-top: 8px; font-size: 10px; color: rgba(255,255,255,0.8); text-align: center; display: none;">
                            <span id="aiStatusText">Thinking...</span>
                        </div>
                    </div>
                </div>

                <!-- Results -->
                <div class="results">
                    <h4>Search Results</h4>
                    <div class="result-text" id="resultText">Enter a ZIP code to search for stores</div>
                    <div class="store-list" id="storeList"></div>
                </div>
            </div>

            <!-- Map -->
            <div class="map-container">
                <div id="map"></div>
                
                <div class="loading-overlay" id="loadingOverlay">
                    <div class="spinner"></div>
                </div>
                
                <!-- Right Side Dashboard -->
                <div id="rightDashboard" style="position: absolute; top: 20px; right: 20px; width: 450px; background: white; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); padding: 20px; max-height: calc(100vh - 200px); overflow-y: auto; display: block; z-index: 1000;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #667eea;">
                        <h3 style="color: #667eea; font-size: 16px; margin: 0;">üìä EJV Dashboard</h3>
                        <button onclick="closeRightDashboard()" style="background: none; border: none; font-size: 20px; cursor: pointer; color: #999;">&times;</button>
                    </div>
                    
                    <div id="storeInfoHeader" style="background: #f8f9fa; padding: 10px; border-radius: 6px; margin-bottom: 12px; font-size: 12px;">
                        <strong id="storeNameDisplay" style="color: #333;">Hover over a store to see details</strong><br>
                        <small id="storeLocationDisplay" style="color: #666;">Search for stores using ZIP code in left sidebar</small>
                    </div>
                    
                    <div id="mainMetricsGrid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 12px;">
                        <div style="background: linear-gradient(135deg, #f0f4ff 0%, #e0e7ff 100%); padding: 10px; border-radius: 6px; text-align: center; border: 2px solid #667eea; position: relative;">
                            <div style="position: absolute; top: 5px; left: 5px; background: #4caf50; color: white; padding: 2px 6px; border-radius: 10px; font-size: 7px; font-weight: 700;">üìä PROGRAMMATIC</div>
                            <div id="ejvV41ProgDisplay" style="font-size: 20px; font-weight: 700; color: #667eea;">-</div>
                            <div style="font-size: 9px; color: #4c51bf; margin-top: 2px; text-transform: uppercase; font-weight: 600;">
                                EJV 4.1 (6 Components)
                            </div>
                            <div style="font-size: 7px; color: #888; margin-top: 2px;">0-100 Scale | Real Data APIs</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #f0f4ff 0%, #e0e7ff 100%); padding: 10px; border-radius: 6px; text-align: center; border: 2px solid #ff9800; position: relative;">
                            <div style="position: absolute; top: 5px; left: 5px; background: #ff9800; color: white; padding: 2px 6px; border-radius: 10px; font-size: 7px; font-weight: 700;">ü§ñ AI-ASSISTED</div>
                            <div id="ejvV41AIDisplay" style="font-size: 20px; font-weight: 700; color: #ff9800;">-</div>
                            <div style="font-size: 9px; color: #ff9800; margin-top: 2px; text-transform: uppercase; font-weight: 600;">
                                EJV 4.1 (AI Estimate)
                            </div>
                            <div style="font-size: 7px; color: #888; margin-top: 2px;">AI-Assisted Value</div>
                            <button class="help-btn" onclick="showHelpModal('v4.1')" data-tooltip="EJV 4.1 = (LC+W+DN+EQ+ENV+PROC)/6 | AI-estimated from industry patterns" style="position: absolute; top: 5px; right: 5px; z-index: 10;">‚ùì</button>
                        </div>
                    </div>
                    
                    <div id="engageMetricsGrid" style="display: none; grid-template-columns: 1fr; gap: 8px; margin-bottom: 12px;">
                        <div style="background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); padding: 10px; border-radius: 6px; text-align: center; border: 2px solid #4caf50; position: relative;">
                            <div id="ejvV42Display" style="font-size: 20px; font-weight: 700; color: #2e7d32;">-</div>
                            <div style="font-size: 9px; color: #1b5e20; margin-top: 2px; text-transform: uppercase; font-weight: 600;">
                                EJV v4.2 (Participation)
                            </div>
                            <button class="help-btn" onclick="showHelpModal('v4.2')" data-tooltip="Learn about EJV v4.2 - Participation Amplification - Click for details" style="position: absolute; top: 6px; right: 6px;">‚ùì</button>
                        </div>
                    </div>
                    
                    <div id="participationPanel" style="background: #fff3e0; padding: 12px; border-radius: 6px; margin-bottom: 12px; border-left: 4px solid #ff9800; display: none;">
                        <div style="font-size: 11px; font-weight: 600; color: #e65100; margin-bottom: 8px;">ü§ù Participation Amplification</div>
                        <div style="display: flex; justify-content: space-between; padding: 5px 0; font-size: 10px;">
                            <span style="color: #666;">PAF (Amplification Factor)</span>
                            <span id="pafDisplay" style="font-weight: 700; color: #ff6f00;">1.00√ó</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 5px 0; font-size: 10px; border-top: 1px solid #ffe0b2; padding-top: 5px; margin-top: 5px;">
                            <span style="color: #666;">Amplification Value</span>
                            <span id="ampValueDisplay" style="font-weight: 700; color: #4caf50;">$0.00</span>
                        </div>
                        <div id="participationActivities" style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #ffe0b2; font-size: 9px; color: #666;"></div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 12px;">
                        <div style="background: #f8f9fa; padding: 10px; border-radius: 6px; text-align: center; border-left: 3px solid #28a745;">
                            <div id="wealthRetained" style="font-size: 16px; font-weight: 700; color: #28a745;">0%</div>
                            <div style="font-size: 9px; color: #666; margin-top: 3px; cursor: help;" data-tooltip="Percentage of purchase value that stays in the local economy through wages, suppliers, and taxes">Estimated Local Retention (%)</div>
                        </div>
                        <div style="background: #f8f9fa; padding: 10px; border-radius: 6px; text-align: center; border-left: 3px solid #dc3545;">
                            <div id="wealthLeakage" style="font-size: 16px; font-weight: 700; color: #dc3545;">0%</div>
                            <div style="font-size: 9px; color: #666; margin-top: 3px; cursor: help;" data-tooltip="Percentage of purchase value that leaves the local economy to external suppliers, headquarters, and investors">Estimated Leakage (%)</div>
                        </div>
                    </div>
                    
                    <div id="scoreBreakdown" style="background: linear-gradient(135deg, #f0f4ff 0%, #e8f5e9 100%); padding: 12px; border-radius: 8px; margin-bottom: 12px; border: 2px solid #667eea;">
                        <div style="font-size: 12px; font-weight: 700; color: #667eea; margin-bottom: 10px; text-align: center;">üåü EJV 4.1 Components (0-100)</div>
                        <div style="display: flex; justify-content: space-between; padding: 6px 0; font-size: 10px; border-bottom: 1px solid #ddd;">
                            <span style="color: #666; font-weight: 600;" title="Local Circulation - money staying local through wages & procurement">üèòÔ∏è LC (Local Circulation)</span>
                            <span id="communityScore" style="font-weight: 700; color: #667eea; font-size: 12px;">-</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 6px 0; font-size: 10px; border-bottom: 1px solid #ddd;">
                            <span style="color: #666; font-weight: 600;" title="Fair Wages - workers earning living wage">üíµ W (Fair Wages)</span>
                            <span id="wageScore" style="font-weight: 700; color: #667eea; font-size: 12px;">-</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 6px 0; font-size: 10px; border-bottom: 1px solid #ddd;">
                            <span style="color: #666; font-weight: 600;" title="Community Need - serving high-need areas (poverty, unemployment)">üè• DN (Community Need)</span>
                            <span id="affordabilityScore" style="font-weight: 700; color: #667eea; font-size: 12px;">-</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 6px 0; font-size: 10px; border-bottom: 1px solid #ddd;">
                            <span style="color: #666; font-weight: 600;" title="Equity & Inclusion - diversity, nondiscrimination, leadership">‚öñÔ∏è EQ (Equity & Inclusion)</span>
                            <span id="hiringScore" style="font-weight: 700; color: #667eea; font-size: 12px;">-</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 6px 0; font-size: 10px; border-bottom: 1px solid #ddd;">
                            <span style="color: #666; font-weight: 600;" title="Environmental - renewable energy, recycling, sustainability">üå± ENV (Environmental)</span>
                            <span id="dashboardParticipationScore" style="font-weight: 700; color: #667eea; font-size: 12px;">-</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 6px 0; font-size: 10px;">
                            <span style="color: #666; font-weight: 600;" title="Procurement - ethical & sustainable purchasing">üõí PROC (Procurement)</span>
                            <span id="procurementScore" style="font-weight: 700; color: #667eea; font-size: 12px;">-</span>
                        </div>
                    </div>
                    
                    <div id="formulaDisplay" style="background: #fffef0; padding: 12px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid #ff9800;">
                        <strong style="color: #e65100; font-size: 11px;">üìê EJV Formulas:</strong>
                        
                        <div style="margin-top: 8px; padding: 8px; background: #f0f4ff; border-radius: 4px; border-left: 3px solid #667eea;">
                            <div style="font-size: 9px; color: #4c51bf; font-weight: 600; margin-bottom: 3px;">üåü EJV 4.1 (6-Component Equal Weight):</div>
                            <div id="formulaText" style="color: #333; margin-top: 3px; font-family: monospace; font-size: 9px; font-weight: 600;">EJV 4.1 = (LC + W + DN + EQ + ENV + PROC) / 6</div>
                            <div style="color: #888; margin-top: 3px; font-size: 7px; line-height: 1.4;">Each = 16.67% | Scale: 0-100</div>
                        </div>
                        
                        <div style="margin-top: 6px; padding: 8px; background: #f3e5f5; border-radius: 4px; border-left: 3px solid #9c27b0;">
                            <div style="font-size: 9px; color: #7b1fa2; font-weight: 600; margin-bottom: 3px;">üìä EJV 4.0 (5-Component Weighted):</div>
                            <div style="color: #333; margin-top: 3px; font-family: monospace; font-size: 9px; font-weight: 600;">EJV 4.0 = 0.25W + 0.15P + 0.30L + 0.15A + 0.15E</div>
                            <div style="color: #888; margin-top: 3px; font-size: 7px; line-height: 1.4;">W(25%) | P(15%) | L(30%) | A(15%) | E(15%)</div>
                        </div>
                    </div>
                    
                    <div id="dataSourcesDisplay" style="background: #f0f9ff; padding: 12px; border-radius: 8px; font-size: 9px; border-left: 4px solid #0288d1;">
                        <strong style="color: #01579b; font-size: 11px;">üìä Data Sources:</strong>
                        <ul id="dataSourcesList" style="margin: 8px 0 0 15px; padding: 0; color: #666; line-height: 1.6;"></ul>
                    </div>
                </div>
                
                <!-- Legend -->
                <div class="legend">
                    <h4>Store Categories</h4>
                    <div class="legend-item">
                        <span class="legend-icon">üõí</span>
                        <span>Supermarket</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-icon">üè¢</span>
                        <span>Warehouse Club</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-icon">üíä</span>
                        <span>Pharmacy</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-icon">üçΩÔ∏è</span>
                        <span>Restaurant</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-icon">üè™</span>
                        <span>Convenience</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-icon">üè¨</span>
                        <span>Other Stores</span>
                    </div>
                    <hr style="margin: 10px 0; border: none; border-top: 1px solid #e0e0e0;">
                    <!-- Updated Legend: 4-tier Economic Justice Impact -->
                    <h4 style="margin-top: 10px;">Economic Justice Impact</h4>
                    <div class="legend-item">
                        <span style="display: inline-block; width: 14px; height: 14px; background: linear-gradient(135deg, #c8e6c9, #a5d6a7); border: 1px solid #4caf50; border-radius: 3px; margin-right: 5px;"></span>
                        <span style="font-size: 10px; font-weight: 600; color: #1b5e20;">üåü Excellent (75-100)</span>
                    </div>
                    <div class="legend-item">
                        <span style="display: inline-block; width: 14px; height: 14px; background: linear-gradient(135deg, #b3e5fc, #81d4fa); border: 1px solid #03a9f4; border-radius: 3px; margin-right: 5px;"></span>
                        <span style="font-size: 10px; font-weight: 600; color: #01579b;">üëç Good (50-74)</span>
                    </div>
                    <div class="legend-item">
                        <span style="display: inline-block; width: 14px; height: 14px; background: linear-gradient(135deg, #ffe0b2, #ffcc80); border: 1px solid #ff9800; border-radius: 3px; margin-right: 5px;"></span>
                        <span style="font-size: 10px; font-weight: 600; color: #e65100;">‚ö†Ô∏è Fair (25-49)</span>
                    </div>
                    <div class="legend-item">
                        <span style="display: inline-block; width: 14px; height: 14px; background: linear-gradient(135deg, #ffcdd2, #ef9a9a); border: 1px solid #f44336; border-radius: 3px; margin-right: 5px;"></span>
                        <span style="font-size: 10px; font-weight: 600; color: #b71c1c;">‚ö° Poor (0-24)</span>
                    </div>
                    <div style="font-size: 9px; color: #666; margin-top: 5px; font-style: italic;">
                        Hover over stores to see impact grid
                    </div>
                    <hr style="margin: 10px 0; border: none; border-top: 1px solid #e0e0e0;">
                    <!-- Health Score Legend -->
                    <h4 style="margin-top: 10px;">Health Inspection Grades</h4>
                    <div class="legend-item">
                        <span style="display: inline-block; width: 20px; height: 20px; background: #28a745; color: white; font-weight: bold; text-align: center; line-height: 20px; border-radius: 3px; margin-right: 5px; font-size: 12px;">A</span>
                        <span style="font-size: 10px; color: #1b5e20;">0-13 points (Excellent)</span>
                    </div>
                    <div class="legend-item">
                        <span style="display: inline-block; width: 20px; height: 20px; background: #ffc107; color: white; font-weight: bold; text-align: center; line-height: 20px; border-radius: 3px; margin-right: 5px; font-size: 12px;">B</span>
                        <span style="font-size: 10px; color: #e65100;">14-27 points (Good)</span>
                    </div>
                    <div class="legend-item">
                        <span style="display: inline-block; width: 20px; height: 20px; background: #ff6b6b; color: white; font-weight: bold; text-align: center; line-height: 20px; border-radius: 3px; margin-right: 5px; font-size: 12px;">C</span>
                        <span style="font-size: 10px; color: #b71c1c;">28+ points (Needs work)</span>
                    </div>
                    <div style="font-size: 9px; color: #666; margin-top: 5px; font-style: italic;">
                        ‚ö†Ô∏è Lower points = Better<br>
                        üìç Coverage: NYC, SF, LA, Chicago
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Compare Module -->
    <div id="compareModule" class="module-page">
        <div class="module-header">
            <button class="back-btn" onclick="showLanding()">
                <span>‚Üê</span> Back to Home
            </button>
            <h2>‚öñÔ∏è Compare</h2>
            <div style="width: 120px;"></div>
        </div>
        <div style="padding: 40px; overflow-y: auto; height: calc(100vh - 80px); background: #f5f7fa;">
            
            <!-- Page Title Section -->
            <div style="max-width: 1200px; margin: 0 auto 40px;">
                <div style="background: white; padding: 40px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); border: 2px dashed #2196f3;">
                    <h1 style="color: #2196f3; text-align: center; font-size: 32px; margin-bottom: 20px;">
                        Compare Two Distinct Transactions for Economic Justice Value
                    </h1>
                    <div style="text-align: center; margin-bottom: 20px;">
                        <div style="font-size: 20px; font-weight: 600; color: #333; margin-bottom: 10px;">
                            COMPARE ‚Äî Choice Evaluation (Post Choice)
                        </div>
                        <div style="font-size: 16px; color: #666; margin-bottom: 20px;">
                            Powered by: EJV v4.1
                        </div>
                        <div style="font-size: 16px; font-weight: 600; color: #2196f3; margin-bottom: 15px;">
                            Purpose
                        </div>
                        <ul style="text-align: left; display: inline-block; color: #555; font-size: 15px; line-height: 1.8;">
                            <li>Evaluates selected choices against alternatives</li>
                            <li>Uses actual user behavior</li>
                        </ul>
                        <div style="margin-top: 20px; padding: 15px; background: #e3f2fd; border-radius: 8px; font-style: italic; color: #1565c0;">
                            <strong>Example insight:</strong><br>
                            "This choice generated 22% more justice weighted impact than the nearest alternative."
                        </div>
                    </div>
                </div>
            </div>

            <!-- Comparison Selection Section -->
            <div style="max-width: 1200px; margin: 0 auto 30px;">
                <h2 style="color: #333; font-size: 24px; margin-bottom: 20px; text-align: center;">
                    Select Two Stores to Compare
                </h2>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px;">
                    
                    <!-- Store A Selection -->
                    <div style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); border-left: 4px solid #4caf50;">
                        <h3 style="color: #4caf50; font-size: 20px; margin-bottom: 15px;">üìç Store A (Your Choice)</h3>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; color: #666; font-size: 13px; margin-bottom: 8px; font-weight: 600;">Select from Recent Searches or Purchases</label>
                            <select id="storeASelect" onchange="loadStoreA()" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; background: white;">
                                <option value="">-- Select Store A --</option>
                            </select>
                        </div>
                        <div style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px; min-height: 100px;" id="storeADetails">
                            <div style="text-align: center; color: #999; padding: 20px;">
                                Select a store to see details
                            </div>
                        </div>
                    </div>

                    <!-- Store B Selection -->
                    <div style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); border-left: 4px solid #f44336;">
                        <h3 style="color: #f44336; font-size: 20px; margin-bottom: 15px;">üìç Store B (Alternative)</h3>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; color: #666; font-size: 13px; margin-bottom: 8px; font-weight: 600;">Select from Recent Searches or Purchases</label>
                            <select id="storeBSelect" onchange="loadStoreB()" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; background: white;">
                                <option value="">-- Select Store B --</option>
                            </select>
                        </div>
                        <div style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px; min-height: 100px;" id="storeBDetails">
                            <div style="text-align: center; color: #999; padding: 20px;">
                                Select a store to see details
                            </div>
                        </div>
                    </div>

                </div>

                <!-- Compare Button -->
                <div style="text-align: center; margin-bottom: 30px;">
                    <button onclick="compareStores()" style="padding: 16px 48px; background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%); color: white; border: none; border-radius: 8px; font-size: 18px; font-weight: 700; cursor: pointer; box-shadow: 0 4px 15px rgba(33, 150, 243, 0.3);">
                        ‚öñÔ∏è Compare Stores
                    </button>
                </div>
            </div>

            <!-- Comparison Results Section -->
            <div id="comparisonResults" style="display: none; max-width: 1200px; margin: 0 auto;">
                
                <!-- Winner Banner -->
                <div id="winnerBanner" style="background: linear-gradient(135deg, #4caf50 0%, #66bb6a 100%); padding: 30px; border-radius: 15px; box-shadow: 0 8px 30px rgba(76, 175, 80, 0.3); margin-bottom: 30px; color: white; text-align: center;">
                    <div style="font-size: 48px; margin-bottom: 10px;">üèÜ</div>
                    <div style="font-size: 24px; font-weight: 700; margin-bottom: 10px;" id="winnerName">Store A</div>
                    <div style="font-size: 32px; font-weight: 700; margin-bottom: 10px;" id="winnerMessage">
                        generates 22% more justice weighted impact
                    </div>
                    <div style="font-size: 18px; opacity: 0.95;">than the alternative</div>
                </div>

                <!-- Detailed Comparison Grid -->
                <div style="background: white; padding: 30px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); margin-bottom: 30px;">
                    <h3 style="color: #333; font-size: 20px; margin-bottom: 20px; text-align: center;">Detailed EJV Comparison</h3>
                    
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: #f5f7fa;">
                                <th style="padding: 15px; text-align: left; border-bottom: 2px solid #e0e0e0; font-weight: 600; color: #666;">Metric</th>
                                <th style="padding: 15px; text-align: center; border-bottom: 2px solid #e0e0e0; font-weight: 600; color: #4caf50;">Store A</th>
                                <th style="padding: 15px; text-align: center; border-bottom: 2px solid #e0e0e0; font-weight: 600; color: #f44336;">Store B</th>
                                <th style="padding: 15px; text-align: center; border-bottom: 2px solid #e0e0e0; font-weight: 600; color: #2196f3;">Difference</th>
                            </tr>
                        </thead>
                        <tbody id="comparisonTableBody">
                            <!-- Populated dynamically -->
                        </tbody>
                    </table>
                </div>

                <!-- Component Scores Comparison -->
                <div style="background: white; padding: 30px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); margin-bottom: 30px;">
                    <h3 style="color: #333; font-size: 20px; margin-bottom: 20px; text-align: center;">EJV 4.1 Component Scores (0-100)</h3>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                        
                        <!-- LC: Local Circulation -->
                        <div style="padding: 20px; background: #f8f9fa; border-radius: 8px;">
                            <div style="font-size: 14px; color: #666; margin-bottom: 10px; font-weight: 600;">üîÑ LC: Local Circulation</div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                <span style="color: #4caf50; font-weight: 600;">Store A:</span>
                                <span id="lcA" style="font-size: 18px; font-weight: 700; color: #4caf50;">-</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: #f44336; font-weight: 600;">Store B:</span>
                                <span id="lcB" style="font-size: 18px; font-weight: 700; color: #f44336;">-</span>
                            </div>
                        </div>

                        <!-- W: Fair Wages -->
                        <div style="padding: 20px; background: #f8f9fa; border-radius: 8px;">
                            <div style="font-size: 14px; color: #666; margin-bottom: 10px; font-weight: 600;">üí∞ W: Fair Wages</div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                <span style="color: #4caf50; font-weight: 600;">Store A:</span>
                                <span id="wA" style="font-size: 18px; font-weight: 700; color: #4caf50;">-</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: #f44336; font-weight: 600;">Store B:</span>
                                <span id="wB" style="font-size: 18px; font-weight: 700; color: #f44336;">-</span>
                            </div>
                        </div>

                        <!-- DN: Community Need -->
                        <div style="padding: 20px; background: #f8f9fa; border-radius: 8px;">
                            <div style="font-size: 14px; color: #666; margin-bottom: 10px; font-weight: 600;">üèòÔ∏è DN: Community Need</div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                <span style="color: #4caf50; font-weight: 600;">Store A:</span>
                                <span id="dnA" style="font-size: 18px; font-weight: 700; color: #4caf50;">-</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: #f44336; font-weight: 600;">Store B:</span>
                                <span id="dnB" style="font-size: 18px; font-weight: 700; color: #f44336;">-</span>
                            </div>
                        </div>

                        <!-- EQ: Equity & Inclusion -->
                        <div style="padding: 20px; background: #f8f9fa; border-radius: 8px;">
                            <div style="font-size: 14px; color: #666; margin-bottom: 10px; font-weight: 600;">‚öñÔ∏è EQ: Equity & Inclusion</div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                <span style="color: #4caf50; font-weight: 600;">Store A:</span>
                                <span id="eqA" style="font-size: 18px; font-weight: 700; color: #4caf50;">-</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: #f44336; font-weight: 600;">Store B:</span>
                                <span id="eqB" style="font-size: 18px; font-weight: 700; color: #f44336;">-</span>
                            </div>
                        </div>

                        <!-- ENV: Environmental -->
                        <div style="padding: 20px; background: #f8f9fa; border-radius: 8px;">
                            <div style="font-size: 14px; color: #666; margin-bottom: 10px; font-weight: 600;">üå± ENV: Environmental</div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                <span style="color: #4caf50; font-weight: 600;">Store A:</span>
                                <span id="envA" style="font-size: 18px; font-weight: 700; color: #4caf50;">-</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: #f44336; font-weight: 600;">Store B:</span>
                                <span id="envB" style="font-size: 18px; font-weight: 700; color: #f44336;">-</span>
                            </div>
                        </div>

                        <!-- PROC: Procurement -->
                        <div style="padding: 20px; background: #f8f9fa; border-radius: 8px;">
                            <div style="font-size: 14px; color: #666; margin-bottom: 10px; font-weight: 600;">üì¶ PROC: Procurement</div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                <span style="color: #4caf50; font-weight: 600;">Store A:</span>
                                <span id="procA" style="font-size: 18px; font-weight: 700; color: #4caf50;">-</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: #f44336; font-weight: 600;">Store B:</span>
                                <span id="procB" style="font-size: 18px; font-weight: 700; color: #f44336;">-</span>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- Recommendation -->
                <div id="recommendation" style="background: white; padding: 30px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); border-left: 4px solid #2196f3;">
                    <h3 style="color: #2196f3; font-size: 20px; margin-bottom: 15px;">üí° Recommendation</h3>
                    <div id="recommendationText" style="color: #555; font-size: 16px; line-height: 1.6;">
                        <!-- Populated dynamically -->
                    </div>
                </div>

            </div>

            <!-- Empty State -->
            <div id="compareEmptyState" style="max-width: 800px; margin: 40px auto; text-align: center; padding: 60px 40px; background: white; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.08);">
                <div style="font-size: 72px; margin-bottom: 20px;">‚öñÔ∏è</div>
                <h3 style="color: #333; font-size: 24px; margin-bottom: 15px;">Start by Searching for Stores</h3>
                <p style="color: #666; font-size: 16px; line-height: 1.6; margin-bottom: 20px;">
                    Use the <strong>Locator</strong> module to search for stores in your area. Once you have search results, come back here to compare their Economic Justice Values.
                </p>
                <button onclick="showModule('locator')" style="padding: 14px 32px; background: #2196f3; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">
                    Go to Locator ‚Üí
                </button>
            </div>

        </div>
    </div>

    <!-- Optimize Module -->
    <div id="optimizeModule" class="module-page">
        <div class="module-header">
            <button class="back-btn" onclick="showLanding()">
                <span>‚Üê</span> Back to Home
            </button>
            <h2>‚ú® Optimize</h2>
            <div style="width: 120px;"></div>
        </div>
        <div style="padding: 40px; overflow-y: auto; height: calc(100vh - 80px); background: #f5f7fa;">
            
            <!-- Page Title Section -->
            <div style="max-width: 1200px; margin: 0 auto 40px;">
                <div style="background: white; padding: 40px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); border: 2px dashed #ff9800;">
                    <h1 style="color: #ff9800; text-align: center; font-size: 32px; margin-bottom: 20px;">
                        OPTIMIZE ‚Äî Improvement Over Time
                    </h1>
                    <div style="text-align: center; margin-bottom: 20px;">
                        <div style="font-size: 16px; color: #666; margin-bottom: 20px;">
                            Powered by: <strong>EJV v4.1 ‚Üí v4.2 deltas</strong>
                        </div>
                        <div style="font-size: 16px; font-weight: 600; color: #ff9800; margin-bottom: 15px;">
                            Purpose
                        </div>
                        <ul style="text-align: left; display: inline-block; color: #555; font-size: 15px; line-height: 1.8;">
                            <li>Measures improvement in impact efficiency</li>
                            <li>Considers budget, distance, access constraints</li>
                        </ul>
                        <div style="margin-top: 20px; padding: 15px; background: #fff3e0; border-radius: 8px; font-style: italic; color: #e65100;">
                            <strong>Example insight:</strong><br>
                            "Small shifts increased your impact efficiency by 8% this month."
                        </div>
                    </div>
                </div>
            </div>

            <!-- Current Month Summary -->
            <div style="max-width: 1200px; margin: 0 auto 30px;">
                <div style="background: linear-gradient(135deg, #ff9800 0%, #fb8c00 100%); padding: 35px; border-radius: 15px; box-shadow: 0 8px 30px rgba(255, 152, 0, 0.3); margin-bottom: 30px; color: white; text-align: center;">
                    <div style="font-size: 18px; opacity: 0.95; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px;">Your Impact Efficiency This Month</div>
                    <div style="display: flex; align-items: center; justify-content: center; gap: 20px; margin-bottom: 15px;">
                        <div style="font-size: 64px; font-weight: 700;" id="efficiencyChange">-</div>
                        <div style="font-size: 48px;" id="efficiencyTrendIcon">üìä</div>
                    </div>
                    <div style="font-size: 18px; font-style: italic; opacity: 0.95; margin-bottom: 20px;" id="efficiencyMessage">
                        Start logging purchases to track your improvement!
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-top: 20px;">
                        <div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 10px;">
                            <div style="font-size: 13px; opacity: 0.9; margin-bottom: 5px;">Avg EJV This Month</div>
                            <div style="font-size: 24px; font-weight: 700;" id="currentAvgEJV">-</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 10px;">
                            <div style="font-size: 13px; opacity: 0.9; margin-bottom: 5px;">Avg EJV Last Month</div>
                            <div style="font-size: 24px; font-weight: 700;" id="previousAvgEJV">-</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 10px;">
                            <div style="font-size: 13px; opacity: 0.9; margin-bottom: 5px;">Purchases This Month</div>
                            <div style="font-size: 24px; font-weight: 700;" id="currentMonthPurchases">0</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Improvement Metrics Grid -->
            <div style="max-width: 1200px; margin: 0 auto 30px;">
                <h2 style="color: #333; font-size: 24px; margin-bottom: 20px;">üìà Improvement Metrics</h2>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 30px;">
                    
                    <!-- Distance Optimization -->
                    <div style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); border-left: 4px solid #4caf50;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <div>
                                <div style="color: #666; font-size: 12px; text-transform: uppercase;">Distance</div>
                                <div style="font-weight: 600; color: #333;">Proximity Gain</div>
                            </div>
                            <div style="font-size: 32px;">üìç</div>
                        </div>
                        <div style="font-size: 32px; font-weight: 700; color: #4caf50; margin-bottom: 10px;" id="distanceChange">-</div>
                        <div style="color: #666; font-size: 13px;" id="distanceMessage">Average distance to stores</div>
                    </div>

                    <!-- Budget Efficiency -->
                    <div style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); border-left: 4px solid #2196f3;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <div>
                                <div style="color: #666; font-size: 12px; text-transform: uppercase;">Budget</div>
                                <div style="font-weight: 600; color: #333;">Spending Efficiency</div>
                            </div>
                            <div style="font-size: 32px;">üí∞</div>
                        </div>
                        <div style="font-size: 32px; font-weight: 700; color: #2196f3; margin-bottom: 10px;" id="budgetEfficiency">-</div>
                        <div style="color: #666; font-size: 13px;" id="budgetMessage">EJV per dollar spent</div>
                    </div>

                    <!-- Access Score -->
                    <div style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); border-left: 4px solid #9c27b0;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <div>
                                <div style="color: #666; font-size: 12px; text-transform: uppercase;">Access</div>
                                <div style="font-weight: 600; color: #333;">Store Diversity</div>
                            </div>
                            <div style="font-size: 32px;">üéØ</div>
                        </div>
                        <div style="font-size: 32px; font-weight: 700; color: #9c27b0; margin-bottom: 10px;" id="accessScore">-</div>
                        <div style="color: #666; font-size: 13px;" id="accessMessage">Unique stores visited</div>
                    </div>

                </div>
            </div>

            <!-- Month-over-Month Comparison Chart -->
            <div style="max-width: 1200px; margin: 0 auto 30px;">
                <div style="background: white; padding: 30px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.08);">
                    <h3 style="color: #333; font-size: 20px; margin-bottom: 20px;">üìä Impact Efficiency Trend (Last 6 Months)</h3>
                    <div id="optimizeChart" style="height: 250px; display: flex; align-items: flex-end; gap: 12px; padding: 20px 10px; background: #f9fafb; border-radius: 8px; position: relative;">
                        <!-- Chart will be dynamically generated -->
                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; color: #999;">
                            <div style="font-size: 48px; margin-bottom: 10px;">üìà</div>
                            <div style="font-size: 14px;">Log purchases to see your improvement trend</div>
                        </div>
                    </div>
                    <div style="display: flex; justify-content: space-around; margin-top: 15px; font-size: 11px; color: #999;">
                        <span id="optChartMonth1">Jan</span>
                        <span id="optChartMonth2">Feb</span>
                        <span id="optChartMonth3">Mar</span>
                        <span id="optChartMonth4">Apr</span>
                        <span id="optChartMonth5">May</span>
                        <span id="optChartMonth6">Jun</span>
                    </div>
                </div>
            </div>

            <!-- Optimization Opportunities -->
            <div style="max-width: 1200px; margin: 0 auto 30px;">
                <div style="background: white; padding: 30px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.08);">
                    <h3 style="color: #333; font-size: 20px; margin-bottom: 20px;">üí° Optimization Opportunities</h3>
                    <div id="optimizationOpportunities">
                        <!-- Populated dynamically -->
                        <div style="text-align: center; padding: 40px; color: #999;">
                            <div style="font-size: 48px; margin-bottom: 10px;">üîç</div>
                            <div style="font-size: 14px;">Make more purchases to discover optimization opportunities</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Detailed Analysis -->
            <div style="max-width: 1200px; margin: 0 auto;">
                <div style="background: white; padding: 30px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); border-left: 4px solid #ff9800;">
                    <h3 style="color: #ff9800; font-size: 20px; margin-bottom: 20px;">üìã Monthly Breakdown</h3>
                    <div id="monthlyBreakdown">
                        <!-- Populated dynamically -->
                        <div style="text-align: center; padding: 40px; color: #999;">
                            <div style="font-size: 14px;">Log purchases to see detailed monthly analysis</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Empty State -->
            <div id="optimizeEmptyState" style="display: none; max-width: 800px; margin: 40px auto; text-align: center; padding: 60px 40px; background: white; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.08);">
                <div style="font-size: 72px; margin-bottom: 20px;">‚ú®</div>
                <h3 style="color: #333; font-size: 24px; margin-bottom: 15px;">Start Tracking Your Impact</h3>
                <p style="color: #666; font-size: 16px; line-height: 1.6; margin-bottom: 20px;">
                    Log your purchases in the <strong>User Dashboard</strong> to see how your choices improve over time. The system will automatically track your optimization progress.
                </p>
                <button onclick="showModule('userDashboard')" style="padding: 14px 32px; background: #ff9800; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">
                    Go to Dashboard ‚Üí
                </button>
            </div>

        </div>
    </div>

    <!-- Engage Module -->
    <div id="engageModule" class="module-page">
        <div class="module-header">
            <button class="back-btn" onclick="showLanding()">
                <span>‚Üê</span> Back to Home
            </button>
            <h2>ü§ù Engage</h2>
            <div style="width: 120px;"></div>
        </div>
        <div style="padding: 40px; overflow-y: auto; height: calc(100vh - 80px); background: #f5f7fa;">
            
            <!-- Page Title Section -->
            <div style="max-width: 1200px; margin: 0 auto 40px;">
                <div style="background: white; padding: 40px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); border: 2px dashed #e91e63;">
                    <h1 style="color: #e91e63; text-align: center; font-size: 32px; margin-bottom: 20px;">
                        ENGAGE ‚Äî Total Justice Impact
                    </h1>
                    <div style="text-align: center; margin-bottom: 20px;">
                        <div style="font-size: 16px; color: #666; margin-bottom: 20px;">
                            <strong>Canonical Definition (LOCKED)</strong>
                        </div>
                        <div style="font-size: 20px; font-weight: 600; color: #e91e63; margin-bottom: 20px; font-family: 'Courier New', monospace; background: #fce4ec; padding: 15px; border-radius: 8px;">
                            ENGAGE = EJV_{4.1} + EJV_{4.2}
                        </div>
                        <div style="font-size: 16px; font-weight: 600; color: #e91e63; margin-bottom: 15px;">
                            What ENGAGE captures
                        </div>
                        <ul style="text-align: left; display: inline-block; color: #555; font-size: 15px; line-height: 1.8;">
                            <li>Justice weighted economic behavior (v4.1)</li>
                            <li>Amplification via participation and capacity (v4.2)</li>
                        </ul>
                        <div style="margin-top: 20px; padding: 15px; background: #fce4ec; border-radius: 8px; font-style: italic; color: #c2185b;">
                            <strong>User facing explanation</strong><br>
                            "ENGAGE reflects your total justice impact when spending and civic participation are counted together. Engagement never penalizes ‚Äî it only adds."
                        </div>
                    </div>
                </div>
            </div>

            <!-- Total ENGAGE Score Card -->
            <div style="max-width: 1200px; margin: 0 auto 30px;">
                <div style="background: linear-gradient(135deg, #e91e63 0%, #d81b60 100%); padding: 35px; border-radius: 15px; box-shadow: 0 8px 30px rgba(233, 30, 99, 0.3); margin-bottom: 30px; color: white; text-align: center;">
                    <div style="font-size: 18px; opacity: 0.95; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px;">Your Total Justice Impact (ENGAGE Score)</div>
                    <div style="display: flex; align-items: baseline; justify-content: center; gap: 20px; margin-bottom: 15px;">
                        <div style="font-size: 64px; font-weight: 700;" id="totalEngageScore">0</div>
                        <div style="font-size: 32px; opacity: 0.9;">/ 200</div>
                    </div>
                    <div style="font-size: 18px; font-style: italic; opacity: 0.95; margin-bottom: 25px;" id="engageScoreMessage">
                        Your economic choices and civic participation combined
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
                        <div style="background: rgba(255,255,255,0.15); padding: 20px; border-radius: 10px;">
                            <div style="font-size: 13px; opacity: 0.9; margin-bottom: 8px;">EJV v4.1 (Economic)</div>
                            <div style="font-size: 36px; font-weight: 700;" id="ejv41Score">0</div>
                            <div style="font-size: 12px; opacity: 0.85; margin-top: 5px;">Justice weighted spending</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.15); padding: 20px; border-radius: 10px;">
                            <div style="font-size: 13px; opacity: 0.9; margin-bottom: 8px;">EJV v4.2 (Participation)</div>
                            <div style="font-size: 36px; font-weight: 700;" id="ejv42Score">0</div>
                            <div style="font-size: 12px; opacity: 0.85; margin-top: 5px;">Civic engagement amplifier</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Two Column Layout -->
            <div style="max-width: 1200px; margin: 0 auto;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px;">
                    
                    <!-- Economic Behavior (v4.1) -->
                    <div style="background: white; padding: 30px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); border-left: 4px solid #2196f3;">
                        <h3 style="color: #2196f3; font-size: 20px; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                            <span>üí∞</span> Economic Behavior (EJV v4.1)
                        </h3>
                        
                        <div style="margin-bottom: 20px; padding: 15px; background: #e3f2fd; border-radius: 8px;">
                            <div style="font-size: 13px; color: #1565c0; margin-bottom: 8px; font-weight: 600;">Your Average EJV Score</div>
                            <div style="font-size: 42px; font-weight: 700; color: #2196f3; text-align: center;" id="avgEJVDisplay">0</div>
                            <div style="font-size: 12px; color: #666; text-align: center; margin-top: 5px;">From <span id="totalPurchasesCount">0</span> logged purchases</div>
                        </div>

                        <div style="margin-bottom: 15px;">
                            <div style="font-size: 14px; color: #666; margin-bottom: 10px; font-weight: 600;">What this measures:</div>
                            <ul style="font-size: 13px; color: #555; line-height: 1.8; margin-left: 20px;">
                                <li>Economic justice of your store choices</li>
                                <li>Wage equity, hiring practices, community investment</li>
                                <li>Your purchasing power directed at high-EJV businesses</li>
                            </ul>
                        </div>

                        <div style="padding: 15px; background: #f5f7fa; border-radius: 8px; margin-bottom: 15px;">
                            <div style="font-size: 12px; color: #666; margin-bottom: 8px;">Recent Purchase Impact</div>
                            <div id="recentPurchaseImpact" style="font-size: 13px; color: #333;">
                                Log purchases to see impact details
                            </div>
                        </div>

                        <button onclick="showModule('userDashboard')" style="width: 100%; padding: 12px; background: #2196f3; color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer;">
                            Log Purchase ‚Üí
                        </button>
                    </div>

                    <!-- Civic Participation (v4.2) -->
                    <div style="background: white; padding: 30px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); border-left: 4px solid #9c27b0;">
                        <h3 style="color: #9c27b0; font-size: 20px; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                            <span>üéØ</span> Civic Participation (EJV v4.2)
                        </h3>
                        
                        <div style="margin-bottom: 20px; padding: 15px; background: #f3e5f5; border-radius: 8px;">
                            <div style="font-size: 13px; color: #7b1fa2; margin-bottom: 8px; font-weight: 600;">Participation Amplifier</div>
                            <div style="font-size: 42px; font-weight: 700; color: #9c27b0; text-align: center;" id="participationScore">0</div>
                            <div style="font-size: 12px; color: #666; text-align: center; margin-top: 5px;">From <span id="totalActionsCount">0</span> civic actions</div>
                        </div>

                        <div style="margin-bottom: 15px;">
                            <div style="font-size: 14px; color: #666; margin-bottom: 10px; font-weight: 600;">What this measures:</div>
                            <ul style="font-size: 13px; color: #555; line-height: 1.8; margin-left: 20px;">
                                <li>Community organizing and collective action</li>
                                <li>Sharing knowledge about economic justice</li>
                                <li>Building capacity for local economic power</li>
                            </ul>
                        </div>

                        <div style="padding: 15px; background: #f5f7fa; border-radius: 8px; margin-bottom: 15px;">
                            <div style="font-size: 14px; color: #666; margin-bottom: 12px; font-weight: 600;">Track Your Actions:</div>
                            <div id="actionsList" style="font-size: 13px; color: #333;">
                                <!-- Populated dynamically -->
                            </div>
                        </div>

                        <button onclick="logCivicAction()" style="width: 100%; padding: 12px; background: #9c27b0; color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer;">
                            ‚ûï Log Civic Action
                        </button>
                    </div>

                </div>
            </div>

            <!-- Civic Actions Tracking -->
            <div style="max-width: 1200px; margin: 0 auto 30px;">
                <div style="background: white; padding: 30px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.08);">
                    <h3 style="color: #333; font-size: 20px; margin-bottom: 20px;">üåü Your Civic Actions</h3>
                    <div id="civicActionsHistory">
                        <!-- Populated dynamically -->
                        <div style="text-align: center; padding: 40px; color: #999;">
                            <div style="font-size: 48px; margin-bottom: 10px;">ü§ù</div>
                            <div style="font-size: 14px;">Start logging civic actions to amplify your impact!</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Impact Explanation -->
            <div style="max-width: 1200px; margin: 0 auto;">
                <div style="background: white; padding: 30px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); border-left: 4px solid #e91e63;">
                    <h3 style="color: #e91e63; font-size: 20px; margin-bottom: 20px;">üìö Understanding ENGAGE</h3>
                    
                    <div style="margin-bottom: 20px;">
                        <div style="font-size: 16px; font-weight: 600; color: #333; margin-bottom: 10px;">Why combine economic + civic?</div>
                        <p style="color: #555; font-size: 14px; line-height: 1.8;">
                            Individual purchasing decisions (EJV v4.1) create immediate economic justice impact. But civic participation (EJV v4.2) <strong>amplifies</strong> that impact through collective action, community organizing, and building local economic power. Together, they represent your <strong>total justice impact</strong>.
                        </p>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <div style="font-size: 16px; font-weight: 600; color: #333; margin-bottom: 10px;">The "only adds" principle</div>
                        <p style="color: #555; font-size: 14px; line-height: 1.8;">
                            ENGAGE never penalizes you. If you're not civically active yet, your score equals your EJV v4.1 (economic behavior). Every civic action <strong>adds</strong> to your total impact. This encourages participation without creating pressure.
                        </p>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div style="padding: 20px; background: #e3f2fd; border-radius: 8px;">
                            <div style="font-size: 14px; font-weight: 600; color: #1565c0; margin-bottom: 10px;">üõí Economic Actions (v4.1)</div>
                            <ul style="font-size: 13px; color: #555; line-height: 1.8; margin-left: 20px;">
                                <li>Shopping at high-EJV stores</li>
                                <li>Supporting local businesses</li>
                                <li>Choosing equitable employers</li>
                            </ul>
                        </div>
                        <div style="padding: 20px; background: #f3e5f5; border-radius: 8px;">
                            <div style="font-size: 14px; font-weight: 600; color: #7b1fa2; margin-bottom: 10px;">ü§ù Civic Actions (v4.2)</div>
                            <ul style="font-size: 13px; color: #555; line-height: 1.8; margin-left: 20px;">
                                <li>Sharing economic justice insights</li>
                                <li>Organizing community events</li>
                                <li>Advocating for policy changes</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Civic Action Logging Modal -->
    <div id="civicActionModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 15px; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto; padding: 30px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="color: #333; font-size: 24px; margin: 0;">Log Civic Action</h2>
                <button onclick="closeCivicActionModal()" style="background: none; border: none; font-size: 28px; cursor: pointer; color: #999;">&times;</button>
            </div>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; color: #333; font-weight: 600; margin-bottom: 8px;">Action Type</label>
                <select id="actionType" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                    <option value="">Select action type...</option>
                    <option value="share">üì¢ Shared economic justice insights</option>
                    <option value="organize">ü§ù Organized community event</option>
                    <option value="advocate">üì£ Advocated for policy change</option>
                    <option value="educate">üìö Educated others about EJV</option>
                    <option value="support">üí™ Supported local business initiative</option>
                    <option value="volunteer">üôã Volunteered for community organization</option>
                    <option value="other">‚ú® Other civic action</option>
                </select>
            </div>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; color: #333; font-weight: 600; margin-bottom: 8px;">Description</label>
                <textarea id="actionDescription" placeholder="Briefly describe what you did..." style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; min-height: 80px; font-family: inherit;"></textarea>
            </div>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; color: #333; font-weight: 600; margin-bottom: 8px;">Date</label>
                <input type="date" id="actionDate" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
            </div>
            
            <div style="margin-bottom: 30px;">
                <label style="display: block; color: #333; font-weight: 600; margin-bottom: 8px;">Impact Points (Estimated)</label>
                <input type="number" id="actionPoints" value="5" min="1" max="25" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                <small style="color: #999;">Typical actions: 5-10 points. Major organizing: 15-25 points.</small>
            </div>
            
            <button onclick="saveCivicAction()" style="width: 100%; padding: 16px; background: linear-gradient(135deg, #e91e63 0%, #d81b60 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 700;">
                Save Civic Action
            </button>
        </div>
    </div>

    <!-- Compete Module -->
    <div id="competeModule" class="module-page">
        <div class="module-header">
            <button class="back-btn" onclick="showLanding()">
                <span>‚Üê</span> Back to Home
            </button>
            <h2>üèÜ Compete</h2>
            <div></div>
        </div>
        <div class="empty-module">
            <div class="empty-module-content">
                <div class="icon">üèÜ</div>
                <h3>Compete Module</h3>
                <p>Coming soon...</p>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Global variables
        var map = null;
        var markers = [];
        var storeData = [];
        var rawStores = [];
        var ejvData = {};
        var currentUser = { username: 'Guest' }; // Default user
        var ejvCache = {};
        var hoverDebounceTimer = null;
        var allStoresEJV = [];
        var currentZip = null;
        var decisionMode = 'locator'; // Default mode: locator

        function toggleCustomSearch(type) {
            const select = document.getElementById(type + 'Category');
            const customDiv = document.getElementById(type + 'CustomSearch');
            const restaurantTypeDiv = document.getElementById(type + 'RestaurantType');
            
            if (select.value === 'custom') {
                customDiv.style.display = 'block';
            } else {
                customDiv.style.display = 'none';
            }
            
            // Show restaurant type filter when restaurant category is selected
            if (restaurantTypeDiv) {
                if (select.value === 'restaurant') {
                    restaurantTypeDiv.style.display = 'block';
                } else {
                    restaurantTypeDiv.style.display = 'none';
                }
            }
        }
        window.toggleCustomSearch = toggleCustomSearch; // Make it globally accessible

        // ==========================================
        // EJV v4.2: PAF Calculation
        // ==========================================
        const PARTICIPATION_TYPES = {
            mentoring: { weight: 0.08 },
            volunteering: { weight: 0.06 },
            sponsorship: { weight: 0.05 },
            apprenticeship: { weight: 0.04 },
            facilities: { weight: 0.02 }
        };

        function calculatePAF(participationData) {
            if (!participationData || Object.keys(participationData).length === 0) {
                return 1.0;
            }
            
            let totalContribution = 0.0;
            
            for (const [activityType, activityData] of Object.entries(participationData)) {
                if (!PARTICIPATION_TYPES[activityType]) continue;
                
                const baseWeight = PARTICIPATION_TYPES[activityType].weight;
                const intensity = Math.min((activityData.hours || 1) / 10.0, 1.0);
                const verificationMultiplier = activityData.verified ? 1.2 : 1.0;
                const durationFactor = Math.min((activityData.duration_months || 1) / 12.0, 1.0);
                
                const contribution = baseWeight * intensity * verificationMultiplier * durationFactor;
                totalContribution += contribution;
            }
            
            const paf = 1.0 + Math.min(totalContribution, 0.25);
            return Number(paf.toFixed(3));
        }

        // Custom marker icons
        const storeIcons = {
            supermarket: { icon: 'üõí', color: '#1e7e34' },
            warehouse: { icon: 'üè¢', color: '#6a1b9a' },
            pharmacy: { icon: 'üíä', color: '#bd2130' },
            restaurant: { icon: 'üçΩÔ∏è', color: '#d39e00' },
            convenience: { icon: 'üè™', color: '#117a8b' },
            default: { icon: 'üè¨', color: '#4a5bb8' }
        };

        function getStoreIcon(shopType) {
            return storeIcons[shopType] || storeIcons.default;
        }

        function setDecisionMode(mode) {
            decisionMode = mode;
            document.querySelectorAll('.decision-step').forEach(el => el.classList.remove('active'));
            document.querySelector(`[data-mode="${mode}"]`).classList.add('active');
            
            const modeDisplay = document.getElementById('modeDisplay');
            const currentModeText = document.getElementById('currentMode');
            modeDisplay.style.display = 'block';
            
            // Show/hide v4.2 metrics based on mode
            const engageMetrics = document.getElementById('engageMetricsGrid');
            
            if (mode === 'locator') {
                currentModeText.innerHTML = 'üìç Locator Mode: Hover on stores to see details';
                currentModeText.style.color = '#667eea';
                engageMetrics.style.display = 'none';
                // Re-display stores if they exist
                if (rawStores.length > 0) {
                    const storeListDiv = document.getElementById('storeList');
                    storeListDiv.innerHTML = ''; // Clear ENGAGE/COMPARE content
                    displayStores(rawStores); // Re-render store list
                    showResult(`Found ${rawStores.length} stores`);
                } else {
                    showResult('Enter a ZIP code or address to search for stores');
                }
            } else if (mode === 'compare') {
                currentModeText.innerHTML = '‚öñÔ∏è Compare Mode: Viewing all calculated EJV scores';
                currentModeText.style.color = '#28a745';
                engageMetrics.style.display = 'none';
                showCompareMode();
            } else if (mode === 'optimize') {
                currentModeText.innerHTML = '‚ú® Optimize Mode: Showing best and least impact';
                currentModeText.style.color = '#ffc107';
                engageMetrics.style.display = 'none';
                showOptimizeMode();
            } else if (mode === 'engage') {
                currentModeText.innerHTML = 'ü§ù Engage Mode: Amplify impact through participation (EJV v4.2)';
                currentModeText.style.color = '#ff5722';
                engageMetrics.style.display = 'grid';
                showEngageMode();
            }
        }

        function showCompareMode() {
            if (allStoresEJV.length === 0) {
                showResult('Calculate EJV for stores first to enable Compare mode');
                return;
            }
            
            const storeListDiv = document.getElementById('storeList');
            
            // Group stores by type
            const storesByType = {};
            allStoresEJV.forEach(store => {
                const type = store.type || 'default';
                if (!storesByType[type]) {
                    storesByType[type] = [];
                }
                storesByType[type].push(store);
            });
            
            // Sort by ELVR within each type
            Object.keys(storesByType).forEach(type => {
                storesByType[type].sort((a, b) => (b.elvr || 0) - (a.elvr || 0));
            });
        
            
            storeListDiv.innerHTML = '<div style="font-size: 12px; font-weight: 600; margin-bottom: 10px; color: #28a745;">‚öñÔ∏è Comparing ' + allStoresEJV.length + ' stores by category:</div>';
            
            // Display each category with its stores
            Object.keys(storesByType).forEach(type => {
                const stores = storesByType[type];
                const categoryIcon = getStoreIcon(type);
                
                // Category header
                const categoryHeader = document.createElement('div');
                categoryHeader.style.cssText = 'background: #f8f9fa; padding: 8px 10px; border-radius: 4px; margin: 10px 0 5px 0; font-weight: 600; font-size: 11px; color: #333;';
                categoryHeader.innerHTML = `${categoryIcon.icon} ${categoryIcon.name} (${stores.length})`;
                storeListDiv.appendChild(categoryHeader);
                
                // Display stores in this category
                stores.forEach((store, index) => {
                    const storeItem = document.createElement('div');
                    storeItem.className = 'store-item';
                    storeItem.style.borderLeftColor = categoryIcon.color;
                    
                    // Get address and website from store object (already stored during EJV calculation)
                    const address = store.address || '';
                    const website = store.website || null;
                    
                    console.log(`Compare mode - Store: ${store.name}, Address: "${address}", Website: ${website}`);
                    
                    // Best/worst indicator
                    let rankBadge = '';
                    if (index === 0 && stores.length > 1) {
                        rankBadge = '<span style="background: #28a745; color: white; padding: 2px 6px; border-radius: 3px; font-size: 9px; margin-left: 5px;">üèÜ BEST</span>';
                    } else if (index === stores.length - 1 && stores.length > 1) {
                        rankBadge = '<span style="background: #dc3545; color: white; padding: 2px 6px; border-radius: 3px; font-size: 9px; margin-left: 5px;">‚ö† LEAST</span>';
                    }
                    
                    storeItem.innerHTML = `
                        <div class="store-name" style="display: flex; align-items: center; justify-content: space-between;">
                            <span>
                                <span class="store-icon">${categoryIcon.icon}</span>
                                #${index + 1} - ${store.name}
                            </span>
                            ${rankBadge}
                        </div>
                        <div style="font-size: 11px; color: #666; margin: 5px 0;">
                            üìç ${address ? `<span style="color: #555;" title="Store address">${address}</span>` : '<span style="color: #999;" title="Address data not available in OpenStreetMap">Address not available</span>'}
                        </div>
                        <div style="font-size: 11px; color: #666; margin: 5px 0;">
                            üåê ${website ? `<a href="${website}" target="_blank" rel="noopener noreferrer" style="color: #667eea; text-decoration: none;" title="Visit store website">Visit Website</a>` : '<span style="color: #999;" title="Website information not available">Website not available</span>'}
                        </div>
                        
                        <div style="margin-top: 10px; padding: 10px; background: linear-gradient(135deg, #e8f5e9 0%, #f0f4ff 100%); border-radius: 6px; border: 2px solid #667eea;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px;">
                                <div style="text-align: center; background: white; padding: 6px; border-radius: 4px; border-left: 3px solid #667eea;">
                                    <div style="font-size: 9px; color: #666; font-weight: 600; margin-bottom: 2px;">üåü EJV 4.1</div>
                                    <div style="font-weight: 700; color: #667eea; font-size: 14px;">${(store.ejv_v2_baseline || 0).toFixed(1)}</div>
                                    <div style="font-size: 8px; color: #888;">0-100</div>
                                </div>
                                <div style="text-align: center; background: white; padding: 6px; border-radius: 4px; border-left: 3px solid #7b1fa2;">
                                    <div style="font-size: 9px; color: #666; font-weight: 600; margin-bottom: 2px;">üìä EJV 4.0</div>
                                    <div style="font-weight: 700; color: #7b1fa2; font-size: 14px;">${store.data?.ejv_original?.ejv_percentage ? store.data.ejv_original.ejv_percentage.toFixed(1) : '0.0'}%</div>
                                    <div style="font-size: 8px; color: #888;">0-100%</div>
                                </div>
                            </div>
                            
                            <div style="border-top: 1px solid #ddd; padding-top: 6px; margin-top: 6px;">
                                <div style="font-size: 10px; font-weight: 600; color: #555; margin-bottom: 4px;">EJV 4.1 Components (0-100):</div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 3px; font-size: 10px;">
                                    <div style="display: flex; justify-content: space-between; padding: 2px;">
                                        <span style="color: #666;" title="Local Circulation">LC:</span>
                                        <span style="font-weight: 600; color: #667eea;">${store.data?.components?.LC_local_circulation?.toFixed(1) || '-'}</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; padding: 2px;">
                                        <span style="color: #666;" title="Fair Wages">W:</span>
                                        <span style="font-weight: 600; color: #667eea;">${store.data?.components?.W_fair_wages?.toFixed(1) || '-'}</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; padding: 2px;">
                                        <span style="color: #666;" title="Community Need">DN:</span>
                                        <span style="font-weight: 600; color: #667eea;">${store.data?.components?.DN_community_need?.toFixed(1) || '-'}</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; padding: 2px;">
                                        <span style="color: #666;" title="Equity & Inclusion">EQ:</span>
                                        <span style="font-weight: 600; color: #667eea;">${store.data?.components?.EQ_equity_inclusion?.toFixed(1) || '-'}</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; padding: 2px;">
                                        <span style="color: #666;" title="Environmental">ENV:</span>
                                        <span style="font-weight: 600; color: #667eea;">${store.data?.components?.ENV_environmental?.toFixed(1) || '-'}</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; padding: 2px;">
                                        <span style="color: #666;" title="Procurement">PROC:</span>
                                        <span style="font-weight: 600; color: #667eea;">${store.data?.components?.PROC_procurement?.toFixed(1) || '-'}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    storeItem.onclick = () => {
                        map.setView([store.lat, store.lon], 16);
                        updateRightDashboard(store.data, store.name);
                    };
                    storeListDiv.appendChild(storeItem);
                });
            });
        }

        function showOptimizeMode() {
            if (allStoresEJV.length === 0) {
                showResult('Calculate EJV for stores first to enable Optimize mode');
                return;
            }
            
            const sorted = [...allStoresEJV].sort((a, b) => (b.elvr || 0) - (a.elvr || 0));
            const best = sorted[0];
            const worst = sorted[sorted.length - 1];
            
            // Get addresses and websites from stored objects
            const bestAddress = best.address || '';
            const worstAddress = worst.address || '';
            const bestWebsite = best.website || null;
            const worstWebsite = worst.website || null;
            
            const storeListDiv = document.getElementById('storeList');
            storeListDiv.innerHTML = `
                <div style="font-size: 12px; font-weight: 600; margin-bottom: 10px; color: #ffc107;">‚ú® Optimization Results:</div>
                
                <div style="background: #d4edda; padding: 12px; border-radius: 6px; margin-bottom: 10px; border-left: 4px solid #28a745;">
                    <div style="font-size: 11px; font-weight: 700; color: #155724; margin-bottom: 5px;">üèÜ BEST CHOICE</div>
                    <div style="font-weight: 600; color: #333; margin-bottom: 3px;">${getStoreIcon(best.type).icon} ${best.name}</div>
                    <div style="font-size: 11px; color: #666; margin-bottom: 5px;">
                        üìç ${bestAddress ? `<span style="color: #555;" title="Store address">${bestAddress}</span>` : '<span style="color: #999;" title="Address data not available in OpenStreetMap">Address not available</span>'}
                    </div>
                    <div style="font-size: 11px; color: #666; margin-bottom: 5px;">
                        üåê ${bestWebsite ? `<a href="${bestWebsite}" target="_blank" rel="noopener noreferrer" style="color: #667eea; text-decoration: none; font-weight: 600;" title="Visit ${best.name} website">Visit Website</a>` : '<span style="color: #999;" title="Website information not available">Website not available</span>'}
                    </div>
                    
                    <div style="margin-top: 10px; padding: 10px; background: white; border-radius: 6px; border: 2px solid #28a745;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px;">
                            <div style="text-align: center; background: #f0f4ff; padding: 6px; border-radius: 4px; border-left: 3px solid #667eea;">
                                <div style="font-size: 9px; color: #666; font-weight: 600; margin-bottom: 2px;">üåü EJV 4.1</div>
                                <div style="font-weight: 700; color: #667eea; font-size: 14px;">${(best.ejv_v2_baseline || 0).toFixed(1)}</div>
                                <div style="font-size: 8px; color: #888;">0-100</div>
                            </div>
                            <div style="text-align: center; background: #f3e5f5; padding: 6px; border-radius: 4px; border-left: 3px solid #7b1fa2;">
                                <div style="font-size: 9px; color: #666; font-weight: 600; margin-bottom: 2px;">üìä EJV 4.0</div>
                                <div style="font-weight: 700; color: #7b1fa2; font-size: 14px;">${best.data?.ejv_original?.ejv_percentage ? best.data.ejv_original.ejv_percentage.toFixed(1) : '0.0'}%</div>
                                <div style="font-size: 8px; color: #888;">0-100%</div>
                            </div>
                        </div>
                        <div style="border-top: 1px solid #ddd; padding-top: 6px;">
                            <div style="font-size: 10px; font-weight: 600; color: #555; margin-bottom: 4px;">EJV 4.1 Components:</div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 3px; font-size: 10px;">
                                <div style="display: flex; justify-content: space-between;"><span style="color: #666;">LC:</span><span style="font-weight: 600; color: #28a745;">${best.data?.components?.LC_local_circulation?.toFixed(1) || '-'}</span></div>
                                <div style="display: flex; justify-content: space-between;"><span style="color: #666;">W:</span><span style="font-weight: 600; color: #28a745;">${best.data?.components?.W_fair_wages?.toFixed(1) || '-'}</span></div>
                                <div style="display: flex; justify-content: space-between;"><span style="color: #666;">DN:</span><span style="font-weight: 600; color: #28a745;">${best.data?.components?.DN_community_need?.toFixed(1) || '-'}</span></div>
                                <div style="display: flex; justify-content: space-between;"><span style="color: #666;">EQ:</span><span style="font-weight: 600; color: #28a745;">${best.data?.components?.EQ_equity_inclusion?.toFixed(1) || '-'}</span></div>
                                <div style="display: flex; justify-content: space-between;"><span style="color: #666;">ENV:</span><span style="font-weight: 600; color: #28a745;">${best.data?.components?.ENV_environmental?.toFixed(1) || '-'}</span></div>
                                <div style="display: flex; justify-content: space-between;"><span style="color: #666;">PROC:</span><span style="font-weight: 600; color: #28a745;">${best.data?.components?.PROC_procurement?.toFixed(1) || '-'}</span></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div style="background: #f8d7da; padding: 12px; border-radius: 6px; border-left: 4px solid #dc3545;">
                    <div style="font-size: 11px; font-weight: 700; color: #721c24; margin-bottom: 5px;">‚ö†Ô∏è LEAST IMPACT</div>
                    <div style="font-weight: 600; color: #333; margin-bottom: 3px;">${getStoreIcon(worst.type).icon} ${worst.name}</div>
                    <div style="font-size: 11px; color: #666; margin-bottom: 5px;">
                        üìç ${worstAddress ? `<span style="color: #555;" title="Store address">${worstAddress}</span>` : '<span style="color: #999;" title="Address data not available in OpenStreetMap">Address not available</span>'}
                    </div>
                    <div style="font-size: 11px; color: #666; margin-bottom: 5px;">
                        üåê ${worstWebsite ? `<a href="${worstWebsite}" target="_blank" rel="noopener noreferrer" style="color: #667eea; text-decoration: none; font-weight: 600;" title="Visit ${worst.name} website">Visit Website</a>` : '<span style="color: #999;" title="Website information not available">Website not available</span>'}
                    </div>
                    
                    <div style="margin-top: 10px; padding: 10px; background: white; border-radius: 6px; border: 2px solid #dc3545;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px;">
                            <div style="text-align: center; background: #f0f4ff; padding: 6px; border-radius: 4px; border-left: 3px solid #667eea;">
                                <div style="font-size: 9px; color: #666; font-weight: 600; margin-bottom: 2px;">üåü EJV 4.1</div>
                                <div style="font-weight: 700; color: #667eea; font-size: 14px;">${(worst.ejv_v2_baseline || 0).toFixed(1)}</div>
                                <div style="font-size: 8px; color: #888;">0-100</div>
                            </div>
                            <div style="text-align: center; background: #f3e5f5; padding: 6px; border-radius: 4px; border-left: 3px solid #7b1fa2;">
                                <div style="font-size: 9px; color: #666; font-weight: 600; margin-bottom: 2px;">üìä EJV 4.0</div>
                                <div style="font-weight: 700; color: #7b1fa2; font-size: 14px;">${worst.data?.ejv_original?.ejv_percentage ? worst.data.ejv_original.ejv_percentage.toFixed(1) : '0.0'}%</div>
                                <div style="font-size: 8px; color: #888;">0-100%</div>
                            </div>
                        </div>
                        <div style="border-top: 1px solid #ddd; padding-top: 6px;">
                            <div style="font-size: 10px; font-weight: 600; color: #555; margin-bottom: 4px;">EJV 4.1 Components:</div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 3px; font-size: 10px;">
                                <div style="display: flex; justify-content: space-between;"><span style="color: #666;">LC:</span><span style="font-weight: 600; color: #dc3545;">${worst.data?.components?.LC_local_circulation?.toFixed(1) || '-'}</span></div>
                                <div style="display: flex; justify-content: space-between;"><span style="color: #666;">W:</span><span style="font-weight: 600; color: #dc3545;">${worst.data?.components?.W_fair_wages?.toFixed(1) || '-'}</span></div>
                                <div style="display: flex; justify-content: space-between;"><span style="color: #666;">DN:</span><span style="font-weight: 600; color: #dc3545;">${worst.data?.components?.DN_community_need?.toFixed(1) || '-'}</span></div>
                                <div style="display: flex; justify-content: space-between;"><span style="color: #666;">EQ:</span><span style="font-weight: 600; color: #dc3545;">${worst.data?.components?.EQ_equity_inclusion?.toFixed(1) || '-'}</span></div>
                                <div style="display: flex; justify-content: space-between;"><span style="color: #666;">ENV:</span><span style="font-weight: 600; color: #dc3545;">${worst.data?.components?.ENV_environmental?.toFixed(1) || '-'}</span></div>
                                <div style="display: flex; justify-content: space-between;"><span style="color: #666;">PROC:</span><span style="font-weight: 600; color: #dc3545;">${worst.data?.components?.PROC_procurement?.toFixed(1) || '-'}</span></div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function showEngageMode() {
            if (allStoresEJV.length === 0) {
                showResult('Calculate EJV for stores first to enable Engage mode');
                return;
            }
            
            const storeListDiv = document.getElementById('storeList');
            storeListDiv.innerHTML = `
                <div style="font-size: 12px; font-weight: 600; margin-bottom: 10px; color: #ff5722;">ü§ù Engage: Participation Amplification (EJV v4.2)</div>
                
                <div style="background: #fff3e0; padding: 12px; border-radius: 6px; margin-bottom: 12px; border-left: 4px solid #ff9800;">
                    <div style="font-size: 11px; line-height: 1.6; color: #333;">
                        <strong>How it works:</strong><br>
                        ‚Ä¢ Add verified participation actions<br>
                        ‚Ä¢ PAF multiplier: 1.0 to 1.25 (up to 25% boost)<br>
                        ‚Ä¢ Activities: Mentoring, Volunteering, Sponsorship, Apprenticeships<br>
                        ‚Ä¢ Amplifies EJV v4.1 decomposed flows
                    </div>
                </div>
                
                <div style="font-size: 11px; margin-bottom: 10px; color: #666;">
                    Select a store to add participation activities:
                </div>
            `;
            
            allStoresEJV.forEach(store => {
                const storeItem = document.createElement('div');
                storeItem.className = 'store-item';
                storeItem.style.cursor = 'pointer';
                storeItem.style.padding = '10px';
                storeItem.style.marginBottom = '8px';
                storeItem.style.background = 'white';
                storeItem.style.borderRadius = '6px';
                storeItem.style.borderLeft = '3px solid #ff5722';
                storeItem.innerHTML = `
                    <div style="font-weight: 600; color: #333; margin-bottom: 3px;">${getStoreIcon(store.type).icon} ${store.name}</div>
                    <div style="font-size: 10px; color: #666; margin-bottom: 5px;">
                        Base EJV v2: $${store.ejv_v2.toFixed(2)}
                    </div>
                    <div style="font-size: 10px; color: #ff5722;">
                        Click to apply participation (v4.2)
                    </div>
                `;
                storeItem.onclick = () => showParticipationForm(store);
                storeListDiv.appendChild(storeItem);
            });
        }

        function showParticipationForm(store) {
            const storeListDiv = document.getElementById('storeList');
            storeListDiv.innerHTML = `
                <div style="font-size: 12px; font-weight: 600; margin-bottom: 10px; color: #ff5722;">
                    ü§ù ${store.name} - Add Participation
                </div>
                
                <div style="background: white; padding: 12px; border-radius: 6px; margin-bottom: 10px;">
                    <div style="font-size: 11px; margin-bottom: 8px;">
                        <label style="display: block; margin-bottom: 4px; font-weight: 600;">Mentoring (hrs/week):</label>
                        <input type="number" id="mentoring_hours" min="0" max="10" value="2" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    
                    <div style="font-size: 11px; margin-bottom: 8px;">
                        <label style="display: block; margin-bottom: 4px; font-weight: 600;">Volunteering (hrs/week):</label>
                        <input type="number" id="volunteering_hours" min="0" max="10" value="4" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    
                    <div style="font-size: 11px; margin-bottom: 12px;">
                        <label style="display: flex; align-items: center;">
                            <input type="checkbox" id="verified" checked style="margin-right: 6px;">
                            <span>Verified by community partner (+20%)</span>
                        </label>
                    </div>
                    
                    <button onclick="calculateEngageEJV('${store.storeId}', '${store.name}', ${store.ejv_v2})" 
                            style="width: 100%; padding: 10px; background: #ff5722; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer;">
                        Calculate EJV v4.2
                    </button>
                    
                    <button onclick="showEngageMode()" 
                            style="width: 100%; padding: 8px; background: #666; color: white; border: none; border-radius: 6px; margin-top: 8px; cursor: pointer;">
                        ‚Üê Back
                    </button>
                </div>
            `;
        }

        async function calculateEngageEJV(storeId, storeName, baseEjv) {
            const mentoring_hours = parseFloat(document.getElementById('mentoring_hours').value) || 0;
            const volunteering_hours = parseFloat(document.getElementById('volunteering_hours').value) || 0;
            const verified = document.getElementById('verified').checked;
            
            try {
                const response = await fetch(`/api/ejv-v4.2/${storeId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        zip: currentZip,
                        location: storeName,
                        purchase: 100,
                        participation: {
                            mentoring: {
                                hours: mentoring_hours,
                                verified: verified,
                                duration_months: 12
                            },
                            volunteering: {
                                hours: volunteering_hours,
                                verified: verified,
                                duration_months: 6
                            }
                        }
                    })
                });
                
                const data = await response.json();
                displayEngageResults(storeName, data, baseEjv);
            } catch (error) {
                showResult(`Error calculating EJV v4.2: ${error.message}`);
            }
        }

        function displayEngageResults(storeName, data, baseEjv) {
            const storeListDiv = document.getElementById('storeList');
            const ejv42 = data.ejv_v42;
            const paf = data.participation.paf;
            const amplification = ejv42.amplification_value;
            
            storeListDiv.innerHTML = `
                <div style="font-size: 12px; font-weight: 600; margin-bottom: 10px; color: #ff5722;">
                    ü§ù ${storeName} - EJV v4.2 Results
                </div>
                
                <div style="background: linear-gradient(135deg, #ff5722 0%, #ff9800 100%); padding: 15px; border-radius: 8px; margin-bottom: 12px; color: white;">
                    <div style="font-size: 20px; font-weight: 700; margin-bottom: 5px;">
                        $${ejv42.elvr_amplified.toFixed(2)}
                    </div>
                    <div style="font-size: 11px; opacity: 0.9;">Amplified Local Value Retained (ELVR)</div>
                </div>
                
                <div style="background: white; padding: 12px; border-radius: 6px; margin-bottom: 10px;">
                    <div style="font-size: 11px; line-height: 1.8;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span style="color: #666;">Base ELVR (v4.1):</span>
                            <span style="font-weight: 600;">$${ejv42.elvr_base.toFixed(2)}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span style="color: #666;">PAF Multiplier:</span>
                            <span style="font-weight: 600; color: #ff5722;">${paf.toFixed(3)}x</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding-top: 5px; border-top: 1px solid #eee;">
                            <span style="color: #ff5722; font-weight: 600;">Amplification:</span>
                            <span style="font-weight: 600; color: #ff5722;">+$${amplification.toFixed(2)} (+${((paf - 1) * 100).toFixed(1)}%)</span>
                        </div>
                    </div>
                </div>
                
                <div style="background: #f5f5f5; padding: 10px; border-radius: 6px; font-size: 10px; color: #666; line-height: 1.6; margin-bottom: 12px;">
                    <strong>Interpretation:</strong><br>
                    ${data.interpretation.message}
                </div>
                
                <button onclick="showEngageMode()" 
                        style="width: 100%; padding: 10px; background: #666; color: white; border: none; border-radius: 6px; cursor: pointer;">
                    ‚Üê Back to Engage Mode
                </button>
            `;
        }

        // Logout function - just reload the page (no login required)
        function handleLogout() {
            console.log('Refreshing application...');
            window.location.reload();
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('========================================');
            console.log('FIX$ GeoEquity Impact Engine - Initializing');
            console.log('========================================');
            console.log('‚úì Page loaded');
            
            // Update user display (if element exists)
            const userDisplayElement = document.getElementById('userDisplay');
            if (currentUser && currentUser.username && userDisplayElement) {
                userDisplayElement.textContent = `üë§ ${currentUser.username}`;
                console.log('‚úì User display updated:', currentUser.username);
            }
            
            console.log('‚úì Initializing map...');
            initMap();
        });

        function initMap() {
            if (map) {
                console.log('Removing existing map');
                map.remove();
            }
            
            console.log('Initializing Leaflet map...');
            const mapContainer = document.getElementById('map');
            console.log('Map container:', mapContainer);
            console.log('Map container dimensions:', mapContainer?.offsetWidth, 'x', mapContainer?.offsetHeight);
            
            if (!mapContainer) {
                console.error('Map container not found!');
                return;
            }
            
            map = L.map('map').setView([39.8283, -98.5795], 4);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png?lang=en', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 19,
                language: 'en'
            }).addTo(map);

            setTimeout(() => {
                map.invalidateSize();
                console.log('Map initialized successfully');
            }, 200);
        }

        // Search Near Me (using geolocation)
        // Handle Near Me category change to show/hide restaurant type selector
        function handleNearMeCategoryChange() {
            const category = document.getElementById('nearMeCategory').value;
            const restaurantTypeDiv = document.getElementById('nearMeRestaurantType');
            
            if (category === 'restaurant') {
                restaurantTypeDiv.style.display = 'block';
            } else {
                restaurantTypeDiv.style.display = 'none';
            }
        }

        async function searchNearMe() {
            console.log('=== NEAR ME SEARCH STARTED (EJV 4.1) ===');
            
            // Check if geolocation is supported
            if (!navigator.geolocation) {
                alert('‚ùå Geolocation is not supported by your browser.\n\nPlease use ZIP code search instead.');
                return;
            }
            
            showLoading(true);
            showResult('üìç Getting your location...');
            
            // Request user's location
            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    try {
                        const lat = position.coords.latitude;
                        const lon = position.coords.longitude;
                        const accuracy = position.coords.accuracy;
                        
                        console.log(`Location found: (${lat}, ${lon}) with accuracy ${accuracy}m`);
                        showResult(`‚úÖ Location found!\nüîç Finding stores near you...`);
                        
                        // Clear previous results
                        clearMarkers();
                        window.storeData = [];
                        rawStores = [];
                        allStoresEJV = [];
                        ejvCache = {};
                        
                        // Center map on user's location
                        map.setView([lat, lon], 14);
                        
                        // Add user location marker
                        const userMarker = L.marker([lat, lon], {
                            icon: L.divIcon({
                                className: 'custom-div-icon',
                                html: `<div style="background: #667eea; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 3px 8px rgba(0,0,0,0.3);"></div>`,
                                iconSize: [20, 20],
                                iconAnchor: [10, 10]
                            })
                        }).addTo(map);
                        
                        userMarker.bindPopup(`
                            <div style="text-align: center; padding: 8px;">
                                <strong style="color: #667eea;">üìç You are here</strong><br>
                                <small style="color: #666;">Accuracy: ~${Math.round(accuracy)}m</small>
                            </div>
                        `).openPopup();
                        
                        markers.push(userMarker);
                        
                        // Get category from Near Me dropdown (not ZIP dropdown)
                        const category = document.getElementById('nearMeCategory').value;
                        const restaurantType = document.getElementById('nearMeRestaurantTypeSelect')?.value || null;
                        const radiusMiles = parseFloat(document.getElementById('nearMeRadius').value) || 2;
                        const radiusMeters = radiusMiles * 1609.34;
                        
                        console.log(`Near Me search: category=${category}, restaurantType=${restaurantType}, radius=${radiusMiles}mi`);
                        
                        // Search for stores using existing function
                        await searchStores(lat, lon, radiusMeters, category, '', restaurantType);
                        
                        showResult(`‚úÖ Found stores near your location!\nüìä Calculating EJV 4.1 values...`);
                        showLoading(false);
                        
                    } catch (error) {
                        console.error('Error searching near me:', error);
                        showResult(`‚ùå Error finding stores: ${error.message}`);
                        showLoading(false);
                    }
                },
                (error) => {
                    console.error('Geolocation error:', error);
                    
                    let errorMessage = '';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage = '‚ùå Location access denied\n\nüí° To enable:\n1. Click the location icon in your browser\'s address bar\n2. Allow location access\n3. Try "Near Me" again\n\nOr use ZIP code search instead.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage = '‚ùå Location unavailable\n\nYour device cannot determine your location.\nPlease use ZIP code search instead.';
                            break;
                        case error.TIMEOUT:
                            errorMessage = '‚ùå Location request timed out\n\nPlease try again or use ZIP code search.';
                            break;
                        default:
                            errorMessage = '‚ùå Error getting location\n\nPlease use ZIP code search instead.';
                    }
                    
                    showResult(errorMessage);
                    showLoading(false);
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 300000  // Cache for 5 minutes
                }
            );
        }

        async function searchByZip() {
            console.log('üîç searchByZip called');
            
            // Clear previous results FIRST to prevent mixing
            console.log('üßπ Clearing previous search data before ZIP search');
            clearMarkers();
            allStoresEJV = [];
            ejvCache = {};
            rawStores = [];
            window.storeData = [];
            
            try {
                const zip = document.getElementById('zipInput')?.value.trim();
                console.log('ZIP value:', zip);
                const radius = document.getElementById('zipRadius')?.value || 2;
                let category = document.getElementById('zipCategory')?.value || 'all';
                let restaurantType = null;
                console.log('Radius:', radius, 'Category:', category);
                
                if (!zip) {
                    showResult('Please enter a ZIP code');
                    return;
                }
                
                // Save current ZIP for EJV calculations
                currentZip = zip;
                
                // Increment search count for User Dashboard
                if (typeof incrementSearchCount === 'function') {
                    incrementSearchCount();
                    console.log('Search count incremented');
                }
                
                // Check if restaurant type filter is selected
                if (category === 'restaurant') {
                    const restaurantTypeSelect = document.getElementById('zipRestaurantTypeSelect');
                    if (restaurantTypeSelect && restaurantTypeSelect.value !== 'all') {
                        restaurantType = restaurantTypeSelect.value;
                        console.log('Restaurant type filter:', restaurantType);
                    }
                }
                
                // Check if custom search
                if (category === 'custom') {
                    const customValue = document.getElementById('zipCustomInput')?.value.trim();
                    if (!customValue) {
                        showResult('Please enter a business type');
                        return;
                    }
                    category = customValue;
                }

                showLoading(true);
                showResult('Geocoding ZIP code...');
                console.log('Starting geocode for ZIP:', zip);

                // Geocode ZIP code using Nominatim
                const geocodeUrl = `https://nominatim.openstreetmap.org/search?format=json&postalcode=${zip}&country=USA`;
                console.log('Geocode URL:', geocodeUrl);
                
                const geocodeResponse = await fetch(geocodeUrl);
                console.log('Geocode response status:', geocodeResponse.status);
                
                if (!geocodeResponse.ok) {
                    throw new Error(`Geocoding failed: ${geocodeResponse.status}`);
                }
                
                const geocodeData = await geocodeResponse.json();
                console.log('Geocode results:', geocodeData.length);

                if (geocodeData.length === 0) {
                    showResult(`ZIP code ${zip} not found. Please try a different ZIP code.`);
                    showLoading(false);
                    return;
                }

                const lat = parseFloat(geocodeData[0].lat);
                const lon = parseFloat(geocodeData[0].lon);
                console.log('Coordinates found:', lat, lon);
                console.log('Map object exists:', !!map);

                if (!map) {
                    showResult('Map not initialized. Please refresh the page and try again.');
                    showLoading(false);
                    return;
                }

                console.log('Setting map view...');
                map.setView([lat, lon], 13);
                console.log('Map view set successfully');
                
                console.log('Calling searchStores with:', { lat, lon, radius: radius * 1609.34, category, restaurantType });
                await searchStores(lat, lon, radius * 1609.34, category, '', restaurantType);
                console.log('searchStores completed successfully');

            } catch (error) {
                console.error('‚ùå Search error:', error);
                showResult(`Error: ${error.message || 'Search failed'}. Please try again.`);
            } finally {
                showLoading(false);
            }
        }
        
        // Find Stores by Address
        async function findStoresByAddress() {
            const streetAddress = document.getElementById('addressSearchInput').value.trim();
            const cityOrZip = document.getElementById('addressCityInput').value.trim();
            const radius = parseFloat(document.getElementById('addressSearchRadius').value);

            if (!cityOrZip) {
                showResult('Please enter a city or ZIP code');
                return;
            }

            // Clear previous results FIRST to prevent mixing
            console.log('üßπ Clearing previous search data before address search');
            clearMarkers();
            allStoresEJV = [];
            ejvCache = {};
            rawStores = [];
            window.storeData = [];

            showLoading(true);
            showResult(`Finding stores on "${streetAddress}" in ${cityOrZip}...`);

            try {
                // Search for stores on the specific street using Nominatim
                const searchQuery = `${streetAddress}, ${cityOrZip}`;
                const searchUrl = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(searchQuery)}&limit=50&addressdetails=1`;
                
                const response = await fetch(searchUrl);
                const results = await response.json();

                if (results.length === 0) {
                    showResult(`No results found for "${streetAddress}" in ${cityOrZip}. Try a different address.`);
                    showLoading(false);
                    return;
                }

                // Get center point (first result)
                const centerLat = parseFloat(results[0].lat);
                const centerLon = parseFloat(results[0].lon);
                
                // Center map on location
                map.setView([centerLat, centerLon], 15);

                showResult(`Searching for places on ${streetAddress}...`);
                
                // Filter results by street name and radius
                const lowerSearchTerm = streetAddress.toLowerCase();
                const radiusMeters = radius * 1609.34;
                
                const storeResults = results.filter(result => {
                    // Check if on the correct street
                    const street = (result.address?.road || '').toLowerCase();
                    const displayName = result.display_name.toLowerCase();
                    
                    // Must match street name
                    const matchesStreet = street.includes(lowerSearchTerm) || displayName.includes(lowerSearchTerm);
                    if (!matchesStreet) return false;
                    
                    // Check radius
                    const lat = parseFloat(result.lat);
                    const lon = parseFloat(result.lon);
                    const distance = calculateDistance(centerLat, centerLon, lat, lon);
                    
                    return distance <= radiusMeters;
                });

                if (storeResults.length === 0) {
                    showResult(`No stores found on "${streetAddress}" in ${cityOrZip}. Try: 1) Different street name 2) Larger radius 3) Different city`);
                    showLoading(false);
                    return;
                }

                showResult(`Found ${storeResults.length} store(s) on "${streetAddress}". Adding to map...`);

                // Process each store
                let processedCount = 0;
                for (const store of storeResults) {
                    const storeLat = parseFloat(store.lat);
                    const storeLon = parseFloat(store.lon);
                    
                    if (!storeLat || !storeLon) continue;
                    
                    const name = store.name || store.display_name.split(',')[0];
                    const address = store.display_name;
                    const distance = calculateDistance(centerLat, centerLon, storeLat, storeLon);
                    const zipCode = store.address?.postcode || currentZip || '10001';
                    
                    // Determine category from class/type
                    let category = 'all';
                    if (store.class === 'shop') {
                        category = store.type || 'all';
                    } else if (store.class === 'amenity') {
                        if (store.type === 'restaurant' || store.type === 'fast_food') {
                            category = 'restaurant';
                        } else if (store.type === 'pharmacy') {
                            category = 'pharmacy';
                        } else if (store.type === 'cafe') {
                            category = 'coffee';
                        } else {
                            category = store.type || 'all';
                        }
                    }

                    // Add to storeData
                    const storeInfo = {
                        name: name,
                        address: address,
                        lat: storeLat,
                        lon: storeLon,
                        distance: distance,
                        category: category,
                        zipCode: zipCode,
                        ejv: null,
                        rawScore: null,
                        breakdown: null
                    };

                    window.storeData.push(storeInfo);

                    // Get category icon
                    const categoryIcon = getCategoryIcon(category);

                    // Add marker
                    const marker = L.marker([storeLat, storeLon], {
                        icon: L.divIcon({
                            className: 'custom-div-icon',
                            html: `<div style="background-color: #28a745; width: 32px; height: 32px; border-radius: 50%; border: 3px solid white; box-shadow: 0 3px 8px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; font-size: 16px;">${categoryIcon}</div>`,
                            iconSize: [32, 32],
                            iconAnchor: [16, 16]
                        })
                    });

                    // Bind hover event
                    marker.on('mouseover', function() {
                        displayStoreInfoOnHover(processedCount);
                    });

                    marker.on('click', function() {
                        displayStoreInfoOnHover(processedCount);
                    });

                    // Create popup
                    const popupContent = `
                        <div style="min-width: 220px;">
                            <strong style="font-size: 14px;">${name}</strong><br>
                            <span style="font-size: 11px; color: #666;">${address}</span><br>
                            <div style="margin-top: 8px; padding: 6px; background: #f5f5f5; border-radius: 4px; font-size: 11px;">
                                üìè ${(distance / 1000).toFixed(2)} km away
                            </div>
                            <button onclick="calculateSingleStoreEJV(${processedCount})" style="margin-top: 8px; padding: 8px 14px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; width: 100%; font-weight: 600;">
                                Calculate EJV
                            </button>
                        </div>
                    `;

                    marker.bindPopup(popupContent);
                    marker.addTo(map);
                    markers.push(marker);

                    processedCount++;
                }

                // Display results
                displayQuickFindResults(window.storeData);

                // Fit map to show all markers
                if (markers.length > 0) {
                    const group = L.featureGroup(markers);
                    map.fitBounds(group.getBounds().pad(0.1));
                }

                showResult(`‚úì Found ${processedCount} store(s) on "${streetAddress}". Calculating EJV for top results...`);
                
                // Calculate EJV for top 3 stores
                for (let i = 0; i < Math.min(3, window.storeData.length); i++) {
                    await calculateSingleStoreEJV(i);
                    await new Promise(resolve => setTimeout(resolve, 100));
                }

            } catch (error) {
                console.error('Find by address error:', error);
                showResult(`Error: ${error.message}. Please try again.`);
            } finally {
                showLoading(false);
            }
        }

        async function searchByAddress() {
            const address = document.getElementById('addressInput').value.trim();
            const radius = document.getElementById('addressRadius').value;
            let category = document.getElementById('addressCategory').value;
            
            // Check if custom search
            if (category === 'custom') {
                const customValue = document.getElementById('addressCustomInput').value.trim();
                if (!customValue) {
                    showResult('Please enter a business type');
                    return;
                }
                category = customValue;
            }

            if (!address) {
                showResult('Please enter an address');
                return;
            }

            // Clear previous results FIRST to prevent mixing
            console.log('üßπ Clearing previous search data before address search');
            clearMarkers();
            allStoresEJV = [];
            ejvCache = {};
            rawStores = [];
            window.storeData = [];

            showLoading(true);
            showResult('Geocoding address...');

            try {
                // Geocode address using Nominatim
                const geocodeUrl = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`;
                const geocodeResponse = await fetch(geocodeUrl);
                const geocodeData = await geocodeResponse.json();

                if (geocodeData.length === 0) {
                    showResult('Address not found');
                    showLoading(false);
                    return;
                }

                const lat = parseFloat(geocodeData[0].lat);
                const lon = parseFloat(geocodeData[0].lon);
                const displayName = geocodeData[0].display_name;

                // Center map on the address
                map.setView([lat, lon], 16);

                // Add a single marker for the entered address
                const marker = L.marker([lat, lon], {
                    icon: L.divIcon({
                        className: 'custom-div-icon',
                        html: `<div style="background-color: #28a745; width: 32px; height: 32px; border-radius: 50%; border: 3px solid white; box-shadow: 0 3px 8px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; font-size: 16px;">üìç</div>`,
                        iconSize: [32, 32],
                        iconAnchor: [16, 16]
                    })
                });

                // Create popup for the address
                const popupContent = `
                    <div style="min-width: 220px;">
                        <strong style="font-size: 14px;">Selected Location</strong><br>
                        <span style="font-size: 11px; color: #666;">${displayName}</span><br>
                        <button onclick="calculateSingleStoreEJV(0)" style="margin-top: 8px; padding: 8px 14px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; width: 100%; font-weight: 600;">
                            Calculate EJV
                        </button>
                    </div>
                `;

                marker.bindPopup(popupContent);
                marker.addTo(map);
                marker.openPopup();
                markers.push(marker);

                // Add to storeData for EJV calculation
                const storeInfo = {
                    name: address,
                    address: displayName,
                    lat: lat,
                    lon: lon,
                    distance: 0,
                    category: category === 'all' ? 'all' : category,
                    zipCode: geocodeData[0].address?.postcode || '10001',
                    ejv: null,
                    rawScore: null,
                    breakdown: null
                };

                window.storeData.push(storeInfo);

                // Display the single address in results
                displayQuickFindResults(window.storeData);

                showResult(`‚úì Location found: ${displayName}`);

            } catch (error) {
                console.error('Error:', error);
                showResult('Error searching address: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        // Open Google Maps search in new tab
        function searchOnGoogleMaps() {
            const storeName = document.getElementById('storeNameInput').value.trim();
            const location = document.getElementById('storeLocationInput').value.trim();

            if (!storeName) {
                showResult('Please enter a store name');
                return;
            }

            if (!location) {
                showResult('Please enter a location');
                return;
            }

            // Create Google Maps search URL
            const query = encodeURIComponent(`${storeName} near ${location}`);
            const googleMapsUrl = `https://www.google.com/maps/search/${query}`;
            
            // Open in new tab
            window.open(googleMapsUrl, '_blank');
            showResult(`Opening Google Maps search for "${storeName}" near ${location}...`);
        }

        async function searchByStoreName() {
            const storeName = document.getElementById('storeNameInput').value.trim();
            const location = document.getElementById('storeLocationInput').value.trim();
            const radius = document.getElementById('storeNameRadius').value;
            const apiKey = document.getElementById('googleApiKey').value.trim();

            if (!storeName) {
                showResult('Please enter a store name');
                return;
            }

            if (!location) {
                showResult('Please enter a location (city, state, or address)');
                return;
            }

            // Clear previous markers and data FIRST to prevent mixing results
            console.log('üßπ Clearing previous search data before new store name search');
            clearMarkers();
            allStoresEJV = [];
            ejvCache = {};
            rawStores = [];
            window.storeData = [];

            // If Google API key is provided, use Google Places API
            if (apiKey) {
                return searchWithGooglePlaces(storeName, location, radius, apiKey);
            }

            showLoading(true);
            showResult('Searching for "' + storeName + '" in ' + location + '...');

            try {
                // First, geocode the location
                const locationUrl = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(location)}`;
                const locationResponse = await fetch(locationUrl);
                const locationData = await locationResponse.json();

                if (locationData.length === 0) {
                    showResult('Location not found. Please try a different location.');
                    showLoading(false);
                    return;
                }

                const lat = parseFloat(locationData[0].lat);
                const lon = parseFloat(locationData[0].lon);

                // Center map on location
                map.setView([lat, lon], 13);

                showResult('Geocoded location. Now searching for stores...');

                // Search for the store name using Nominatim
                const storeSearchUrl = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(storeName + ' ' + location)}&limit=50`;
                const storeResponse = await fetch(storeSearchUrl);
                const storeData = await storeResponse.json();

                if (storeData.length === 0) {
                    showResult('No stores found matching "' + storeName + '" in ' + location);
                    showLoading(false);
                    return;
                }

                // Filter results to be within the specified radius
                const radiusMeters = radius * 1609.34; // Convert miles to meters
                const nearbyStores = storeData.filter(store => {
                    const storeLat = parseFloat(store.lat);
                    const storeLon = parseFloat(store.lon);
                    const distance = calculateDistance(lat, lon, storeLat, storeLon);
                    return distance <= radiusMeters;
                });

                if (nearbyStores.length === 0) {
                    showResult('No stores found within ' + radius + ' miles of ' + location);
                    showLoading(false);
                    return;
                }

                showResult(`Found ${nearbyStores.length} matching store(s)`);

                // Process each store found
                const processedStores = [];
                for (const store of nearbyStores) {
                    const storeLat = parseFloat(store.lat);
                    const storeLon = parseFloat(store.lon);
                    const storeDisplayName = store.display_name;
                    
                    // Extract store name from display_name
                    const name = storeDisplayName.split(',')[0];

                    // Determine category based on store type
                    const category = determineStoreCategory(store);

                    // Create store object in Overpass format for consistency with displayStores()
                    const storeObj = {
                        id: `nominatim_${store.place_id || store.osm_id}`,
                        lat: storeLat,
                        lon: storeLon,
                        tags: {
                            name: name,
                            'addr:full': storeDisplayName,
                            shop: category,
                            // Add address components if available
                            'addr:housenumber': store.address?.house_number,
                            'addr:street': store.address?.road,
                            'addr:city': store.address?.city || store.address?.town
                        }
                    };

                    processedStores.push(storeObj);
                }

                // Use displayStores() which handles EJV calculation on hover
                displayStores(processedStores);

                // Fit map to show all markers
                if (markers.length > 0) {
                    const group = L.featureGroup(markers);
                    map.fitBounds(group.getBounds().pad(0.1));
                }

            } catch (error) {
                console.error('Error:', error);
                showResult('Error searching for store: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        // Search using Google Places API for better results
        async function searchWithGooglePlaces(storeName, location, radius, apiKey) {
            showLoading(true);
            showResult('Searching with Google Places API for "' + storeName + '" in ' + location + '...');

            try {
                // First, geocode the location using Google Geocoding API
                const geocodeUrl = `https://maps.googleapis.com/maps/api/geocode/json?address=${encodeURIComponent(location)}&key=${apiKey}`;
                const geocodeResponse = await fetch(geocodeUrl);
                const geocodeData = await geocodeResponse.json();

                if (geocodeData.status !== 'OK' || geocodeData.results.length === 0) {
                    showResult('Location not found. Error: ' + geocodeData.status);
                    showLoading(false);
                    return;
                }

                const lat = geocodeData.results[0].geometry.location.lat;
                const lon = geocodeData.results[0].geometry.location.lng;

                // Center map on location
                map.setView([lat, lon], 13);

                // Search for places using Google Places API (nearby search)
                const radiusMeters = radius * 1609.34; // Convert miles to meters
                const placesUrl = `https://maps.googleapis.com/maps/api/place/nearbysearch/json?location=${lat},${lon}&radius=${radiusMeters}&keyword=${encodeURIComponent(storeName)}&key=${apiKey}`;
                
                // Need to use a CORS proxy for client-side API calls
                const proxyUrl = 'https://cors-anywhere.herokuapp.com/';
                const placesResponse = await fetch(proxyUrl + placesUrl);
                const placesData = await placesResponse.json();

                if (placesData.status !== 'OK' || !placesData.results || placesData.results.length === 0) {
                    showResult('No stores found. Try using the "Google Maps" button or check your API key.');
                    showLoading(false);
                    return;
                }

                showResult(`Found ${placesData.results.length} matching store(s) using Google Places`);

                // Process each place found
                const processedStores = [];
                for (const place of placesData.results) {
                    const storeLat = place.geometry.location.lat;
                    const storeLon = place.geometry.location.lng;
                    const name = place.name;
                    const address = place.vicinity || place.formatted_address || 'Address not available';

                    // Determine category
                    const category = determineGooglePlaceCategory(place);

                    // Create store object in Overpass format for consistency with displayStores()
                    const storeObj = {
                        id: `google_${place.place_id}`,
                        lat: storeLat,
                        lon: storeLon,
                        tags: {
                            name: name,
                            'addr:full': address,
                            shop: category,
                            source: 'Google Places'
                        }
                    };

                    processedStores.push(storeObj);
                }

                // Use displayStores() which handles EJV calculation on hover
                displayStores(processedStores);

                // Fit map to show all markers
                if (markers.length > 0) {
                    const group = L.featureGroup(markers);
                    map.fitBounds(group.getBounds().pad(0.1));
                }

            } catch (error) {
                console.error('Error:', error);
                showResult('Error with Google Places API: ' + error.message + '. Try using the "Google Maps" button instead.');
            } finally {
                showLoading(false);
            }
        }

        // Determine category from Google Place types
        function determineGooglePlaceCategory(place) {
            const types = place.types || [];
            
            if (types.includes('supermarket') || types.includes('grocery_or_supermarket')) {
                return 'supermarket';
            } else if (types.includes('pharmacy') || types.includes('drugstore')) {
                return 'pharmacy';
            } else if (types.includes('cafe') || types.includes('coffee_shop')) {
                return 'coffee';
            } else if (types.includes('restaurant') || types.includes('food') || types.includes('meal_takeaway')) {
                return 'restaurant';
            } else if (types.includes('convenience_store')) {
                return 'convenience';
            } else if (types.includes('electronics_store')) {
                return 'electronics';
            }

            return 'all';
        }

        // Helper function to determine store category based on Nominatim data
        function determineStoreCategory(store) {
            const type = store.type ? store.type.toLowerCase() : '';
            const className = store.class ? store.class.toLowerCase() : '';
            const displayName = store.display_name ? store.display_name.toLowerCase() : '';

            // Categorize based on keywords
            if (displayName.includes('walmart') || displayName.includes('target') || displayName.includes('kroger') || 
                displayName.includes('safeway') || displayName.includes('whole foods') || type === 'supermarket') {
                return 'supermarket';
            } else if (displayName.includes('cvs') || displayName.includes('walgreens') || displayName.includes('pharmacy') || 
                       type === 'pharmacy') {
                return 'pharmacy';
            } else if (displayName.includes('starbucks') || displayName.includes('coffee') || displayName.includes('cafe') || 
                       type === 'cafe') {
                return 'coffee';
            } else if (displayName.includes('mcdonald') || displayName.includes('burger') || displayName.includes('restaurant') || 
                       className === 'amenity' && type === 'restaurant') {
                return 'restaurant';
            } else if (displayName.includes('7-eleven') || displayName.includes('convenience') || type === 'convenience') {
                return 'convenience';
            } else if (displayName.includes('best buy') || displayName.includes('electronics') || type === 'electronics') {
                return 'electronics';
            }

            return 'all'; // Default category
        }

        // Helper function to display store results
        function displayStoreResults(stores) {
            const storeList = document.getElementById('storeList');
            storeList.innerHTML = '';

            stores.forEach((store, index) => {
                const storeItem = document.createElement('div');
                storeItem.className = `store-item ${store.category}`;
                storeItem.innerHTML = `
                    <div class="store-name">
                        <span class="store-icon">${getCategoryIcon(store.category)}</span>
                        ${store.name}
                    </div>
                    <div class="store-address">${store.address}</div>
                    <div style="font-size: 11px; color: #999; margin-top: 3px;">
                        üìè ${(store.distance / 1000).toFixed(2)} km away
                    </div>
                `;
                
                storeItem.onclick = () => {
                    // Zoom to the store on map
                    map.setView([store.lat, store.lon], 16);
                    // Highlight the marker
                    if (markers[index]) {
                        markers[index].openPopup();
                    }
                };

                storeList.appendChild(storeItem);
            });
        }

        // Helper function to get category icon
        function getCategoryIcon(category) {
            const icons = {
                'supermarket': 'üõí',
                'pharmacy': 'üíä',
                'restaurant': 'üçΩÔ∏è',
                'cafe': '‚òï',
                'fast_food': 'üçî',
                'convenience': 'üè™',
                'coffee': '‚òï',
                'electronics': 'üì±',
                'bank': 'üè¶',
                'all': 'üè¢'
            };
            return icons[category] || 'üè™';
        }

        async function searchStores(lat, lon, radiusMeters, category, filterStoreAddress = '', restaurantType = null) {
            clearMarkers();
            
            // Clear previous search data to prevent mixing results
            allStoresEJV = [];
            ejvCache = {};
            rawStores = [];
            storeData = [];
            
            if (restaurantType && restaurantType !== 'all') {
                showResult(`Searching for ${restaurantType} restaurants...`);
            } else {
                showResult('Searching for stores...');
            }

            try {
                // Build Overpass query based on category
                let query;
                if (category === 'all') {
                    query = `[out:json][timeout:15];
(
  node["shop"](around:${radiusMeters},${lat},${lon});
  way["shop"](around:${radiusMeters},${lat},${lon});
  node["amenity"="restaurant"](around:${radiusMeters},${lat},${lon});
  way["amenity"="restaurant"](around:${radiusMeters},${lat},${lon});
);
out center;`;

                } else if (category === 'restaurant') {
                    // Restaurants use amenity tag, not shop tag
                    if (restaurantType && restaurantType !== 'all') {
                        // Filter by specific cuisine type using word boundary matching
                        // This ensures "mexican" doesn't match "indian" or other cuisines
                        query = `[out:json][timeout:30];
(
  node["amenity"="restaurant"]["cuisine"~"(^|;)${restaurantType}(;|$)",i](around:${radiusMeters},${lat},${lon});
  way["amenity"="restaurant"]["cuisine"~"(^|;)${restaurantType}(;|$)",i](around:${radiusMeters},${lat},${lon});
  node["amenity"="fast_food"]["cuisine"~"(^|;)${restaurantType}(;|$)",i](around:${radiusMeters},${lat},${lon});
  way["amenity"="fast_food"]["cuisine"~"(^|;)${restaurantType}(;|$)",i](around:${radiusMeters},${lat},${lon});
);
out center;`;
                    } else {
                        // All restaurants
                        query = `[out:json][timeout:30];
(
  node["amenity"="restaurant"](around:${radiusMeters},${lat},${lon});
  way["amenity"="restaurant"](around:${radiusMeters},${lat},${lon});
  node["amenity"="fast_food"](around:${radiusMeters},${lat},${lon});
  way["amenity"="fast_food"](around:${radiusMeters},${lat},${lon});
);
out center;`;
                    }
                } else if (category === 'pharmacy') {
                    // Pharmacies use amenity tag in OSM
                    query = `[out:json][timeout:30];
(
  node["amenity"="pharmacy"](around:${radiusMeters},${lat},${lon});
  way["amenity"="pharmacy"](around:${radiusMeters},${lat},${lon});
);
out center;`;
                } else if (category === 'coffee') {
                    // Coffee shops use amenity=cafe in OSM
                    query = `[out:json][timeout:30];
(
  node["amenity"="cafe"](around:${radiusMeters},${lat},${lon});
  way["amenity"="cafe"](around:${radiusMeters},${lat},${lon});
  node["shop"="coffee"](around:${radiusMeters},${lat},${lon});
  way["shop"="coffee"](around:${radiusMeters},${lat},${lon});
);
out center;`;
                } else {
                    const categoryMap = {
                        'supermarket': 'supermarket',
                        'convenience': 'convenience',
                        'electronics': 'electronics'
                    };
                    const shopValue = categoryMap[category] || category; // Use direct value if not in map
                    // Only search shop tag for these categories (not amenity) to prevent wrong results
                    query = `[out:json][timeout:30];
(
  node["shop"="${shopValue}"](around:${radiusMeters},${lat},${lon});
  way["shop"="${shopValue}"](around:${radiusMeters},${lat},${lon});
);
out center;`;
                }

                console.log('Sending query to backend proxy...');
                console.log('Query:', query.substring(0, 100) + '...');
                showResult('Searching for stores...');
                
                // Use our backend proxy instead of calling Overpass directly
                const response = await fetch('/api/overpass', {
                    method: 'POST',
                    body: query
                });

                console.log('Proxy response status:', response.status, response.statusText);
                
                if (!response.ok) {
                    // Try to get error details
                    let errorData;
                    try {
                        const responseText = await response.text();
                        console.error('Backend error response (text):', responseText);
                        errorData = JSON.parse(responseText);
                    } catch (parseError) {
                        console.error('Could not parse error response:', parseError);
                        errorData = { error: `Server returned ${response.status}: ${response.statusText}` };
                    }
                    
                    const errorMsg = errorData.error || `Server returned ${response.status}: ${response.statusText}`;
                    const details = errorData.details ? `\n${errorData.details}` : '';
                    
                    throw new Error(errorMsg + details);
                }

                const data = await response.json();
                console.log('Backend response data:', data);
                
                if (data.error) {
                    console.error('Overpass error:', data.error);
                    const fullError = data.details ? `${data.error}\nDetails: ${data.details}` : data.error;
                    throw new Error(fullError);
                }
                
                console.log('‚úì Got response:', data.elements?.length || 0, 'elements');
                const stores = data.elements;

                if (!stores || stores.length === 0) {
                    showResult('No stores found in this area. Try: (1) Larger radius, (2) Different category, or (3) Different location.');
                    document.getElementById('storeList').innerHTML = '<div style="padding: 10px; color: #666; font-size: 12px;">üí° Tip: Some areas have limited data. Try searching in major cities or use "All Stores" category.</div>';
                    console.warn('No stores returned from Overpass API');
                    return;
                }

                console.log(`Found ${stores.length} stores, calling displayStores`);
                console.log('Sample store data:', stores[0]);
                showResult(`Found ${stores.length} store(s) - Calculating EJV scores...`);
                
                displayStores(stores);
                console.log(`Markers on map: ${markers.length}`);
                
                // Auto-calculate EJV for all stores to enable comparison
                setTimeout(async () => {
                    const storesToCalculate = filteredStores.slice(0, Math.min(filteredStores.length, 20)); // Limit to 20 stores
                    for (const store of storesToCalculate) {
                        try {
                            const storeName = store.tags?.brand || store.tags?.name || store.tags?.shop || store.tags?.amenity || 'Unnamed Store';
                            
                            // Extract and store address/website data with the store
                            const addrParts = [
                                store.tags?.['addr:housenumber'],
                                store.tags?.['addr:street'],
                                store.tags?.['addr:city'],
                                store.tags?.['addr:state']
                            ].filter(Boolean);
                            const storeAddress = addrParts.join(' ');
                            const storeWebsite = store.tags?.website || store.tags?.['contact:website'] || store.tags?.url || null;
                            
                            // Store temporarily so calculateEJV can access it
                            store._cachedAddress = storeAddress;
                            store._cachedWebsite = storeWebsite;
                            
                            await calculateEJV(store.id, storeName, false);
                        } catch (ejvError) {
                            console.warn(`Failed to calculate EJV for store ${store.id}:`, ejvError);
                            // Continue with next store even if this one fails
                        }
                    }
                    showResult(`Found ${stores.length} store(s) - Ready to compare!`);
                    console.log('EJV calculation complete for all stores');
                }, 500);

            } catch (error) {
                console.error('Error:', error);
                const errorMessage = error.message || 'Unknown error occurred';
                
                // Detect 503 errors specifically
                const is503Error = errorMessage.includes('503') || errorMessage.includes('unavailable') || errorMessage.includes('Service unavailable');
                
                // Show user-friendly error with retry button
                showResult(`‚ùå ${errorMessage}`);
                
                // Add retry button to store list with specific guidance for 503
                const storeListDiv = document.getElementById('storeList');
                const bgColor = is503Error ? '#ffe6e6' : '#fff3cd';
                const borderColor = is503Error ? '#dc3545' : '#ffc107';
                const textColor = is503Error ? '#721c24' : '#856404';
                
                storeListDiv.innerHTML = `
                    <div style="padding: 15px; background: ${bgColor}; border-left: 4px solid ${borderColor}; border-radius: 6px; margin: 10px 0;">
                        <div style="font-size: 13px; color: ${textColor}; margin-bottom: 10px;">
                            <strong>${is503Error ? 'üî¥ Server Overload (503)' : '‚ö†Ô∏è Search Failed'}</strong><br>
                            ${errorMessage.replace(/\n/g, '<br>')}
                        </div>
                        <div style="font-size: 12px; color: ${textColor}; margin-bottom: 10px;">
                            <strong>${is503Error ? 'Quick Fixes:' : 'Suggestions:'}</strong><br>
                            ${is503Error ? 
                                '‚Ä¢ <strong>Reduce radius to 1 mile</strong> and retry immediately<br>‚Ä¢ Try a major city like New York, Los Angeles, Chicago<br>‚Ä¢ Wait 60 seconds if all servers are busy<br>‚Ä¢ Use "Grocery" or "Restaurant" categories (better data)' :
                                '‚Ä¢ Reduce search radius (try 1-2 miles)<br>‚Ä¢ Wait 30 seconds and try again<br>‚Ä¢ Try a different location or category<br>‚Ä¢ Search in major cities for better results'}
                        </div>
                        <button onclick="location.reload()" 
                                style="background: ${borderColor}; color: ${is503Error ? '#fff' : '#000'}; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; font-weight: 600;">
                            üîÑ Refresh & Retry
                        </button>
                    </div>
                `;
            }
        }
        function displayStores(stores) {
            const storeListDiv = document.getElementById('storeList');
            storeListDiv.innerHTML = '';
            storeData = [];
            rawStores = stores; // Save for re-rendering
            
            // Save search results globally for User Dashboard
            window.lastSearchResults = stores;

            console.log(`Displaying ${stores.length} stores on map`);
            console.log('Map object:', map);
            console.log('Leaflet loaded:', typeof L !== 'undefined');

            if (!map) {
                console.error('Map is not initialized!');
                showResult('Error: Map not initialized');
                return;
            }

            stores.forEach((store, index) => {
                const lat = store.lat || store.center?.lat;
                const lon = store.lon || store.center?.lon;

                if (!lat || !lon) {
                    console.log('Skipping store - no coordinates:', store);
                    return;
                }

                const storeName = store.tags?.brand || store.tags?.name || store.tags?.shop || store.tags?.amenity || 'Unnamed Store';
                let shopType = store.tags?.shop || store.tags?.amenity || 'default';
                const cuisineType = store.tags?.cuisine || null;
                
                // Detect warehouse clubs
                if (shopType === 'wholesale' || /costco|sam's club|bj's wholesale/i.test(storeName)) {
                    shopType = 'warehouse';
                }
                // Normalize restaurant types
                if (shopType === 'fast_food' || shopType === 'restaurant') {
                    shopType = 'restaurant';
                }
                
                const storeIcon = getStoreIcon(shopType);
                console.log(`Creating marker for ${storeName} (type: ${shopType}) with icon ${storeIcon.icon}`);
                
                const address = [
                    store.tags?.['addr:housenumber'],
                    store.tags?.['addr:street'],
                    store.tags?.['addr:city']
                ].filter(Boolean).join(' ');

                // Extract website from OSM tags
                const website = store.tags?.website || 
                               store.tags?.['contact:website'] || 
                               store.tags?.url || null;

                // Store data for dashboard
                storeData.push({
                    id: store.id,
                    name: storeName,
                    address: address || 'No address available',
                    type: shopType,
                    lat: lat,
                    lon: lon,
                    website: website,
                    tags: store.tags
                });

                // Fetch health score for restaurants
                let healthScoreHtml = '';
                if (shopType === 'restaurant') {
                    // We'll fetch this asynchronously and update
                    fetchHealthScore(store.id, storeName, lat, lon, address);
                }

                // Create custom marker with icon
                const customIcon = L.divIcon({
                    className: 'custom-marker',
                    html: `<div style="font-size: 36px; text-shadow: 2px 2px 6px rgba(0,0,0,0.5), 0 0 10px rgba(255,255,255,0.3);">${storeIcon.icon}</div>`,
                    iconSize: [40, 40],
                    iconAnchor: [20, 40]
                });

                console.log(`Adding marker at [${lat}, ${lon}]`);

                try {
                    const marker = L.marker([lat, lon], { icon: customIcon }).addTo(map);
                    markers.push(marker);
                    console.log(`Marker added successfully, total markers: ${markers.length}`);
                    
                    // Store reference for impact circle
                    marker.storeId = store.id;
                    marker.storeName = storeName;
                    
                    // Auto-calculate on hover with minimal debouncing (cached responses are instant)
                    marker.on('mouseover', async function(e) {
                        clearTimeout(hoverDebounceTimer);
                        hoverDebounceTimer = setTimeout(async () => {
                            console.log(`Map marker hover: ${storeName}, showing EJV on dashboard`);
                            const ejvData = await calculateEJV(store.id, storeName, true);
                            if (ejvData) {
                                showImpactCircle(e.latlng, ejvData.elvr || 0);
                            }
                        }, 50); // 50ms debounce - instant for cached data
                    });
                    
                    marker.on('mouseout', function() {
                        clearTimeout(hoverDebounceTimer);
                        hideImpactCircle();
                    });
                    
                    const popupContent = `
                        <div style="min-width: 220px;">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                <span style="font-size: 28px;">${storeIcon.icon}</span>
                                <strong style="flex: 1; font-size: 14px;">${storeName}</strong>
                            </div>
                            ${address ? `<div style="font-size: 12px; color: #666; margin-bottom: 8px;" title="Store address from OpenStreetMap">üìç ${address}</div>` : ''}
                            <div style="font-size: 12px; color: #666; margin-bottom: 8px;">
                                üåê ${website ? `<a href="${website}" target="_blank" rel="noopener noreferrer" style="color: #667eea; text-decoration: none; font-weight: 600;" title="Visit ${storeName} website">Visit Website</a>` : '<span style="color: #999;" title="Website information not available">Website not available</span>'}
                            </div>
                            <div style="background: #f8f9fa; padding: 8px; border-radius: 5px; margin-bottom: 10px;">
                                <small style="color: #666;">Category: <strong style="color: ${storeIcon.color};">${shopType}</strong></small>
                                ${cuisineType ? `<br><small style="color: #666;">Cuisine: <strong style="color: #ff6b6b;">üç¥ ${cuisineType}</strong></small>` : ''}
                            </div>
                            ${shopType === 'restaurant' ? `<div id="health-score-popup-${store.id}" style="font-size: 11px; color: #666; margin-bottom: 8px;">üè• Loading health score...</div>` : ''}
                            <div style="text-align: center; color: #667eea; font-size: 11px; font-style: italic;">Hover to see EJV scores on dashboard ‚Üí</div>
                        </div>
                    `;
                    marker.bindPopup(popupContent);
                } catch (markerError) {
                    console.error('Error creating marker:', markerError);
                }

                // Create store list item with LOCATOR UI pattern
                const storeItem = document.createElement('div');
                storeItem.className = `store-item ${shopType}`;
                storeItem.style.transition = 'all 0.2s ease';
                storeItem.style.position = 'relative';
                storeItem.innerHTML = `
                    <div class="store-name" style="font-weight: 600; margin-bottom: 6px; display: flex; align-items: center; gap: 6px;">
                        <span class="store-icon">${storeIcon.icon}</span>
                        <span>${storeName}</span>
                        <span style="color: #ffa500; font-size: 10px;">‚òÖ</span>
                    </div>
                    ${cuisineType ? `<div style="font-size: 11px; color: #ff6b6b; margin-bottom: 4px; font-weight: 600;">üç¥ ${cuisineType.charAt(0).toUpperCase() + cuisineType.slice(1)}</div>` : ''}
                    ${shopType === 'restaurant' ? `<div id="health-score-${store.id}" style="font-size: 11px; margin-bottom: 6px; font-weight: 600;">üè• Loading health score...</div>` : ''}
                    <div style="font-size: 11px; color: #666; margin-bottom: 6px;">
                        üìç ${address ? `<span style="color: #555;" data-tooltip="Store address from OpenStreetMap">${address}</span>` : '<span style="color: #999;" data-tooltip="Address data not available in OpenStreetMap for this location">Address not available</span>'}
                    </div>
                    <div style="font-size: 11px; color: #666; margin-bottom: 6px;">
                        üåê ${website ? `<a href="${website}" target="_blank" rel="noopener noreferrer" style="color: #667eea; text-decoration: none;" data-tooltip="Visit ${storeName} website">Visit Website</a>` : '<span style="color: #999;" data-tooltip="Website information not available in OpenStreetMap">Website not available</span>'}
                    </div>
                    <div class="ejv-scores" style="margin: 8px 0; padding: 10px; background: linear-gradient(135deg, #f0f4ff 0%, #e8f5e9 100%); border-radius: 6px; border: 2px solid #667eea;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 8px;">
                            <div style="text-align: center; background: white; padding: 6px; border-radius: 4px; border-left: 3px solid #7b1fa2;">
                                <div style="font-size: 9px; color: #666; font-weight: 600; margin-bottom: 2px;">üìä EJV 4.0</div>
                                <div id="ejv-original-${store.id}" style="font-weight: 700; color: #7b1fa2; font-size: 14px;">...</div>
                                <div style="font-size: 8px; color: #888;">0-100%</div>
                            </div>
                            <div style="text-align: center; background: white; padding: 6px; border-radius: 4px; border-left: 3px solid #667eea;">
                                <div style="font-size: 9px; color: #666; font-weight: 600; margin-bottom: 2px;">üåü EJV 4.1</div>
                                <div id="ejv-v2-${store.id}" style="font-weight: 700; color: #667eea; font-size: 14px;">...</div>
                                <div style="font-size: 8px; color: #888;">0-100</div>
                            </div>
                        </div>
                        <div style="font-size: 8px; color: #666; margin-bottom: 6px; text-align: center; font-style: italic;">
                            4.1: (LC+W+DN+EQ+ENV+PROC)/6 | 4.0: 0.25W+0.15P+0.30L+0.15A+0.15E
                        </div>
                        <div style="border-top: 1px solid #ddd; padding-top: 6px; margin-top: 6px;">
                            <div style="font-size: 10px; font-weight: 600; color: #555; margin-bottom: 4px;">EJV 4.1 Components (0-100):</div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 3px; font-size: 10px;">
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: #666;" title="Local Circulation">LC:</span>
                                    <span id="community-${store.id}" style="font-weight: 600; color: #667eea;">-</span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: #666;" title="Fair Wages">W:</span>
                                    <span id="wage-${store.id}" style="font-weight: 600; color: #667eea;">-</span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: #666;" title="Community Need">DN:</span>
                                    <span id="affordability-${store.id}" style="font-weight: 600; color: #667eea;">-</span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: #666;" title="Equity & Inclusion">EQ:</span>
                                    <span id="hiring-${store.id}" style="font-weight: 600; color: #667eea;">-</span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: #666;" title="Environmental">ENV:</span>
                                    <span id="participation-${store.id}" style="font-weight: 600; color: #667eea;">-</span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: #666;" title="Procurement">PROC:</span>
                                    <span id="procurement-${store.id}" style="font-weight: 600; color: #667eea;">-</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div style="margin: 8px 0; padding: 6px; background: #fffef0; border-radius: 4px; font-size: 9px; color: #666;">
                        <strong>Data:</strong> Census ACS, BLS, MIT Living Wage, HUD, EPA, EEOC, USDA
                    </div>
                    <div class="ejv-actions" style="display: flex; gap: 6px; margin-top: 8px;">
                        <button onclick="showWhyModal('${store.id}', '${storeName.replace(/'/g, "\\'")}')" style="flex: 1; padding: 4px 8px; background: #667eea; color: white; border: none; border-radius: 4px; font-size: 10px; cursor: pointer; font-weight: 600;" data-tooltip="See detailed calculation methodology and data sources">Why?</button>
                        <button onclick="compareStore('${store.id}')" style="flex: 1; padding: 4px 8px; background: #26a69a; color: white; border: none; border-radius: 4px; font-size: 10px; cursor: pointer; font-weight: 600;" title="View this store on the dashboard with full metrics">Compare</button>
                        <button onclick="quickLogPurchase('${storeName.replace(/'/g, "\\'")}', ${store.id})" style="flex: 1; padding: 4px 8px; background: #4caf50; color: white; border: none; border-radius: 4px; font-size: 10px; cursor: pointer; font-weight: 600;" title="Quickly log a purchase at this store">üí∞ Log</button>
                    </div>
                `;
                
                storeItem.onmouseenter = async () => {
                    // Visual feedback
                    storeItem.style.backgroundColor = '#f0f4ff';
                    storeItem.style.borderLeftWidth = '4px';
                    storeItem.style.transform = 'translateX(2px)';
                    
                    clearTimeout(hoverDebounceTimer);
                    hoverDebounceTimer = setTimeout(async () => {
                        console.log(`Hovering on ${storeName}, loading EJV 4.1 data`);
                        const ejvData = await calculateEJV(store.id, storeName, true);
                        if (ejvData && ejvData.data) {
                            console.log('EJV 4.1 Data received:', ejvData.data);
                            const apiData = ejvData.data;
                            
                            // Update both EJV 4.1 and original EJV scores
                            const v2Element = document.getElementById(`ejv-v2-${store.id}`);
                            const originalElement = document.getElementById(`ejv-original-${store.id}`);
                            
                            if (v2Element && apiData.ejv_score !== undefined) {
                                v2Element.textContent = apiData.ejv_score.toFixed(2);
                            }
                            
                            if (originalElement) {
                                if (apiData.ejv_original?.ejv_percentage !== undefined) {
                                    originalElement.textContent = apiData.ejv_original.ejv_percentage.toFixed(1) + '%';
                                } else if (apiData.ejv_original?.ejv_score !== undefined) {
                                    originalElement.textContent = (apiData.ejv_original.ejv_score * 100).toFixed(1) + '%';
                                }
                            }

                            const wageElement = document.getElementById(`wage-${store.id}`);
                            const hiringElement = document.getElementById(`hiring-${store.id}`);
                            const communityElement = document.getElementById(`community-${store.id}`);
                            const affordabilityElement = document.getElementById(`affordability-${store.id}`);
                            const participationElement = document.getElementById(`participation-${store.id}`);
                            const procurementElement = document.getElementById(`procurement-${store.id}`);
                            
                            // Display EJV 4.1 components (LC, W, DN, EQ, ENV, PROC) - already 0-100 scale
                            const components = apiData.components || {};
                            
                            // Map EJV 4.1 components to display elements
                            // LC -> Community, W -> Wage, DN -> Affordability, EQ -> Hiring, ENV -> Participation, PROC -> Procurement
                            if (communityElement && components.LC_local_circulation !== undefined) {
                                communityElement.textContent = components.LC_local_circulation.toFixed(2);
                            }
                            if (wageElement && components.W_fair_wages !== undefined) {
                                wageElement.textContent = components.W_fair_wages.toFixed(2);
                            }
                            if (affordabilityElement && components.DN_community_need !== undefined) {
                                affordabilityElement.textContent = components.DN_community_need.toFixed(2);
                            }
                            if (hiringElement && components.EQ_equity_inclusion !== undefined) {
                                hiringElement.textContent = components.EQ_equity_inclusion.toFixed(2);
                            }
                            if (participationElement && components.ENV_environmental !== undefined) {
                                participationElement.textContent = components.ENV_environmental.toFixed(2);
                            }
                            if (procurementElement && components.PROC_procurement !== undefined) {
                                procurementElement.textContent = components.PROC_procurement.toFixed(2);
                            }
                            
                            // Show impact circle on map
                            const marker = markers.find(m => m.storeId === store.id);
                            if (marker) {
                                const elvr = ejvData.data.economic_impact?.elvr || ejvData.data.elvr || 0;
                                showImpactCircle(marker.getLatLng(), elvr);
                            }
                        }
                    }, 50); // 50ms debounce - instant for cached data
                };
                
                storeItem.onmouseleave = () => {
                    // Reset visual feedback
                    storeItem.style.backgroundColor = '';
                    storeItem.style.borderLeftWidth = '3px';
                    storeItem.style.transform = '';
                    
                    clearTimeout(hoverDebounceTimer);
                    hideImpactCircle();
                };
                storeItem.onclick = () => {
                    map.setView([lat, lon], 16);
                    marker.openPopup();
                };
                storeListDiv.appendChild(storeItem);
                
                // Auto-load EJV values immediately for this store
                (async () => {
                    try {
                        console.log(`üîÑ Auto-loading EJV for ${storeName} (ID: ${store.id})`);
                        const ejvData = await calculateEJV(store.id, storeName, false);
                        console.log(`üìä Auto-load result for ${storeName}:`, ejvData);
                        
                        if (!ejvData) {
                            console.error(`‚ùå No ejvData returned for ${storeName}`);
                            return;
                        }
                        
                        if (!ejvData.data) {
                            console.error(`‚ùå No ejvData.data property for ${storeName}`, ejvData);
                            return;
                        }
                        
                        // Access the API response data directly
                        const apiData = ejvData.data;
                        console.log(`‚úÖ API data for ${storeName}:`, apiData);
                        
                        // Update both EJV 4.1 and original EJV scores
                        const v2Element = document.getElementById(`ejv-v2-${store.id}`);
                        const originalElement = document.getElementById(`ejv-original-${store.id}`);
                        
                        console.log(`üîç Element check - v2: ${v2Element ? 'Found' : 'NOT FOUND'}, original: ${originalElement ? 'Found' : 'NOT FOUND'}`);
                        console.log(`üîç Score values - ejv_score: ${apiData.ejv_score}, original: ${apiData.ejv_original?.ejv_percentage}`);
                        
                        if (v2Element && apiData.ejv_score !== undefined) {
                            v2Element.textContent = apiData.ejv_score.toFixed(2);
                            console.log(`‚úì Set EJV 4.1 score for ${storeName}: ${apiData.ejv_score.toFixed(2)}`);
                        } else {
                            console.error(`‚ùå Could not set EJV 4.1: element=${!!v2Element}, score=${apiData.ejv_score}`);
                        }
                        
                        if (originalElement) {
                            if (apiData.ejv_original?.ejv_percentage !== undefined) {
                                originalElement.textContent = apiData.ejv_original.ejv_percentage.toFixed(1) + '%';
                                console.log(`‚úì Set EJV original for ${storeName}: ${apiData.ejv_original.ejv_percentage.toFixed(1)}%`);
                            } else if (apiData.ejv_original?.ejv_score !== undefined) {
                                originalElement.textContent = (apiData.ejv_original.ejv_score * 100).toFixed(1) + '%';
                                console.log(`‚úì Set EJV original from score for ${storeName}: ${(apiData.ejv_original.ejv_score * 100).toFixed(1)}%`);
                            } else {
                                console.error(`‚ùå No EJV original score data available`);
                            }
                        } else {
                            console.error(`‚ùå Original element not found`);
                        }
                        
                        // Update components
                        const components = apiData.components || {};
                        console.log(`üîß Components data:`, components);
                        
                        const communityElement = document.getElementById(`community-${store.id}`);
                        const wageElement = document.getElementById(`wage-${store.id}`);
                        const affordabilityElement = document.getElementById(`affordability-${store.id}`);
                        const hiringElement = document.getElementById(`hiring-${store.id}`);
                        const participationElement = document.getElementById(`participation-${store.id}`);
                        const procurementElement = document.getElementById(`procurement-${store.id}`);
                        
                        console.log(`üîç Component elements - LC: ${!!communityElement}, W: ${!!wageElement}, DN: ${!!affordabilityElement}, EQ: ${!!hiringElement}, ENV: ${!!participationElement}, PROC: ${!!procurementElement}`);
                        
                        if (communityElement && components.LC_local_circulation !== undefined) {
                            communityElement.textContent = components.LC_local_circulation.toFixed(2);
                            console.log(`‚úì LC: ${components.LC_local_circulation.toFixed(2)}`);
                        }
                        if (wageElement && components.W_fair_wages !== undefined) {
                            wageElement.textContent = components.W_fair_wages.toFixed(2);
                            console.log(`‚úì W: ${components.W_fair_wages.toFixed(2)}`);
                        }
                        if (affordabilityElement && components.DN_community_need !== undefined) {
                            affordabilityElement.textContent = components.DN_community_need.toFixed(2);
                            console.log(`‚úì DN: ${components.DN_community_need.toFixed(2)}`);
                        }
                        if (hiringElement && components.EQ_equity_inclusion !== undefined) {
                            hiringElement.textContent = components.EQ_equity_inclusion.toFixed(2);
                            console.log(`‚úì EQ: ${components.EQ_equity_inclusion.toFixed(2)}`);
                        }
                        if (participationElement && components.ENV_environmental !== undefined) {
                            participationElement.textContent = components.ENV_environmental.toFixed(2);
                            console.log(`‚úì ENV: ${components.ENV_environmental.toFixed(2)}`);
                        }
                        if (procurementElement && components.PROC_procurement !== undefined) {
                            procurementElement.textContent = components.PROC_procurement.toFixed(2);
                            console.log(`‚úì PROC: ${components.PROC_procurement.toFixed(2)}`);
                        }
                    } catch (error) {
                        console.error(`‚ùå Error auto-loading EJV for ${storeName}:`, error);
                        console.error(`Error stack:`, error.stack);
                    }
                })();
            });

            // Fit map to show all markers
            if (markers.length > 0) {
                const group = L.featureGroup(markers);
                map.fitBounds(group.getBounds(), { padding: [50, 50] });
                console.log(`Map fitted to ${markers.length} markers`);
            }
        }

        // LOCATOR UI Pattern action buttons
        async function showWhyModal(storeId, storeName) {
            try {
                console.log(`Loading Why modal for ${storeName} (ID: ${storeId})`);
                const ejvData = await calculateEJV(storeId, storeName, false);
                console.log('Why modal EJV data:', ejvData);
                
                if (!ejvData || !ejvData.data) {
                    console.error('Failed to load EJV data for modal');
                    alert('Unable to load EJV data. Please try again.');
                    return;
                }
                
                const data = ejvData.data;
                console.log('Modal data structure:', data);
                
                const components = data.components || {};
                const componentDetails = data.component_details || {};
                const economicImpact = data.economic_impact || {};
                
                const modalContent = `
                    <div style="padding: 20px; max-width: 600px;">
                        <h3 style="color: #667eea; margin-bottom: 15px;">üìä ${storeName} - EJV 4.1 Breakdown</h3>
                        
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 15px; border-radius: 8px; margin-bottom: 15px; color: white;">
                            <div style="font-size: 24px; font-weight: 700; margin-bottom: 5px;">
                                ${data.ejv_score ? data.ejv_score.toFixed(2) : '0.00'} / 100
                            </div>
                            <div style="font-size: 12px; opacity: 0.9;">Economic Justice Value Score (EJV 4.1)</div>
                            <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.3);">
                                <div style="font-size: 14px; font-weight: 600;">ELVR: $${(economicImpact.elvr || 0).toFixed(2)}</div>
                                <div style="font-size: 11px; opacity: 0.9;">Estimated Local Value Retained (per $100 spent)</div>
                            </div>
                        </div>
                        
                        <div style="background: linear-gradient(135deg, #7b1fa2 0%, #512da8 100%); padding: 15px; border-radius: 8px; margin-bottom: 15px; color: white;">
                            <div style="font-size: 20px; font-weight: 700; margin-bottom: 5px;">
                                ${data.ejv_original?.ejv_percentage ? data.ejv_original.ejv_percentage.toFixed(1) : '0.0'}%
                            </div>
                            <div style="font-size: 12px; opacity: 0.9;">EJV 4.0 Score (5-Component Weighted)</div>
                        </div>
                        
                        <h4 style="margin: 15px 0 10px; color: #333;">EJV 4.1 Components (Equal Weight 16.67% each):</h4>
                        <div style="font-size: 12px; line-height: 1.8;">
                            <div style="display: flex; justify-content: space-between; padding: 8px; background: #f0f4ff; border-radius: 4px; margin-bottom: 5px;">
                                <span>üèòÔ∏è LC (Local Circulation):</span>
                                <strong style="color: #667eea;">${(components.LC_local_circulation || 0).toFixed(2)}</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 8px; background: #fff; border-radius: 4px; margin-bottom: 5px;">
                                <span>üíµ W (Fair Wages):</span>
                                <strong style="color: #667eea;">${(components.W_fair_wages || 0).toFixed(2)}</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 8px; background: #f0f4ff; border-radius: 4px; margin-bottom: 5px;">
                                <span>üè• DN (Community Need):</span>
                                <strong style="color: #667eea;">${(components.DN_community_need || 0).toFixed(2)}</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 8px; background: #fff; border-radius: 4px; margin-bottom: 5px;">
                                <span>‚öñÔ∏è EQ (Equity & Inclusion):</span>
                                <strong style="color: #667eea;">${(components.EQ_equity_inclusion || 0).toFixed(2)}</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 8px; background: #f0f4ff; border-radius: 4px; margin-bottom: 5px;">
                                <span>üå± ENV (Environmental):</span>
                                <strong style="color: #667eea;">${(components.ENV_environmental || 0).toFixed(2)}</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 8px; background: #fff; border-radius: 4px;">
                                <span>üõí PROC (Procurement):</span>
                                <strong style="color: #667eea;">${(components.PROC_procurement || 0).toFixed(2)}</strong>
                            </div>
                        </div>
                        
                        <div style="font-size: 11px; color: #666; margin-top: 10px; padding: 8px; background: #fffef0; border-radius: 4px;">
                            <strong>Formula:</strong> ${data.formula || 'EJV 4.1 = (LC + W + DN + EQ + ENV + PROC) / 6'}
                        </div>
                        
                        <h4 style="margin: 15px 0 10px; color: #333;">Data Sources:</h4>
                        <div style="font-size: 11px; color: #666; line-height: 1.6; background: #f8f9fa; padding: 10px; border-radius: 4px;">
                            <strong>üìä Primary Data:</strong><br>
                            ‚Ä¢ Census ACS (Income, Poverty, Demographics)<br>
                            ‚Ä¢ BLS (Unemployment, Wages, Labor Market)<br>
                            ‚Ä¢ MIT Living Wage Calculator<br>
                            ‚Ä¢ HUD (Housing Need Areas)<br>
                            ‚Ä¢ EPA EJScreen (Environmental Justice)<br>
                            ‚Ä¢ EEOC (Equity Data), USDA (Food Deserts)<br>
                            ‚Ä¢ Supply Chain Research
                        </div>
                        
                        <button onclick="closeModal()" style="width: 100%; margin-top: 15px; padding: 10px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">Close</button>
                    </div>
                `;
                
                showModal(modalContent);
            } catch (error) {
                console.error('Error showing Why modal:', error);
                alert('Error loading EJV details: ' + error.message);
            }
        }
        
        function compareStore(storeId) {
            // Switch to compare mode to see all stores
            setDecisionMode('compare');
        }
        
        function engageStore(storeId) {
            // Switch to ENGAGE mode
            decisionMode = 'engage';
            showEngageMode();
            alert('Switched to ENGAGE mode - EJV v4.2 with Participation Amplification is now active');
        }
        
        function showModal(content) {
            const modal = document.createElement('div');
            modal.id = 'customModal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10000;';
            modal.innerHTML = `<div style="background: white; border-radius: 10px; max-width: 600px; max-height: 80vh; overflow-y: auto;">${content}</div>`;
            document.body.appendChild(modal);
            modal.onclick = (e) => { if (e.target === modal) closeModal(); };
        }
        
        function closeModal() {
            const modal = document.getElementById('customModal');
            if (modal) modal.remove();
        }

        async function calculateEJV(storeId, storeName, showDashboard = false, zipCode = null) {
            // Use provided zipCode or fall back to currentZip
            const useZip = zipCode || currentZip;
            
            // Check cache first for instant response
            if (ejvCache[storeId]) {
                console.log(`‚úÖ Using cached EJV for ${storeName}`);
                console.log(`üì¶ Cached data structure:`, ejvCache[storeId]);
                console.log(`üì¶ Cached data.data:`, ejvCache[storeId].data);
                console.log(`üì¶ Cached ejv_score:`, ejvCache[storeId].data?.ejv_score);
                if (showDashboard) {
                    updateRightDashboard(ejvCache[storeId].data, storeName);
                }
                return ejvCache[storeId];
            }
            
            console.log(`Calculating EJV 4.1 for store ${storeId} (${storeName}) with ZIP: ${useZip}`);
            
            // Disable cache temporarily to ensure fresh calculations
            // if (ejvCache[storeId]) {
            //     console.log(`‚úÖ Using cached EJV for ${storeName}`);
            //     console.log(`üì¶ Cached data structure:`, ejvCache[storeId]);
            //     console.log(`üì¶ Cached data.data:`, ejvCache[storeId].data);
            //     console.log(`üì¶ Cached ejv_score:`, ejvCache[storeId].data?.ejv_score);
            //     if (showDashboard) {
            //         updateRightDashboard(ejvCache[storeId].data, storeName);
            //     }
            //     return ejvCache[storeId];
            // }
            
            try {
                // Get store type and location details from rawStores
                const storeRecord = rawStores.find(s => s.id === storeId);
                let storeType = 'retail';
                let storeAddress = '';
                let storeCoordinates = '';
                let storeWebsite = null;
                
                if (storeRecord) {
                    storeType = storeRecord.type || storeRecord.tags?.shop || storeRecord.tags?.amenity || 'retail';
                    storeAddress = storeRecord.tags?.['addr:full'] || storeRecord._cachedAddress || '';
                    if (storeRecord.lat && storeRecord.lon) {
                        storeCoordinates = `${storeRecord.lat}, ${storeRecord.lon}`;
                    }
                }
                
                // Determine chain size based on store name
                const lowerName = storeName.toLowerCase();
                let chainSize = 'local';
                const nationalChains = ['walmart', 'target', 'kroger', 'safeway', 'whole foods', 'costco', 'starbucks', 'mcdonalds', 'subway', 'cvs', 'walgreens', 'rite aid'];
                const regionalChains = ['publix', 'wegmans', 'aldi', 'trader joe'];
                
                if (nationalChains.some(chain => lowerName.includes(chain))) {
                    chainSize = 'national';
                } else if (regionalChains.some(chain => lowerName.includes(chain))) {
                    chainSize = 'regional';
                }
                
                // Build specific location string
                const locationDetails = storeAddress || `ZIP ${useZip}`;
                const additionalContext = [
                    `Store ID: ${storeId}`,
                    storeAddress ? `Address: ${storeAddress}` : '',
                    storeCoordinates ? `Coordinates: ${storeCoordinates}` : ''
                ].filter(Boolean).join(' | ');
                
                // Call AI-Assisted EJV 4.1 endpoint
                const apiUrl = `/api/ai/calculate-ejv-41`;  
                console.log('ü§ñ Calling AI-Assisted EJV 4.1 API:', apiUrl);
                console.log('üìç Store Name:', storeName);
                console.log('üìç Store Type:', storeType);
                console.log('üìç Location Details:', locationDetails);
                console.log('üìç Additional Context:', additionalContext);
                console.log('üìç Chain Size:', chainSize);
                
                // Add timeout to prevent hanging
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 15000); // 15 second timeout
                
                let response;
                try {
                    const requestBody = {
                        store_name: storeName,
                        store_type: storeType,
                        location: locationDetails,
                        chain_size: chainSize,
                        additional_info: additionalContext
                    };
                    console.log('üì§ Full AI Request Body:', JSON.stringify(requestBody, null, 2));
                    
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(requestBody),
                        signal: controller.signal
                    });
                    clearTimeout(timeoutId);
                } catch (err) {
                    clearTimeout(timeoutId);
                    console.warn(`AI API error for ${storeName}:`, err.message);
                    // Use fallback for any fetch error
                    response = { ok: false, status: 500, statusText: err.message };
                }
                
                console.log('üîç AI API Response status:', response.status);
                

                // Fetch both EJV values from the new combined endpoint
                let ejvData = null;
                try {
                    const combinedResponse = await fetch(`/api/ejv/simple/${storeId}?zip=${useZip}&location=${encodeURIComponent(storeName)}&name=${encodeURIComponent(storeName)}`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    if (combinedResponse.ok) {
                        const combinedData = await combinedResponse.json();
                        console.log('‚úì Got combined EJV response:', combinedData);
                        ejvData = {
                            programmatic_ejv: combinedData.programmatic_ejv,
                            ai_assisted_ejv: combinedData.ai_assisted_ejv
                        };
                    } else {
                        console.warn('‚ö†Ô∏è Could not fetch combined EJV values');
                    }
                } catch (err) {
                    console.warn('‚ö†Ô∏è Combined EJV fetch error:', err.message);
                }
                
                // If API failed or parse error, use fallback
                if (!ejvData) {
                    console.warn('‚ö†Ô∏è Using fallback mock data');
                    // Create deterministic seed from store ID for consistent fallback
                    const storeIdNum = typeof storeId === 'number' ? storeId : parseInt(storeId.toString().replace(/\D/g, '')) || 1;
                    const seed = (storeIdNum * 9301 + 49297) % 233280;
                    const r1 = ((seed * 1.1) % 233280) / 233280;
                    const r2 = ((seed * 2.3) % 233280) / 233280;
                    const r3 = ((seed * 3.7) % 233280) / 233280;
                    const r4 = ((seed * 5.1) % 233280) / 233280;
                    const r5 = ((seed * 7.2) % 233280) / 233280;
                    const r6 = ((seed * 8.9) % 233280) / 233280;
                    
                    // Create fallback data with EJV 4.1 score (0-100 scale)
                    const fallbackEjvScore = 55 + (r1 * 20);  // 55-75
                    const purchaseAmt = 100.0;
                    const fallbackElvr = purchaseAmt * (fallbackEjvScore / 100);
                    const fallbackEvl = purchaseAmt - fallbackElvr;
                    
                    ejvData = {
                        ejv_score: fallbackEjvScore,
                        ejv_percentage: fallbackEjvScore,
                        ejv_version: "EJV 4.1 (6-Component Equal Weight)",
                        components: {
                            LC_local_circulation: 50 + (r1 * 30),
                            W_fair_wages: 60 + (r2 * 30),
                            DN_community_need: 40 + (r3 * 40),
                            EQ_equity_inclusion: 55 + (r4 * 30),
                            ENV_environmental: 45 + (r5 * 35),
                            PROC_procurement: 50 + (r6 * 30)
                        },
                        economic_impact: {
                            elvr: fallbackElvr,
                            evl: fallbackEvl,
                            retention_percent: fallbackEjvScore
                        },
                        formula: "EJV 4.1 = (LC + W + DN + EQ + ENV + PROC) / 6",
                        data_sources: [
                            "Census ACS (Income, Poverty, Demographics)",
                            "BLS (Unemployment, Wages, Labor Market)",
                            "MIT Living Wage Calculator",
                            "HUD (Housing Need Areas)",
                            "EPA EJScreen (Environmental Justice)",
                            "EEOC (Equity Data)",
                            "USDA (Food Deserts)",
                            "Supply Chain Research"
                        ],
                        local_context: {
                            unemployment_rate: 5.0,
                            median_income: 50000
                        },
                        ejv_original: ejv40Data || {
                            ejv_score: 0.55,
                            ejv_percentage: 55.0,
                            note: 'Programmatic EJV 4.0 unavailable, using fallback'
                        }
                    };
                    console.log('‚ö†Ô∏è Using fallback data with EJV 4.0:', ejv40Data ? 'REAL DATA' : 'MOCK DATA');
                    console.log('‚ö†Ô∏è Full fallback data:', ejvData);
                }
                
                console.log('üîß Pre-structure ejvData:', ejvData);
                console.log('üîß ejvData.ejv_score:', ejvData.ejv_score);
                console.log('üîß ejvData.components:', ejvData.components);
                console.log('üîß ejvData.economic_impact:', ejvData.economic_impact);
                
                // Structure data for dashboard - preserve API response structure
                const data = {
                    ejv_version: ejvData.ejv_version || "EJV 4.1 (6-Component Equal Weight)",
                    ejv_score: ejvData.ejv_score,  // Direct access to EJV 4.1 score (0-100)
                    ejv_percentage: ejvData.ejv_percentage || ejvData.ejv_score,
                    components: ejvData.components,  // Direct access to components
                    component_details: ejvData.component_details,
                    ejv_original: ejvData.ejv_original,  // Direct access to original EJV
                    elvr: ejvData.economic_impact?.elvr || 0,
                    evl: ejvData.economic_impact?.evl || 0,
                    retention_percentage: ejvData.economic_impact?.retention_percent || ejvData.ejv_score || 0,
                    economic_impact: ejvData.economic_impact,
                    formula: ejvData.formula || "EJV 4.1 = (LC + W + DN + EQ + ENV + PROC) / 6",
                    data_sources: ejvData.data_sources || [],
                    local_context: ejvData.local_context,
                    zip_analysis: {
                        unemployment_rate: ejvData.local_context?.unemployment_rate || 5.0,
                        median_income: ejvData.local_context?.median_income || 50000
                    }
                };

                console.log('üìä Structured EJV Data for display:', data);
                console.log('üìä data.ejv_score:', data.ejv_score);
                console.log('üìä data.components:', data.components);

                if (data.error) {
                    console.error('‚ùå EJV Error:', data.error);
                    return null;
                }

                // Extract values from API response
                const elvr = data.elvr || 0;
                const evl = data.evl || 0;
                const ejvV2Baseline = data.ejv_score || 0;  // EJV 4.1 score (0-100)

                console.log(`üí∞ EJV 4.1 Final Values - Score: ${ejvV2Baseline}, ELVR: $${elvr}, EVL: $${evl}, Retention: ${data.retention_percentage}%`);

                // Store in global array for compare/optimize modes
                // Get address from rawStores with fallback to cached data
                const rawStore = rawStores.find(s => s.id === storeId);
                console.log(`Looking for store ${storeId} in rawStores (${rawStores.length} stores), found:`, rawStore ? 'YES' : 'NO');
                
                // Reuse storeAddress and storeWebsite from earlier scope
                storeAddress = '';
                storeWebsite = null;
                
                if (rawStore) {
                    // First try: use cached data that was extracted during search
                    if (rawStore._cachedAddress) {
                        storeAddress = rawStore._cachedAddress;
                        storeWebsite = rawStore._cachedWebsite;
                        console.log(`Using cached data - Address: "${storeAddress}", Website: ${storeWebsite}`);
                    } 
                    // Second try: extract from tags
                    else if (rawStore.tags) {
                        const addrParts = [
                            rawStore.tags['addr:housenumber'],
                            rawStore.tags['addr:street'],
                            rawStore.tags['addr:city'],
                            rawStore.tags['addr:state']
                        ].filter(Boolean);
                        storeAddress = addrParts.join(' ');
                        
                        storeWebsite = rawStore.tags.website || 
                                      rawStore.tags['contact:website'] || 
                                      rawStore.tags.url || null;
                        
                        console.log(`Extracted from tags - Address: "${storeAddress}", Website: ${storeWebsite}`);
                    }
                } else {
                    console.log(`Store ${storeId} not found in rawStores array`);
                }
                
                const storeEJV = {
                    id: storeId,
                    storeId: storeId,
                    name: storeName,
                    type: data.store_type || 'default',
                    elvr: elvr,
                    evl: evl,
                    retention_percentage: data.retention_percentage || 0,
                    ejv_v2_baseline: ejvV2Baseline,
                    data: data,
                    lat: storeData.find(s => s.id === storeId)?.lat,
                    lon: storeData.find(s => s.id === storeId)?.lon,
                    address: storeAddress,
                    website: storeWebsite
                };
                
                // Update or add to array
                const existingIndex = allStoresEJV.findIndex(s => s.id === storeId);
                if (existingIndex >= 0) {
                    allStoresEJV[existingIndex] = storeEJV;
                } else {
                    allStoresEJV.push(storeEJV);
                }

                // Cache the result for instant future access
                const result = { elvr: elvr, evl: evl, ejv_v2_baseline: ejvV2Baseline, data: data };
                ejvCache[storeId] = result;
                console.log(`Cached EJV for store ${storeId}`);
                
                // If in ENGAGE mode and showing dashboard, also fetch v4.2
                if (showDashboard) {
                    if (decisionMode === 'engage') {
                        console.log('ENGAGE mode: fetching v4.2 with participation data');
                        try {
                            // Call v4.2 API with demo participation data
                            const apiUrlV42 = `/api/ejv-v4.2/${storeId}`;
                            const responseV42 = await fetch(apiUrlV42, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    zip: currentZip,
                                    location: storeName,
                                    purchase: 100,
                                    participation: {
                                        mentoring: { hours: 3, verified: true, duration_months: 12 },
                                        volunteering: { hours: 2, verified: true, duration_months: 12 },
                                        sponsorship: { hours: 1, verified: true, duration_months: 12 },
                                        apprenticeship: { hours: 2, verified: true, duration_months: 10 },
                                        facilities: { hours: 1, verified: false, duration_months: 12 }
                                    }
                                })
                            });
                            
                            if (responseV42.ok) {
                                const dataV42 = await responseV42.json();
                                console.log('‚úì Fetched REAL EJV v4.2:', dataV42);
                                // Add v4.2 data to combined data object
                                data.ejv_v42 = dataV42.ejv_v42;
                            } else {
                                console.warn('v4.2 API call failed, will use fallback PAF calculation');
                            }
                        } catch (error) {
                            console.error('Error fetching v4.2:', error);
                        }
                    }
                    
                    console.log('Updating dashboard with data');
                    updateRightDashboard(data, storeName);
                }

                return result;
            } catch (error) {
                console.error('‚ùå Error in calculateEJV function:', error);
                console.error('‚ùå Error stack:', error.stack);
                console.error('‚ùå Store ID:', storeId, 'Name:', storeName);
                return null;
            }
        }

        // Impact Grid Visualization with Colored Squares
        let currentImpactCircle = null;
        let impactCircleLayers = [];

        function showImpactCircle(latlng, ejvScore) {
            console.log(`Showing impact grid at ${latlng.lat}, ${latlng.lng} with EJV score ${ejvScore}`);
            hideImpactCircle();
            
            // Determine impact level and color
            const color = ejvScore >= 70 ? '#28a745' : ejvScore >= 40 ? '#ffc107' : '#dc3545';
            
            // Create a grid of colored squares around the store
            // Grid size: 3x3 for better performance (was 5x5)
            const gridSize = 3;
            const squareSize = 0.0012; // Larger squares to maintain visual impact
            
            // Calculate starting position (center the grid on the store)
            const centerOffset = Math.floor(gridSize / 2);
            
            for (let row = 0; row < gridSize; row++) {
                for (let col = 0; col < gridSize; col++) {
                    // Calculate position offset from center
                    const rowOffset = (row - centerOffset) * squareSize;
                    const colOffset = (col - centerOffset) * squareSize;
                    
                    // Calculate square position
                    const squareLat = latlng.lat + rowOffset;
                    const squareLng = latlng.lng + colOffset;
                    
                    // Calculate distance from center (for gradient effect)
                    const distanceFromCenter = Math.sqrt(Math.pow(row - centerOffset, 2) + Math.pow(col - centerOffset, 2));
                    const maxDistance = Math.sqrt(2 * Math.pow(centerOffset, 2));
                    
                    // Opacity decreases with distance from center
                    let opacity = 0.6 - (distanceFromCenter / maxDistance) * 0.4;
                    
                    // Add some variation to create a more organic pattern
                    const variation = (Math.random() * 0.15) - 0.075;
                    opacity = Math.max(0.2, Math.min(0.7, opacity + variation));
                    
                    // Slightly vary the color intensity for each square
                    let squareColor = color;
                    const brightnessVariation = Math.random() * 0.2 - 0.1;
                    
                    // Create rectangle bounds for the square
                    const bounds = [
                        [squareLat - squareSize/2, squareLng - squareSize/2],
                        [squareLat + squareSize/2, squareLng + squareSize/2]
                    ];
                    
                    // Create the square
                    const square = L.rectangle(bounds, {
                        fillColor: squareColor,
                        fillOpacity: opacity,
                        color: squareColor,
                        weight: 1,
                        opacity: opacity * 0.8
                    }).addTo(map);
                    
                    impactCircleLayers.push(square);
                }
            }
            
            // Add a brighter center square to mark the store location
            const centerBounds = [
                [latlng.lat - squareSize/2, latlng.lng - squareSize/2],
                [latlng.lat + squareSize/2, latlng.lng + squareSize/2]
            ];
            
            const centerSquare = L.rectangle(centerBounds, {
                fillColor: color,
                fillOpacity: 0.8,
                color: '#ffffff',
                weight: 2,
                opacity: 1
            }).addTo(map);
            
            impactCircleLayers.push(centerSquare);
            
            console.log(`Impact grid created with ${impactCircleLayers.length} squares`);
        }

        function hideImpactCircle() {
            impactCircleLayers.forEach(layer => {
                if (map.hasLayer(layer)) {
                    map.removeLayer(layer);
                }
            });
            impactCircleLayers = [];
            currentImpactCircle = null;
        }

        function updateRightDashboard(data, storeName) {
            const dashboard = document.getElementById('rightDashboard');
            
            // Show dashboard with smooth animation
            if (dashboard.style.display === 'none' || !dashboard.style.display) {
                dashboard.style.display = 'block';
                dashboard.style.opacity = '0';
                setTimeout(() => {
                    dashboard.style.transition = 'opacity 0.3s ease';
                    dashboard.style.opacity = '1';
                }, 10);
            }
            
            console.log(`Updating dashboard for ${storeName}`);
            console.log('API Data received - Full data object:', data);
            console.log('API Data - elvr:', data.elvr, 'evl:', data.evl, 'retention_percentage:', data.retention_percentage);
            console.log('API Data - ejv_v2_baseline:', data.ejv_v2_baseline);
            
            // Store info
            document.getElementById('storeNameDisplay').textContent = storeName;
            document.getElementById('storeLocationDisplay').textContent = data.location || data.zip_code || 'Unknown';
            
            // Extract values from EJV 4.1 structure with explicit logging
            const elvr = data.economic_impact?.elvr || data.elvr || 0;
            const evl = data.economic_impact?.evl || data.evl || 0;
            const retentionPct = data.economic_impact?.retention_percent || data.retention_percentage || 0;
            const ejvV2Baseline = data.ejv_percentage || data.ejv_score || 0;
            const wealthRetained = elvr;  // ELVR
            const wealthLeakage = evl;    // EVL
            
            console.log('Extracted values - elvr:', elvr, 'evl:', evl, 'retentionPct:', retentionPct, 'ejvV2Baseline:', ejvV2Baseline);
            
            // Use v4.2 data from backend if available, otherwise calculate with demo participation
            let ejvV42, paf, ampValue;
            
            if (data.ejv_v42) {
                // Real v4.2 data from backend API
                ejvV42 = data.ejv_v42.elvr_amplified || elvr;
                paf = data.ejv_v42.amplification_factor || 1.0;
                ampValue = data.ejv_v42.amplification_value || 0;
                console.log('‚úì Using REAL EJV v4.2 from backend:', { ejvV42, paf, ampValue });
            } else {
                // Fallback: Demo participation with all 5 pathways
                const demoParticipation = {
                    mentoring: { hours: 3, verified: true, duration_months: 12 },
                    volunteering: { hours: 2, verified: true, duration_months: 12 },
                    sponsorship: { hours: 1, verified: true, duration_months: 12 },
                    apprenticeship: { hours: 2, verified: true, duration_months: 10 },
                    facilities: { hours: 1, verified: false, duration_months: 12 }
                };
                
                paf = calculatePAF(demoParticipation); // Returns ~1.232 (close to max 1.25)
                ejvV42 = elvr * paf;  // Apply PAF to v4.1 ELVR
                ampValue = ejvV42 - elvr;
                console.log(`Fallback PAF calculation: ELVR v4.1: $${elvr.toFixed(2)}, PAF: ${paf} (all 5 pathways)`);
            }
            
            // Calculate percentages for wealth flows
            const totalWealth = wealthRetained + wealthLeakage;
            let retainedPercent, leakagePercent;
            
            if (totalWealth > 0) {
                retainedPercent = (wealthRetained / totalWealth) * 100;
                leakagePercent = (wealthLeakage / totalWealth) * 100;
            } else {
                // If no wealth data, show 0 for both but log warning
                console.warn('No wealth data available - elvr and evl are both 0');
                retainedPercent = 0;
                leakagePercent = 0;
            }
            
            console.log('Wealth Metrics:', { elvr, evl, totalWealth, retainedPercent, leakagePercent });
            
            // Determine impact category based on v2 baseline score and styling
            let impactCategory, impactColor, impactBg, impactBorder, impactLabel;
            if (ejvV2Baseline >= 75) {
                impactCategory = 'Excellent';
                impactLabel = 'üåü Outstanding';
                impactColor = '#1b5e20';
                impactBg = 'linear-gradient(135deg, #c8e6c9 0%, #a5d6a7 100%)';
                impactBorder = '#4caf50';
            } else if (ejvV2Baseline >= 50) {
                impactCategory = 'Good';
                impactLabel = 'üëç Good';
                impactColor = '#01579b';
                impactBg = 'linear-gradient(135deg, #b3e5fc 0%, #81d4fa 100%)';
                impactBorder = '#03a9f4';
            } else if (ejvV2Baseline >= 25) {
                impactCategory = 'Fair';
                impactLabel = '‚ö†Ô∏è Moderate';
                impactColor = '#e65100';
                impactBg = 'linear-gradient(135deg, #ffe0b2 0%, #ffcc80 100%)';
                impactBorder = '#ff9800';
            } else {
                impactCategory = 'Poor';
                impactLabel = '‚ö° Limited';
                impactColor = '#b71c1c';
                impactBg = 'linear-gradient(135deg, #ffcdd2 0%, #ef9a9a 100%)';
                impactBorder = '#f44336';
            }

            // Main EJV scores
            console.log('About to set displays - ejvV2Baseline:', ejvV2Baseline, 'elvr:', elvr);
            
            const v41ProgDisplay = document.getElementById('ejvV41ProgDisplay');
            const v41AIDisplay = document.getElementById('ejvV41AIDisplay');

            // Set EJV 4.1 Programmatic (0-100)
            if (v41ProgDisplay && data.programmatic_ejv) {
                const progValue = (data.programmatic_ejv.ejv_percentage || data.programmatic_ejv.ejv_score * 100).toFixed(2);
                v41ProgDisplay.textContent = progValue;
            }
            // Set EJV 4.1 AI-Assisted (0-100)
            if (v41AIDisplay && data.ai_assisted_ejv) {
                const aiValue = (data.ai_assisted_ejv.ejv_percentage || data.ai_assisted_ejv.ejv_score * 100).toFixed(2);
                v41AIDisplay.textContent = aiValue;
            }
            
            console.log('Display values set - check screen');
            
            // v4.2 only shown in ENGAGE mode
            if (decisionMode === 'engage') {
                // Show the engage metrics grid
                const engageMetricsGrid = document.getElementById('engageMetricsGrid');
                engageMetricsGrid.style.display = 'grid';
                
                document.getElementById('ejvV42Display').textContent = '$' + ejvV42.toFixed(2);
                
                // Show participation panel
                const participationPanel = document.getElementById('participationPanel');
                participationPanel.style.display = 'block';
                document.getElementById('pafDisplay').textContent = paf.toFixed(3) + '√ó';
                document.getElementById('ampValueDisplay').textContent = '$' + ampValue.toFixed(2);
                
                // Show participation activities
                const activitiesHTML = `
                    <div style="margin-bottom: 4px;"><strong>Active Participation (5 Pathways):</strong></div>
                    <div style="margin-left: 10px;">‚Ä¢ 3 hrs/week <strong>mentoring</strong> (verified, 12mo)</div>
                    <div style="margin-left: 10px;">‚Ä¢ 2 hrs/week <strong>volunteering</strong> (verified, 12mo)</div>
                    <div style="margin-left: 10px;">‚Ä¢ 1 hr/week <strong>sponsorship</strong> (verified, 12mo)</div>
                    <div style="margin-left: 10px;">‚Ä¢ 2 hrs/week <strong>apprenticeship</strong> (verified, 10mo)</div>
                    <div style="margin-left: 10px;">‚Ä¢ 1 hr/week <strong>facilities</strong> support (12mo)</div>
                    <div style="margin-top: 6px; font-style: italic; color: #e65100;">Demo: ${((paf - 1) * 100).toFixed(1)}% amplification through comprehensive civic engagement</div>
                `;
                document.getElementById('participationActivities').innerHTML = activitiesHTML;
            } else {
                // Hide participation panel in other modes
                const participationPanel = document.getElementById('participationPanel');
                participationPanel.style.display = 'none';
            }

            // Wealth metrics as percentages
            console.log('Setting wealthRetained to:', retainedPercent.toFixed(1) + '%', '(from elvr:', elvr, ', evl:', evl, ')');
            console.log('Setting wealthLeakage to:', leakagePercent.toFixed(1) + '%');
            
            const wealthRetainedElem = document.getElementById('wealthRetained');
            const wealthLeakageElem = document.getElementById('wealthLeakage');
            
            if (wealthRetainedElem) {
                const retainedDisplay = (elvr > 0 || evl > 0) ? retainedPercent.toFixed(2) + '%' : '-';
                wealthRetainedElem.textContent = retainedDisplay;
                console.log('Successfully updated wealthRetained element to:', retainedDisplay);
            } else {
                console.error('ERROR: wealthRetained element not found!');
            }
            
            if (wealthLeakageElem) {
                const leakageDisplay = (elvr > 0 || evl > 0) ? leakagePercent.toFixed(2) + '%' : '-';
                wealthLeakageElem.textContent = leakageDisplay;
                console.log('Successfully updated wealthLeakage element to:', leakageDisplay);
            } else {
                console.error('ERROR: wealthLeakage element not found!');
            }

            // EJV 4.1 Components (LC, W, DN, EQ, ENV, PROC) - 0-100 scale
            const components = data.components || {};
            
            const LC_local_circulation = components.LC_local_circulation || 0;
            const W_fair_wages = components.W_fair_wages || 0;
            const DN_community_need = components.DN_community_need || 0;
            const EQ_equity_inclusion = components.EQ_equity_inclusion || 0;
            const ENV_environmental = components.ENV_environmental || 0;
            const PROC_procurement = components.PROC_procurement || 0;
            
            console.log('EJV 4.1 Components:', { LC_local_circulation, W_fair_wages, DN_community_need, EQ_equity_inclusion, ENV_environmental, PROC_procurement });
            
            const wageScoreElem = document.getElementById('wageScore');
            const hiringScoreElem = document.getElementById('hiringScore');
            const communityScoreElem = document.getElementById('communityScore');
            const affordabilityScoreElem = document.getElementById('affordabilityScore');
            const participationScoreElem = document.getElementById('dashboardParticipationScore');
            const procurementScoreElem = document.getElementById('procurementScore');
            
            // Map EJV 4.1 components to dashboard elements
            // LC -> Community (showing local circulation)
            // W -> Wage (fair wages)
            // DN -> Affordability (showing community need)
            // EQ -> Hiring (equity & inclusion)
            // ENV -> Participation (environmental)
            // PROC -> Add new element or show in tooltip
            
            if (communityScoreElem) {
                communityScoreElem.textContent = LC_local_circulation.toFixed(2);
                console.log('Set LC (Local Circulation) to:', LC_local_circulation.toFixed(2));
            }
            
            if (wageScoreElem) {
                wageScoreElem.textContent = W_fair_wages.toFixed(2);
                console.log('Set W (Fair Wages) to:', W_fair_wages.toFixed(2));
            }
            
            if (affordabilityScoreElem) {
                affordabilityScoreElem.textContent = DN_community_need.toFixed(2);
                console.log('Set DN (Community Need) to:', DN_community_need.toFixed(2));
            }
            
            if (hiringScoreElem) {
                hiringScoreElem.textContent = EQ_equity_inclusion.toFixed(2);
                console.log('Set EQ (Equity & Inclusion) to:', EQ_equity_inclusion.toFixed(2));
            }
            
            if (participationScoreElem) {
                participationScoreElem.textContent = ENV_environmental.toFixed(2);
                console.log('Set ENV (Environmental) to:', ENV_environmental.toFixed(2));
            }
            
            if (procurementScoreElem) {
                procurementScoreElem.textContent = PROC_procurement.toFixed(2);
                console.log('Set PROC (Procurement) to:', PROC_procurement.toFixed(2));
            }

            // EJV Local Capture Flows (per $100 spent)
            const lc = data.local_capture_components || {};
            
            const flowWagesElem = document.getElementById('flowWages');
            const flowSuppliersElem = document.getElementById('flowSuppliers');
            const flowTaxesElem = document.getElementById('flowTaxes');
            
            if (flowWagesElem) {
                const wageValue = lc.lc_wages ? '$' + (lc.lc_wages * 35).toFixed(2) : (lc.wages ? '$' + (lc.wages * 100).toFixed(2) : '-');
                flowWagesElem.textContent = wageValue;
            }
            if (flowSuppliersElem) {
                const supplierValue = lc.lc_suppliers ? '$' + (lc.lc_suppliers * 25).toFixed(2) : (lc.suppliers ? '$' + (lc.suppliers * 100).toFixed(2) : '-');
                flowSuppliersElem.textContent = supplierValue;
            }
            if (flowTaxesElem) {
                const taxValue = lc.lc_taxes ? '$' + (lc.lc_taxes * 15).toFixed(2) : (lc.taxes ? '$' + (lc.taxes * 100).toFixed(2) : '-');
                flowTaxesElem.textContent = taxValue;
            }

            // Formula display - EJV 4.1
            const formulaText = document.getElementById('formulaText');
            const formula = data.formula || "EJV 4.1 = (LC + W + DN + EQ + ENV + PROC) / 6";
            if (formulaText) {
                formulaText.textContent = formula;
            }

            // Data sources with clear references
            const dataSourcesList = document.getElementById('dataSourcesList');
            const dataSources = data.data_sources || [];
            
            let sourcesHTML = '';
            
            // Check if AI-assisted
            const isAIAssisted = data.ejv_version?.includes('AI') || dataSources[0]?.includes('AI');
            
            if (isAIAssisted) {
                // AI-Assisted calculation
                const confidence = data.local_context?.confidence || 'medium';
                const reasoning = data.local_context?.reasoning || 'Estimated based on industry patterns';
                
                const confidenceColors = {
                    'high': { bg: '#e8f5e9', border: '#4caf50', text: '#1b5e20', label: 'High Confidence' },
                    'medium': { bg: '#fff3e0', border: '#ff9800', text: '#e65100', label: 'Medium Confidence' },
                    'low': { bg: '#ffebee', border: '#f44336', text: '#b71c1c', label: 'Low Confidence' }
                };
                
                const confStyle = confidenceColors[confidence] || confidenceColors['medium'];
                
                sourcesHTML = `
                    <li style="background: ${confStyle.bg}; padding: 8px; border-radius: 4px; margin-bottom: 8px; border-left: 3px solid ${confStyle.border};">
                        <strong style="color: ${confStyle.text};">ü§ñ AI-ASSISTED CALCULATION</strong><br>
                        <span style="font-size: 9px; color: #666;">Confidence: <strong>${confStyle.label}</strong></span>
                    </li>
                    <li style="margin-top: 6px; background: #f5f5f5; padding: 6px; border-radius: 4px;">
                        <strong style="font-size: 9px;">üí° AI Reasoning:</strong><br>
                        <span style="font-size: 8px; color: #666;">${reasoning}</span>
                    </li>
                    <li style="margin-top: 6px;"><strong>ü§ñ Method:</strong>
                        <ul style="margin-left: 15px; font-size: 8px; color: #666; margin-top: 3px;">
                            <li>AI estimates components based on industry patterns</li>
                            <li>Uses OpenAI GPT-4o-mini for analysis</li>
                            <li>Considers store type, chain size, and location</li>
                        </ul>
                    </li>
                `;
            } else {
                // Real data calculation
                const hasRealData = dataSources.length > 0;
                
                if (hasRealData) {
                    sourcesHTML = `
                        <li style="background: #e8f5e9; padding: 8px; border-radius: 4px; margin-bottom: 8px; border-left: 3px solid #4caf50;">
                            <strong style="color: #1b5e20;">‚úì DUAL EJV SYSTEM - LIVE DATA</strong><br>
                            <span style="font-size: 9px; color: #666;">Showing both EJV 4.1 (6-component) and EJV 4.0 (5-component) for comparison</span>
                        </li>
                    `;
                    
                    // Add primary sources for EJV 4.1
                    sourcesHTML += `<li style="margin-top: 6px;"><strong>üìä Data Sources (Both Versions):</strong>
                        <ul style="margin-left: 15px; font-size: 8px; color: #666; margin-top: 3px;">
                            <li>Census ACS (Income, Poverty, Demographics)</li>
                            <li>BLS (Unemployment, Wages, Labor Market)</li>
                            <li>MIT Living Wage Calculator</li>
                            <li>HUD (Housing Need Areas) - 4.1 only</li>
                            <li>EPA EJScreen (Environmental Justice)</li>
                            <li>EEOC (Equity Data), USDA (Food Deserts)</li>
                        </ul>
                </li>`;
                
                // Add component details for EJV 4.1
                const componentDetails = data.component_details;
                if (componentDetails) {
                    sourcesHTML += `<li style="margin-top: 8px;"><strong>üîç EJV 4.1 Components (Equal Weight):</strong>
                        <ul style="margin-left: 15px; font-size: 8px; color: #666; margin-top: 3px;">
                            <li><strong>LC (16.7%)</strong>: ${componentDetails.local_circulation?.source || 'Census LODES + Supply Chain'}</li>
                            <li><strong>W (16.7%)</strong>: ${componentDetails.fair_wages?.source || 'BLS OEWS + MIT Living Wage'}</li>
                            <li><strong>DN (16.7%)</strong>: ${componentDetails.community_need?.source || 'Census ACS + BLS + HUD'}</li>
                            <li><strong>EQ (16.7%)</strong>: ${componentDetails.equity_inclusion?.source || 'EEOC + Diversity Data'}</li>
                            <li><strong>ENV (16.7%)</strong>: ${componentDetails.environmental?.source || 'EPA + Sustainability Metrics'}</li>
                            <li><strong>PROC (16.7%)</strong>: ${componentDetails.procurement?.source || 'Supply Chain Research'}</li>
                        </ul>
                    </li>`;
                }
                
                // Add original EJV components info
                const originalComponents = data.ejv_original?.component_details;
                if (originalComponents) {
                    sourcesHTML += `<li style="margin-top: 8px;"><strong>üîç EJV Original (Weighted):</strong>
                        <ul style="margin-left: 15px; font-size: 8px; color: #666; margin-top: 3px;">
                            <li><strong>W (25%)</strong>: Fair Wage</li>
                            <li><strong>P (15%)</strong>: Pay Equity</li>
                            <li><strong>L (30%)</strong>: Local Impact</li>
                            <li><strong>A (15%)</strong>: Affordability</li>
                            <li><strong>E (15%)</strong>: Environmental</li>
                        </ul>
                    </li>`;
                }
                } else {
                sourcesHTML = `
                    <li style="background: #fff3e0; padding: 8px; border-radius: 4px; margin-bottom: 8px; border-left: 3px solid #ff9800;">
                        <strong style="color: #e65100;">‚ö†Ô∏è DEMO MODE</strong><br>
                        <span style="font-size: 9px; color: #666;">Showing simulated EJV 4.1 data. Connect to API for real values.</span>
                    </li>
                    <li><strong>EJV Version:</strong> 4.1 (6-Component Equal Weight)</li>
                    <li><strong>Components:</strong> LC, W, DN, EQ, ENV, PROC (simulated)</li>
                `;
            }
            }
            
            sourcesHTML += `
                <li><strong>Retention Rate:</strong> ${retentionPct.toFixed(1)}% (ELVR/(ELVR+EVL))</li>
                <li><strong>ELVR:</strong> $${elvr.toFixed(2)} (Local value retained)</li>
                <li><strong>EVL:</strong> $${evl.toFixed(2)} (Value leakage)</li>
            `;
            
            dataSourcesList.innerHTML = sourcesHTML;
        }

        function closeRightDashboard() {
            document.getElementById('rightDashboard').style.display = 'none';
        }

        function clearMarkers() {
            console.log('Clearing', markers.length, 'markers...');
            if (window.graphicsLayer) {
                window.graphicsLayer.removeAll();
            }
            markers.forEach(marker => {
                if (map && map.hasLayer(marker)) {
                    try {
                        map.removeLayer(marker);
                    } catch (e) {
                        console.warn('Error removing marker:', e);
                    }
                }
            });
            markers = [];
            hideImpactCircle();
            // Clear the store list display
            const storeListDiv = document.getElementById('storeList');
            if (storeListDiv) {
                storeListDiv.innerHTML = '';
            }
            // Clear ejvCache to prevent old data from showing
            ejvCache = {};
            console.log('Markers and cache cleared');
        }
        
        // Complete data reset function
        function resetAllSearchData() {
            console.log('=== COMPLETE DATA RESET ===');
            clearMarkers();
            window.storeData = [];
            rawStores = [];
            allStoresEJV = [];
            ejvCache = {};
            console.log('All search data reset');
        }

        // ==========================================
        // Health Score Fetching
        // ==========================================
        async function fetchHealthScore(storeId, storeName, lat, lon, address) {
            try {
                // Include current zipcode in the request to help determine the correct city API
                const zipcodeParam = currentZip ? `&zipcode=${currentZip}` : '';
                const response = await fetch(`/api/health-score?name=${encodeURIComponent(storeName)}&lat=${lat}&lon=${lon}&address=${encodeURIComponent(address)}${zipcodeParam}`);
                const data = await response.json();
                
                const healthScoreDiv = document.getElementById(`health-score-${storeId}`);
                const healthScorePopup = document.getElementById(`health-score-popup-${storeId}`);
                
                if (data.available && data.grade) {
                    // Grade color mapping
                    let gradeColor, displayText;
                    if (data.grade === 'A') {
                        gradeColor = '#28a745';
                    } else if (data.grade === 'B') {
                        gradeColor = '#ffc107';
                    } else if (data.grade === 'C') {
                        gradeColor = '#ff6b6b';
                    } else if (data.grade === 'F') {
                        gradeColor = '#dc3545';
                    } else if (data.grade === 'Pending' || data.grade === 'Z' || data.grade === 'P' || data.grade === 'N') {
                        gradeColor = '#999';
                        displayText = 'Pending';
                    } else {
                        gradeColor = '#999';
                    }
                    
                    const scoreText = data.score ? ` (${data.score})` : '';
                    const gradeDisplay = displayText || data.grade;
                    const sourceText = data.source ? `<br><small style="color: #666;">${data.source}</small>` : '';
                    const healthHtml = `üè• Health: <span style="color: ${gradeColor}; font-weight: 700;">${gradeDisplay}${scoreText}</span>${sourceText}`;
                    
                    if (healthScoreDiv) healthScoreDiv.innerHTML = healthHtml;
                    if (healthScorePopup) healthScorePopup.innerHTML = healthHtml;
                } else {
                    if (healthScoreDiv) healthScoreDiv.innerHTML = 'üè• <span style="color: #999;">Health score not available</span>';
                    if (healthScorePopup) healthScorePopup.innerHTML = '';
                }
            } catch (error) {
                console.error('Error fetching health score:', error);
                const healthScoreDiv = document.getElementById(`health-score-${storeId}`);
                if (healthScoreDiv) healthScoreDiv.innerHTML = '';
            }
        }

        // ==========================================
        // Map Search Bar Functionality
        // ==========================================
        let searchTimeout = null;
        let selectedSearchIndex = -1;
        let googleAutocompleteService = null;
        let googlePlacesService = null;

        // AI Smart Search - Simple query-based search
        async function performAISearch() {
            const query = document.getElementById('aiSearchInput').value.trim();

            if (!query) {
                showResult('Please enter a search query (e.g., Walmart in Huntsville, AL)');
                return;
            }

            showLoading(true);
            showResult(`ü§ñ AI searching for "${query}"...`);

            try {
                // Clear previous results
                clearMarkers();
                allStoresEJV = [];
                ejvCache = {};
                rawStores = [];
                window.storeData = [];

                // Search using Nominatim
                const searchUrl = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=20&addressdetails=1`;
                const response = await fetch(searchUrl);
                const results = await response.json();

                if (results.length === 0) {
                    showResult(`No results found for "${query}". Try different keywords.`);
                    showLoading(false);
                    return;
                }

                showResult(`Found ${results.length} result(s). Displaying on map...`);

                // Get first result's location as reference point
                const centerLat = parseFloat(results[0].lat);
                const centerLon = parseFloat(results[0].lon);

                // Process each result
                let processedCount = 0;
                for (const result of results) {
                    const storeLat = parseFloat(result.lat);
                    const storeLon = parseFloat(result.lon);
                    const name = result.name || result.display_name.split(',')[0];
                    const address = result.display_name;
                    
                    // Determine category
                    const category = determineStoreCategory(result);

                    // Create store object
                    const storeObj = {
                        lat: storeLat,
                        lon: storeLon,
                        tags: {
                            name: name,
                            'addr:full': address,
                            shop: category
                        }
                    };

                    rawStores.push(storeObj);

                    // Calculate distance from center
                    const distance = calculateDistance(centerLat, centerLon, storeLat, storeLon);

                    // Add to storeData
                    window.storeData.push({
                        name: name,
                        address: address,
                        lat: storeLat,
                        lon: storeLon,
                        distance: distance,
                        category: category
                    });

                    // Get category icon
                    const categoryIcon = getCategoryIcon(category);

                    // Add marker to map with blue color
                    const marker = L.marker([storeLat, storeLon], {
                        icon: L.divIcon({
                            className: 'custom-div-icon',
                            html: `<div style="background-color: #4285f4; width: 28px; height: 28px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; font-size: 14px;">${categoryIcon}</div>`,
                            iconSize: [28, 28],
                            iconAnchor: [14, 14]
                        })
                    });

                    // Bind hover event to show EJV
                    marker.on('mouseover', function() {
                        displayStoreInfoOnHover(storeObj);
                    });

                    // Create popup with EJV button
                    const popupContent = `
                        <div style="min-width: 200px;">
                            <strong style="font-size: 14px;">${name}</strong><br>
                            <span style="font-size: 12px; color: #666;">${address}</span><br>
                            <button onclick="calculateStoreEJV(${processedCount})" style="margin-top: 8px; padding: 6px 12px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; width: 100%;">
                                Calculate EJV
                            </button>
                        </div>
                    `;
                    
                    marker.bindPopup(popupContent);
                    marker.addTo(map);
                    markers.push(marker);
                    
                    processedCount++;
                }

                // Display results in sidebar
                displayStoreResultsWithEJV(window.storeData);

                // Fit map to show all markers
                if (markers.length > 0) {
                    const group = L.featureGroup(markers);
                    map.fitBounds(group.getBounds().pad(0.1));
                }

                showResult(`‚úÖ Found ${processedCount} store(s). Calculating EJV values...`);
                
                // Auto-calculate EJV for all stores in background
                autoCalculateAllStoreEJV();

            } catch (error) {
                console.error('AI Search error:', error);
                showResult('Error searching. Please try again.');
            } finally {
                showLoading(false);
            }
        }

        // Auto-calculate EJV for all stores in search results
        async function autoCalculateAllStoreEJV() {
            if (!window.storeData || window.storeData.length === 0) {
                return;
            }
            
            console.log(`Auto-calculating EJV for ${window.storeData.length} stores...`);
            
            // Calculate EJV for each store sequentially (to avoid overwhelming the API)
            for (let i = 0; i < window.storeData.length; i++) {
                const store = window.storeData[i];
                
                // Generate unique store ID
                const storeId = `store_${store.lat.toFixed(6)}_${store.lon.toFixed(6)}`;
                
                // Skip if already calculated
                const existingEJV = allStoresEJV.find(s => 
                    s.id === storeId || s.name === store.name || (s.lat === store.lat && s.lon === store.lon)
                );
                
                if (existingEJV) {
                    console.log(`Store ${store.name} already has EJV data, skipping`);
                    continue;
                }
                
                // Ensure store exists in rawStores array with proper structure
                const existingRawStore = rawStores.find(s => 
                    (s.lat === store.lat && s.lon === store.lon) || s.id === storeId
                );
                
                if (!existingRawStore) {
                    // Add to rawStores if not already there
                    const rawStoreObj = {
                        id: storeId,
                        lat: store.lat,
                        lon: store.lon,
                        tags: {
                            name: store.name,
                            'addr:full': store.address
                        },
                        _cachedAddress: store.address,
                        _cachedWebsite: store.website || null
                    };
                    rawStores.push(rawStoreObj);
                    console.log(`Added ${store.name} to rawStores with ID ${storeId}`);
                }
                
                // Get ZIP code for the store location
                try {
                    const geocodeUrl = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${store.lat}&lon=${store.lon}&addressdetails=1`;
                    const geocodeResponse = await fetch(geocodeUrl);
                    const geocodeData = await geocodeResponse.json();
                    
                    const zipCode = geocodeData.address?.postcode || currentZip || '10001';
                    currentZip = zipCode;
                    
                    // Calculate EJV
                    console.log(`Calculating EJV for ${store.name} (${i+1}/${window.storeData.length}) with storeId: ${storeId}`);
                    await calculateEJV(storeId, store.name, false);
                    
                    // Small delay to avoid overwhelming the API
                    await new Promise(resolve => setTimeout(resolve, 50));
                    
                } catch (error) {
                    console.error(`Error calculating EJV for ${store.name}:`, error);
                    // Even if geocoding fails, try with default ZIP
                    try {
                        console.log(`Retrying with default ZIP for ${store.name}`);
                        currentZip = currentZip || '10001';
                        await calculateEJV(storeId, store.name, false);
                    } catch (retryError) {
                        console.error(`Retry also failed for ${store.name}:`, retryError);
                    }
                }
            }
            
            // Refresh the display to show all calculated values
            console.log(`Finished calculating EJV for all stores. Total in allStoresEJV: ${allStoresEJV.length}`);
            displayStoreResultsWithEJV(window.storeData);
            showResult(`‚úÖ EJV values calculated for ${allStoresEJV.length} store(s)!`);
        }

        // Quick Find Store with Automatic EJV Calculation (DEPRECATED - Using AI Search now)
        async function quickFindStore() {
            // Redirect to AI Search
            performAISearch();
        }

        // Calculate EJV for a single store
        async function calculateSingleStoreEJV(storeIndex) {
            if (!window.storeData || storeIndex >= window.storeData.length) {
                return;
            }

            const store = window.storeData[storeIndex];
            
            // Skip if already calculated
            if (store.ejv) {
                showStoreDetails(storeIndex);
                return;
            }

            try {
                const ejvResult = await calculateEJV(store.id, store.name, false, store.zipCode);
                
                if (ejvResult) {
                    // Update store data
                    store.ejv = ejvResult.ejv;
                    store.rawScore = ejvResult.rawScore;
                    store.breakdown = ejvResult.breakdown;

                    const cacheKey = `${store.name}_${store.zipCode}`;
                    ejvCache[cacheKey] = ejvResult;

                    // Update marker color
                    const markerColor = getEJVColor(ejvResult.ejv);
                    const categoryIcon = getCategoryIcon(store.category);
                    
                    if (markers[storeIndex]) {
                        markers[storeIndex].setIcon(L.divIcon({
                            className: 'custom-div-icon',
                            html: `<div style="background-color: ${markerColor}; width: 32px; height: 32px; border-radius: 50%; border: 3px solid white; box-shadow: 0 3px 8px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; font-size: 16px;">${categoryIcon}</div>`,
                            iconSize: [32, 32],
                            iconAnchor: [16, 16]
                        }));

                        // Update popup
                        const popupContent = `
                            <div style="min-width: 220px;">
                                <strong style="font-size: 14px;">${store.name}</strong><br>
                                <span style="font-size: 11px; color: #666;">${store.address}</span><br>
                                <div style="margin-top: 8px; padding: 8px; background: ${markerColor}; color: white; border-radius: 4px; text-align: center; font-weight: bold;">
                                    EJV: ${ejvResult.ejv.toFixed(2)}
                                </div>
                                <button onclick="showStoreDetails(${storeIndex})" style="margin-top: 6px; padding: 6px 12px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px; width: 100%;">
                                    View Full Details
                                </button>
                            </div>
                        `;
                        markers[storeIndex].setPopupContent(popupContent);
                    }

                    // Refresh the sidebar display
                    displayQuickFindResults(window.storeData);

                    return ejvResult;
                }
            } catch (error) {
                console.error(`Error calculating EJV for ${store.name}:`, error);
            }
            return null;
        }

        // Get ZIP code for a location
        async function getZipCodeForLocation(lat, lon) {
            try {
                const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&addressdetails=1`;
                const response = await fetch(url);
                const data = await response.json();
                return data.address?.postcode || '10001';
            } catch (error) {
                return '10001'; // Default ZIP
            }
        }

        // Get color based on EJV value
        function getEJVColor(ejv) {
            if (ejv >= 8) return '#4caf50'; // Green - High EJV
            if (ejv >= 6) return '#8bc34a'; // Light Green
            if (ejv >= 4) return '#ffc107'; // Yellow
            if (ejv >= 2) return '#ff9800'; // Orange
            return '#f44336'; // Red - Low EJV
        }

        // Display quick find results with EJV
        function displayQuickFindResults(stores) {
            const storeList = document.getElementById('storeList');
            storeList.innerHTML = '';

            if (stores.length === 0) {
                storeList.innerHTML = '<p style="color: #666; font-size: 12px; padding: 10px;">No stores found</p>';
                return;
            }

            // Sort by EJV (highest first), then by distance
            stores.sort((a, b) => {
                if (a.ejv && b.ejv) return b.ejv - a.ejv;
                if (a.ejv) return -1;
                if (b.ejv) return 1;
                return a.distance - b.distance;
            });

            stores.forEach((store, index) => {
                const storeItem = document.createElement('div');
                const bgColor = store.ejv ? getEJVColor(store.ejv) : '#f5f5f5';
                const textColor = store.ejv ? 'white' : '#333';
                
                storeItem.className = `store-item`;
                storeItem.style.borderLeft = `4px solid ${bgColor}`;
                storeItem.innerHTML = `
                    <div class="store-name">
                        <span class="store-icon">${getCategoryIcon(store.category)}</span>
                        ${store.name}
                    </div>
                    <div class="store-address">${store.address}</div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 6px;">
                        <span style="font-size: 11px; color: #999;">
                            üìè ${(store.distance / 1000).toFixed(2)} km
                        </span>
                        ${store.ejv ? `
                            <div style="background: ${bgColor}; color: white; padding: 4px 10px; border-radius: 3px; font-weight: bold; font-size: 12px;">
                                EJV: ${store.ejv.toFixed(2)}
                            </div>
                        ` : `
                            <span style="font-size: 10px; color: #999;">No EJV data</span>
                        `}
                    </div>
                `;
                
                storeItem.onclick = () => {
                    map.setView([store.lat, store.lon], 16);
                    if (markers[index]) {
                        markers[index].openPopup();
                    }
                    if (store.ejv) {
                        showStoreDetails(index);
                    }
                };

                storeList.appendChild(storeItem);
            });
        }

        // Show detailed store information
        function showStoreDetails(storeIndex) {
            if (!window.storeData || storeIndex >= window.storeData.length) {
                return;
            }

            const store = window.storeData[storeIndex];
            if (!store.breakdown) return;

            updateDashboard(store, {
                ejv: store.ejv,
                rawScore: store.rawScore,
                breakdown: store.breakdown
            });
        }

        // Display store info on hover or click
        async function displayStoreInfoOnHover(storeIndex) {
            if (!window.storeData || storeIndex >= window.storeData.length) {
                return;
            }

            const store = window.storeData[storeIndex];
            
            // Update store info header
            document.getElementById('storeNameDisplay').textContent = store.name;
            document.getElementById('storeLocationDisplay').textContent = store.address;

            // If EJV already calculated, show it
            if (store.ejv) {
                showStoreDetails(storeIndex);
            } else {
                // Calculate EJV if not already done
                await calculateSingleStoreEJV(storeIndex);
            }
        }

        // Search directly on Google
        async function searchDirectlyOnGoogle() {
            const query = document.getElementById('mapSearchInput').value.trim();
            
            if (!query) {
                showResult('Please enter a search term');
                return;
            }

            showLoading(true);
            hideMapSearchAutocomplete();
            showResult(`Searching for "${query}"...`);

            try {
                // Get current map center for location-based search
                const center = map.getCenter();
                const lat = center.lat;
                const lon = center.lng;

                // First try to geocode/find the location
                const searchUrl = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=20&addressdetails=1`;
                const response = await fetch(searchUrl);
                const results = await response.json();

                if (results.length === 0) {
                    showResult(`No results found for "${query}". Try different keywords.`);
                    showLoading(false);
                    return;
                }

                // Clear previous results
                clearMarkers();
                allStoresEJV = [];
                ejvCache = {};
                rawStores = [];
                window.storeData = [];

                showResult(`Found ${results.length} result(s) for "${query}". Calculating EJV values...`);

                // Process each result
                let processedCount = 0;
                for (const result of results) {
                    const storeLat = parseFloat(result.lat);
                    const storeLon = parseFloat(result.lon);
                    const name = result.name || result.display_name.split(',')[0];
                    const address = result.display_name;
                    
                    // Determine category
                    const category = determineStoreCategory(result);

                    // Create store object
                    const storeObj = {
                        lat: storeLat,
                        lon: storeLon,
                        tags: {
                            name: name,
                            'addr:full': address,
                            shop: category
                        }
                    };

                    rawStores.push(storeObj);

                    // Calculate distance from search center
                    const distance = calculateDistance(lat, lon, storeLat, storeLon);

                    // Add to storeData
                    window.storeData.push({
                        name: name,
                        address: address,
                        lat: storeLat,
                        lon: storeLon,
                        distance: distance,
                        category: category
                    });

                    // Get category icon
                    const categoryIcon = getCategoryIcon(category);

                    // Add marker to map
                    const marker = L.marker([storeLat, storeLon], {
                        icon: L.divIcon({
                            className: 'custom-div-icon',
                            html: `<div style="background-color: #4285f4; width: 28px; height: 28px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; font-size: 14px;">${categoryIcon}</div>`,
                            iconSize: [28, 28],
                            iconAnchor: [14, 14]
                        })
                    });

                    // Create popup with EJV button
                    const popupContent = `
                        <div style="min-width: 200px;">
                            <strong style="font-size: 14px;">${name}</strong><br>
                            <span style="font-size: 12px; color: #666;">${address}</span><br>
                            <button onclick="calculateStoreEJV(${processedCount})" style="margin-top: 8px; padding: 6px 12px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; width: 100%;">
                                Calculate EJV
                            </button>
                        </div>
                    `;
                    
                    marker.bindPopup(popupContent);
                    marker.addTo(map);
                    markers.push(marker);
                    
                    processedCount++;
                }

                // Display results in sidebar
                displayStoreResultsWithEJV(window.storeData);

                // Fit map to show all markers
                if (markers.length > 0) {
                    const group = L.featureGroup(markers);
                    map.fitBounds(group.getBounds().pad(0.1));
                }

                showResult(`Found ${processedCount} store(s) for "${query}". Click on markers or Calculate EJV buttons to see details.`);

            } catch (error) {
                console.error('Search error:', error);
                showResult('Error searching. Please try again.');
            } finally {
                showLoading(false);
            }
        }

        // Calculate EJV for a specific store by index
        async function calculateStoreEJV(storeIndex) {
            if (!window.storeData || storeIndex >= window.storeData.length) {
                return;
            }

            const store = window.storeData[storeIndex];
            showLoading(true);
            showResult(`Calculating EJV for ${store.name}...`);

            try {
                // Get ZIP code for the store location
                const geocodeUrl = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${store.lat}&lon=${store.lon}&addressdetails=1`;
                const geocodeResponse = await fetch(geocodeUrl);
                const geocodeData = await geocodeResponse.json();
                
                const zipCode = geocodeData.address?.postcode || '10001';
                currentZip = zipCode;

                // Calculate EJV
                const ejvResult = await calculateEJV(store.name, zipCode);
                
                if (ejvResult) {
                    // Store in cache
                    const cacheKey = `${store.name}_${zipCode}`;
                    ejvCache[cacheKey] = ejvResult;

                    // Update store data
                    store.ejv = ejvResult.ejv;
                    store.rawScore = ejvResult.rawScore;
                    store.breakdown = ejvResult.breakdown;

                    // Show results in dashboard
                    updateDashboard(store, ejvResult);
                    
                    showResult(`‚úì EJV calculated for ${store.name}: ${ejvResult.ejv.toFixed(2)}`);
                } else {
                    showResult(`Could not calculate EJV for ${store.name}`);
                }

            } catch (error) {
                console.error('EJV calculation error:', error);
                showResult('Error calculating EJV. Please try again.');
            } finally {
                showLoading(false);
            }
        }

        // Display store results with EJV calculation buttons
        function displayStoreResultsWithEJV(stores) {
            const storeList = document.getElementById('storeList');
            storeList.innerHTML = '';

            if (stores.length === 0) {
                storeList.innerHTML = '<p style="color: #666; font-size: 12px; padding: 10px;">No stores found</p>';
                return;
            }

            stores.forEach((store, index) => {
                // Try to find EJV data for this store in allStoresEJV array
                const ejvData = allStoresEJV.find(s => 
                    s.name === store.name || 
                    (s.lat === store.lat && s.lon === store.lon)
                );
                
                console.log(`Display store ${store.name}: EJV data found:`, ejvData ? 'YES' : 'NO', ejvData);
                
                const storeItem = document.createElement('div');
                storeItem.className = `store-item ${store.category}`;
                storeItem.innerHTML = `
                    <div class="store-name">
                        <span class="store-icon">${getCategoryIcon(store.category)}</span>
                        ${store.name}
                    </div>
                    <div class="store-address">${store.address}</div>
                    <div style="font-size: 11px; color: #999; margin-top: 3px;">
                        üìè ${(store.distance / 1000).toFixed(2)} km away
                    </div>
                    ${ejvData ? `
                        <div style="margin-top: 8px; padding: 8px; background: #f0f7ff; border-radius: 4px; border-left: 3px solid #667eea;">
                            <div style="display: flex; gap: 8px; flex-wrap: wrap; font-size: 10px;">
                                <span style="background: #667eea; color: white; padding: 4px 8px; border-radius: 3px; font-weight: 600;">
                                    ELVR: $${(ejvData.elvr || 0).toFixed(2)}
                                </span>
                                <span style="background: #dc3545; color: white; padding: 4px 8px; border-radius: 3px; font-weight: 600;">
                                    EVL: $${(ejvData.evl || 0).toFixed(2)}
                                </span>
                                <span style="background: #28a745; color: white; padding: 4px 8px; border-radius: 3px; font-weight: 600;">
                                    ${(ejvData.retention_percentage || 0).toFixed(1)}% Retention
                                </span>
                            </div>
                            <div style="font-size: 10px; color: #666; margin-top: 4px;">
                                EJV v2: ${(ejvData.ejv_v2_baseline || 0).toFixed(2)}
                            </div>
                        </div>
                    ` : `
                        <div style="margin-top: 8px; padding: 6px; background: #fff3e0; border-radius: 4px; text-align: center; font-size: 10px; color: #e65100;">
                            Hover over map marker to calculate EJV
                        </div>
                    `}
                `;
                
                storeItem.onclick = (e) => {
                    // Don't trigger if clicking the button
                    if (e.target.tagName === 'BUTTON') return;
                    
                    // Zoom to the store on map
                    map.setView([store.lat, store.lon], 16);
                    // Highlight the marker
                    if (markers[index]) {
                        markers[index].openPopup();
                    }
                };

                storeList.appendChild(storeItem);
            });
        }

        // Load Google Places API dynamically
        function loadGooglePlacesAPI() {
            const apiKey = document.getElementById('googlePlacesApiKey').value.trim();
            
            if (!apiKey) {
                alert('Please enter a Google Places API key');
                return;
            }

            // Check if already loaded
            if (typeof google !== 'undefined' && google.maps && google.maps.places) {
                console.log('Google Places API already loaded');
                initializeGooglePlaces();
                return;
            }

            // Remove any existing script
            const existingScript = document.querySelector('script[src*="maps.googleapis.com"]');
            if (existingScript) {
                existingScript.remove();
            }

            // Load the script
            const script = document.createElement('script');
            script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&libraries=places&callback=initializeGooglePlaces`;
            script.async = true;
            script.defer = true;
            
            script.onerror = () => {
                alert('Failed to load Google Places API. Please check your API key and ensure:\n1. Places API is enabled\n2. Billing is set up\n3. Key has proper restrictions');
            };

            // Store API key in localStorage
            localStorage.setItem('googlePlacesApiKey', apiKey);
            
            document.head.appendChild(script);
        }

        // Initialize map search bar
        document.addEventListener('DOMContentLoaded', function() {
            // Check for saved API key and auto-load
            const savedApiKey = localStorage.getItem('googlePlacesApiKey');
            if (savedApiKey) {
                const apiKeyInput = document.getElementById('googlePlacesApiKey');
                if (apiKeyInput) {
                    apiKeyInput.value = savedApiKey;
                    // Auto-load if API key exists
                    setTimeout(() => loadGooglePlacesAPI(), 1000);
                }
            }
        });

        // Free search using OpenStreetMap (no API key required)
        // Global variable to store user's location
        let userLocation = null;
        
        // Chain/brand keywords for nearby search
        const chainKeywords = ['walmart', 'target', 'kroger', 'safeway', 'whole foods', 'trader joe', 'wegmans', 'publix', 
                               'costco', 'cvs', 'walgreens', 'mcdonalds', 'burger king', 'subway', 'starbucks', 
                               'chipotle', 'panera', 'dunkin', 'taco bell', 'kfc', 'wendys', 'arbys'];
        
        async function getUserLocation() {
            const btn = document.getElementById('enableLocationBtn');
            if (!btn) return;
            
            btn.disabled = true;
            btn.innerHTML = '‚è≥ Getting location...';
            
            if (!navigator.geolocation) {
                alert('Geolocation is not supported by your browser');
                btn.disabled = false;
                btn.innerHTML = 'üìç Enable My Location';
                return;
            }
            
            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    userLocation = {
                        lat: position.coords.latitude,
                        lon: position.coords.longitude
                    };
                    
                    // Update button
                    btn.innerHTML = '‚úÖ Location Enabled';
                    btn.style.background = 'linear-gradient(135deg, #28a745 0%, #20873a 100%)';
                    btn.disabled = false;
                    
                    // Center map on user location
                    map.setView([userLocation.lat, userLocation.lon], 14);
                    
                    // Add user location marker
                    const existingUserMarker = markers.find(m => m.getPopup()?.getContent().includes('Your Location'));
                    if (existingUserMarker) {
                        map.removeLayer(existingUserMarker);
                        markers = markers.filter(m => m !== existingUserMarker);
                    }
                    
                    const userMarker = L.marker([userLocation.lat, userLocation.lon], {
                        icon: L.divIcon({
                            className: 'custom-div-icon',
                            html: '<div style="background: #4caf50; width: 28px; height: 28px; border-radius: 50%; border: 3px solid white; box-shadow: 0 3px 10px rgba(0,0,0,0.3);">üß≠</div>',
                            iconSize: [28, 28],
                            iconAnchor: [14, 14]
                        })
                    }).addTo(map);
                    userMarker.bindPopup('<strong>üìç Your Location</strong>').openPopup();
                    markers.push(userMarker);
                    
                    // Get address
                    try {
                        const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${userLocation.lat}&lon=${userLocation.lon}`);
                        const data = await response.json();
                        currentZip = data.address?.postcode || '10001';
                        showResult(`‚úÖ Location enabled! You can now search for stores near you.`);
                    } catch (error) {
                        showResult('‚úÖ Location enabled! You can now search for stores near you.');
                    }
                    
                    setTimeout(() => {
                        btn.disabled = false;
                    }, 2000);
                },
                (error) => {
                    
                    btn.disabled = false;
                    btn.innerHTML = 'üìç Enable My Location';
                    btn.style.background = 'linear-gradient(135deg, #4caf50 0%, #45a049 100%)';
                    
                    if (error.code === error.PERMISSION_DENIED) {
                        showResult('‚ùå Location permission denied. Please use "Search by Address" instead.');
                    } else {
                        showResult('‚ùå Error getting location. Please use "Search by Address" instead.');
                    }
                }
            );
        }
        
        // Unified search function - handles both store names and addresses
        // Simple search function - works with any address
        window.simpleSearch = async function simpleSearch() {
            console.log('=== SIMPLE SEARCH STARTED ===');
            
            const searchInput = document.getElementById('simpleSearchInput');
            if (!searchInput) {
                console.error('Search input not found!');
                alert('Error: Search box not found. Please refresh the page.');
                return;
            }
            
            const query = searchInput.value.trim();
            console.log('Search query:', query);
            
            if (!query) {
                alert('Please enter a store name and location or an address');
                return;
            }
            
            // Clear all previous search results first
            console.log('‚Üí Clearing previous markers and data...');
            clearMarkers();
            window.storeData = [];
            rawStores = [];
            allStoresEJV = [];
            ejvCache = {};
            
            showLoading(true);
            showResult(`Searching for "${query}"...`);
            
            try {
                console.log('‚Üí Searching for:', query);
                
                // Build URL with better parameters for finding stores
                const geocodeUrl = `https://nominatim.openstreetmap.org/search?` +
                    `format=json` +
                    `&q=${encodeURIComponent(query)}` +
                    `&limit=10` +
                    `&addressdetails=1` +
                    `&namedetails=1` +
                    `&extratags=1` +
                    `&dedupe=0`;
                
                console.log('‚Üí URL:', geocodeUrl);
                
                // Add timeout
                const timeoutPromise = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('Search timeout after 15 seconds')), 15000)
                );
                
                const fetchPromise = fetch(geocodeUrl, {
                    headers: {
                        'User-Agent': 'EJV-Search-App',
                        'Accept': 'application/json'
                    }
                });
                
                const response = await Promise.race([fetchPromise, timeoutPromise]);
                
                console.log('‚Üí Response status:', response.status);
                
                if (!response.ok) {
                    if (response.status === 429) {
                        throw new Error('Too many requests. Please wait a moment and try again.');
                    }
                    throw new Error(`Search failed (Status ${response.status}). Try a different search term.`);
                }
                
                const results = await response.json();
                console.log('‚Üí Results found:', results.length);
                console.log('‚Üí First result sample:', results[0]);
                
                if (results.length === 0) {
                    showResult(`‚ùå No results found for "${query}". Try:\n‚Ä¢ Adding city/state (e.g., "Walmart Huntsville AL")\n‚Ä¢ Using a full address\n‚Ä¢ Different spelling`);
                    showLoading(false);
                    return;
                }
                
                // Clear existing markers
                clearMarkers();
                window.storeData = [];
                
                // Process results
                window.storeData = results.slice(0, 5).map((result, idx) => {
                    const storeLat = parseFloat(result.lat);
                    const storeLon = parseFloat(result.lon);
                    const distance = 0; // No user location, so distance is 0
                    
                    // Extract store name - try to get the actual business name
                    let storeName = result.display_name.split(',')[0];
                    
                    // Check if result has name/shop/amenity tags (actual store name)
                    if (result.namedetails && result.namedetails.name) {
                        storeName = result.namedetails.name;
                    } else if (result.name) {
                        storeName = result.name;
                    }
                    
                    console.log(`Result ${idx + 1}: ${storeName} at [${storeLat}, ${storeLon}]`);
                    
                    return {
                        id: `search_${idx}`,
                        name: storeName,
                        address: result.display_name,
                        lat: storeLat,
                        lon: storeLon,
                        distance: distance,
                        category: 'location',
                        zipCode: result.address?.postcode || currentZip,
                        ejv: null,
                        rawScore: null,
                        breakdown: null
                    };
                });
                
                rawStores = [...window.storeData];
                
                console.log('‚Üí Centering map on:', window.storeData[0].lat, window.storeData[0].lon);
                
                // Center map on first result
                map.setView([window.storeData[0].lat, window.storeData[0].lon], 13);
                
                // Add markers
                window.storeData.forEach((store, idx) => {
                    console.log(`Adding marker ${idx + 1} at [${store.lat}, ${store.lon}]`);
                    
                    const marker = L.marker([store.lat, store.lon], {
                        icon: L.divIcon({
                            className: 'custom-div-icon',
                            html: `<div style="background: #667eea; width: 30px; height: 30px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 11px; color: white;">${idx + 1}</div>`,
                            iconSize: [30, 30],
                            iconAnchor: [15, 15]
                        })
                    }).addTo(map);
                    
                    marker.bindPopup(`
                        <div style="min-width: 200px;">
                            <strong>${store.name}</strong><br>
                            <span style="font-size: 11px; color: #666;">${store.address}</span><br>
                            ${store.distance > 0 ? `<span style="font-size: 10px; color: #999;">${store.distance.toFixed(2)} km away</span><br>` : ''}
                            <button onclick="calculateChainStoreEJV(${idx})" style="margin-top: 8px; padding: 6px 12px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px; width: 100%; font-weight: 600;">
                                Calculate EJV
                            </button>
                        </div>
                    `);
                    
                    markers.push(marker);
                });
                
                // Display results
                if (window.storeData.length > 1) {
                    displayChainSearchResults(window.storeData, query);
                }
                
                showResult(`‚úì Found ${window.storeData.length} location(s) for "${query}"`);
                showLoading(false);
                
            } catch (error) {
                console.error('Unified search error:', error);
                showResult(`‚ùå Search failed: ${error.message}. Please try again.`);
                showLoading(false);
            }
        }
        
        // Find and display address on map with stores and EJV
        async function findAddress() {
            console.log('=== FIND ADDRESS WITH STORES STARTED ===');
            console.log('Clearing all previous data...');
            
            const searchInput = document.getElementById('simpleSearchInput');
            if (!searchInput) {
                console.error('Search input not found!');
                alert('Search box not found');
                return;
            }
            
            const originalAddress = searchInput.value.trim();
            console.log('Original address:', originalAddress);
            
            if (!originalAddress) {
                alert('Please enter an address or location');
                return;
            }
            
            // Clean address: Remove suite/unit/apt numbers that Nominatim can't handle
            // Pattern matches: suite a, unit 123, apt 5, #123, etc.
            let address = originalAddress.replace(/\b(suite|unit|apt|apartment|#)\s*[a-z0-9\-]+\b/gi, '').trim();
            // Clean up multiple spaces and commas
            address = address.replace(/\s+/g, ' ').replace(/,\s*,/g, ',').replace(/,\s*$/, '');
            
            if (address !== originalAddress) {
                console.log(`Address cleaned: "${originalAddress}" ‚Üí "${address}"`);
                showResult(`üìç Searching for: "${originalAddress}" (cleaned: "${address}")`);
            } else {
                console.log('Address to find:', address);
            }
            
            // Check if map is initialized
            if (!map) {
                console.error('Map not initialized!');
                alert('Map not ready. Please try again in a moment.');
                return;
            }
            
            // CRITICAL: Clear ALL previous data immediately
            console.log('Clearing markers and data structures...');
            clearMarkers();
            window.storeData = [];
            rawStores = [];
            allStoresEJV = [];
            ejvCache = {};
            
            // Clear the store list display
            const storeList = document.getElementById('storeList');
            if (storeList) {
                storeList.innerHTML = '<p style="color: #666; font-size: 12px; padding: 10px;">Loading...</p>';
            }
            
            showLoading(true);
            showResult(`üìç Searching for: "${address}"...`);
            
            try {
                // Step 1: Try multiple geocoding strategies for better address recognition
                let results = [];
                let lastError = null;
                
                // Strategy 1: Direct search with address details (with timeout)
                console.log('Strategy 1: Direct address search...');
                const url1 = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&limit=5&addressdetails=1&extratags=1`;
                
                try {
                    const timeout1 = new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('Geocoding timeout')), 10000)
                    );
                    
                    const fetch1 = fetch(url1, {
                        headers: {
                            'User-Agent': 'FIX-EJV-App/1.0',
                            'Accept': 'application/json'
                        }
                    });
                    
                    const response1 = await Promise.race([fetch1, timeout1]);
                    
                    if (response1.ok) {
                        results = await response1.json();
                        console.log('Strategy 1 results:', results.length);
                    }
                } catch (e) {
                    console.warn('Strategy 1 failed:', e.message);
                    lastError = e;
                }
                
                // Strategy 2: If no results, try with structured search
                if (results.length === 0 && address.includes(',')) {
                    console.log('Strategy 2: Structured search...');
                    try {
                        const parts = address.split(',').map(p => p.trim());
                        let structuredUrl = 'https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&limit=5';
                        
                        if (parts.length >= 1) structuredUrl += `&street=${encodeURIComponent(parts[0])}`;
                        if (parts.length >= 2) structuredUrl += `&city=${encodeURIComponent(parts[1])}`;
                        if (parts.length >= 3) structuredUrl += `&state=${encodeURIComponent(parts[2])}`;
                        
                        const timeout2 = new Promise((_, reject) => 
                            setTimeout(() => reject(new Error('Geocoding timeout')), 10000)
                        );
                        
                        const fetch2 = fetch(structuredUrl, {
                            headers: {
                                'User-Agent': 'FIX-EJV-App/1.0',
                                'Accept': 'application/json'
                            }
                        });
                        
                        const response2 = await Promise.race([fetch2, timeout2]);
                        
                        if (response2.ok) {
                            results = await response2.json();
                            console.log('Strategy 2 results:', results.length);
                        }
                    } catch (e) {
                        console.warn('Strategy 2 failed:', e.message);
                        lastError = e;
                    }
                }
                
                // Strategy 3: If still no results, try as a place name
                if (results.length === 0) {
                    console.log('Strategy 3: Place name search...');
                    try {
                        const url3 = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&limit=5`;
                        
                        const timeout3 = new Promise((_, reject) => 
                            setTimeout(() => reject(new Error('Geocoding timeout')), 10000)
                        );
                        
                        const fetch3 = fetch(url3, {
                            headers: {
                                'User-Agent': 'FIX-EJV-App/1.0',
                                'Accept': 'application/json'
                            }
                        });
                        
                        const response3 = await Promise.race([fetch3, timeout3]);
                        
                        if (response3.ok) {
                            results = await response3.json();
                            console.log('Strategy 3 results:', results.length);
                        }
                    } catch (e) {
                        console.warn('Strategy 3 failed:', e.message);
                        lastError = e;
                    }
                }
                
                console.log('Total geocoding results:', results.length, 'found');
                console.log('Total geocoding results:', results.length, 'found');
                
                if (results.length === 0) {
                    const errorMsg = lastError && lastError.message.includes('timeout') 
                        ? `‚è±Ô∏è Search timed out for: "${address}"\n\nüí° Try:\n‚Ä¢ Waiting a moment and searching again\n‚Ä¢ Using a simpler search (just city name or ZIP)\n‚Ä¢ Using ZIP code search in left sidebar\n‚Ä¢ Checking your internet connection`
                        : `‚ùå Location not found: "${address}"\n\nüí° Try these formats:\n‚Ä¢ Store name: "Walmart"\n‚Ä¢ City: "Boston" or "New York"\n‚Ä¢ ZIP code: "10001"\n‚Ä¢ Full address: "123 Main St, New York, NY"\n‚Ä¢ Avoid special characters`;
                    
                    showResult(errorMsg);
                    showLoading(false);
                    return;
                }
                
                // Use the first (best) result
                const location = results[0];
                const lat = parseFloat(location.lat);
                const lon = parseFloat(location.lon);
                const displayName = location.display_name;
                const locationType = location.type;
                const locationClass = location.class;
                
                console.log('Location found:', lat, lon);
                console.log('Display name:', displayName);
                console.log('Type:', locationType, 'Class:', locationClass);
                
                // Double-check: Clear previous markers and data again
                console.log('Final data clear before new search...');
                clearMarkers();
                window.storeData = [];
                rawStores = [];
                allStoresEJV = [];
                ejvCache = {};
                
                // Clear sidebar
                const storeListElement = document.getElementById('storeList');
                if (storeListElement) {
                    storeListElement.innerHTML = '';
                }
                
                // Center map on the address
                map.setView([lat, lon], 17);
                
                // Check if the search result itself is a store/business
                const isStore = locationClass === 'shop' || 
                               locationClass === 'amenity' || 
                               location.extratags?.shop || 
                               location.extratags?.amenity ||
                               (location.name && location.address && (location.address.shop || location.address.amenity));
                
                console.log('Is this a store?', isStore);
                
                if (isStore) {
                    // User searched for a specific store - show ONLY that store
                    const storeName = location.name || displayName.split(',')[0];
                    showResult(`üè™ Searched: "${originalAddress}"\n‚úì Found: ${storeName}\n‚è≥ Calculating EJV...`);
                    const storeCategory = location.extratags?.shop || location.extratags?.amenity || locationType || 'all';
                    
                    window.storeData = [{
                        id: 'searched_store',
                        name: storeName,
                        address: displayName,
                        lat: lat,
                        lon: lon,
                        distance: 0,
                        category: storeCategory,
                        zipCode: location.address?.postcode || '10001',
                        ejv: null,
                        rawScore: null,
                        breakdown: null
                    }];
                    
                    rawStores = [...window.storeData];
                    
                    // Add marker for this specific store
                    const icon = getCategoryIcon(storeCategory);
                    const marker = L.marker([lat, lon], {
                        icon: L.divIcon({
                            className: 'custom-div-icon',
                            html: `<div style="background: #4caf50; width: 40px; height: 40px; border-radius: 50%; border: 4px solid white; box-shadow: 0 4px 12px rgba(0,0,0,0.4); display: flex; align-items: center; justify-content: center; font-size: 24px;">${icon}</div>`,
                            iconSize: [40, 40],
                            iconAnchor: [20, 40]
                        })
                    });
                    
                    marker.bindPopup(`
                        <div style="min-width: 240px; padding: 12px;">
                            <strong style="color: #4caf50; font-size: 16px;">üè™ ${storeName}</strong><br>
                            <div style="margin: 10px 0; padding: 10px; background: #e8f5e9; border-radius: 6px; font-size: 12px; color: #2e7d32; line-height: 1.5;">
                                ${displayName}
                            </div>
                            <div id="ejvQuickDisplay" style="margin-top: 10px; padding: 8px; background: #f8f9fa; border-radius: 4px; font-size: 12px; color: #666; text-align: center;">
                                ‚è≥ Calculating EJV...
                            </div>
                        </div>
                    `).openPopup();
                    
                    marker.addTo(map);
                    markers.push(marker);
                    
                    // Display in sidebar
                    displayQuickFindResults(window.storeData);
                    
                    // Calculate EJV for this store
                    showResult(`üè™ Analyzing "${storeName}"...`);
                    await calculateSingleStoreEJV(0);
                    
                    // Update popup with EJV
                    const store = window.storeData[0];
                    if (store.ejv) {
                        marker.setPopupContent(`
                            <div style="min-width: 240px; padding: 12px;">
                                <strong style="color: #4caf50; font-size: 16px;">üè™ ${storeName}</strong><br>
                                <div style="margin: 10px 0; padding: 10px; background: #e8f5e9; border-radius: 6px; font-size: 12px; color: #2e7d32; line-height: 1.5;">
                                    ${displayName}
                                </div>
                                <div style="margin-top: 10px; padding: 10px; background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%); border-radius: 6px; text-align: center; border: 2px solid #9c27b0;">
                                    <div style="font-size: 24px; font-weight: 700; color: #7b1fa2;">${store.ejv.toFixed(2)}</div>
                                    <div style="font-size: 10px; color: #4a148c; margin-top: 2px;">ECONOMIC JUSTICE VALUE</div>
                                </div>
                            </div>
                        `);
                    }
                    
                    displayQuickFindResults(window.storeData);
                    showResult(`‚úÖ "${originalAddress}"\n‚úÖ Found: ${storeName}\n‚úÖ EJV: ${store.ejv ? store.ejv.toFixed(2) : 'N/A'}`);
                    showLoading(false);
                    return;
                }
                
                // Not a specific store - search for stores nearby
                // Show user's original search for clarity
                const searchedFor = originalAddress;
                const foundLocation = displayName.split(',').slice(0, 3).join(','); // First 3 parts
                showResult(`üìç Searched: "${searchedFor}"
‚úì Found: ${foundLocation}
üîç Searching for stores within 500m...`);
                
                const radius = 500; // 500 meters
                const overpassQuery = `
                    [out:json][timeout:25];
                    (
                        node["shop"](around:${radius},${lat},${lon});
                        way["shop"](around:${radius},${lat},${lon});
                        node["amenity"~"restaurant|cafe|fast_food|pharmacy|bank|supermarket|convenience"](around:${radius},${lat},${lon});
                        way["amenity"~"restaurant|cafe|fast_food|pharmacy|bank|supermarket|convenience"](around:${radius},${lat},${lon});
                    );
                    out center 100;
                `;
                
                console.log('Searching for stores with Overpass...');
                showResult(`üîç Searching for stores near "${displayName.split(',')[0]}"...`);
                
                // Add timeout to Overpass request (30 seconds)
                const overpassTimeout = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('Store search timed out after 30 seconds')), 30000)
                );
                
                const overpassFetch = fetch('https://overpass-api.de/api/interpreter', {
                    method: 'POST',
                    body: overpassQuery,
                    headers: {
                        'Content-Type': 'text/plain'
                    }
                });
                
                let overpassResponse;
                let stores = [];
                
                try {
                    overpassResponse = await Promise.race([overpassFetch, overpassTimeout]);
                    
                    if (!overpassResponse.ok) {
                        console.warn('Overpass API returned non-OK status:', overpassResponse.status);
                        stores = [];
                    } else {
                        try {
                            const storeData = await overpassResponse.json();
                            stores = storeData.elements || [];
                        } catch (jsonError) {
                            console.warn('Overpass JSON parse error:', jsonError.message);
                            stores = [];
                        }
                    }
                } catch (timeoutError) {
                    console.warn('Overpass request failed or timed out:', timeoutError.message);
                    stores = [];
                }
                
                console.log(`Found ${stores.length} stores nearby`);
                
                if (stores.length === 0) {
                    // No stores found - just show the address marker with helpful message
                    console.log('No stores found nearby, showing location only');
                    
                    const marker = L.marker([lat, lon], {
                        icon: L.divIcon({
                            className: 'custom-div-icon',
                            html: `<div style="background: #2196f3; width: 40px; height: 40px; border-radius: 50%; border: 4px solid white; box-shadow: 0 4px 12px rgba(0,0,0,0.4); display: flex; align-items: center; justify-content: center; font-size: 24px;">üìç</div>`,
                            iconSize: [40, 40],
                            iconAnchor: [20, 40]
                        })
                    }).addTo(map);
                    
                    marker.bindPopup(`
                        <div style="min-width: 280px; padding: 12px;">
                            <strong style="color: #2196f3; font-size: 16px;">üìç ${originalAddress}</strong><br>
                            <div style="margin: 8px 0 12px 0; font-size: 11px; color: #666; font-style: italic;">
                                ${displayName.split(',').slice(0, 2).join(',')}
                            </div>
                            <div style="margin-top: 12px; padding: 10px; background: #fff3e0; border-radius: 4px; font-size: 12px; color: #e65100; line-height: 1.5;">
                                <strong>‚ÑπÔ∏è No stores found within 500m</strong><br>
                                <div style="margin-top: 6px; font-size: 11px;">
                                This might be a residential area.<br><br>
                                Try:<br>
                                ‚Ä¢ ZIP Code search (left sidebar)<br>
                                ‚Ä¢ Search for a specific store name<br>
                                ‚Ä¢ Try a nearby shopping area
                                </div>
                            </div>
                        </div>
                    `).openPopup();
                    markers.push(marker);
                    
                    showResult(`‚úì Searched: "${originalAddress}"
‚úì Found location (no stores within 500m)
üí° Try: ZIP code search or specific store name`);
                    showLoading(false);
                    return;
                }
                
                // Step 3: Process stores and add to window.storeData
                console.log(`Processing ${stores.length} stores from Overpass...`);
                
                window.storeData = stores.map((store, idx) => {
                    const storeLat = store.lat || store.center?.lat;
                    const storeLon = store.lon || store.center?.lon;
                    const distance = calculateDistance(lat, lon, storeLat, storeLon);
                    
                    const category = store.tags?.shop || store.tags?.amenity || 'all';
                    const name = store.tags?.brand || store.tags?.name || store.tags?.shop || store.tags?.amenity || 'Store';
                    
                    // Build store address from tags if available
                    let storeAddress = '';
                    if (store.tags) {
                        const addrParts = [
                            store.tags['addr:housenumber'],
                            store.tags['addr:street'],
                            store.tags['addr:city'],
                            store.tags['addr:state'],
                            store.tags['addr:postcode']
                        ].filter(Boolean);
                        
                        if (addrParts.length > 0) {
                            storeAddress = addrParts.join(', ');
                        }
                    }
                    
                    // Fallback: use nearby location (city, state) if no specific address
                    if (!storeAddress) {
                        const locationParts = displayName.split(',');
                        // Use city and state from the search location
                        if (locationParts.length >= 3) {
                            storeAddress = locationParts.slice(-3, -1).map(s => s.trim()).join(', ');
                        } else {
                            storeAddress = locationParts.slice(0, 2).join(', ');
                        }
                    }
                    
                    console.log(`  ${idx + 1}. ${name} [${category}] - ${distance.toFixed(0)}m away - ${storeAddress}`);
                    
                    return {
                        id: `addr_store_${idx}`,
                        name: name,
                        address: storeAddress,
                        lat: storeLat,
                        lon: storeLon,
                        distance: distance,
                        category: category,
                        zipCode: location.address?.postcode || store.tags?.['addr:postcode'] || '10001',
                        ejv: null,
                        rawScore: null,
                        breakdown: null
                    };
                }).filter(s => s.lat && s.lon).sort((a, b) => a.distance - b.distance).slice(0, 15); // Sort by distance, limit to 15 closest
                
                rawStores = [...window.storeData];
                
                console.log(`Processed ${window.storeData.length} stores (sorted by distance, limited to 15 closest)`);
                
                // Step 4: Add markers for stores
                window.storeData.forEach((store, idx) => {
                    const icon = getCategoryIcon(store.category);
                    
                    const marker = L.marker([store.lat, store.lon], {
                        icon: L.divIcon({
                            className: 'custom-div-icon',
                            html: `<div style="background: #667eea; width: 32px; height: 32px; border-radius: 50%; border: 3px solid white; box-shadow: 0 3px 8px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; font-size: 14px;">${icon}</div>`,
                            iconSize: [32, 32],
                            iconAnchor: [16, 16]
                        })
                    });
                    
                    marker.bindPopup(`
                        <div style="min-width: 220px;">
                            <strong style="font-size: 14px;">${store.name}</strong><br>
                            <span style="font-size: 11px; color: #666;">${store.address}</span><br>
                            <span style="font-size: 10px; color: #999;">üìè ${(store.distance / 1000).toFixed(2)} km away</span><br>
                            <button onclick="calculateSingleStoreEJV(${idx})" style="margin-top: 8px; padding: 8px 14px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; width: 100%; font-weight: 600;">
                                Calculate EJV
                            </button>
                        </div>
                    `);
                    
                    marker.addTo(map);
                    markers.push(marker);
                });
                
                // Step 5: Display in sidebar
                displayQuickFindResults(window.storeData);
                
                // Fit bounds to show all stores
                if (markers.length > 1) {
                    const group = L.featureGroup(markers);
                    map.fitBounds(group.getBounds().pad(0.1));
                }
                
                showResult(`‚úì Searched: "${originalAddress}"\n‚úì Found ${window.storeData.length} store(s) nearby\nüîÑ Calculating EJV values...`);
                
                // Step 6: Calculate EJV for stores (top 8 for performance)
                const storesToCalculate = Math.min(8, window.storeData.length);
                console.log(`Calculating EJV for ${storesToCalculate} stores...`);
                
                for (let i = 0; i < storesToCalculate; i++) {
                    showResult(`üîÑ Calculating EJV ${i + 1}/${storesToCalculate} for ${window.storeData[i].name}...`);
                    await calculateSingleStoreEJV(i);
                    
                    // Update the results display after each calculation
                    displayQuickFindResults(window.storeData);
                    
                    // Small delay to prevent API rate limiting
                    if (i < storesToCalculate - 1) {
                        await new Promise(resolve => setTimeout(resolve, 400));
                    }
                }
                
                console.log('EJV calculation complete!');
                
                // Final update of results
                displayQuickFindResults(window.storeData);
                
                const calculatedCount = window.storeData.filter(s => s.ejv !== null).length;
                showResult(`‚úÖ "${originalAddress}"\n‚úÖ Found ${window.storeData.length} store(s), calculated EJV for ${calculatedCount}`);
                showLoading(false);
                
            } catch (error) {
                console.error('Find address error:', error);
                console.error('Error details:', error.message, error.stack);
                
                // Clear any partial results
                clearMarkers();
                window.storeData = [];
                rawStores = [];
                allStoresEJV = [];
                ejvCache = {};
                
                const storeListElement = document.getElementById('storeList');
                if (storeListElement) {
                    storeListElement.innerHTML = '<p style="color: #999; font-size: 12px; padding: 10px;">Search failed</p>';
                }
                
                // Provide specific error messages based on error type
                if (error.message.includes('timeout') || error.message.includes('timed out')) {
                    showResult(`‚è±Ô∏è Search timed out\n\nüí° Solutions:\n‚Ä¢ Wait 10 seconds and try again\n‚Ä¢ Use ZIP code search (left sidebar)\n‚Ä¢ Try a simpler search term\n‚Ä¢ Check your spelling`);
                } else if (error.message.includes('unavailable') || error.message.includes('service')) {
                    showResult(`‚ö†Ô∏è Search service temporarily unavailable\n\nüí° Alternative:\n‚Ä¢ Use ZIP code search in left sidebar\n‚Ä¢ Try Google Maps button above\n‚Ä¢ Wait a moment and try again`);
                } else {
                    showResult(`‚ùå Error: ${error.message}\n\nüí° Tips:\n‚Ä¢ Check your spelling\n‚Ä¢ Try: "Boston", "10001", or "Walmart"\n‚Ä¢ Use ZIP code search (left sidebar)\n‚Ä¢ Simplify your search term`);
                }
                showLoading(false);
            }
        }
        
        // Open Google Maps search in new tab
        function openGoogleMapsSearch() {
            const searchInput = document.getElementById('simpleSearchInput');
            if (!searchInput) {
                alert('Search box not found');
                return;
            }
            
            const query = searchInput.value.trim();
            
            if (!query) {
                alert('Please enter a search term first');
                return;
            }
            
            // Create Google Maps search URL
            const googleMapsUrl = `https://www.google.com/maps/search/${encodeURIComponent(query)}`;
            
            // Open in new tab
            window.open(googleMapsUrl, '_blank');
            showResult(`Opening Google Maps for "${query}"...`);
        }
        
        // Search by ZIP Code
        async function searchByZipCode() {
            const zipInput = document.getElementById('zipInput');
            const zip = zipInput.value.trim();
            
            if (!zip) {
                alert('Please enter a ZIP code');
                return;
            }
            
            if (!/^\d{5}$/.test(zip)) {
                alert('Please enter a valid 5-digit ZIP code');
                return;
            }
            
            currentZip = zip;
            showLoading(true);
            showResult(`Searching in ZIP code ${zip}...`);
            
            try {
                // Geocode ZIP code to get coordinates
                const geocodeUrl = `https://nominatim.openstreetmap.org/search?format=json&postalcode=${zip}&country=US&limit=1`;
                const response = await fetch(geocodeUrl);
                const results = await response.json();
                
                if (results.length === 0) {
                    showResult('ZIP code not found. Please try a different ZIP code.');
                    showLoading(false);
                    return;
                }
                
                const lat = parseFloat(results[0].lat);
                const lon = parseFloat(results[0].lon);
                
                // Center map on ZIP code
                map.setView([lat, lon], 13);
                
                // Add marker for ZIP code area
                clearMarkers();
                const marker = L.marker([lat, lon]).addTo(map);
                marker.bindPopup(`<strong>ZIP Code: ${zip}</strong><br>${results[0].display_name}`).openPopup();
                markers.push(marker);
                
                showResult(`Showing ZIP code ${zip}. Now select a store from "Search Stores Near My Location" to find stores in this area.`);
                showLoading(false);
                
            } catch (error) {
                console.error('ZIP code search error:', error);
                showResult('Error searching ZIP code. Please try again.');
                showLoading(false);
            }
        }
        
        // Search stores near user's current location (using fast geocoding instead of Overpass)
        async function searchStoreNearMe() {
            const storeSelect = document.getElementById('storeSelect');
            const storeName = storeSelect.value;
            
            if (!storeName) {
                alert('Please select a store from the dropdown');
                return;
            }
            
            showLoading(true);
            showResult(`Getting your location for ${storeName.toUpperCase()} search...`);
            
            // Get user location if not already set
            if (!userLocation) {
                await getUserLocation();
                if (!userLocation) {
                    showResult(`‚ùå Location access denied. Please use "Search by Address" instead - type "${storeName} [your city]"`);
                    showLoading(false);
                    
                    // Auto-focus address input
                    const addressInput = document.getElementById('addressInput');
                    if (addressInput) {
                        addressInput.focus();
                        addressInput.placeholder = `Try: ${storeName} Huntsville AL`;
                    }
                    return;
                }
            }
            
            try {
                // Use geocoding to find stores with timeout
                console.log(`‚Üí Searching for ${storeName} near [${userLocation.lat}, ${userLocation.lon}]`);
                const geocodeUrl = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(storeName)}&limit=5&addressdetails=1&bounded=1&viewbox=${userLocation.lon-0.1},${userLocation.lat+0.1},${userLocation.lon+0.1},${userLocation.lat-0.1}`;
                
                // Add timeout to prevent long waits
                const timeoutPromise = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('Search timeout - server is taking too long')), 8000)
                );
                
                const fetchPromise = fetch(geocodeUrl);
                const response = await Promise.race([fetchPromise, timeoutPromise]);
                const results = await response.json();
                
                if (results.length === 0) {
                    showResult(`No ${storeName.toUpperCase()} stores found nearby. Try searching by full address instead.`);
                    showLoading(false);
                    return;
                }
                
                console.log(`‚úì Found ${results.length} ${storeName} locations`);
                
                // Clear existing markers and data
                clearMarkers();
                window.storeData = [];
                
                // Process results (limit to 5 for speed)
                window.storeData = results.slice(0, 5).map((result, idx) => {
                    const storeLat = parseFloat(result.lat);
                    const storeLon = parseFloat(result.lon);
                    const distance = calculateDistance(userLocation.lat, userLocation.lon, storeLat, storeLon);
                    
                    return {
                        id: `${storeName}_${idx}`,
                        name: result.display_name.split(',')[0] || storeName.toUpperCase(),
                        address: result.display_name,
                        lat: storeLat,
                        lon: storeLon,
                        distance: distance,
                        category: 'store',
                        zipCode: result.address?.postcode || currentZip,
                        ejv: null,
                        rawScore: null,
                        breakdown: null
                    };
                }).sort((a, b) => a.distance - b.distance).slice(0, 8);
                
                rawStores = [...window.storeData];
                
                // Center map on user location
                map.setView([userLocation.lat, userLocation.lon], 12);
                
                // Add markers
                window.storeData.forEach((store, idx) => {
                    const marker = L.marker([store.lat, store.lon], {
                        icon: L.divIcon({
                            className: 'custom-div-icon',
                            html: `<div style="background: #4CAF50; width: 30px; height: 30px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 11px; color: white;">${idx + 1}</div>`,
                            iconSize: [30, 30],
                            iconAnchor: [15, 15]
                        })
                    }).addTo(map);
                    
                    marker.bindPopup(`
                        <div style="min-width: 200px;">
                            <strong>${store.name}</strong><br>
                            <span style="font-size: 11px; color: #666;">${store.address}</span><br>
                            <span style="font-size: 10px; color: #999;">${store.distance.toFixed(2)} km away</span><br>
                            <button onclick="calculateChainStoreEJV(${idx})" style="margin-top: 8px; padding: 6px 12px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px; width: 100%; font-weight: 600;">
                                Calculate EJV
                            </button>
                        </div>
                    `);
                    
                    markers.push(marker);
                });
                
                displayChainSearchResults(window.storeData, storeName);
                showResult(`Found ${window.storeData.length} ${storeName.toUpperCase()} location(s) nearby`);
                showLoading(false);
                
            } catch (error) {
                console.error('Store search error:', error);
                showResult(`Error searching for ${storeName}. Please try again or use address search.`);
                showLoading(false);
            }
        }
        
        // Search by address (using geocoding)
        async function searchByAddress() {
            const addressInput = document.getElementById('addressInput');
            const address = addressInput.value.trim();
            
            console.log('searchByAddress called with:', address);
            
            if (!address) {
                alert('Please enter an address or location');
                return;
            }
            
            showLoading(true);
            showResult(`Searching for "${address}"...`);
            
            try {
                // Geocode the address with timeout
                const geocodeUrl = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&limit=3&addressdetails=1`;
                console.log('‚Üí Geocoding address:', address);
                console.log('‚Üí URL:', geocodeUrl);
                
                // Add timeout
                const timeoutPromise = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('Search timeout - taking too long')), 10000)
                );
                
                const fetchPromise = fetch(geocodeUrl);
                const response = await Promise.race([fetchPromise, timeoutPromise]);
                
                console.log('‚Üí Response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`API returned status ${response.status}`);
                }
                
                const results = await response.json();
                console.log('‚Üí Results:', results);
                
                if (results.length === 0) {
                    showResult('Location not found. Try a different search like "Walmart Huntsville AL" or "35801"');
                    showLoading(false);
                    return;
                }
                
                console.log(`‚úì Found ${results.length} location(s)`);
                
                // Clear existing markers
                clearMarkers();
                window.storeData = [];
                
                // If multiple results, show them all
                if (results.length > 1) {
                    window.storeData = results.map((result, idx) => {
                        const storeLat = parseFloat(result.lat);
                        const storeLon = parseFloat(result.lon);
                        
                        return {
                            id: `address_${idx}`,
                            name: result.display_name.split(',')[0],
                            address: result.display_name,
                            lat: storeLat,
                            lon: storeLon,
                            distance: 0,
                            category: 'location',
                            zipCode: result.address?.postcode || currentZip,
                            ejv: null,
                            rawScore: null,
                            breakdown: null
                        };
                    });
                    
                    rawStores = [...window.storeData];
                    
                    // Center on first result
                    map.setView([window.storeData[0].lat, window.storeData[0].lon], 13);
                    
                    // Add markers
                    window.storeData.forEach((store, idx) => {
                        const marker = L.marker([store.lat, store.lon], {
                            icon: L.divIcon({
                                className: 'custom-div-icon',
                                html: `<div style="background: #764ba2; width: 30px; height: 30px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 11px; color: white;">${idx + 1}</div>`,
                                iconSize: [30, 30],
                                iconAnchor: [15, 15]
                            })
                        }).addTo(map);
                        
                        marker.bindPopup(`
                            <div style="min-width: 200px;">
                                <strong>${store.name}</strong><br>
                                <span style="font-size: 11px; color: #666;">${store.address}</span><br>
                                <button onclick="calculateChainStoreEJV(${idx})" style="margin-top: 8px; padding: 6px 12px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px; width: 100%; font-weight: 600;">
                                    Calculate EJV
                                </button>
                            </div>
                        `);
                        
                        markers.push(marker);
                    });
                    
                    displayChainSearchResults(window.storeData, 'Locations');
                    showResult(`Found ${window.storeData.length} location(s) matching "${address}"`);
                } else {
                    // Single result
                    const result = results[0];
                    const storeLat = parseFloat(result.lat);
                    const storeLon = parseFloat(result.lon);
                    
                    map.setView([storeLat, storeLon], 15);
                    currentZip = result.address?.postcode || currentZip;
                    
                    window.storeData = [{
                        id: 'address_0',
                        name: result.display_name.split(',')[0],
                        address: result.display_name,
                        lat: storeLat,
                        lon: storeLon,
                        distance: 0,
                        category: 'location',
                        zipCode: currentZip,
                        ejv: null,
                        rawScore: null,
                        breakdown: null
                    }];
                    
                    const marker = L.marker([storeLat, storeLon]).addTo(map);
                    marker.bindPopup(`
                        <div style="min-width: 200px;">
                            <strong>${window.storeData[0].name}</strong><br>
                            <span style="font-size: 11px; color: #666;">${window.storeData[0].address}</span><br>
                            <button onclick="calculateChainStoreEJV(0)" style="margin-top: 8px; padding: 6px 12px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px; width: 100%; font-weight: 600;">
                                Calculate EJV
                            </button>
                        </div>
                    `).openPopup();
                    markers.push(marker);
                    
                    showResult(`Found: ${window.storeData[0].name}. Click marker to calculate EJV.`);
                }
                
                showLoading(false);
                
            } catch (error) {
                console.error('Address search error:', error);
                showResult('Error searching address. Please try again.');
                showLoading(false);
            }
        }
        
        // Quick search function for popular chains
        async function quickSearch(chainName) {
            const searchInput = document.getElementById('searchInput');
            searchInput.value = chainName + ' near me';
            await performSearch();
        }
        
        async function performSearch() {
            const searchInput = document.getElementById('searchInput');
            let query = searchInput.value.trim().toLowerCase();
            
            if (!query) {
                alert('Please enter a location or store name to search');
                return;
            }
            
            showLoading(true);
            showResult(`Searching for "${query}"...`);
            
            try {
                // Clear previous markers and data (keep user location marker)
                const userMarker = markers.find(m => m.getPopup()?.getContent().includes('Your Location'));
                clearMarkers();
                if (userMarker) markers.push(userMarker);
                allStoresEJV = [];
                ejvCache = {};
                rawStores = [];
                window.storeData = [];
                
                // Detect if searching for a chain/brand
                const isChainSearch = chainKeywords.some(keyword => query.includes(keyword));
                let chainName = null;
                
                if (isChainSearch) {
                    chainName = chainKeywords.find(keyword => query.includes(keyword));
                    console.log('‚úì Detected chain search:', chainName);
                }
                
                // Check if "near me" search requires user location
                console.log('‚Üí Checking location: query includes "near me"?', query.includes('near me'), '| userLocation exists?', !!userLocation);
                if (query.includes('near me') && !userLocation) {
                    console.log('‚Üí Requesting user location...');
                    showResult('Getting your location...');
                    await getUserLocation();
                    console.log('‚Üí Location request complete. userLocation:', !!userLocation);
                    if (!userLocation) {
                        showResult('Location permission denied. Please click "My Location" button or search with an address.');
                        showLoading(false);
                        return;
                    }
                }
                
                // Determine search location
                let searchLat, searchLon, searchAddress;
                
                if (query.includes('near me') && userLocation) {
                    // Use user's current location
                    searchLat = userLocation.lat;
                    searchLon = userLocation.lon;
                    searchAddress = 'Your Location';
                    console.log('‚úì Using user location:', searchLat, searchLon);
                } else if (userLocation && isChainSearch && !query.includes('near')) {
                    // Chain search uses user location by default if no other location specified
                    searchLat = userLocation.lat;
                    searchLon = userLocation.lon;
                    searchAddress = 'Your Location';
                    console.log('‚úì Using user location for chain search:', searchLat, searchLon);
                } else if (!isChainSearch || (isChainSearch && !userLocation)) {
                    // Geocode the address/ZIP or chain name with location
                    const searchQuery = query.replace('near me', '').trim();
                    const geocodeUrl = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(searchQuery)}&limit=1&addressdetails=1`;
                    console.log('‚Üí Geocoding:', searchQuery);
                    const geocodeResponse = await fetch(geocodeUrl);
                    const geocodeResults = await geocodeResponse.json();
                    
                    if (geocodeResults.length === 0) {
                        showResult('Location not found. Try clicking "My Location" button first or use a specific address.');
                        showLoading(false);
                        return;
                    }
                    
                    searchLat = parseFloat(geocodeResults[0].lat);
                    searchLon = parseFloat(geocodeResults[0].lon);
                    searchAddress = geocodeResults[0].display_name;
                    currentZip = geocodeResults[0].address?.postcode || currentZip || '10001';
                    console.log('‚úì Geocoded to:', searchLat, searchLon);
                }
                
                // Center map
                map.setView([searchLat, searchLon], 14);
                
                // If chain search, find nearby stores
                if (isChainSearch && chainName) {
                    await searchNearbyChainStores(chainName, searchLat, searchLon);
                } else {
                    // Single location search
                    await searchSingleLocation(query, searchLat, searchLon, searchAddress);
                }
                
            } catch (error) {
                console.error('Search error:', error);
                showResult('Search failed. Please try again.');
                showLoading(false);
            }
        }
        
        async function searchNearbyChainStores(chainName, lat, lon) {
            showResult(`Searching for ${chainName.toUpperCase()} stores near you...`);
            
            // Search using Overpass API (OpenStreetMap) with timeout
            const radius = 3000; // 3km radius (faster results)
            const overpassQuery = `
                [out:json][timeout:12];
                (
                    node["name"~"${chainName}",i](around:${radius},${lat},${lon});
                    way["name"~"${chainName}",i](around:${radius},${lat},${lon});
                );
                out center;
            `;
            
            try {
                // Create timeout promise (15 seconds to allow for network delay)
                const timeoutPromise = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('Search timeout')), 15000)
                );
                
                const fetchPromise = fetch('https://overpass-api.de/api/interpreter', {
                    method: 'POST',
                    body: overpassQuery
                });
                
                const response = await Promise.race([fetchPromise, timeoutPromise]);
                
                if (!response.ok) {
                    throw new Error(`API returned status ${response.status}`);
                }
                
                const data = await response.json();
                
                if (!data || !data.elements) {
                    throw new Error('Invalid API response');
                }
                
                const stores = data.elements || [];
                console.log(`‚úì Overpass API returned ${stores.length} results`);
                
                if (stores.length === 0) {
                    showResult(`No ${chainName.toUpperCase()} stores found within 5km. Try a different location.`);
                    showLoading(false);
                    return;
                }
                
                // Process and display stores
                window.storeData = stores.map((store, idx) => {
                    const storeLat = store.lat || store.center?.lat;
                    const storeLon = store.lon || store.center?.lon;
                    const distance = calculateDistance(lat, lon, storeLat, storeLon);
                    
                    console.log(`Store ${idx + 1}: ${store.tags?.name} at [${storeLat}, ${storeLon}] - ${distance.toFixed(2)}km away`);
                    
                    return {
                        id: `${chainName}_${idx}`,
                        name: store.tags?.name || chainName.toUpperCase(),
                        address: `${store.tags?.['addr:street'] || ''} ${store.tags?.['addr:city'] || ''}`.trim() || 'Address not available',
                        lat: storeLat,
                        lon: storeLon,
                        distance: distance,
                        category: 'supermarket',
                        zipCode: store.tags?.['addr:postcode'] || currentZip,
                        ejv: null,
                        rawScore: null,
                        breakdown: null
                    };
                }).filter(s => s.lat && s.lon).sort((a, b) => a.distance - b.distance).slice(0, 10);
                
                rawStores = [...window.storeData];
                
                // Add markers for all stores
                window.storeData.forEach((store, idx) => {
                    const marker = L.marker([store.lat, store.lon], {
                        icon: L.divIcon({
                            className: 'custom-div-icon',
                            html: `<div style="background: #ff6b6b; width: 32px; height: 32px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 11px; color: white;">${idx + 1}</div>`,
                            iconSize: [32, 32],
                            iconAnchor: [16, 16]
                        })
                    }).addTo(map);
                    
                    marker.bindPopup(`
                        <div style="min-width: 200px;">
                            <strong>${store.name}</strong><br>
                            <span style="font-size: 11px; color: #666;">${store.address}</span><br>
                            <span style="font-size: 10px; color: #999;">${store.distance.toFixed(2)} km away</span><br>
                            <button onclick="calculateChainStoreEJV(${idx})" style="margin-top: 8px; padding: 6px 12px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px; width: 100%; font-weight: 600;">
                                Calculate EJV
                            </button>
                        </div>
                    `);
                    
                    markers.push(marker);
                });
                
                // Display results
                displayChainSearchResults(window.storeData, chainName);
                showResult(`Found ${window.storeData.length} ${chainName.toUpperCase()} stores nearby`);
                showLoading(false);
                
            } catch (error) {
                console.error('Nearby search error:', error);
                
                // If Overpass API times out or fails, try geocoding specific store location
                if (error.message.includes('504') || error.message.includes('timeout')) {
                    console.log('‚Üí Overpass API unavailable, using geocoding fallback...');
                    showResult(`Overpass API is busy. Searching for ${chainName.toUpperCase()} location via geocoding...`);
                    
                    try {
                        // Geocode specific store by name and location
                        const geocodeUrl = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(chainName + ' near ' + lat + ',' + lon)}&limit=5&addressdetails=1`;
                        const geocodeResponse = await fetch(geocodeUrl);
                        const geocodeResults = await geocodeResponse.json();
                        
                        if (geocodeResults.length > 0) {
                            console.log(`‚úì Found ${geocodeResults.length} locations via geocoding`);
                            
                            // Convert geocode results to store data
                            window.storeData = geocodeResults.slice(0, 5).map((result, idx) => {
                                const storeLat = parseFloat(result.lat);
                                const storeLon = parseFloat(result.lon);
                                const distance = calculateDistance(lat, lon, storeLat, storeLon);
                                
                                return {
                                    id: `${chainName}_geocoded_${idx}`,
                                    name: result.display_name.split(',')[0] || chainName.toUpperCase(),
                                    address: result.display_name,
                                    lat: storeLat,
                                    lon: storeLon,
                                    distance: distance,
                                    category: 'store',
                                    zipCode: result.address?.postcode || currentZip,
                                    ejv: null,
                                    rawScore: null,
                                    breakdown: null
                                };
                            }).sort((a, b) => a.distance - b.distance);
                            
                            rawStores = [...window.storeData];
                            
                            // Add markers
                            window.storeData.forEach((store, idx) => {
                                const marker = L.marker([store.lat, store.lon], {
                                    icon: L.divIcon({
                                        className: 'custom-div-icon',
                                        html: `<div style="background: #4CAF50; width: 32px; height: 32px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 11px; color: white;">${idx + 1}</div>`,
                                        iconSize: [32, 32],
                                        iconAnchor: [16, 16]
                                    })
                                }).addTo(map);
                                
                                marker.bindPopup(`
                                    <div style="min-width: 200px;">
                                        <strong>${store.name}</strong><br>
                                        <span style="font-size: 11px; color: #666;">${store.address}</span><br>
                                        <span style="font-size: 10px; color: #999;">${store.distance.toFixed(2)} km away</span><br>
                                        <button onclick="calculateChainStoreEJV(${idx})" style="margin-top: 8px; padding: 6px 12px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px; width: 100%; font-weight: 600;">
                                            Calculate EJV
                                        </button>
                                    </div>
                                `);
                                
                                markers.push(marker);
                            });
                            
                            displayChainSearchResults(window.storeData, chainName);
                            showResult(`Found ${window.storeData.length} ${chainName.toUpperCase()} location(s) nearby`);
                            showLoading(false);
                            return;
                        }
                    } catch (geocodeError) {
                        console.error('Geocoding fallback error:', geocodeError);
                    }
                }
                
                // Final fallback - show user location
                showResult(`No ${chainName.toUpperCase()} stores found within 3km. Showing your search location - you can still calculate EJV for any store at this address.`);
                showLoading(false);
                
                try {
                    await searchSingleLocation(chainName, lat, lon, `${chainName.toUpperCase()} - Your Location`);
                } catch (fallbackError) {
                    console.error('Fallback search error:', fallbackError);
                    showResult('Search failed. Please try a specific address or store name.');
                    showLoading(false);
                }
            }
        }
        
        async function searchSingleLocation(query, lat, lon, address) {
            // Add location marker
            const locationMarker = L.marker([lat, lon], {
                icon: L.divIcon({
                    className: 'custom-div-icon',
                    html: '<div style="background-color: #667eea; width: 30px; height: 30px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 16px;">üìç</div>',
                    iconSize: [30, 30],
                    iconAnchor: [15, 15]
                })
            }).addTo(map);
            
            locationMarker.bindPopup(`
                <div style="min-width: 220px;">
                    <strong style="font-size: 14px;">Searched Location</strong><br>
                    <span style="font-size: 11px; color: #666;">${address}</span><br>
                    <button onclick="calculateSingleStoreEJV(0)" style="margin-top: 8px; padding: 8px 14px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; width: 100%; font-weight: 600;">
                        Calculate EJV
                    </button>
                </div>
            `).openPopup();
            markers.push(locationMarker);
            
            window.storeData = [{
                name: query,
                address: address,
                lat: lat,
                lon: lon,
                distance: 0,
                category: 'all',
                zipCode: currentZip,
                ejv: null,
                rawScore: null,
                breakdown: null
            }];
            
            displayQuickFindResults(window.storeData);
            showResult(`Found location: ${address}`);
            showLoading(false);
        }
        
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Earth radius in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }
        
        async function calculateChainStoreEJV(storeIndex) {
            const store = window.storeData[storeIndex];
            showLoading(true);
            showResult(`Calculating EJV for ${store.name}...`);
            
            try {
                // Set current ZIP from store's ZIP code
                if (store.zipCode) {
                    currentZip = store.zipCode;
                } else {
                    // Get ZIP code from geocoding if not available
                    const geocodeUrl = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${store.lat}&lon=${store.lon}&addressdetails=1`;
                    const geocodeResponse = await fetch(geocodeUrl);
                    const geocodeData = await geocodeResponse.json();
                    currentZip = geocodeData.address?.postcode || '10001';
                }
                
                // Call the main calculateEJV function with proper parameters
                const storeId = store.id || `store_${storeIndex}`;
                const storeEjv = await calculateEJV(storeId, store.name, true);
                
                if (storeEjv && storeEjv.data) {
                    updateRightDashboard(storeEjv.data, store.name);
                    showResult(`‚úì EJV calculated for ${store.name}: ${storeEjv.data.ejv?.toFixed(2) || 'N/A'}`);
                } else {
                    showResult(`Could not calculate EJV for ${store.name}`);
                }
            } catch (error) {
                console.error('Chain store EJV calculation error:', error);
                showResult('Error calculating EJV. Please try again.');
            } finally {
                showLoading(false);
            }
        }
        
        async function calculateSingleStoreEJV(storeIndex) {
            const store = window.storeData[storeIndex];
            showLoading(true);
            showResult(`Calculating EJV for ${store.name}...`);
            
            try {
                // Set current ZIP from store's ZIP code
                if (store.zipCode) {
                    currentZip = store.zipCode;
                } else {
                    // Get ZIP code from geocoding if not available
                    const geocodeUrl = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${store.lat}&lon=${store.lon}&addressdetails=1`;
                    const geocodeResponse = await fetch(geocodeUrl);
                    const geocodeData = await geocodeResponse.json();
                    currentZip = geocodeData.address?.postcode || '10001';
                }
                
                // Call the main calculateEJV function with proper parameters
                const storeId = store.id || 'store_0';
                const storeEjv = await calculateEJV(storeId, store.name, true);
                
                if (storeEjv && storeEjv.data) {
                    updateRightDashboard(storeEjv.data, store.name);
                    showResult(`‚úì EJV calculated for ${store.name}: ${storeEjv.data.ejv?.toFixed(2) || 'N/A'}`);
                } else {
                    showResult(`Could not calculate EJV for ${store.name}`);
                }
            } catch (error) {
                console.error('Single store EJV calculation error:', error);
                showResult('Error calculating EJV. Please try again.');
            } finally {
                showLoading(false);
            }
        }
        
        function displayChainSearchResults(stores, chainName) {
            const storeList = document.getElementById('storeList');
            storeList.innerHTML = `
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 15px; border-radius: 8px; margin-bottom: 15px; color: white;">
                    <h3 style="margin: 0 0 8px 0; font-size: 16px;">üè™ ${chainName.toUpperCase()} Stores Found: ${stores.length}</h3>
                    <p style="margin: 0; font-size: 12px; opacity: 0.9;">Click on any store to see its EJV score</p>
                </div>
                ${stores.map((store, idx) => `
                    <div class="result-item" onclick="calculateChainStoreEJV(${idx})" style="cursor: pointer; border-left: 4px solid #667eea;">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div style="flex: 1;">
                                <strong style="font-size: 14px; color: #667eea;">${idx + 1}. ${store.name}</strong><br>
                                <span style="font-size: 11px; color: #666;">${store.address}</span>
                            </div>
                            <div style="text-align: right; margin-left: 10px;">
                                <div style="font-size: 12px; font-weight: 600; color: #ff6b6b;">${store.distance.toFixed(2)} km</div>
                                <div style="font-size: 10px; color: #999; margin-top: 2px;">Click for EJV</div>
                            </div>
                        </div>
                    </div>
                `).join('')}
            `;
        }
        
        // Make function globally accessible
        window.performSearch = performSearch;

        async function selectGooglePlace(place) {
            const lat = place.geometry.location.lat();
            const lon = place.geometry.location.lng();
            const name = place.name;
            const address = place.formatted_address;

            // Center map on location
            map.setView([lat, lon], 15);

            // Add a marker
            const marker = L.marker([lat, lon], {
                icon: L.divIcon({
                    className: 'custom-div-icon',
                    html: `<div style="background-color: #4285f4; width: 30px; height: 30px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 16px;">G</div>`,
                    iconSize: [30, 30],
                    iconAnchor: [15, 15]
                })
            });

            marker.bindPopup(`
                <div style="min-width: 220px;">
                    <strong style="font-size: 14px;">${name}</strong><br>
                    <span style="font-size: 11px; color: #666;">${address}</span><br>
                    <small style="color: #999;">via Google Places</small><br>
                    <button onclick="calculateSingleStoreEJV(0)" style="margin-top: 8px; padding: 8px 14px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; width: 100%; font-weight: 600;">
                        Calculate EJV
                    </button>
                </div>
            `).openPopup();
            marker.addTo(map);
            markers.push(marker);

            // Add to storeData for EJV calculation
            window.storeData = [{
                name: name,
                address: address,
                lat: lat,
                lon: lon,
                distance: 0,
                category: 'all',
                zipCode: '10001',
                ejv: null,
                rawScore: null,
                breakdown: null
            }];
            
            // Display the single location in results
            displayQuickFindResults(window.storeData);
            
            showResult(`‚úì Selected: ${name}`);
        }

        function handleMapSearchInput() {
            const searchInput = document.getElementById('mapSearchInput');
            const clearBtn = document.getElementById('mapSearchClear');
            const query = searchInput.value.trim();

            // Show/hide clear button
            if (query) {
                clearBtn.classList.add('visible');
            } else {
                clearBtn.classList.remove('visible');
                hideMapSearchAutocomplete();
                return;
            }

            // Debounce search
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                performMapSearch(query);
            }, 300);
        }

        function handleMapSearchKeydown(e) {
            const autocomplete = document.getElementById('mapSearchAutocomplete');
            const results = autocomplete.querySelectorAll('.map-search-result');

            if (e.key === 'ArrowDown') {
                e.preventDefault();
                selectedSearchIndex = Math.min(selectedSearchIndex + 1, results.length - 1);
                updateSearchSelection(results);
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                selectedSearchIndex = Math.max(selectedSearchIndex - 1, -1);
                updateSearchSelection(results);
            } else if (e.key === 'Enter') {
                e.preventDefault();
                if (selectedSearchIndex >= 0 && results[selectedSearchIndex]) {
                    results[selectedSearchIndex].click();
                } else {
                    // Search with current input
                    const query = document.getElementById('mapSearchInput').value.trim();
                    if (query) {
                        performDirectSearch(query);
                    }
                }
            } else if (e.key === 'Escape') {
                hideMapSearchAutocomplete();
            }
        }

        function updateSearchSelection(results) {
            results.forEach((result, index) => {
                if (index === selectedSearchIndex) {
                    result.style.background = '#f8f9fa';
                } else {
                    result.style.background = 'white';
                }
            });
        }

        async function performMapSearch(query) {
            const autocomplete = document.getElementById('mapSearchAutocomplete');
            
            // Show loading
            autocomplete.innerHTML = '<div class="map-search-loading">Searching...</div>';
            autocomplete.classList.add('visible');

            try {
                // Use Nominatim for autocomplete
                const searchUrl = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=10&addressdetails=1`;
                const response = await fetch(searchUrl);
                const results = await response.json();

                if (results.length === 0) {
                    autocomplete.innerHTML = '<div class="map-search-no-results">No results found</div>';
                    return;
                }

                // Display results - Check if any results are stores
                autocomplete.innerHTML = '';
                
                // First check if we can find stores at this location
                const storesAtLocation = await searchStoresAtLocation(results[0]);
                
                if (storesAtLocation && storesAtLocation.length > 0) {
                    // Show header for stores found
                    const headerDiv = document.createElement('div');
                    headerDiv.style.cssText = 'padding: 10px 20px; background: #e8f5e9; font-weight: 600; font-size: 12px; color: #2e7d32; border-bottom: 2px solid #4caf50;';
                    headerDiv.textContent = `üè™ ${storesAtLocation.length} Store(s) Found at This Location:`;
                    autocomplete.appendChild(headerDiv);
                    
                    // Display stores
                    storesAtLocation.slice(0, 5).forEach((store, index) => {
                        const resultDiv = document.createElement('div');
                        resultDiv.className = 'map-search-result';
                        resultDiv.style.background = '#f8fff9';
                        
                        const icon = getCategoryIcon(store.category || 'all');
                        
                        resultDiv.innerHTML = `
                            <span class="map-search-result-icon" style="font-size: 18px;">${icon}</span>
                            <div class="map-search-result-content">
                                <div class="map-search-result-name" style="color: #2e7d32;">${store.name}</div>
                                <div class="map-search-result-address">${store.address}</div>
                                <div style="font-size: 10px; color: #4caf50; margin-top: 2px;">üìä Click to view with EJV</div>
                            </div>
                        `;

                        resultDiv.onclick = () => selectStoreResult(store, storesAtLocation);
                        autocomplete.appendChild(resultDiv);
                    });
                    
                    // Add divider
                    const divider = document.createElement('div');
                    divider.style.cssText = 'padding: 8px 20px; background: #f5f5f5; font-size: 11px; color: #666; font-weight: 600;';
                    divider.textContent = 'üìç Other Locations:';
                    autocomplete.appendChild(divider);
                }
                
                // Display location results
                results.forEach((result, index) => {
                    const resultDiv = document.createElement('div');
                    resultDiv.className = 'map-search-result';
                    
                    const icon = getSearchResultIcon(result);
                    const name = result.name || result.display_name.split(',')[0];
                    const address = result.display_name;

                    resultDiv.innerHTML = `
                        <span class="map-search-result-icon">${icon}</span>
                        <div class="map-search-result-content">
                            <div class="map-search-result-name">${name}</div>
                            <div class="map-search-result-address">${address}</div>
                        </div>
                    `;

                    resultDiv.onclick = () => selectSearchResult(result);
                    autocomplete.appendChild(resultDiv);
                });

                selectedSearchIndex = -1;

            } catch (error) {
                console.error('Search error:', error);
                autocomplete.innerHTML = '<div class="map-search-no-results">Search error. Please try again.</div>';
            }
        }
        
        // New function to search for stores at a specific location
        async function searchStoresAtLocation(location) {
            try {
                const lat = parseFloat(location.lat);
                const lon = parseFloat(location.lon);
                const radius = 100; // 100 meters radius
                
                // Query overpass for stores near this location
                const overpassQuery = `
                    [out:json][timeout:10];
                    (
                        node["shop"](around:${radius},${lat},${lon});
                        way["shop"](around:${radius},${lat},${lon});
                        node["amenity"~"restaurant|cafe|fast_food|pharmacy"](around:${radius},${lat},${lon});
                        way["amenity"~"restaurant|cafe|fast_food|pharmacy"](around:${radius},${lat},${lon});
                    );
                    out center;
                `;
                
                const response = await fetch('https://overpass-api.de/api/interpreter', {
                    method: 'POST',
                    body: overpassQuery
                });
                
                const data = await response.json();
                const elements = data.elements || [];
                
                if (elements.length === 0) return [];
                
                // Process stores
                return elements.map((el, idx) => {
                    const storeLat = el.lat || el.center?.lat;
                    const storeLon = el.lon || el.center?.lon;
                    
                    return {
                        id: `search_${idx}`,
                        name: el.tags?.name || el.tags?.shop || el.tags?.amenity || 'Store',
                        address: location.display_name,
                        lat: storeLat,
                        lon: storeLon,
                        distance: 0,
                        category: el.tags?.shop || el.tags?.amenity || 'all',
                        zipCode: location.address?.postcode || '10001',
                        ejv: null,
                        rawScore: null,
                        breakdown: null
                    };
                }).filter(s => s.lat && s.lon);
                
            } catch (error) {
                console.error('Store search error:', error);
                return [];
            }
        }
        
        // New function to select a store from search results
        async function selectStoreResult(store, allStores) {
            hideMapSearchAutocomplete();
            document.getElementById('mapSearchInput').value = store.name;
            
            // Clear previous markers and data
            clearMarkers();
            allStoresEJV = [];
            ejvCache = {};
            rawStores = [];
            window.storeData = allStores || [store];
            
            // Center map on store location
            map.setView([store.lat, store.lon], 17);
            
            showLoading(true);
            showResult(`Found ${window.storeData.length} store(s). Calculating EJV values...`);
            
            // Add markers for all stores
            window.storeData.forEach((s, idx) => {
                const marker = L.marker([s.lat, s.lon], {
                    icon: L.divIcon({
                        className: 'custom-div-icon',
                        html: `<div style="background: #667eea; width: 32px; height: 32px; border-radius: 50%; border: 3px solid white; box-shadow: 0 3px 8px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; font-size: 14px;">${getCategoryIcon(s.category)}</div>`,
                        iconSize: [32, 32],
                        iconAnchor: [16, 16]
                    })
                });
                
                marker.bindPopup(`
                    <div style="min-width: 220px;">
                        <strong style="font-size: 14px;">${s.name}</strong><br>
                        <span style="font-size: 11px; color: #666;">${s.address}</span><br>
                        <button onclick="calculateSingleStoreEJV(${idx})" style="margin-top: 8px; padding: 8px 14px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; width: 100%; font-weight: 600;">
                            Calculate EJV
                        </button>
                    </div>
                `);
                
                marker.addTo(map);
                markers.push(marker);
            });
            
            // Calculate EJV for all stores
            for (let i = 0; i < window.storeData.length; i++) {
                await calculateSingleStoreEJV(i);
            }
            
            displayQuickFindResults(window.storeData);
            showLoading(false);
            showResult(`‚úÖ Found ${window.storeData.length} store(s) with EJV values!`);
        }

        function getSearchResultIcon(result) {
            const type = result.type?.toLowerCase() || '';
            const className = result.class?.toLowerCase() || '';
            
            if (type === 'supermarket' || className === 'shop') return 'üõí';
            if (type === 'pharmacy') return 'üíä';
            if (type === 'restaurant' || type === 'cafe') return 'üçΩÔ∏è';
            if (type === 'convenience') return 'üè™';
            if (className === 'amenity') return 'üìç';
            if (className === 'building') return 'üè¢';
            if (className === 'highway' || className === 'place') return 'üìç';
            
            return 'üìç';
        }

        async function selectSearchResult(result) {
            const lat = parseFloat(result.lat);
            const lon = parseFloat(result.lon);
            const name = result.name || result.display_name.split(',')[0];
            const displayName = result.display_name;

            // Update search input
            document.getElementById('mapSearchInput').value = name;
            hideMapSearchAutocomplete();

            // Clear previous markers and data
            clearMarkers();
            allStoresEJV = [];
            ejvCache = {};
            rawStores = [];
            window.storeData = [];

            // Center map on location
            map.setView([lat, lon], 16);
            
            showLoading(true);
            showResult(`Searching for stores at ${name}...`);
            
            // Try to find stores at this location
            const storesNearby = await searchStoresAtLocation(result);
            
            if (storesNearby && storesNearby.length > 0) {
                // Found stores - display them with EJV
                window.storeData = storesNearby;
                
                showResult(`Found ${storesNearby.length} store(s). Calculating EJV values...`);
                
                // Add markers for all stores
                window.storeData.forEach((store, idx) => {
                    const marker = L.marker([store.lat, store.lon], {
                        icon: L.divIcon({
                            className: 'custom-div-icon',
                            html: `<div style="background: #667eea; width: 32px; height: 32px; border-radius: 50%; border: 3px solid white; box-shadow: 0 3px 8px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; font-size: 14px;">${getCategoryIcon(store.category)}</div>`,
                            iconSize: [32, 32],
                            iconAnchor: [16, 16]
                        })
                    });
                    
                    marker.bindPopup(`
                        <div style="min-width: 220px;">
                            <strong style="font-size: 14px;">${store.name}</strong><br>
                            <span style="font-size: 11px; color: #666;">${store.address}</span><br>
                            <button onclick="calculateSingleStoreEJV(${idx})" style="margin-top: 8px; padding: 8px 14px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; width: 100%; font-weight: 600;">
                                Calculate EJV
                            </button>
                        </div>
                    `);
                    
                    marker.addTo(map);
                    markers.push(marker);
                });
                
                // Calculate EJV for all stores
                for (let i = 0; i < window.storeData.length; i++) {
                    await calculateSingleStoreEJV(i);
                }
                
                displayQuickFindResults(window.storeData);
                showLoading(false);
                showResult(`‚úÖ Found ${window.storeData.length} store(s) with EJV values!`);
                
            } else {
                // No stores found - show location marker only
                const marker = L.marker([lat, lon], {
                    icon: L.divIcon({
                        className: 'custom-div-icon',
                        html: `<div style="background-color: #28a745; width: 32px; height: 32px; border-radius: 50%; border: 3px solid white; box-shadow: 0 3px 8px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; font-size: 16px;">üìç</div>`,
                        iconSize: [32, 32],
                        iconAnchor: [16, 16]
                    })
                });

                // Create popup with EJV calculation option
                const popupContent = `
                    <div style="min-width: 220px;">
                        <strong style="font-size: 14px;">${name}</strong><br>
                        <span style="font-size: 11px; color: #666;">${displayName}</span><br>
                        <button onclick="calculateSingleStoreEJV(0)" style="margin-top: 8px; padding: 8px 14px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; width: 100%; font-weight: 600;">
                            Calculate EJV
                        </button>
                    </div>
                `;

                marker.bindPopup(popupContent).openPopup();
                marker.addTo(map);
                markers.push(marker);

                // Add to storeData for EJV calculation
                const storeInfo = {
                    name: name,
                    address: displayName,
                    lat: lat,
                    lon: lon,
                    distance: 0,
                    category: 'all',
                    zipCode: result.address?.postcode || '10001',
                    ejv: null,
                    rawScore: null,
                    breakdown: null
                };

                window.storeData.push(storeInfo);
                displayQuickFindResults(window.storeData);
                showLoading(false);
                showResult(`‚úì Location found: ${name}. No stores detected at this exact address.`);
            }
        }

        async function performDirectSearch(query) {
            hideMapSearchAutocomplete();
            showLoading(true);
            showResult('Searching for "' + query + '"...');

            try {
                const searchUrl = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1`;
                const response = await fetch(searchUrl);
                const results = await response.json();

                if (results.length > 0) {
                    await selectSearchResult(results[0]);
                } else {
                    showResult('No results found for "' + query + '"');
                }
            } catch (error) {
                console.error('Search error:', error);
                showResult('Search error. Please try again.');
            } finally {
                showLoading(false);
            }
        }

        function clearMapSearch() {
            document.getElementById('mapSearchInput').value = '';
            document.getElementById('mapSearchClear').classList.remove('visible');
            hideMapSearchAutocomplete();
        }

        function hideMapSearchAutocomplete() {
            document.getElementById('mapSearchAutocomplete').classList.remove('visible');
            selectedSearchIndex = -1;
        }

        // Close autocomplete when clicking outside
        document.addEventListener('click', function(e) {
            const searchContainer = document.querySelector('.map-search-container');
            if (searchContainer && !searchContainer.contains(e.target)) {
                hideMapSearchAutocomplete();
            }
        });

        // Calculate distance between two coordinates using Haversine formula
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // Earth's radius in meters
            const œÜ1 = lat1 * Math.PI / 180;
            const œÜ2 = lat2 * Math.PI / 180;
            const ŒîœÜ = (lat2 - lat1) * Math.PI / 180;
            const ŒîŒª = (lon2 - lon1) * Math.PI / 180;

            const a = Math.sin(ŒîœÜ / 2) * Math.sin(ŒîœÜ / 2) +
                      Math.cos(œÜ1) * Math.cos(œÜ2) *
                      Math.sin(ŒîŒª / 2) * Math.sin(ŒîŒª / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

            return R * c; // Distance in meters
        }

        function showResult(message) {
            const resultText = document.getElementById('resultText');
            if (resultText) {
                resultText.textContent = message;
            }
        }

        function showLoading(show) {
            const overlay = document.getElementById('loadingOverlay');
            if (show) {
                overlay.classList.add('active');
            } else {
                overlay.classList.remove('active');
            }
        }

        // Handle Enter key in login form
        document.addEventListener('DOMContentLoaded', function() {
            const passwordInput = document.getElementById('password');
            if (passwordInput) {
                passwordInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        handleLogin();
                    }
                });
            }
        });

        // Help Modal Functions
        async function showHelpModal(version) {
            const modal = document.getElementById('helpModal');
            let endpoint;
            if (version === 'v1') {
                endpoint = '/api/ejv-v1/help';
            } else if (version === 'v4.1') {
                endpoint = '/api/ejv-v4.1/help';
            } else if (version === 'v4.2') {
                endpoint = '/api/ejv-v4.2/help';
            } else if (version === 'simple') {
                endpoint = '/api/ejv/simple/help';
            } else {
                endpoint = '/api/ejv-v2/help';
            }
            
            try {
                console.log('Loading help from endpoint:', endpoint);
                const response = await fetch(endpoint);
                console.log('Help response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const helpData = await response.json();
                console.log('Help data loaded:', helpData);
                
                // Populate modal content
                document.getElementById('helpModalTitle').textContent = helpData.title || 'EJV Help';
                document.getElementById('helpModalSubtitle').textContent = helpData.subtitle || '';
                document.getElementById('helpModalDescription').textContent = helpData.description || '';
                
                // Formula section
                document.getElementById('helpFormula').innerHTML = `<code>${helpData.formula}</code>`;
                document.getElementById('helpFormulaExplanation').textContent = helpData.formula_explanation;
                
                // Components section
                let componentsHtml = '';
                if (version === 'v4.2') {
                    // For v4.2, show participation pathways and PAF
                    componentsHtml = `
                        <div class="help-component">
                            <h4>${helpData.core_innovation.name}</h4>
                            <p><strong>Description:</strong> ${helpData.core_innovation.description}</p>
                            <h5 style="margin-top: 15px; color: #ff9800;">Participation Pathways:</h5>
                            ${helpData.core_innovation.pathways.map(pathway => `
                                <div style="margin: 10px 0; padding: 10px; background: #f5f5f5; border-radius: 4px;">
                                    <strong>${pathway.type}</strong> (${pathway.weight})
                                    <p>${pathway.description}</p>
                                    <p><em>Unit: ${pathway.unit}</em></p>
                                    <p><strong>Examples:</strong> ${pathway.examples.join(', ')}</p>
                                </div>
                            `).join('')}
                        </div>
                        <div class="help-component">
                            <h4>${helpData.paf.name}</h4>
                            <p><strong>Description:</strong> ${helpData.paf.description}</p>
                            <p><strong>Range:</strong> ${helpData.paf.range}</p>
                            <p><strong>Calculation Factors:</strong></p>
                            <ul>
                                ${helpData.paf.calculation_factors.map(f => `<li>${f}</li>`).join('')}
                            </ul>
                            <h5 style="margin-top: 15px;">PAF Interpretation:</h5>
                            ${Object.entries(helpData.paf.interpretation).map(([value, meaning]) => `
                                <div style="padding: 5px 0;">
                                    <strong>${value}:</strong> ${meaning}
                                </div>
                            `).join('')}
                        </div>
                    `;
                } else if (helpData.components) {
                    componentsHtml = helpData.components.map(comp => `
                        <div class="help-component">
                            <h4>${comp.code}: ${comp.name}</h4>
                            <p><strong>Description:</strong> ${comp.description}</p>
                            ${comp.formula ? `<p><strong>Formula:</strong> <code style="background: #f0f0f0; padding: 2px 6px; border-radius: 3px;">${comp.formula}</code></p>` : ''}
                            ${comp.implementation ? `<p><strong>Implementation:</strong> <code style="background: #e3f2fd; padding: 2px 6px; border-radius: 3px; color: #1565c0;">${comp.implementation}</code></p>` : ''}
                            ${comp.calculation_steps ? `
                                <p><strong>Calculation Steps:</strong></p>
                                <ol style="margin-left: 20px; font-size: 12px; color: #555;">
                                    ${comp.calculation_steps.map(step => `<li>${step}</li>`).join('')}
                                </ol>
                            ` : ''}
                            ${comp.calculation ? `<p><strong>Calculation:</strong> <code>${comp.calculation}</code></p>` : ''}
                            ${comp.data_sources ? `
                                <p><strong>Data Sources:</strong> ${comp.data_sources.join(', ')}</p>
                            ` : ''}
                            ${comp.factors ? `
                                <p><strong>Factors:</strong></p>
                                <ul>
                                    ${comp.factors.map(f => `<li>${f}</li>`).join('')}
                                </ul>
                            ` : ''}
                            ${comp.range ? `<p><strong>Range:</strong> ${comp.range}</p>` : ''}
                            ${comp.default ? `<p><strong>Default:</strong> ${comp.default}</p>` : ''}
                            ${comp.usage ? `<p><strong>Usage:</strong> ${comp.usage}</p>` : ''}
                        </div>
                    `).join('');
                }
                document.getElementById('helpComponents').innerHTML = componentsHtml;
                
                // Outputs section (for v4.1)
                let outputsHtml = '';
                if (version === 'v4.1' && helpData.outputs) {
                    outputsHtml = `
                        <div style="margin-top: 20px; padding: 15px; background: #e3f2fd; border-radius: 6px; border-left: 4px solid #2196f3;">
                            <h4 style="color: #1976d2; margin-bottom: 10px;">üìä v4.1 Outputs</h4>
                            ${helpData.outputs.map(output => `
                                <div style="margin: 10px 0; padding: 10px; background: white; border-radius: 4px;">
                                    <strong>${output.name}</strong>
                                    <p>${output.description}</p>
                                    <p><em>Calculation:</em> <code>${output.calculation}</code></p>
                                    <p><em>Display:</em> ${output.display}</p>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
                componentsHtml += outputsHtml;
                
                // UI Pattern section (for v4.1)
                if (version === 'v4.1' && helpData.ui_pattern) {
                    const uiPatternHtml = `
                        <div style="margin-top: 20px; padding: 15px; background: #f3e5f5; border-radius: 6px; border-left: 4px solid #9c27b0;">
                            <h4 style="color: #7b1fa2; margin-bottom: 10px;">üé® ${helpData.ui_pattern.recommended}</h4>
                            <p><strong>${helpData.ui_pattern.description}</strong></p>
                            
                            <div style="margin: 15px 0; padding: 12px; background: white; border-radius: 6px; font-family: monospace; font-size: 13px;">
                                <div style="font-weight: bold; margin-bottom: 8px;">${helpData.ui_pattern.example.store}</div>
                                <div style="margin-left: 15px; line-height: 1.8;">
                                    <div>‚Ä¢ EJV v2 (Gov): <strong>${helpData.ui_pattern.example.ejv_v2_value}</strong></div>
                                    <div>‚Ä¢ EJV v4.1 (Adv): <strong>${helpData.ui_pattern.example.ejv_v4_1_value}</strong></div>
                                    <div style="margin-top: 5px;">[Why?] [Compare] [Enable]</div>
                                </div>
                            </div>
                            
                            <div style="margin-top: 10px; padding: 10px; background: #fff3e0; border-radius: 4px;">
                                <p style="margin: 5px 0;"><strong>Why?</strong> ${helpData.ui_pattern.example.why_button}</p>
                                <p style="margin: 5px 0;"><strong>Compare:</strong> ${helpData.ui_pattern.example.compare_button}</p>
                                <p style="margin: 5px 0;"><strong>Enable:</strong> ${helpData.ui_pattern.example.enable_button}</p>
                            </div>
                            
                            <p style="margin-top: 10px; font-style: italic; color: #666;"><em>Toggle Behavior:</em> ${helpData.ui_pattern.toggle_behavior}</p>
                        </div>
                    `;
                    componentsHtml += uiPatternHtml;
                }
                
                document.getElementById('helpComponents').innerHTML = componentsHtml;
                
                // Data sources section
                const sourcesHtml = helpData.data_sources.map(source => `
                    <div class="help-data-source">
                        <strong>üìä ${source.source}</strong>
                        <p>${source.data}</p>
                        ${source.url ? `<a href="${source.url}" target="_blank">${source.url}</a>` : ''}
                    </div>
                `).join('');
                document.getElementById('helpDataSources').innerHTML = sourcesHtml;
                
                // Key insight
                document.getElementById('helpKeyInsight').textContent = helpData.key_insight;
                
                // Interpretation (only for v1)
                const interpretationSection = document.getElementById('helpInterpretationSection');
                if (helpData.interpretation && version === 'v1') {
                    interpretationSection.style.display = 'block';
                    const interpHtml = `
                        <div class="help-interpretation-item excellent">
                            <strong>${helpData.interpretation.excellent}</strong>
                        </div>
                        <div class="help-interpretation-item good">
                            <strong>${helpData.interpretation.good}</strong>
                        </div>
                        <div class="help-interpretation-item fair">
                            <strong>${helpData.interpretation.fair}</strong>
                        </div>
                        <div class="help-interpretation-item poor">
                            <strong>${helpData.interpretation.poor}</strong>
                        </div>
                    `;
                    document.getElementById('helpInterpretation').innerHTML = interpHtml;
                } else {
                    interpretationSection.style.display = 'none';
                }
                
                // Example calculation (for v2 and v4.2)
                const exampleSection = document.getElementById('helpExampleSection');
                if (version === 'v4.2' && helpData.example) {
                    exampleSection.style.display = 'block';
                    const example = helpData.example;
                    const exampleHtml = `
                        <div class="help-component">
                            <h4>Example: ${example.scenario}</h4>
                            <p><strong>Base EJV v4.1:</strong> ${example.base_ejv_v41}</p>
                            <p><strong>Participation Activities:</strong></p>
                            <ul>
                                ${example.participation.map(p => `<li>${p}</li>`).join('')}
                            </ul>
                            <p><strong>PAF Calculated:</strong> ${example.paf_calculated}</p>
                            <p><strong>EJV v4.2 Result:</strong> ${example.ejv_v42}</p>
                            <p style="background: #e8f5e9; padding: 10px; border-radius: 6px; margin-top: 10px;">
                                <strong>üí° ${example.interpretation}</strong>
                            </p>
                        </div>
                    `;
                    document.getElementById('helpExample').innerHTML = exampleHtml;
                } else if (helpData.example_calculation && version === 'v2') {
                    exampleSection.style.display = 'block';
                    const example = helpData.example_calculation;
                    const exampleHtml = `
                        <div class="help-component">
                            <h4>Example: ${example.scenario}</h4>
                            <p><strong>Purchase:</strong> ${example.purchase}</p>
                            <p><strong>Local Capture:</strong> ${example.local_capture}</p>
                            <p><strong>Base Dimensions:</strong> ${example.base_dimensions}</p>
                            <p><strong>Adjusted Dimensions:</strong> ${example.adjusted_dimensions}</p>
                            <p><strong>Justice Score:</strong> ${example.justice_score}</p>
                            <p><strong>EJV v2 Result:</strong> ${example.ejv_v2}</p>
                            <p style="background: #e3f2fd; padding: 10px; border-radius: 6px; margin-top: 10px;">
                                <strong>üí° ${example.interpretation}</strong>
                            </p>
                        </div>
                    `;
                    document.getElementById('helpExample').innerHTML = exampleHtml;
                } else {
                    exampleSection.style.display = 'none';
                }
                
                // Nine Dimensions (only for v2)
                const dimensionsSection = document.getElementById('helpNineDimensionsSection');
                if (helpData.nine_dimensions && version === 'v2') {
                    dimensionsSection.style.display = 'block';
                    
                    const dims = helpData.nine_dimensions;
                    const dimensionsHtml = `
                        <p><strong>${dims.description}</strong></p>
                        ${dims.dimensions.map((dim, idx) => `
                            <div class="help-component" style="border-left: 4px solid ${idx < 3 ? '#ff9800' : '#667eea'};">
                                <h4>${dim.code}: ${dim.name} ${idx < 3 ? '‚ö°' : ''}</h4>
                                <p><strong>Calculation:</strong> ${dim.calculation}</p>
                                <p><strong>Modifier:</strong> ${dim.modifier}</p>
                                <p><strong>Represents:</strong> ${dim.represents}</p>
                            </div>
                        `).join('')}
                        
                        <div class="help-component" style="background: #fff8e1; border-left: 4px solid #ff9800;">
                            <h4>‚ö° ZIP Need Modifiers (NM)</h4>
                            <p>${dims.zip_need_modifiers.description}</p>
                            <p><strong>Range:</strong> ${dims.zip_need_modifiers.range}</p>
                            <p><strong>Factors:</strong></p>
                            <ul>
                                ${dims.zip_need_modifiers.factors.map(f => `<li>${f}</li>`).join('')}
                            </ul>
                            <p><strong>Examples:</strong></p>
                            <ul>
                                ${dims.zip_need_modifiers.examples.map(e => `<li>${e}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                    document.getElementById('helpNineDimensions').innerHTML = dimensionsHtml;
                } else {
                    dimensionsSection.style.display = 'none';
                }
                
                // Advantages (only for v2)
                const advantagesSection = document.getElementById('helpAdvantagesSection');
                if (helpData.advantages && version === 'v2') {
                    advantagesSection.style.display = 'block';
                    const advantagesHtml = `
                        <ul>
                            ${helpData.advantages.map(adv => `<li>${adv}</li>`).join('')}
                        </ul>
                    `;
                    document.getElementById('helpAdvantages').innerHTML = advantagesHtml;
                } else {
                    advantagesSection.style.display = 'none';
                }
                
                // Show modal
                modal.style.display = 'block';
                
            } catch (error) {
                console.error('Error loading help content:', error);
                console.error('Endpoint was:', endpoint);
                alert(`Failed to load help content from ${endpoint}. Error: ${error.message}. Check console for details.`);
            }
        }

        function closeHelpModal() {
            document.getElementById('helpModal').style.display = 'none';
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('helpModal');
            if (event.target === modal) {
                closeHelpModal();
            }
            const purchaseModal = document.getElementById('purchaseModal');
            if (event.target === purchaseModal) {
                closePurchaseModal();
            }
        }

        // ============================================
        // USER DASHBOARD FUNCTIONS
        // ============================================

        // Initialize User Dashboard
        function initUserDashboard() {
            const userData = localStorage.getItem('fixAppUserData');
            
            if (!userData) {
                // First time user - show welcome/setup
                document.getElementById('welcomeSection').style.display = 'block';
                document.getElementById('mainDashboard').style.display = 'none';
                // Set today's date as default
                document.getElementById('purchaseDate').valueAsDate = new Date();
            } else {
                // Returning user - show dashboard
                document.getElementById('welcomeSection').style.display = 'none';
                document.getElementById('mainDashboard').style.display = 'block';
                loadUserDashboard();
            }
        }

        // Save user profile from setup form
        function saveUserProfile() {
            const name = document.getElementById('setupName').value.trim();
            const zip = document.getElementById('setupZip').value.trim();
            const goal = document.getElementById('setupGoal').value || 5000;

            if (!name) {
                alert('Please enter your name');
                return;
            }
            if (!zip || zip.length !== 5) {
                alert('Please enter a valid 5-digit ZIP code');
                return;
            }

            const userData = {
                profile: {
                    name: name,
                    homeZip: zip,
                    monthlyGoal: parseFloat(goal),
                    createdAt: new Date().toISOString()
                },
                purchases: [],
                activity: {
                    searchCount: 0,
                    compareCount: 0,
                    optimizationAdopted: 0,
                    communityActions: 0
                },
                monthlyScores: {}
            };

            localStorage.setItem('fixAppUserData', JSON.stringify(userData));
            
            // Show main dashboard
            document.getElementById('welcomeSection').style.display = 'none';
            document.getElementById('mainDashboard').style.display = 'block';
            loadUserDashboard();
        }

        // Edit user profile
        function editUserProfile() {
            const userData = JSON.parse(localStorage.getItem('fixAppUserData'));
            if (!userData) return;

            const newName = prompt('Enter your name:', userData.profile.name);
            if (newName && newName.trim()) {
                userData.profile.name = newName.trim();
            }

            const newZip = prompt('Enter your home ZIP code:', userData.profile.homeZip);
            if (newZip && newZip.length === 5) {
                userData.profile.homeZip = newZip;
            }

            const newGoal = prompt('Enter your monthly spending goal:', userData.profile.monthlyGoal);
            if (newGoal && !isNaN(newGoal)) {
                userData.profile.monthlyGoal = parseFloat(newGoal);
            }

            localStorage.setItem('fixAppUserData', JSON.stringify(userData));
            loadUserDashboard();
        }

        // Load and display user dashboard
        function loadUserDashboard() {
            const userData = JSON.parse(localStorage.getItem('fixAppUserData'));
            if (!userData) return;

            // Update user greeting
            document.getElementById('userName').textContent = userData.profile.name;

            // Calculate and display metrics
            const metrics = calculateDashboardMetrics(userData);
            
            // Update main GeoEquity Score
            document.getElementById('geoEquityScore').textContent = metrics.geoEquityScore;
            document.getElementById('scoreTrend').textContent = metrics.scoreTrend;
            document.getElementById('scoreMessage').textContent = metrics.scoreMessage;
            
            // Calculate dollar value approximation
            // Each point represents roughly $1 of local economic value per $100 spent
            // So a score of 80 means ~$80 retained locally per $100
            const totalSpent = userData.purchases.reduce((sum, p) => sum + (p.amount || 0), 0);
            const estimatedLocalImpact = (metrics.geoEquityScore / 100) * totalSpent;
            const scoreInDollarsElement = document.getElementById('scoreInDollars');
            if (scoreInDollarsElement) {
                if (totalSpent > 0) {
                    scoreInDollarsElement.textContent = `‚âà $${estimatedLocalImpact.toFixed(0)} local impact from $${totalSpent.toFixed(0)} spent`;
                } else {
                    scoreInDollarsElement.textContent = '‚âà $0 local impact';
                }
            }

            // Update dimension scores
            document.getElementById('locatorScore').textContent = metrics.locatorScore;
            document.getElementById('locatorTrend').textContent = metrics.locatorTrend;
            document.getElementById('locatorMessage').textContent = metrics.locatorMessage;

            document.getElementById('compareScore').textContent = metrics.compareScore;
            document.getElementById('compareTrend').textContent = metrics.compareTrend;
            document.getElementById('compareMessage').textContent = metrics.compareMessage;

            document.getElementById('optimizeScore').textContent = metrics.optimizeScore;
            document.getElementById('optimizeTrend').textContent = metrics.optimizeTrend;
            document.getElementById('optimizeMessage').textContent = metrics.optimizeMessage;

            document.getElementById('engageScore').textContent = metrics.engageScore;
            document.getElementById('engageTrend').textContent = metrics.engageTrend;
            document.getElementById('engageMessage').textContent = metrics.engageMessage;

            // Update spending flow
            document.getElementById('localRetainedPercent').textContent = metrics.localRetainedPercent + '%';
            document.getElementById('localRetainedBar').style.width = metrics.localRetainedPercent + '%';
            
            document.getElementById('regionalLeakPercent').textContent = metrics.regionalLeakPercent + '%';
            document.getElementById('regionalLeakBar').style.width = metrics.regionalLeakPercent + '%';
            
            document.getElementById('nationalLeakPercent').textContent = metrics.nationalLeakPercent + '%';
            document.getElementById('nationalLeakBar').style.width = metrics.nationalLeakPercent + '%';

            document.getElementById('avgDistance').textContent = metrics.avgDistance + ' miles';

            // Update progress chart
            updateProgressChart(userData);

            // Update purchase history
            displayPurchaseHistory(userData.purchases);

            // Populate store datalist for quick purchase logging
            populateStoreDatalist();
        }

        // Calculate all dashboard metrics
        function calculateDashboardMetrics(userData) {
            const metrics = {
                geoEquityScore: 0,
                scoreTrend: '--',
                scoreMessage: 'Start logging purchases to see your impact!',
                locatorScore: 0,
                locatorTrend: '--',
                locatorMessage: 'Search for stores to increase awareness',
                compareScore: 0,
                compareTrend: '--',
                compareMessage: 'Your avg EJV from purchases',
                optimizeScore: 0,
                optimizeTrend: '--',
                optimizeMessage: 'Adopt suggestions to improve',
                engageScore: 0,
                engageTrend: '--',
                engageMessage: 'Participate in community activities',
                localRetainedPercent: 0,
                regionalLeakPercent: 0,
                nationalLeakPercent: 0,
                avgDistance: 0
            };

            // LOCATOR Score: Based on search activity and awareness
            const searchCount = userData.activity.searchCount || 0;
            metrics.locatorScore = Math.min(100, Math.round(searchCount * 5 + (userData.purchases.length * 10)));
            if (metrics.locatorScore > 0) {
                metrics.locatorTrend = metrics.locatorScore >= 70 ? 'üî• Great' : metrics.locatorScore >= 40 ? 'üëç Good' : 'üìà Growing';
                metrics.locatorMessage = `${searchCount} searches, ${userData.purchases.length} purchases logged`;
            }

            // COMPARE Score: Average EJV score from purchases + compare activity bonus
            if (userData.purchases.length > 0) {
                const totalEJV = userData.purchases.reduce((sum, p) => sum + (p.ejvScore || 0), 0);
                const avgEJV = totalEJV / userData.purchases.length;
                // Add bonus for using Compare module (up to 20 points)
                const compareBonus = Math.min(20, (userData.activity.compareCount || 0) * 2);
                metrics.compareScore = Math.min(100, Math.round(avgEJV + compareBonus));
                metrics.compareTrend = metrics.compareScore >= 80 ? '‚≠ê Excellent' : metrics.compareScore >= 60 ? '‚úì Good' : 'üìä Fair';
                metrics.compareMessage = `Avg EJV: ${Math.round(avgEJV)} from ${userData.purchases.length} purchases${compareBonus > 0 ? ` (+${compareBonus} compare bonus)` : ''}`;
            } else {
                // Even without purchases, compare activity counts
                const compareBonus = Math.min(50, (userData.activity.compareCount || 0) * 5);
                if (compareBonus > 0) {
                    metrics.compareScore = compareBonus;
                    metrics.compareTrend = 'üìä Active';
                    metrics.compareMessage = `${userData.activity.compareCount} comparisons made`;
                }
            }

            // OPTIMIZE Score: Calculate from actual improvement over time
            const currentMonth = new Date().toISOString().substring(0, 7);
            const lastMonth = new Date(new Date().setMonth(new Date().getMonth() - 1)).toISOString().substring(0, 7);
            const currentMonthPurchases = userData.purchases.filter(p => p.date.startsWith(currentMonth));
            const lastMonthPurchases = userData.purchases.filter(p => p.date.startsWith(lastMonth));
            
            if (currentMonthPurchases.length > 0 && lastMonthPurchases.length > 0) {
                const currentAvgEJV = currentMonthPurchases.reduce((sum, p) => sum + (p.ejvScore || 0), 0) / currentMonthPurchases.length;
                const lastAvgEJV = lastMonthPurchases.reduce((sum, p) => sum + (p.ejvScore || 0), 0) / lastMonthPurchases.length;
                const improvement = lastAvgEJV > 0 ? ((currentAvgEJV - lastAvgEJV) / lastAvgEJV) * 100 : 0;
                // Score based on improvement percentage (max 100)
                metrics.optimizeScore = Math.min(100, Math.max(0, Math.round(50 + improvement * 5)));
                metrics.optimizeTrend = improvement >= 8 ? 'üöÄ Excellent' : improvement >= 3 ? 'üìà Good' : improvement > 0 ? '‚úì Growing' : '‚û°Ô∏è Steady';
                metrics.optimizeMessage = improvement > 0 ? `${improvement.toFixed(1)}% improvement this month` : 'Keep optimizing your choices';
            } else if (userData.purchases.length > 0) {
                // Base score on purchase diversity and quality
                const avgEJV = userData.purchases.reduce((sum, p) => sum + (p.ejvScore || 0), 0) / userData.purchases.length;
                metrics.optimizeScore = Math.min(100, Math.round(avgEJV * 0.8));
                metrics.optimizeTrend = 'üìä Building';
                metrics.optimizeMessage = 'Building optimization baseline';
            }

            // ENGAGE Score: Based on civic actions (EJV v4.2) + community activity
            const civicActions = userData.civicActions || [];
            const civicPoints = civicActions.reduce((sum, a) => sum + (a.points || 0), 0);
            const communityBonus = Math.min(20, (userData.activity.communityActions || 0) * 4);
            metrics.engageScore = Math.min(100, civicPoints + communityBonus);
            if (metrics.engageScore > 0) {
                metrics.engageTrend = metrics.engageScore >= 80 ? 'üåü Leader' : metrics.engageScore >= 40 ? 'ü§ù Active' : 'üå± Growing';
                metrics.engageMessage = civicActions.length > 0 ? `${civicActions.length} civic actions (+${civicPoints} pts)` : `${userData.activity.communityActions || 0} community activities`;
            }

            // Calculate overall GeoEquity Score (weighted average)
            metrics.geoEquityScore = Math.round(
                (metrics.locatorScore * 0.20) +
                (metrics.compareScore * 0.30) +
                (metrics.optimizeScore * 0.25) +
                (metrics.engageScore * 0.25)
            );

            // Score trend and message
            if (metrics.geoEquityScore >= 80) {
                metrics.scoreTrend = 'üåü Excellent';
                metrics.scoreMessage = 'Outstanding! You\'re a GeoEquity champion!';
            } else if (metrics.geoEquityScore >= 60) {
                metrics.scoreTrend = '‚úì Good';
                metrics.scoreMessage = 'Great work! Keep building your local impact!';
            } else if (metrics.geoEquityScore >= 40) {
                metrics.scoreTrend = 'üìà Growing';
                metrics.scoreMessage = 'You\'re making progress! Continue tracking purchases.';
            } else if (metrics.geoEquityScore > 0) {
                metrics.scoreTrend = 'üå± Starting';
                metrics.scoreMessage = 'Good start! Log more purchases to see your impact grow.';
            }

            // Calculate spending flow (distance-based retention)
            if (userData.purchases.length > 0) {
                let localCount = 0;
                let regionalCount = 0;
                let nationalCount = 0;
                let totalDistance = 0;
                let purchasesWithDistance = 0;

                userData.purchases.forEach(p => {
                    const dist = p.distance || null;
                    
                    if (dist !== null && dist !== undefined) {
                        totalDistance += dist;
                        purchasesWithDistance++;
                        
                        if (dist <= 5) localCount++;
                        else if (dist <= 25) regionalCount++;
                        else nationalCount++;
                    } else {
                        // For purchases without distance, estimate based on EJV
                        // Higher EJV typically correlates with local businesses
                        const ejv = p.ejvScore || 70;
                        if (ejv >= 80) {
                            localCount++;
                            totalDistance += 3; // Estimate 3 miles for high-EJV local
                        } else if (ejv >= 65) {
                            regionalCount++;
                            totalDistance += 15; // Estimate 15 miles for regional
                        } else {
                            nationalCount++;
                            totalDistance += 40; // Estimate 40 miles for national
                        }
                        purchasesWithDistance++;
                    }
                });

                const total = userData.purchases.length;
                metrics.localRetainedPercent = Math.round((localCount / total) * 100);
                metrics.regionalLeakPercent = Math.round((regionalCount / total) * 100);
                metrics.nationalLeakPercent = Math.round((nationalCount / total) * 100);
                metrics.avgDistance = purchasesWithDistance > 0 ? (totalDistance / purchasesWithDistance).toFixed(1) : '0';
            }

            return metrics;
        }

        // Update progress chart
        function updateProgressChart(userData) {
            const chartContainer = document.getElementById('progressChart');
            
            // Get last 6 months of data
            const months = [];
            const scores = [];
            const now = new Date();
            
            for (let i = 5; i >= 0; i--) {
                const month = new Date(now.getFullYear(), now.getMonth() - i, 1);
                const monthKey = month.toISOString().substring(0, 7); // YYYY-MM format
                months.push(month.toLocaleDateString('en-US', { month: 'short' }));
                
                // Get score for this month or calculate from purchases
                const monthScore = userData.monthlyScores[monthKey] || calculateMonthScore(userData, monthKey);
                scores.push(monthScore);
            }

            // Update month labels
            for (let i = 0; i < 6; i++) {
                document.getElementById(`chartMonth${i + 1}`).textContent = months[i];
            }

            // Generate chart bars
            if (scores.some(s => s > 0)) {
                const maxScore = Math.max(...scores, 1);
                chartContainer.innerHTML = scores.map((score, idx) => {
                    const height = (score / 100) * 100; // Percentage height
                    return `
                        <div style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: flex-end;">
                            <div style="font-size: 11px; font-weight: 600; color: #667eea; margin-bottom: 4px;">${score}</div>
                            <div style="width: 100%; background: linear-gradient(180deg, #667eea 0%, #764ba2 100%); border-radius: 4px 4px 0 0; height: ${height}%; min-height: ${score > 0 ? '5px' : '0'}; transition: height 0.5s ease;"></div>
                        </div>
                    `;
                }).join('');
            }
        }

        // Calculate score for a specific month
        function calculateMonthScore(userData, monthKey) {
            const monthPurchases = userData.purchases.filter(p => p.date.startsWith(monthKey));
            if (monthPurchases.length === 0) return 0;
            
            const avgEJV = monthPurchases.reduce((sum, p) => sum + (p.ejvScore || 0), 0) / monthPurchases.length;
            return Math.round(avgEJV);
        }

        // Display purchase history
        function displayPurchaseHistory(purchases) {
            const container = document.getElementById('purchaseHistory');
            
            if (purchases.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #999;">
                        <div style="font-size: 48px; margin-bottom: 10px;">üßæ</div>
                        <div style="font-size: 14px;">No purchases logged yet. Start tracking your impact!</div>
                    </div>
                `;
                return;
            }

            // Sort by date (most recent first)
            const sortedPurchases = [...purchases].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            // Show last 10 purchases
            const recentPurchases = sortedPurchases.slice(0, 10);
            
            container.innerHTML = recentPurchases.map(p => {
                const ejvBadge = p.ejvScore ? `
                    <div style="background: ${p.ejvScore >= 80 ? '#4caf50' : p.ejvScore >= 60 ? '#ff9800' : '#f44336'}; color: white; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600;">
                        EJV: ${p.ejvScore}
                    </div>
                ` : '';
                
                return `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid #e0e0e0;">
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: #333; margin-bottom: 4px;">${p.storeName}</div>
                            <div style="font-size: 12px; color: #999;">
                                ${new Date(p.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}
                                ${p.category ? ` ‚Ä¢ ${p.category}` : ''}
                                ${p.distance ? ` ‚Ä¢ ${p.distance} miles away` : ''}
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 15px;">
                            ${ejvBadge}
                            <div style="font-size: 18px; font-weight: 700; color: #667eea;">
                                $${parseFloat(p.amount).toFixed(2)}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            if (purchases.length > 10) {
                container.innerHTML += `
                    <div style="text-align: center; padding: 15px; color: #999; font-size: 13px;">
                        Showing 10 of ${purchases.length} total purchases
                    </div>
                `;
            }
        }

        // Populate store datalist from recent searches
        function populateStoreDatalist() {
            const datalist = document.getElementById('storesList');
            const recentStores = localStorage.getItem('recentStores');
            
            if (recentStores) {
                const stores = JSON.parse(recentStores);
                datalist.innerHTML = stores.map(s => `<option value="${s}">`).join('');
            }
        }

        // Open purchase logging modal
        function logPurchaseModal() {
            document.getElementById('purchaseModal').style.display = 'flex';
            document.getElementById('purchaseDate').valueAsDate = new Date();
            populateStoreDatalist();
        }

        // Close purchase logging modal
        function closePurchaseModal() {
            document.getElementById('purchaseModal').style.display = 'none';
            document.getElementById('purchaseStoreName').value = '';
            document.getElementById('purchaseAmount').value = '';
            document.getElementById('purchaseCategory').value = '';
        }

        // Save a purchase
        async function savePurchase() {
            const storeName = document.getElementById('purchaseStoreName').value.trim();
            const amount = document.getElementById('purchaseAmount').value;
            const date = document.getElementById('purchaseDate').value;
            const category = document.getElementById('purchaseCategory').value;

            if (!storeName) {
                alert('Please enter a store name');
                return;
            }
            if (!amount || parseFloat(amount) <= 0) {
                alert('Please enter a valid amount');
                return;
            }
            if (!date) {
                alert('Please select a date');
                return;
            }

            const userData = JSON.parse(localStorage.getItem('fixAppUserData'));
            if (!userData) return;

            // Create purchase object
            const purchase = {
                id: Date.now(),
                storeName: storeName,
                amount: parseFloat(amount),
                date: date,
                category: category,
                ejvScore: null, // Will be fetched if available
                distance: null, // Will be calculated if we have store data
                timestamp: new Date().toISOString()
            };

            // Try to get EJV score and distance from recent searches
            const storeData = await getStoreDataFromRecent(storeName);
            if (storeData && storeData.ejvScore) {
                purchase.ejvScore = storeData.ejvScore;
                purchase.distance = storeData.distance || (Math.random() * 20 + 2); // Fallback: 2-22 miles
                console.log('Purchase logged with EJV:', purchase.ejvScore, 'Distance:', purchase.distance);
            } else {
                // Generate reasonable mock data for demonstration
                purchase.ejvScore = 70 + Math.random() * 25; // 70-95 range
                // Higher EJV typically means more local
                const ejvRatio = purchase.ejvScore / 100;
                if (ejvRatio >= 0.85) {
                    purchase.distance = Math.random() * 5; // 0-5 miles for high EJV (local)
                } else if (ejvRatio >= 0.70) {
                    purchase.distance = 5 + Math.random() * 20; // 5-25 miles for medium EJV (regional)
                } else {
                    purchase.distance = 25 + Math.random() * 50; // 25-75 miles for low EJV (national)
                }
                console.log('Generated mock EJV:', purchase.ejvScore, 'Distance:', purchase.distance.toFixed(1));
            }

            // Add purchase
            userData.purchases.push(purchase);

            // Update recent stores list
            updateRecentStores(storeName);

            // Save to localStorage
            localStorage.setItem('fixAppUserData', JSON.stringify(userData));

            // Close modal and reload dashboard
            closePurchaseModal();
            loadUserDashboard();

            alert('Purchase logged successfully! üéâ');
        }

        // Get store data from recent searches
        async function getStoreDataFromRecent(storeName) {
            // Try to find this store in recent search results
            if (window.lastSearchResults) {
                const store = window.lastSearchResults.find(s => 
                    s.name && s.name.toLowerCase().includes(storeName.toLowerCase())
                );
                if (store) {
                    // If ejvScore exists, use it
                    if (store.ejvScore) {
                        return {
                            ejvScore: store.ejvScore,
                            distance: store.distance || null
                        };
                    }
                    
                    // Otherwise, calculate EJV now
                    console.log('Calculating EJV for purchase:', storeName);
                    const ejvData = await calculateEJV(store.id, store.name, false);
                    if (ejvData && ejvData.data) {
                        const ejvScore = ejvData.data.ejv_v2_baseline?.EJV || ejvData.data.elvr || 0;
                        // Cache it for future use
                        store.ejvScore = ejvScore;
                        return {
                            ejvScore: ejvScore,
                            distance: store.distance || null
                        };
                    }
                }
            }
            return null;
        }

        // Update recent stores list
        function updateRecentStores(storeName) {
            let recentStores = localStorage.getItem('recentStores');
            recentStores = recentStores ? JSON.parse(recentStores) : [];
            
            // Add to beginning if not already present
            if (!recentStores.includes(storeName)) {
                recentStores.unshift(storeName);
                // Keep only last 20
                recentStores = recentStores.slice(0, 20);
                localStorage.setItem('recentStores', JSON.stringify(recentStores));
            }
        }

        // Increment search count (called from searchByZip)
        function incrementSearchCount() {
            let userData = JSON.parse(localStorage.getItem('fixAppUserData'));
            if (!userData) {
                // Create minimal user data if it doesn't exist
                userData = {
                    profile: { name: 'User', homeZip: '00000' },
                    purchases: [],
                    activity: { searchCount: 0, compareCount: 0, optimizationAdopted: 0, communityActions: 0 },
                    civicActions: [],
                    monthlyScores: {}
                };
            }
            userData.activity.searchCount = (userData.activity.searchCount || 0) + 1;
            localStorage.setItem('fixAppUserData', JSON.stringify(userData));
            
            console.log('Search count incremented:', userData.activity.searchCount);
        }

        // Show methodology modal
        function showMethodologyModal() {
            alert('GeoEquity Score Methodology:\n\n' +
                'Your score is calculated from 4 dimensions:\n\n' +
                '‚Ä¢ LOCATOR (20%): Store search activity and awareness\n' +
                '‚Ä¢ COMPARE (30%): Average EJV scores from purchases\n' +
                '‚Ä¢ OPTIMIZE (25%): Optimization suggestions adopted\n' +
                '‚Ä¢ ENGAGE (25%): Community participation actions\n\n' +
                'Formula: (LOCATOR √ó 0.20) + (COMPARE √ó 0.30) + (OPTIMIZE √ó 0.25) + (ENGAGE √ó 0.25)');
        }

        // Quick log purchase from store search results
        function quickLogPurchase(storeName, storeId) {
            // Check if user has profile
            const userData = localStorage.getItem('fixAppUserData');
            if (!userData) {
                if (confirm('You need to set up your profile first. Would you like to go to the User Dashboard?')) {
                    showModule('userDashboard');
                }
                return;
            }

            // Pre-fill store name and open modal
            document.getElementById('purchaseStoreName').value = storeName;
            document.getElementById('purchaseAmount').value = '';
            document.getElementById('purchaseDate').valueAsDate = new Date();
            document.getElementById('purchaseCategory').value = '';
            
            // Store the store ID for later use
            window.currentStoreId = storeId;
            
            document.getElementById('purchaseModal').style.display = 'flex';
        }

        // Open quick log from Locator main button (without pre-filled store)
        function openQuickLogFromLocator() {
            // Check if user has profile
            const userData = localStorage.getItem('fixAppUserData');
            if (!userData) {
                if (confirm('You need to set up your profile first. Would you like to go to the User Dashboard?')) {
                    showModule('userDashboard');
                }
                return;
            }

            // Open modal with empty fields
            document.getElementById('purchaseStoreName').value = '';
            document.getElementById('purchaseAmount').value = '';
            document.getElementById('purchaseDate').valueAsDate = new Date();
            document.getElementById('purchaseCategory').value = '';
            
            // Clear stored store ID
            window.currentStoreId = null;
            
            // Populate the datalist with recent search results
            populateStoreDatalist();
            
            document.getElementById('purchaseModal').style.display = 'flex';
        }

        // ============================================
        // COMPARE MODULE FUNCTIONS
        // ============================================

        let storeAData = null;
        let storeBData = null;

        // Initialize Compare Module
        function initCompareModule() {
            console.log('üîÑ Initializing Compare Module...');
            populateCompareSelects();
            
            // Check if we have stores to compare
            const hasStores = window.lastSearchResults && window.lastSearchResults.length > 0;
            const userData = JSON.parse(localStorage.getItem('fixAppUserData'));
            const hasPurchases = userData && userData.purchases && userData.purchases.length > 0;
            
            console.log('Compare module data check:', {
                hasStores,
                storeCount: window.lastSearchResults?.length || 0,
                hasPurchases,
                purchaseCount: userData?.purchases?.length || 0
            });
            
            if (!hasStores && !hasPurchases) {
                // Show empty state
                document.getElementById('compareEmptyState').style.display = 'block';
                console.log('‚ö†Ô∏è No stores or purchases available for comparison');
            } else {
                document.getElementById('compareEmptyState').style.display = 'none';
                console.log('‚úì Stores available for comparison');
            }
            
            // Hide results initially
            document.getElementById('comparisonResults').style.display = 'none';
            console.log('‚úì Compare Module initialized');
        }

        // Populate store dropdowns
        function populateCompareSelects() {
            const storeASelect = document.getElementById('storeASelect');
            const storeBSelect = document.getElementById('storeBSelect');
            
            // Clear existing options (keep default)
            storeASelect.innerHTML = '<option value="">-- Select Store A --</option>';
            storeBSelect.innerHTML = '<option value="">-- Select Store B --</option>';

            // Add from recent search results (most recent search only)
            if (window.lastSearchResults && window.lastSearchResults.length > 0) {
                const searchGroup = document.createElement('optgroup');
                searchGroup.label = 'üìç Current Search Results';
                
                window.lastSearchResults.slice(0, 20).forEach((store, idx) => {
                    const option = document.createElement('option');
                    option.value = 'search_' + idx;
                    const storeName = store.tags?.brand || store.name || store.tags?.name || store.tags?.shop || 'Store #' + (idx + 1);
                    option.textContent = storeName;
                    searchGroup.appendChild(option);
                });
                
                storeASelect.appendChild(searchGroup.cloneNode(true));
                storeBSelect.appendChild(searchGroup);
            }

            // Add from purchase history
            const userData = JSON.parse(localStorage.getItem('fixAppUserData'));
            if (userData && userData.purchases && userData.purchases.length > 0) {
                const purchaseGroup = document.createElement('optgroup');
                purchaseGroup.label = 'üõí Your Purchases';
                
                // Get unique store names
                const uniqueStores = [...new Set(userData.purchases.map(p => p.storeName))];
                
                uniqueStores.slice(0, 20).forEach((storeName, idx) => {
                    const option = document.createElement('option');
                    option.value = 'purchase_' + idx;
                    option.textContent = storeName;
                    option.dataset.storeName = storeName;
                    purchaseGroup.appendChild(option);
                });
                
                storeASelect.appendChild(purchaseGroup.cloneNode(true));
                storeBSelect.appendChild(purchaseGroup);
            }
        }

        // Load Store A
        async function loadStoreA() {
            const select = document.getElementById('storeASelect');
            const value = select.value;
            
            console.log('üîÑ Loading Store A, value:', value);
            
            if (!value) {
                document.getElementById('storeADetails').innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">Select a store to see details</div>';
                storeAData = null;
                return;
            }

            document.getElementById('storeADetails').innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">‚è≥ Loading store data...</div>';

            try {
                const [source, idx] = value.split('_');
                
                if (source === 'search') {
                    if (!window.lastSearchResults || !window.lastSearchResults[parseInt(idx)]) {
                        throw new Error('Store not found in search results');
                    }
                    const store = window.lastSearchResults[parseInt(idx)];
                    console.log('Loading from search results:', store.name);
                    storeAData = await loadStoreData(store);
                } else if (source === 'purchase') {
                    const storeName = select.options[select.selectedIndex].dataset.storeName;
                    console.log('Loading from purchase history:', storeName);
                    storeAData = await loadStoreDataFromPurchase(storeName);
                }

                if (!storeAData) {
                    throw new Error('Failed to load store data');
                }
                
                console.log('‚úÖ Store A loaded successfully:', storeAData);
                displayStoreDetails('storeADetails', storeAData, '#4caf50');
            } catch (error) {
                console.error('‚ùå Error loading Store A:', error);
                document.getElementById('storeADetails').innerHTML = `
                    <div style="text-align: center; color: #f44336; padding: 20px;">
                        <div style="font-size: 24px; margin-bottom: 10px;">‚ö†Ô∏è</div>
                        <div>Error loading store data</div>
                        <div style="font-size: 12px; margin-top: 5px; color: #999;">${error.message}</div>
                    </div>
                `;
                storeAData = null;
            }
        }

        // Load Store B
        async function loadStoreB() {
            const select = document.getElementById('storeBSelect');
            const value = select.value;
            
            console.log('üîÑ Loading Store B, value:', value);
            
            if (!value) {
                document.getElementById('storeBDetails').innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">Select a store to see details</div>';
                storeBData = null;
                return;
            }

            document.getElementById('storeBDetails').innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">‚è≥ Loading store data...</div>';

            try {
                const [source, idx] = value.split('_');
                
                if (source === 'search') {
                    if (!window.lastSearchResults || !window.lastSearchResults[parseInt(idx)]) {
                        throw new Error('Store not found in search results');
                    }
                    const store = window.lastSearchResults[parseInt(idx)];
                    console.log('Loading from search results:', store.name);
                    storeBData = await loadStoreData(store);
                } else if (source === 'purchase') {
                    const storeName = select.options[select.selectedIndex].dataset.storeName;
                    console.log('Loading from purchase history:', storeName);
                    storeBData = await loadStoreDataFromPurchase(storeName);
                }

                if (!storeBData) {
                    throw new Error('Failed to load store data');
                }
                
                console.log('‚úÖ Store B loaded successfully:', storeBData);
                displayStoreDetails('storeBDetails', storeBData, '#2196f3');
            } catch (error) {
                console.error('‚ùå Error loading Store B:', error);
                document.getElementById('storeBDetails').innerHTML = `
                    <div style="text-align: center; color: #f44336; padding: 20px;">
                        <div style="font-size: 24px; margin-bottom: 10px;">‚ö†Ô∏è</div>
                        <div>Error loading store data</div>
                        <div style="font-size: 12px; margin-top: 5px; color: #999;">${error.message}</div>
                    </div>
                `;
                storeBData = null;
            }
        }
        
        async function loadStoreData(store) {
            console.log('üìä Loading store data for:', store.name || store.tags?.name, 'ID:', store.id);
            
            try {
                // Get store name from various possible locations
                const storeName = store.tags?.brand || store.name || store.tags?.name || store.tags?.shop || store.tags?.amenity || 'Unnamed Store';
                
                // Get store address from various possible locations
                let storeAddress = store.address;
                if (!storeAddress && store.tags) {
                    const addrParts = [
                        store.tags['addr:housenumber'],
                        store.tags['addr:street'],
                        store.tags['addr:city'],
                        store.tags['addr:state']
                    ].filter(Boolean);
                    storeAddress = addrParts.length > 0 ? addrParts.join(' ') : 'Address not available';
                } else if (!storeAddress) {
                    storeAddress = 'Address not available';
                }
                
                const ejvData = await calculateEJV(store.id, storeName, true);
                console.log('üìà EJV data received:', ejvData);
                console.log('üìä EJV data structure:', JSON.stringify(ejvData?.data, null, 2));
                
                if (!ejvData || !ejvData.data) {
                    console.warn('‚ö†Ô∏è No EJV data returned, using fallback values');
                }
                
                // Extract EJV scores and 6 components from EJV 4.1 response
                const ejvV40 = ejvData?.data?.ejv_original?.ejv_percentage || ejvData?.data?.ejv_original?.ejv_score * 100 || 0;
                const ejvV41 = ejvData?.data?.ejv_score || 0;
                
                // Extract 6 component scores (0-100 scale)
                const components = ejvData?.data?.components || {};
                const lc = components.LC_local_circulation || 0;
                const w = components.W_fair_wages || 0;
                const dn = components.DN_community_need || 0;
                const eq = components.EQ_equity_inclusion || 0;
                const env = components.ENV_environmental || 0;
                const proc = components.PROC_procurement || 0;
                
                console.log('üìä Extracted components:', { lc, w, dn, eq, env, proc });
                
                const storeData = {
                    name: storeName,
                    address: storeAddress,
                    ejvV40: ejvV40,
                    ejvV41: ejvV41,
                    lc: lc,
                    w: w,
                    dn: dn,
                    eq: eq,
                    env: env,
                    proc: proc,
                    distance: store.distance || 0
                };
                
                console.log('‚úÖ Processed store data:', storeData);
                return storeData;
            } catch (error) {
                console.error('‚ùå Error in loadStoreData:', error);
                // Return fallback data with proper name extraction
                const fallbackName = store.tags?.brand || store.name || store.tags?.name || store.tags?.shop || 'Unknown Store';
                let fallbackAddress = store.address;
                if (!fallbackAddress && store.tags) {
                    const addrParts = [
                        store.tags['addr:housenumber'],
                        store.tags['addr:street'],
                        store.tags['addr:city']
                    ].filter(Boolean);
                    fallbackAddress = addrParts.length > 0 ? addrParts.join(' ') : 'Address not available';
                }
                return {
                    name: fallbackName,
                    address: fallbackAddress || 'Address not available',
                    ejvV40: 0,
                    ejvV41: 0,
                    lc: 0,
                    w: 0,
                    dn: 0,
                    eq: 0,
                    env: 0,
                    proc: 0,
                    distance: store.distance || 0
                };
            }
        }

        // Load store data from purchase history
        async function loadStoreDataFromPurchase(storeName) {
            const userData = JSON.parse(localStorage.getItem('fixAppUserData'));
            const purchase = userData.purchases.find(p => p.storeName === storeName);
            
            // Try to get live data if store is in search results
            if (window.lastSearchResults) {
                const store = window.lastSearchResults.find(s => 
                    s.name && s.name.toLowerCase().includes(storeName.toLowerCase())
                );
                if (store) {
                    return await loadStoreData(store);
                }
            }
            
            // Use cached data from purchase
            return {
                name: storeName,
                address: 'From purchase history',
                ejvV40: purchase.ejvScore || 0,
                ejvV41: purchase.ejvScore || 0,
                lc: 0,
                w: 0,
                dn: 0,
                eq: 0,
                env: 0,
                proc: 0,
                distance: purchase.distance || 0
            };
        }

        // Display store details in panel
        function displayStoreDetails(containerId, data, color) {
            console.log('üñºÔ∏è Displaying store details for container:', containerId, 'data:', data);
            if (!data) {
                console.warn('‚ö†Ô∏è No data provided to displayStoreDetails');
                document.getElementById(containerId).innerHTML = `
                    <div style="text-align: center; color: #f44336; padding: 20px;">
                        <div style="font-size: 24px; margin-bottom: 10px;">‚ö†Ô∏è</div>
                        <div>No store data available</div>
                    </div>
                `;
                return;
            }
            
            const hasEJV = (data.ejvV2 > 0 || data.ejvV41 > 0);
            const ejvNote = !hasEJV ? '<div style="background: #fff3cd; color: #856404; padding: 8px; border-radius: 5px; font-size: 11px; margin-top: 10px;">‚ö†Ô∏è EJV calculation in progress or unavailable</div>' : '';
            
            document.getElementById(containerId).innerHTML = `
                <div style="margin-bottom: 10px;">
                    <div style="font-weight: 600; color: ${color}; font-size: 16px; margin-bottom: 5px;">${data.name || 'Unknown Store'}</div>
                    <div style="font-size: 12px; color: #666; margin-bottom: 10px;">üìç ${data.address || 'No address'}</div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 13px;">
                    <div>
                        <div style="color: #666;">EJV 4.0:</div>
                        <div style="font-weight: 700; color: ${color}; font-size: 16px;">${(data.ejvV40 || 0).toFixed(1)}%</div>
                    </div>
                    <div>
                        <div style="color: #666;">EJV 4.1:</div>
                        <div style="font-weight: 700; color: ${color}; font-size: 16px;">${(data.ejvV41 || 0).toFixed(2)}</div>
                    </div>
                    <div>
                        <div style="color: #666;">Distance:</div>
                        <div style="font-weight: 600;">${(data.distance || 0).toFixed(1)} mi</div>
                    </div>
                </div>
                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e0e0e0; font-size: 12px;">
                    <div style="font-weight: 600; margin-bottom: 8px; color: #555;">EJV 4.1 Components (0-100):</div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px;">
                        <div><span style="color: #666;">LC:</span> <strong>${(data.lc || 0).toFixed(2)}</strong></div>
                        <div><span style="color: #666;">W:</span> <strong>${(data.w || 0).toFixed(2)}</strong></div>
                        <div><span style="color: #666;">DN:</span> <strong>${(data.dn || 0).toFixed(2)}</strong></div>
                        <div><span style="color: #666;">EQ:</span> <strong>${(data.eq || 0).toFixed(2)}</strong></div>
                        <div><span style="color: #666;">ENV:</span> <strong>${(data.env || 0).toFixed(2)}</strong></div>
                        <div><span style="color: #666;">PROC:</span> <strong>${(data.proc || 0).toFixed(2)}</strong></div>
                    </div>
                </div>
                ${ejvNote}
            `;
            console.log('‚úÖ Store details displayed successfully');
        }

        // Compare stores
        function compareStores() {
            if (!storeAData || !storeBData) {
                alert('Please select both stores to compare');
                return;
            }

            // Calculate differences
            const ejvV40Diff = storeAData.ejvV40 - storeBData.ejvV40;
            const ejvV40DiffPercent = storeBData.ejvV40 > 0 ? ((ejvV40Diff / storeBData.ejvV40) * 100) : 0;
            
            const ejvV41Diff = storeAData.ejvV41 - storeBData.ejvV41;
            const ejvV41DiffPercent = storeBData.ejvV41 > 0 ? ((ejvV41Diff / storeBData.ejvV41) * 100) : 0;
            
            const distanceDiff = storeAData.distance - storeBData.distance;
            
            const lcDiff = storeAData.lc - storeBData.lc;
            const wDiff = storeAData.w - storeBData.w;
            const dnDiff = storeAData.dn - storeBData.dn;
            const eqDiff = storeAData.eq - storeBData.eq;
            const envDiff = storeAData.env - storeBData.env;
            const procDiff = storeAData.proc - storeBData.proc;

            // Determine winner (using EJV v4.1 as primary metric)
            const winner = storeAData.ejvV41 >= storeBData.ejvV41 ? 'A' : 'B';
            const winnerData = winner === 'A' ? storeAData : storeBData;
            const loserData = winner === 'A' ? storeBData : storeAData;
            const percentDiff = Math.abs(ejvV41DiffPercent).toFixed(0);

            // Update winner banner
            document.getElementById('winnerName').textContent = winnerData.name;
            document.getElementById('winnerMessage').innerHTML = `generates ${percentDiff}% more justice weighted impact`;
            
            if (winner === 'A') {
                document.getElementById('winnerBanner').style.background = 'linear-gradient(135deg, #4caf50 0%, #66bb6a 100%)';
            } else {
                document.getElementById('winnerBanner').style.background = 'linear-gradient(135deg, #f44336 0%, #ef5350 100%)';
            }

            // Update comparison table
            const tableBody = document.getElementById('comparisonTableBody');
            tableBody.innerHTML = `
                <tr style="border-bottom: 1px solid #e0e0e0;">
                    <td style="padding: 15px; color: #555;">EJV 4.0 (5-Component Weighted)</td>
                    <td style="padding: 15px; text-align: center; font-weight: 700; color: #4caf50;">${storeAData.ejvV40.toFixed(1)}%</td>
                    <td style="padding: 15px; text-align: center; font-weight: 700; color: #f44336;">${storeBData.ejvV40.toFixed(1)}%</td>
                    <td style="padding: 15px; text-align: center; font-weight: 700; color: ${ejvV40Diff >= 0 ? '#4caf50' : '#f44336'};">
                        ${ejvV40Diff >= 0 ? '+' : ''}${ejvV40Diff.toFixed(1)}% (${ejvV40DiffPercent >= 0 ? '+' : ''}${ejvV40DiffPercent.toFixed(0)}%)
                    </td>
                </tr>
                <tr style="border-bottom: 1px solid #e0e0e0;">
                    <td style="padding: 15px; color: #555;">EJV 4.1 (6-Component Equal Weight)</td>
                    <td style="padding: 15px; text-align: center; font-weight: 700; color: #4caf50;">${storeAData.ejvV41.toFixed(2)}</td>
                    <td style="padding: 15px; text-align: center; font-weight: 700; color: #f44336;">${storeBData.ejvV41.toFixed(2)}</td>
                    <td style="padding: 15px; text-align: center; font-weight: 700; color: ${ejvV41Diff >= 0 ? '#4caf50' : '#f44336'};">
                        ${ejvV41Diff >= 0 ? '+' : ''}${ejvV41Diff.toFixed(2)} (${ejvV41DiffPercent >= 0 ? '+' : ''}${ejvV41DiffPercent.toFixed(0)}%)
                    </td>
                </tr>
                <tr style="border-bottom: 1px solid #e0e0e0;">
                    <td style="padding: 15px; color: #555;">Distance from You</td>
                    <td style="padding: 15px; text-align: center; font-weight: 700; color: #4caf50;">${storeAData.distance.toFixed(1)} mi</td>
                    <td style="padding: 15px; text-align: center; font-weight: 700; color: #f44336;">${storeBData.distance.toFixed(1)} mi</td>
                    <td style="padding: 15px; text-align: center; font-weight: 700; color: ${distanceDiff <= 0 ? '#4caf50' : '#f44336'};">
                        ${distanceDiff >= 0 ? '+' : ''}${distanceDiff.toFixed(1)} mi ${distanceDiff <= 0 ? '(Closer)' : '(Farther)'}
                    </td>
                </tr>
            `;

            // Update component scores
            document.getElementById('lcA').textContent = storeAData.lc.toFixed(2);
            document.getElementById('lcB').textContent = storeBData.lc.toFixed(2);
            
            document.getElementById('wA').textContent = storeAData.w.toFixed(2);
            document.getElementById('wB').textContent = storeBData.w.toFixed(2);
            
            document.getElementById('dnA').textContent = storeAData.dn.toFixed(2);
            document.getElementById('dnB').textContent = storeBData.dn.toFixed(2);
            
            document.getElementById('eqA').textContent = storeAData.eq.toFixed(2);
            document.getElementById('eqB').textContent = storeBData.eq.toFixed(2);
            
            document.getElementById('envA').textContent = storeAData.env.toFixed(2);
            document.getElementById('envB').textContent = storeBData.env.toFixed(2);
            
            document.getElementById('procA').textContent = storeAData.proc.toFixed(2);
            document.getElementById('procB').textContent = storeBData.proc.toFixed(2);

            // Generate recommendation
            const storeAName = storeAData?.name || 'Store A';
            const storeBName = storeBData?.name || 'Store B';
            const winnerName = winner === 'A' ? storeAName : storeBName;
            const loserName = winner === 'A' ? storeBName : storeAName;
            
            let recommendation = `<strong>${winnerName}</strong> is the better choice for economic justice impact. `;
            
            if (Math.abs(ejvV41DiffPercent) > 20) {
                recommendation += `With ${percentDiff}% higher EJV, this represents a <strong>significant difference</strong> in justice-weighted impact. `;
            } else if (Math.abs(ejvV41DiffPercent) > 10) {
                recommendation += `The ${percentDiff}% difference in EJV represents a <strong>meaningful improvement</strong> in justice-weighted impact. `;
            } else {
                recommendation += `Both stores have relatively similar EJV scores (${percentDiff}% difference). `;
            }

            if (winnerData.distance < loserData.distance) {
                recommendation += `Additionally, it's <strong>${Math.abs(distanceDiff).toFixed(1)} miles closer</strong>, keeping more economic value in your local community. `;
            } else if (winnerData.distance > loserData.distance) {
                recommendation += `However, note that it's <strong>${Math.abs(distanceDiff).toFixed(1)} miles farther</strong> from you. `;
            }

            // Component analysis
            const strongComponents = [];
            if (lcDiff > 10) strongComponents.push('local circulation');
            if (wDiff > 10) strongComponents.push('fair wages');
            if (dnDiff > 10) strongComponents.push('community need support');
            if (eqDiff > 10) strongComponents.push('equity & inclusion');
            if (envDiff > 10) strongComponents.push('environmental responsibility');
            if (procDiff > 10) strongComponents.push('local procurement');

            if (strongComponents.length > 0 && winner === 'A') {
                recommendation += `<br><br><strong>Key strengths:</strong> ${winnerName} excels particularly in ${strongComponents.join(', ')}.`;
            } else if (strongComponents.length > 0 && winner === 'B') {
                recommendation += `<br><br><strong>Key strengths:</strong> ${winnerName} excels particularly in ${strongComponents.join(', ')}.`;
            }

            document.getElementById('recommendationText').innerHTML = recommendation;

            // Increment compare count in user dashboard and show points earned
            let userData = JSON.parse(localStorage.getItem('fixAppUserData'));
            if (!userData) {
                // Create minimal user data if it doesn't exist
                userData = {
                    profile: { name: 'User', homeZip: '00000' },
                    purchases: [],
                    activity: { searchCount: 0, compareCount: 0, optimizationAdopted: 0, communityActions: 0 },
                    civicActions: [],
                    monthlyScores: {}
                };
            }
            
            const previousCompareCount = userData.activity.compareCount || 0;
            userData.activity.compareCount = previousCompareCount + 1;
            localStorage.setItem('fixAppUserData', JSON.stringify(userData));
            
            const pointsEarned = 2; // 2 points per comparison
            console.log('‚úÖ Comparison completed!', {
                compareCount: userData.activity.compareCount,
                pointsEarned: pointsEarned,
                winner: winnerData.name,
                ejvDifference: percentDiff + '%'
            });

            // Show success message with points
            const successMessage = document.createElement('div');
            successMessage.style.cssText = 'position: fixed; top: 20px; right: 20px; background: linear-gradient(135deg, #4caf50, #66bb6a); color: white; padding: 20px 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(76, 175, 80, 0.4); z-index: 10000; animation: slideIn 0.3s ease;';
            successMessage.innerHTML = `
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div style="font-size: 32px;">üéâ</div>
                    <div>
                        <div style="font-size: 16px; font-weight: 700; margin-bottom: 5px;">Comparison Complete!</div>
                        <div style="font-size: 14px; opacity: 0.95;">+${pointsEarned} points added to your COMPARE score</div>
                        <div style="font-size: 12px; opacity: 0.9; margin-top: 3px;">Total comparisons: ${userData.activity.compareCount}</div>
                    </div>
                </div>
            `;
            document.body.appendChild(successMessage);
            
            // Remove message after 4 seconds
            setTimeout(() => {
                successMessage.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => successMessage.remove(), 300);
            }, 4000);

            // Show results, hide empty state
            document.getElementById('comparisonResults').style.display = 'block';
            document.getElementById('compareEmptyState').style.display = 'none';

            // Scroll to results
            setTimeout(() => {
                document.getElementById('comparisonResults').scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 100);
        }

        // ============================================
        // OPTIMIZE MODULE FUNCTIONS
        // ============================================

        // Initialize Optimize Module
        function initOptimizeModule() {
            console.log('üîÑ Initializing Optimize Module...');
            const userData = JSON.parse(localStorage.getItem('fixAppUserData'));
            
            console.log('Optimize module data check:', {
                hasUserData: !!userData,
                purchaseCount: userData?.purchases?.length || 0
            });
            
            if (!userData || !userData.purchases || userData.purchases.length === 0) {
                // Show empty state
                document.getElementById('optimizeEmptyState').style.display = 'block';
                console.log('‚ö†Ô∏è No purchase data available for optimization tracking');
                return;
            }

            document.getElementById('optimizeEmptyState').style.display = 'none';
            console.log('‚úì Calculating optimization metrics...');
            calculateOptimizationMetrics(userData);
            console.log('‚úì Optimize Module initialized');
        }

        // Calculate optimization metrics
        function calculateOptimizationMetrics(userData) {
            const now = new Date();
            const currentMonth = now.toISOString().substring(0, 7); // YYYY-MM
            const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1).toISOString().substring(0, 7);

            console.log('Calculating optimization for months:', { currentMonth, lastMonth });

            // Filter purchases by month
            const currentMonthPurchases = userData.purchases.filter(p => p.date.startsWith(currentMonth));
            const lastMonthPurchases = userData.purchases.filter(p => p.date.startsWith(lastMonth));

            console.log('Purchase counts:', {
                currentMonth: currentMonthPurchases.length,
                lastMonth: lastMonthPurchases.length,
                totalPurchases: userData.purchases.length
            });

            // Calculate current month metrics
            const currentAvgEJV = currentMonthPurchases.length > 0 
                ? currentMonthPurchases.reduce((sum, p) => sum + (p.ejvScore || 0), 0) / currentMonthPurchases.length 
                : 0;
            
            const currentAvgDistance = currentMonthPurchases.length > 0
                ? currentMonthPurchases.reduce((sum, p) => sum + (p.distance || 0), 0) / currentMonthPurchases.length
                : 0;

            const currentSpending = currentMonthPurchases.reduce((sum, p) => sum + p.amount, 0);
            const currentBudgetEfficiency = currentSpending > 0 ? currentAvgEJV / (currentSpending / 100) : 0;

            // Calculate last month metrics
            const lastAvgEJV = lastMonthPurchases.length > 0
                ? lastMonthPurchases.reduce((sum, p) => sum + (p.ejvScore || 0), 0) / lastMonthPurchases.length
                : 0;

            const lastAvgDistance = lastMonthPurchases.length > 0
                ? lastMonthPurchases.reduce((sum, p) => sum + (p.distance || 0), 0) / lastMonthPurchases.length
                : 0;

            const lastSpending = lastMonthPurchases.reduce((sum, p) => sum + p.amount, 0);
            const lastBudgetEfficiency = lastSpending > 0 ? lastAvgEJV / (lastSpending / 100) : 0;

            // Calculate improvement percentage
            const ejvChange = lastAvgEJV > 0 ? ((currentAvgEJV - lastAvgEJV) / lastAvgEJV) * 100 : 0;
            const distanceChange = lastAvgDistance > 0 ? ((lastAvgDistance - currentAvgDistance) / lastAvgDistance) * 100 : 0;
            const budgetChange = lastBudgetEfficiency > 0 ? ((currentBudgetEfficiency - lastBudgetEfficiency) / lastBudgetEfficiency) * 100 : 0;

            console.log('Optimization metrics:', {
                currentAvgEJV,
                lastAvgEJV,
                ejvChange,
                currentAvgDistance,
                lastAvgDistance,
                distanceChange
            });

            // Update main efficiency card
            // Only show percentage if we have actual data to compare
            if (currentMonthPurchases.length === 0 && lastMonthPurchases.length === 0) {
                // No purchases at all
                document.getElementById('efficiencyChange').textContent = '-';
                document.getElementById('efficiencyTrendIcon').textContent = 'üìä';
                document.getElementById('efficiencyMessage').textContent = 
                    'Start logging purchases to track your improvement!';
            } else if (lastMonthPurchases.length === 0) {
                // Has current month but no last month to compare
                document.getElementById('efficiencyChange').textContent = '-';
                document.getElementById('efficiencyTrendIcon').textContent = 'üéØ';
                document.getElementById('efficiencyMessage').textContent = 
                    'Keep logging! Next month you\'ll see your improvement trend.';
            } else {
                // Has both months - show actual comparison
                document.getElementById('efficiencyChange').textContent = 
                    (ejvChange >= 0 ? '+' : '') + ejvChange.toFixed(1) + '%';
                
                if (ejvChange >= 8) {
                    document.getElementById('efficiencyTrendIcon').textContent = 'üöÄ';
                    document.getElementById('efficiencyMessage').textContent = 
                        `Outstanding! Small shifts increased your impact efficiency by ${ejvChange.toFixed(0)}% this month.`;
                } else if (ejvChange >= 3) {
                    document.getElementById('efficiencyTrendIcon').textContent = 'üìà';
                    document.getElementById('efficiencyMessage').textContent = 
                        `Great work! Your impact efficiency improved by ${ejvChange.toFixed(0)}% this month.`;
                } else if (ejvChange > 0) {
                    document.getElementById('efficiencyTrendIcon').textContent = '‚úì';
                    document.getElementById('efficiencyMessage').textContent = 
                        `You're making progress! Impact efficiency up ${ejvChange.toFixed(1)}% this month.`;
                } else if (ejvChange === 0) {
                    document.getElementById('efficiencyTrendIcon').textContent = '‚û°Ô∏è';
                    document.getElementById('efficiencyMessage').textContent = 
                        'Your impact efficiency is steady. Try exploring higher-EJV stores.';
                } else {
                    document.getElementById('efficiencyTrendIcon').textContent = 'üìâ';
                    document.getElementById('efficiencyMessage').textContent = 
                        `Impact efficiency decreased ${Math.abs(ejvChange).toFixed(1)}%. Let's find better options!`;
                }
            }

            document.getElementById('currentAvgEJV').textContent = currentAvgEJV.toFixed(1);
            document.getElementById('previousAvgEJV').textContent = lastAvgEJV > 0 ? lastAvgEJV.toFixed(1) : 'N/A';
            document.getElementById('currentMonthPurchases').textContent = currentMonthPurchases.length;

            // Update distance metric
            if (currentMonthPurchases.length > 0) {
                document.getElementById('distanceChange').textContent = 
                    distanceChange >= 0 ? `-${distanceChange.toFixed(1)}%` : `+${Math.abs(distanceChange).toFixed(1)}%`;
                document.getElementById('distanceMessage').textContent = 
                    `Avg: ${currentAvgDistance.toFixed(1)} mi (was ${lastAvgDistance.toFixed(1)} mi)`;
                document.getElementById('distanceChange').style.color = distanceChange >= 0 ? '#4caf50' : '#f44336';
            } else {
                document.getElementById('distanceChange').textContent = '-';
                document.getElementById('distanceMessage').textContent = 'No purchases this month';
            }

            // Update budget efficiency
            if (currentSpending > 0) {
                document.getElementById('budgetEfficiency').textContent = currentBudgetEfficiency.toFixed(2);
                document.getElementById('budgetMessage').textContent = 
                    `${currentBudgetEfficiency.toFixed(2)} EJV per $100 spent`;
            } else {
                document.getElementById('budgetEfficiency').textContent = '-';
                document.getElementById('budgetMessage').textContent = 'No spending this month';
            }

            // Update access score (unique stores)
            const uniqueStoresThisMonth = new Set(currentMonthPurchases.map(p => p.storeName)).size;
            const uniqueStoresLastMonth = new Set(lastMonthPurchases.map(p => p.storeName)).size;
            document.getElementById('accessScore').textContent = uniqueStoresThisMonth;
            document.getElementById('accessMessage').textContent = 
                lastMonthPurchases.length > 0 
                    ? `${uniqueStoresThisMonth} stores (was ${uniqueStoresLastMonth} last month)`
                    : `${uniqueStoresThisMonth} unique stores visited`;

            // Update chart
            updateOptimizeChart(userData);

            // Generate opportunities
            generateOptimizationOpportunities(userData, currentMonthPurchases, lastMonthPurchases);

            // Generate monthly breakdown
            generateMonthlyBreakdown(userData, currentMonthPurchases, lastMonthPurchases);
        }

        // Update optimization chart
        function updateOptimizeChart(userData) {
            const chartContainer = document.getElementById('optimizeChart');
            
            // Get last 6 months of data
            const months = [];
            const avgEJVs = [];
            const now = new Date();
            
            for (let i = 5; i >= 0; i--) {
                const month = new Date(now.getFullYear(), now.getMonth() - i, 1);
                const monthKey = month.toISOString().substring(0, 7);
                months.push(month.toLocaleDateString('en-US', { month: 'short' }));
                
                // Calculate avg EJV for this month
                const monthPurchases = userData.purchases.filter(p => p.date.startsWith(monthKey));
                const avgEJV = monthPurchases.length > 0
                    ? monthPurchases.reduce((sum, p) => sum + (p.ejvScore || 0), 0) / monthPurchases.length
                    : 0;
                avgEJVs.push(avgEJV);
            }

            // Update month labels
            for (let i = 0; i < 6; i++) {
                document.getElementById(`optChartMonth${i + 1}`).textContent = months[i];
            }

            // Generate chart bars
            if (avgEJVs.some(v => v > 0)) {
                const maxEJV = Math.max(...avgEJVs, 1);
                chartContainer.innerHTML = avgEJVs.map((ejv, idx) => {
                    const height = (ejv / 100) * 100; // Percentage height
                    const color = idx > 0 && ejv > avgEJVs[idx - 1] ? '#4caf50' : idx > 0 && ejv < avgEJVs[idx - 1] ? '#f44336' : '#ff9800';
                    return `
                        <div style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: flex-end;">
                            <div style="font-size: 11px; font-weight: 600; color: ${color}; margin-bottom: 4px;">${ejv.toFixed(0)}</div>
                            <div style="width: 100%; background: linear-gradient(180deg, ${color} 0%, ${color}aa 100%); border-radius: 4px 4px 0 0; height: ${height}%; min-height: ${ejv > 0 ? '5px' : '0'}; transition: height 0.5s ease;"></div>
                        </div>
                    `;
                }).join('');
            }
        }

        // Generate optimization opportunities
        function generateOptimizationOpportunities(userData, currentMonth, lastMonth) {
            const container = document.getElementById('optimizationOpportunities');
            
            if (currentMonth.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #999;">
                        <div style="font-size: 48px; margin-bottom: 10px;">üîç</div>
                        <div style="font-size: 14px;">Make more purchases to discover optimization opportunities</div>
                    </div>
                `;
                return;
            }

            const opportunities = [];

            // Check if user is shopping at low-EJV stores repeatedly
            const lowEJVStores = currentMonth.filter(p => p.ejvScore && p.ejvScore < 60);
            if (lowEJVStores.length > 0) {
                const avgLowEJV = lowEJVStores.reduce((sum, p) => sum + p.ejvScore, 0) / lowEJVStores.length;
                opportunities.push({
                    type: 'warning',
                    title: 'Low-Impact Stores Detected',
                    message: `You shopped at ${lowEJVStores.length} store(s) with EJV below 60 (avg: ${avgLowEJV.toFixed(1)}). Consider exploring higher-impact alternatives.`,
                    action: 'Search for alternatives in Locator',
                    icon: '‚ö†Ô∏è'
                });
            }

            // Check if user is traveling far
            const farStores = currentMonth.filter(p => p.distance && p.distance > 10);
            if (farStores.length > 0) {
                const avgDistance = farStores.reduce((sum, p) => sum + p.distance, 0) / farStores.length;
                opportunities.push({
                    type: 'info',
                    title: 'Distance Optimization Available',
                    message: `${farStores.length} purchase(s) were from stores averaging ${avgDistance.toFixed(1)} miles away. Shopping locally keeps more money in your community.`,
                    action: 'Find closer alternatives',
                    icon: 'üìç'
                });
            }

            // Check for category diversification
            const categories = new Set(currentMonth.filter(p => p.category).map(p => p.category));
            if (categories.size < 3 && currentMonth.length > 5) {
                opportunities.push({
                    type: 'success',
                    title: 'Expand Your Impact',
                    message: `You're shopping in ${categories.size} categor${categories.size === 1 ? 'y' : 'ies'}. Diversifying across more local businesses amplifies community impact.`,
                    action: 'Explore more categories',
                    icon: 'üéØ'
                });
            }

            // Check for improvement trend
            if (lastMonth.length > 0) {
                const currentAvgEJV = currentMonth.reduce((sum, p) => sum + (p.ejvScore || 0), 0) / currentMonth.length;
                const lastAvgEJV = lastMonth.reduce((sum, p) => sum + (p.ejvScore || 0), 0) / lastMonth.length;
                
                if (currentAvgEJV > lastAvgEJV + 5) {
                    opportunities.push({
                        type: 'success',
                        title: 'Great Progress!',
                        message: `Your choices improved by ${((currentAvgEJV - lastAvgEJV) / lastAvgEJV * 100).toFixed(1)}% this month. Keep up the momentum!`,
                        action: 'View comparison',
                        icon: 'üéâ'
                    });
                }
            }

            if (opportunities.length === 0) {
                opportunities.push({
                    type: 'success',
                    title: 'You\'re Optimized!',
                    message: 'Your current shopping patterns show strong economic justice impact. Keep it up!',
                    action: null,
                    icon: '‚ú®'
                });
            }

            container.innerHTML = opportunities.map(opp => {
                const colors = {
                    warning: { bg: '#fff3e0', border: '#ff9800', text: '#e65100' },
                    info: { bg: '#e3f2fd', border: '#2196f3', text: '#1565c0' },
                    success: { bg: '#e8f5e9', border: '#4caf50', text: '#2e7d32' }
                };
                const color = colors[opp.type];
                
                return `
                    <div style="padding: 20px; margin-bottom: 15px; background: ${color.bg}; border-left: 4px solid ${color.border}; border-radius: 8px;">
                        <div style="display: flex; align-items: flex-start; gap: 15px;">
                            <div style="font-size: 32px; flex-shrink: 0;">${opp.icon}</div>
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: ${color.text}; font-size: 16px; margin-bottom: 8px;">${opp.title}</div>
                                <div style="color: #555; font-size: 14px; line-height: 1.6; margin-bottom: ${opp.action ? '12px' : '0'};">${opp.message}</div>
                                ${opp.action ? `
                                    <button onclick="showModule('locator')" style="padding: 8px 16px; background: ${color.border}; color: white; border: none; border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer;">
                                        ${opp.action} ‚Üí
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Generate monthly breakdown
        function generateMonthlyBreakdown(userData, currentMonth, lastMonth) {
            const container = document.getElementById('monthlyBreakdown');
            
            if (currentMonth.length === 0 && lastMonth.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #999;">
                        <div style="font-size: 14px;">Log purchases to see detailed monthly analysis</div>
                    </div>
                `;
                return;
            }

            const now = new Date();
            const currentMonthName = now.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            const lastMonthName = new Date(now.getFullYear(), now.getMonth() - 1, 1)
                .toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

            const currentAvgEJV = currentMonth.length > 0
                ? currentMonth.reduce((sum, p) => sum + (p.ejvScore || 0), 0) / currentMonth.length
                : 0;
            const lastAvgEJV = lastMonth.length > 0
                ? lastMonth.reduce((sum, p) => sum + (p.ejvScore || 0), 0) / lastMonth.length
                : 0;

            const currentTotalSpent = currentMonth.reduce((sum, p) => sum + p.amount, 0);
            const lastTotalSpent = lastMonth.reduce((sum, p) => sum + p.amount, 0);

            container.innerHTML = `
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: #f5f7fa; border-bottom: 2px solid #e0e0e0;">
                            <th style="padding: 12px; text-align: left; font-weight: 600; color: #666;">Metric</th>
                            <th style="padding: 12px; text-align: center; font-weight: 600; color: #ff9800;">${currentMonthName}</th>
                            <th style="padding: 12px; text-align: center; font-weight: 600; color: #999;">${lastMonthName}</th>
                            <th style="padding: 12px; text-align: center; font-weight: 600; color: #666;">Change</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr style="border-bottom: 1px solid #e0e0e0;">
                            <td style="padding: 12px; color: #555;">Total Purchases</td>
                            <td style="padding: 12px; text-align: center; font-weight: 600;">${currentMonth.length}</td>
                            <td style="padding: 12px; text-align: center; font-weight: 600;">${lastMonth.length}</td>
                            <td style="padding: 12px; text-align: center; font-weight: 600; color: ${currentMonth.length >= lastMonth.length ? '#4caf50' : '#f44336'};">
                                ${currentMonth.length - lastMonth.length >= 0 ? '+' : ''}${currentMonth.length - lastMonth.length}
                            </td>
                        </tr>
                        <tr style="border-bottom: 1px solid #e0e0e0;">
                            <td style="padding: 12px; color: #555;">Average EJV</td>
                            <td style="padding: 12px; text-align: center; font-weight: 600;">${currentAvgEJV.toFixed(1)}</td>
                            <td style="padding: 12px; text-align: center; font-weight: 600;">${lastAvgEJV > 0 ? lastAvgEJV.toFixed(1) : 'N/A'}</td>
                            <td style="padding: 12px; text-align: center; font-weight: 600; color: ${currentAvgEJV >= lastAvgEJV ? '#4caf50' : '#f44336'};">
                                ${lastAvgEJV > 0 ? (currentAvgEJV - lastAvgEJV >= 0 ? '+' : '') + (currentAvgEJV - lastAvgEJV).toFixed(1) : '-'}
                            </td>
                        </tr>
                        <tr style="border-bottom: 1px solid #e0e0e0;">
                            <td style="padding: 12px; color: #555;">Total Spent</td>
                            <td style="padding: 12px; text-align: center; font-weight: 600;">$${currentTotalSpent.toFixed(2)}</td>
                            <td style="padding: 12px; text-align: center; font-weight: 600;">$${lastTotalSpent.toFixed(2)}</td>
                            <td style="padding: 12px; text-align: center; font-weight: 600; color: #666;">
                                ${currentTotalSpent - lastTotalSpent >= 0 ? '+' : ''}$${(currentTotalSpent - lastTotalSpent).toFixed(2)}
                            </td>
                        </tr>
                    </tbody>
                </table>
            `;
        }

        // ========== ENGAGE MODULE ==========
        
        function initEngageModule() {
            console.log('üîÑ Initializing Engage Module...');
            const userData = JSON.parse(localStorage.getItem('fixAppUserData'));
            
            if (!userData) {
                console.log('‚ö†Ô∏è No user data found, showing zero state');
                // No user data, show basic state
                document.getElementById('totalEngageScore').textContent = '0';
                document.getElementById('ejv41Score').textContent = '0';
                document.getElementById('ejv42Score').textContent = '0';
                document.getElementById('avgEJVDisplay').textContent = '0';
                document.getElementById('totalPurchasesCount').textContent = '0';
                const participationElement = document.getElementById('participationScore');
                if (participationElement) {
                    participationElement.textContent = '0';
                }
                document.getElementById('totalActionsCount').textContent = '0';
                return;
            }

            console.log('Engage module data check:', {
                purchaseCount: userData?.purchases?.length || 0,
                civicActionCount: userData?.civicActions?.length || 0
            });
            
            console.log('‚úì Calculating engage metrics...');
            calculateEngageMetrics(userData);
            displayCivicActions(userData);
            console.log('‚úì Engage Module initialized');
        }

        // Calculate ENGAGE metrics
        function calculateEngageMetrics(userData) {
            // EJV v4.1: Economic behavior (average EJV from purchases)
            const purchases = userData.purchases || [];
            const ejv41 = purchases.length > 0
                ? purchases.reduce((sum, p) => sum + (p.ejvScore || 0), 0) / purchases.length
                : 0;

            // EJV v4.2: Civic participation (from civic actions)
            const civicActions = userData.civicActions || [];
            const ejv42 = civicActions.reduce((sum, a) => sum + (a.points || 0), 0);

            // Total ENGAGE score
            const totalEngage = ejv41 + ejv42;

            console.log('Engage metrics calculated:', {
                purchases: purchases.length,
                ejv41: ejv41.toFixed(1),
                civicActions: civicActions.length,
                ejv42,
                totalEngage: totalEngage.toFixed(1)
            });

            // Update main score card
            document.getElementById('totalEngageScore').textContent = Math.round(totalEngage);
            document.getElementById('ejv41Score').textContent = Math.round(ejv41);
            document.getElementById('ejv42Score').textContent = Math.round(ejv42);

            // Update message
            if (totalEngage >= 150) {
                document.getElementById('engageScoreMessage').textContent = 
                    'üåü Outstanding! You\'re a community economic justice leader!';
            } else if (totalEngage >= 100) {
                document.getElementById('engageScoreMessage').textContent = 
                    '‚ú® Excellent engagement! Your impact is growing strong.';
            } else if (totalEngage >= 50) {
                document.getElementById('engageScoreMessage').textContent = 
                    'üëç Good progress! Keep building your total justice impact.';
            } else if (totalEngage > 0) {
                document.getElementById('engageScoreMessage').textContent = 
                    'üå± You\'re starting to build meaningful impact!';
            } else {
                document.getElementById('engageScoreMessage').textContent = 
                    'Start logging purchases and civic actions to build your ENGAGE score';
            }

            // Update economic behavior section
            document.getElementById('avgEJVDisplay').textContent = Math.round(ejv41);
            document.getElementById('totalPurchasesCount').textContent = purchases.length;

            if (purchases.length > 0) {
                const recentPurchases = purchases.slice(-3);
                const recentAvgEJV = recentPurchases.reduce((sum, p) => sum + (p.ejvScore || 0), 0) / recentPurchases.length;
                document.getElementById('recentPurchaseImpact').innerHTML = `
                    <div style="margin-bottom: 8px;">Last 3 purchases avg: <strong>${recentAvgEJV.toFixed(1)}</strong></div>
                    <div style="font-size: 11px; color: #666;">
                        ${recentPurchases.map(p => `‚Ä¢ ${p.storeName} (${p.ejvScore?.toFixed(1) || 'N/A'})`).join('<br>')}
                    </div>
                `;
            } else {
                document.getElementById('recentPurchaseImpact').textContent = 'Log purchases to see impact details';
            }

            // Update participation section
            const participationElement = document.getElementById('participationScore');
            if (participationElement) {
                participationElement.textContent = Math.round(ejv42);
            }
            document.getElementById('totalActionsCount').textContent = civicActions.length;
            
            // Also update dashboard participation score if it exists
            const dashboardParticipation = document.getElementById('dashboardParticipationScore');
            if (dashboardParticipation) {
                dashboardParticipation.textContent = Math.round(ejv42);
            }

            if (civicActions.length > 0) {
                const recentActions = civicActions.slice(-3);
                document.getElementById('actionsList').innerHTML = recentActions.map(a => `
                    <div style="padding: 8px; margin-bottom: 6px; background: white; border-radius: 6px; border-left: 3px solid #9c27b0;">
                        <div style="font-size: 12px; font-weight: 600; color: #333; margin-bottom: 3px;">${getActionEmoji(a.type)} ${a.type}</div>
                        <div style="font-size: 11px; color: #666;">+${a.points} points ‚Ä¢ ${new Date(a.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</div>
                    </div>
                `).join('');
            } else {
                document.getElementById('actionsList').innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #999; font-size: 12px;">
                        No civic actions logged yet.<br>Click below to add one!
                    </div>
                `;
            }
        }

        // Display civic actions history
        function displayCivicActions(userData) {
            const container = document.getElementById('civicActionsHistory');
            const civicActions = userData.civicActions || [];

            if (civicActions.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #999;">
                        <div style="font-size: 48px; margin-bottom: 10px;">ü§ù</div>
                        <div style="font-size: 14px;">Start logging civic actions to amplify your impact!</div>
                    </div>
                `;
                return;
            }

            // Sort by date (most recent first)
            const sortedActions = [...civicActions].sort((a, b) => new Date(b.date) - new Date(a.date));

            container.innerHTML = sortedActions.map(action => {
                return `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid #e0e0e0;">
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: #333; margin-bottom: 4px; display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 20px;">${getActionEmoji(action.type)}</span>
                                <span>${action.type}</span>
                            </div>
                            <div style="font-size: 13px; color: #666; margin-bottom: 4px;">${action.description || 'No description'}</div>
                            <div style="font-size: 12px; color: #999;">
                                ${new Date(action.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div style="background: #e91e63; color: white; padding: 8px 16px; border-radius: 20px; font-size: 14px; font-weight: 700;">
                                +${action.points} pts
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Get emoji for action type
        function getActionEmoji(type) {
            const emojis = {
                'share': 'üì¢',
                'organize': 'ü§ù',
                'advocate': 'üì£',
                'educate': 'üìö',
                'support': 'üí™',
                'volunteer': 'üôã',
                'other': '‚ú®'
            };
            return emojis[type] || '‚ú®';
        }

        // Open civic action modal
        function logCivicAction() {
            document.getElementById('civicActionModal').style.display = 'flex';
            document.getElementById('actionDate').valueAsDate = new Date();
            document.getElementById('actionType').value = '';
            document.getElementById('actionDescription').value = '';
            document.getElementById('actionPoints').value = '5';
        }

        // Close civic action modal
        function closeCivicActionModal() {
            document.getElementById('civicActionModal').style.display = 'none';
        }

        // Save civic action
        function saveCivicAction() {
            const type = document.getElementById('actionType').value;
            const description = document.getElementById('actionDescription').value.trim();
            const date = document.getElementById('actionDate').value;
            const points = parseInt(document.getElementById('actionPoints').value) || 5;

            if (!type) {
                alert('Please select an action type');
                return;
            }
            if (!date) {
                alert('Please select a date');
                return;
            }

            let userData = JSON.parse(localStorage.getItem('fixAppUserData'));
            
            // If no user data, create minimal structure
            if (!userData) {
                userData = {
                    profile: { name: 'User', homeZip: '00000' },
                    purchases: [],
                    activity: { searchCount: 0, compareCount: 0, optimizationAdopted: 0, communityActions: 0 },
                    civicActions: []
                };
            }

            // Initialize civicActions array if it doesn't exist
            if (!userData.civicActions) {
                userData.civicActions = [];
            }

            // Create civic action object
            const civicAction = {
                id: Date.now(),
                type: type,
                description: description,
                date: date,
                points: points,
                timestamp: new Date().toISOString()
            };

            // Add civic action
            userData.civicActions.push(civicAction);

            // Update community actions count for User Dashboard
            userData.activity.communityActions = (userData.activity.communityActions || 0) + 1;

            // Save to localStorage
            localStorage.setItem('fixAppUserData', JSON.stringify(userData));

            // Close modal and reload
            closeCivicActionModal();
            initEngageModule();

            alert('Civic action logged successfully! üéâ Your ENGAGE score has increased!');
        }

        // Close civic action modal when clicking outside
        window.addEventListener('click', function(event) {
            const modal = document.getElementById('civicActionModal');
            if (event.target === modal) {
                closeCivicActionModal();
            }
        });
        
        // ==========================================
        // AI ASSISTANT FUNCTIONS
        // ==========================================
        
        // Toggle AI Assistant visibility
        function toggleAIAssistant() {
            const content = document.getElementById('aiAssistantContent');
            const toggleBtn = document.getElementById('toggleAssistant');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                toggleBtn.textContent = 'Minimize';
            } else {
                content.style.display = 'none';
                toggleBtn.textContent = 'Show';
            }
        }
        
        // Send AI message
        async function sendAIMessage() {
            const input = document.getElementById('aiUserInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Clear input
            input.value = '';
            
            // Add user message to chat
            addMessageToChat('user', message);
            
            // Show loading
            showAIStatus('Thinking...');
            
            try {
                // Get current store context
                const context = getCurrentStoreContext();
                
                // Get selected AI provider
                const provider = document.getElementById('aiProvider').value;
                
                // Call AI API with timeout
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 second timeout for AI chat
                
                let response;
                try {
                    response = await fetch('/api/ai/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            message: message,
                            context: context,
                            provider: provider
                        }),
                        signal: controller.signal
                    });
                    clearTimeout(timeoutId);
                } catch (fetchErr) {
                    clearTimeout(timeoutId);
                    let errorMsg = 'AI request failed: ' + fetchErr.message;
                    if (fetchErr.name === 'AbortError') {
                        errorMsg = 'AI request timed out after 30 seconds. Please try again.';
                    }
                    addMessageToChat('error', errorMsg);
                    return;
                }
                
                let data;
                try {
                    data = await response.json();
                } catch (parseErr) {
                    addMessageToChat('error', 'Failed to parse AI response');
                    return;
                }
                
                if (!response.ok) {
                    // Show the actual error from the API
                    const errorMsg = data.error || 'AI service unavailable';
                    addMessageToChat('error', errorMsg);
                    return;
                }
                
                // Check if there's an error in the response
                if (data.error) {
                    addMessageToChat('error', data.error);
                    return;
                }
                
                // Add AI response to chat
                addMessageToChat('ai', data.response);
                
            } catch (error) {
                console.error('AI error:', error);
                addMessageToChat('error', `Connection error: ${error.message}. Make sure the server is running and API keys are configured.`);
            } finally {
                hideAIStatus();
            }
        }
        
        // Quick ask AI function
        function askAI(question) {
            document.getElementById('aiUserInput').value = question;
            sendAIMessage();
        }
        
        // Add message to chat
        function addMessageToChat(type, message) {
            const chatMessages = document.getElementById('aiChatMessages');
            
            // Remove welcome message if it exists
            if (chatMessages.querySelector('.welcome-message')) {
                chatMessages.innerHTML = '';
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.style.cssText = `
                margin-bottom: 10px;
                padding: 8px 12px;
                border-radius: 10px;
                line-height: 1.5;
                font-size: 12px;
            `;
            
            if (type === 'user') {
                messageDiv.style.cssText += `
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                    margin-left: 20px;
                    text-align: right;
                `;
                messageDiv.innerHTML = `<strong>You:</strong> ${message}`;
            } else if (type === 'ai') {
                messageDiv.style.cssText += `
                    background: #f0f0f0;
                    color: #333;
                    margin-right: 20px;
                `;
                messageDiv.innerHTML = `<strong>ü§ñ AI:</strong> ${message}`;
            } else if (type === 'error') {
                messageDiv.style.cssText += `
                    background: #ffebee;
                    color: #c62828;
                    border-left: 3px solid #c62828;
                `;
                messageDiv.innerHTML = `<strong>‚ö†Ô∏è Error:</strong> ${message}`;
            }
            
            chatMessages.appendChild(messageDiv);
            
            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // Show AI status
        function showAIStatus(text) {
            const status = document.getElementById('aiStatus');
            const statusText = document.getElementById('aiStatusText');
            statusText.textContent = text;
            status.style.display = 'block';
        }
        
        // Hide AI status
        function hideAIStatus() {
            const status = document.getElementById('aiStatus');
            status.style.display = 'none';
        }
        
        // Get current store context for AI
        function getCurrentStoreContext() {
            const context = {
                stores: []
            };
            
            // Get currently selected store info
            const storeNameDisplay = document.getElementById('storeNameDisplay');
            const storeLocationDisplay = document.getElementById('storeLocationDisplay');
            const ejv40Display = document.getElementById('ejvV2Display');
            const ejv41Display = document.getElementById('ejvV41Display');
            
            if (storeNameDisplay && storeNameDisplay.textContent !== 'Hover over a store to see details') {
                context.storeName = storeNameDisplay.textContent;
                context.location = storeLocationDisplay ? storeLocationDisplay.textContent : '';
                context.ejv40 = ejv40Display ? ejv40Display.textContent : 'N/A';
                context.ejv41 = ejv41Display ? ejv41Display.textContent : 'N/A';
            }
            
            // Get all visible stores from markers if available
            if (typeof window.markers !== 'undefined' && window.markers && window.markers.length > 0) {
                context.stores = window.markers.map(marker => {
                    const store = marker.storeData || {};
                    return {
                        name: store.name || 'Unknown',
                        ejv40: store.ejv_v2 || 'N/A',
                        ejv41: store.ejv_v41 || 'N/A',
                        localCirculation: store.community || 'N/A',
                        wealthRetention: store.wealth_retained || 'N/A'
                    };
                });
            }
            
            return context;
        }
        
        // Check AI Assistant status on page load
        async function checkAIStatus() {
            try {
                const response = await fetch('/api/ai/status');
                const data = await response.json();
                
                if (!data.openai_available && !data.claude_available) {
                    const chatMessages = document.getElementById('aiChatMessages');
                    const isProduction = window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1';
                    
                    chatMessages.innerHTML = `
                        <div style="color: #c62828; padding: 15px; text-align: center; line-height: 1.6;">
                            <strong>‚ö†Ô∏è No AI Provider Available</strong><br>
                            <span style="font-size: 11px;">
                                ${isProduction 
                                    ? 'API keys need to be configured in Vercel Dashboard ‚Üí Settings ‚Üí Environment Variables' 
                                    : 'Please configure API keys in the .env file'}
                            </span>
                        </div>
                    `;
                } else {
                    // Show which providers are available
                    const availableProviders = [];
                    if (data.openai_available) availableProviders.push('ChatGPT');
                    if (data.claude_available) availableProviders.push('Claude');
                    
                    if (availableProviders.length < 2) {
                        const chatMessages = document.getElementById('aiChatMessages');
                        chatMessages.innerHTML = `
                            <div style="color: #ff9800; padding: 15px; text-align: center; line-height: 1.6;">
                                <strong>‚ö†Ô∏è Partial AI Availability</strong><br>
                                <span style="font-size: 11px;">
                                    Available: ${availableProviders.join(', ')}<br>
                                    ${!data.openai_available ? 'OpenAI API key missing. ' : ''}
                                    ${!data.claude_available ? 'Claude API key missing.' : ''}
                                </span>
                            </div>
                        `;
                    }
                }
            } catch (error) {
                console.error('Could not check AI status:', error);
                const chatMessages = document.getElementById('aiChatMessages');
                if (chatMessages) {
                    chatMessages.innerHTML = `
                        <div style="color: #c62828; padding: 15px; text-align: center; line-height: 1.6;">
                            <strong>‚ö†Ô∏è Cannot Connect to AI Service</strong><br>
                            <span style="font-size: 11px;">Server may be offline or AI endpoints not configured</span>
                        </div>
                    `;
                }
            }
        }
        
        // Initialize AI Assistant
        if (document.getElementById('aiAssistantPanel')) {
            checkAIStatus();
        }
        
        // Make AI functions globally accessible
        window.toggleAIAssistant = toggleAIAssistant;
        window.sendAIMessage = sendAIMessage;
        window.askAI = askAI;
        
        // ==========================================
        // END AI ASSISTANT FUNCTIONS
        // ==========================================
        
        // Reassign all functions to window to ensure they're globally accessible
        console.log('About to reassign functions...');
        console.log('searchByZip function:', typeof searchByZip);
        window.searchByZip = searchByZip;
        window.findAddress = findAddress;
        window.openGoogleMapsSearch = openGoogleMapsSearch;
        window.initUserDashboard = initUserDashboard;
        window.initCompareModule = initCompareModule;
        window.initOptimizeModule = initOptimizeModule;
        window.initEngageModule = initEngageModule;
        window.initMap = initMap;
        
        console.log('All functions registered - window.searchByZip:', typeof window.searchByZip);
        console.log('findAddress:', typeof window.findAddress);
        console.log('openGoogleMapsSearch:', typeof window.openGoogleMapsSearch);
    </script>

    <!-- Help Modal -->
    <div id="helpModal" class="help-modal">
        <div class="help-modal-content">
            <div class="help-modal-header">
                <span class="help-close" onclick="closeHelpModal()">&times;</span>
                <h2 id="helpModalTitle">EJV Help</h2>
                <p id="helpModalSubtitle"></p>
            </div>
            <div class="help-section">
                    <p id="helpModalDescription"></p>
                </div>
                
                <div class="help-insight" id="helpKeyInsight"></div>
                
                <div class="help-section">
                    <h3>üìê Formula</h3>
                    <div class="help-formula">
                        <div id="helpFormula"></div>
                        <p id="helpFormulaExplanation"></p>
                    </div>
                </div>
                
                <div class="help-section">
                    <h3>üî¢ Components</h3>
                    <div id="helpComponents"></div>
                </div>
                
                <div class="help-section" id="helpExampleSection" style="display: none;">
                    <h3>üí° Example Calculation</h3>
                    <div id="helpExample"></div>
                </div>
                
                <div class="help-section" id="helpNineDimensionsSection" style="display: none;">
                    <h3>üåü 9 Justice Dimensions</h3>
                    <div id="helpNineDimensions"></div>
                </div>
                
                <div class="help-section" id="helpAdvantagesSection" style="display: none;">
                    <h3>‚ú® Key Advantages</h3>
                    <div id="helpAdvantages"></div>
                </div>
                
                <div class="help-section" id="helpInterpretationSection" style="display: none;">
                    <h3>üìä Score Interpretation</h3>
                    <div class="help-interpretation" id="helpInterpretation"></div>
                </div>
                
                <div class="help-section">
                    <h3>üìä Data Sources</h3>
                    <div id="helpDataSources"></div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>

